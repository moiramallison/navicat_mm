[2016-02-15 09:53:22.101] [006798] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 09:53:22.216] [006798] [dwh-prod] [PGSQL]
SELECT d.datname, d.oid, pg_get_userbyid(d.datdba) AS owner, shobj_description(d.oid, 'pg_database') AS comment, t.spcname, d.datacl, d.datlastsysoid, d.encoding, pg_encoding_to_char(d.encoding) AS encodingname FROM pg_database d LEFT JOIN pg_tablespace t ON d.dattablespace=t.oid

[2016-02-15 09:53:31.421] [006831] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 09:53:31.502] [006831] [dwh-prod] [PGSQL]
SELECT nspname, oid, pg_get_userbyid(nspowner) AS owner, nspacl, obj_description(oid) FROM pg_namespace

[2016-02-15 09:53:33.926] [006831] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'moiram'

[2016-02-15 09:53:37.433] [006864] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 09:53:37.513] [006864] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-15 09:53:37.705] [006863] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 09:53:37.784] [006863] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-15 09:53:37.882] [006863] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-15 09:53:37.994] [006863] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-15 09:53:38.078] [006863] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-15 09:53:38.603] [006863] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-15 09:53:38.684] [006863] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-15 09:53:38.778] [006863] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-15 09:53:38.859] [006863] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-15 09:53:38.940] [006863] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-15 09:53:39.020] [006863] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-15 09:53:39.293] [006863] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-15 09:53:39.376] [006863] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-15 09:53:39.466] [006863] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-15 09:53:39.551] [006863] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-15 09:54:15.136] [006864] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 09:54:15.235] [006864] [dwh-prod] [PGSQL]
select * from video_tmp limit 1


[2016-02-15 09:54:15.325] [006864] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 09:54:15.553] [006864] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4609563

[2016-02-15 09:54:43.507] [006864] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 09:54:43.601] [006864] [dwh-prod] [PGSQL]
select count(1) from video_tmp where nid = 117071;


[2016-02-15 09:54:43.933] [006864] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 09:56:16.200] [006864] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 09:56:16.299] [006864] [dwh-prod] [PGSQL]
select count(1) from video_tmp where nid = 117056;


[2016-02-15 09:56:16.390] [006864] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 10:18:52.934] [025377] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 10:18:53.020] [025377] [dwh-dev] [PGSQL]
SELECT d.datname, d.oid, pg_get_userbyid(d.datdba) AS owner, shobj_description(d.oid, 'pg_database') AS comment, t.spcname, d.datacl, d.datlastsysoid, d.encoding, pg_encoding_to_char(d.encoding) AS encodingname FROM pg_database d LEFT JOIN pg_tablespace t ON d.dattablespace=t.oid

[2016-02-15 10:18:56.889] [025379] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 10:18:56.969] [025379] [dwh-dev] [PGSQL]
SELECT nspname, oid, pg_get_userbyid(nspowner) AS owner, nspacl, obj_description(oid) FROM pg_namespace

[2016-02-15 12:41:26.399] [025379] [dwh-dev] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'moiram'

[2016-02-15 12:41:26.399] [025379] [dwh-dev] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-15 12:41:26.968] [027890] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 12:41:27.045] [027890] [dwh-dev] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'moiram'

[2016-02-15 12:41:36.818] [027893] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 12:41:36.895] [027890] [dwh-dev] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'moiram' AND col.table_name = 'look_alike_ranks' ORDER BY col.table_name, col.ordinal_position

[2016-02-15 12:41:37.054] [027890] [dwh-dev] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-15 12:41:37.432] [027890] [dwh-dev] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-15 12:41:37.512] [027890] [dwh-dev] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'moiram' AND ct.relname = 'look_alike_ranks' AND conname IS NOT NULL

[2016-02-15 12:41:37.604] [027890] [dwh-dev] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'moiram' AND t.relname = 'look_alike_ranks' ORDER BY t.relname, i.oid

[2016-02-15 12:41:37.699] [027890] [dwh-dev] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'moiram' AND t.relname = 'look_alike_ranks' ORDER BY t.relname, c.conname, a.attnum

[2016-02-15 12:41:37.873] [027893] [dwh-dev] [PGSQL]
SELECT * FROM "moiram"."look_alike_ranks" LIMIT 1000 OFFSET 0

[2016-02-15 12:41:38.115] [027893] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'moiram' AND cl.table_name = 'look_alike_ranks'

[2016-02-15 12:41:38.212] [027893] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 9773035

[2016-02-15 13:12:12.275] [006831] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common'

[2016-02-15 13:12:12.276] [006831] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-15 13:12:12.866] [004162] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 13:12:12.945] [004162] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common'

[2016-02-15 13:12:19.624] [004208] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 13:12:19.758] [004208] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-15 13:12:19.986] [004207] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 13:12:20.065] [004207] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-15 13:12:20.180] [004207] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-15 13:12:20.265] [004207] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-15 13:12:20.347] [004207] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-15 13:12:20.864] [004207] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-15 13:12:20.944] [004207] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-15 13:12:21.030] [004207] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-15 13:12:21.111] [004207] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-15 13:12:21.211] [004207] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-15 13:12:21.294] [004207] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-15 13:12:21.572] [004207] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-15 13:12:21.652] [004207] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-15 13:12:21.736] [004207] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-15 13:12:21.818] [004207] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-15 13:26:00.366] [008422] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 13:26:00.446] [008422] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-15 13:26:00.654] [008421] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 13:26:00.736] [008421] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-15 13:26:00.832] [008421] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-15 13:26:00.922] [008421] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-15 13:26:01.003] [008421] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-15 13:26:01.521] [008421] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-15 13:26:01.601] [008421] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-15 13:26:01.688] [008421] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-15 13:26:01.774] [008421] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-15 13:26:01.859] [008421] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-15 13:26:01.940] [008421] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-15 13:26:02.218] [008421] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-15 13:26:02.297] [008421] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-15 13:26:02.380] [008421] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-15 13:26:02.462] [008421] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-15 13:26:31.485] [008422] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 13:26:31.634] [008422] [dwh-prod] [PGSQL]
drop table if exists tmp.usage_churn_subs;


create table tmp.usage_churn_subs as
select t2.*,
   case when paid_through_age >  0 then 1 else 0 end sub_120_day,
   case when paid_through_age >= 118 and
             anniversary_120_date < '2016-02-15'::date and
             churn_120_day = 0 
        then 1 
        else  churn_395_day  -- if they are counted as a churner, make sure they are counted as a sub
   end sub_395_day,
   case when paid_through_age >= 393 and
             anniversary_395_date < '2016-02-15'::date and
             churn_395_day = 0 
        then 1 
        else churn_400_day   -- if they are counted as a churner, make sure they are counted as a sub
   end sub_400_day
from
   (select t1.*,
       case when cancel_age <= 124 then 1 
                        when paid_through_age <= 121 and cancel_age is not null then 1
            else 0
       end   churn_120_day,
       case when cancel_age >  124 and cancel_age <= 399 then 1 
            when paid_through_age > 121 and paid_through_age  <= 396 and cancel_age is not null then 1
            else 0
       end   churn_395_day,
       case when cancel_age >  399  then 1 
            when paid_through_age > 396 and cancel_age is not null then 1
            else 0
       end   churn_400_day
    from
        (select ud.gcsi_user_id, ud.drupal_user_id, 
           sd.subscription_id, 
           ud.user_behavior_segment, 
           pd.gcsi_plan_id,
           pd.plan_period, 
           sd.start_date::date start_date,
           sd.cancel_date::date cancel_date,
           sd.paid_through_date::date, 
           sd.start_date::date + 120 anniversary_120_date,
           sd.start_date::date + 395 anniversary_395_date,
           sd.cancel_date::date - start_date::date cancel_age,
           paid_through_date::date - start_date::date paid_through_age
        from common.subscription_d sd
        join common.user_dim ud 
           on sd.gcsi_user_id  = ud.gcsi_user_id
        join common.plan_d pd
           on sd.dwh_plan_id = pd.dwh_plan_id
        where status in ('Active','Lapsed','Cancelled')) t1 ) t2
;


[2016-02-15 13:26:34.121] [008422] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 13:31:18.810] [004162] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'tmp'

[2016-02-15 13:31:24.980] [010130] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 13:31:25.059] [004162] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'usage_churn_subs' ORDER BY col.table_name, col.ordinal_position

[2016-02-15 13:31:25.200] [004162] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-15 13:31:25.566] [004162] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-15 13:31:25.648] [004162] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'usage_churn_subs' AND conname IS NOT NULL

[2016-02-15 13:31:25.741] [004162] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'usage_churn_subs' ORDER BY t.relname, i.oid

[2016-02-15 13:31:25.826] [004162] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'usage_churn_subs' ORDER BY t.relname, c.conname, a.attnum

[2016-02-15 13:31:25.997] [010130] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."usage_churn_subs" LIMIT 1000 OFFSET 0

[2016-02-15 13:31:26.564] [010130] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'usage_churn_subs'

[2016-02-15 13:31:26.669] [010130] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6115285

[2016-02-15 13:33:49.360] [010899] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 13:33:49.449] [010899] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-15 13:33:49.555] [010899] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-15 13:33:49.637] [010899] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-15 13:33:50.150] [010899] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-15 13:33:50.229] [010899] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-15 13:33:50.315] [010899] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-15 13:33:55.986] [010913] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 13:33:56.065] [010913] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='usage_churn_subs' ORDER BY ordinal_position

[2016-02-15 13:34:11.385] [008422] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 13:34:11.478] [008422] [dwh-prod] [PGSQL]
select sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day, count(1)
from tmp.usage_churn_subs
group by sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day;


[2016-02-15 13:34:11.720] [008422] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 13:34:11.978] [008422] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6115285

[2016-02-15 13:38:28.027] [010130] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."usage_churn_subs" WHERE "sub_120_day" = '1' AND "sub_395_day" = '0' AND "sub_400_day" = '1' LIMIT 1000 OFFSET 0

[2016-02-15 13:38:28.319] [010130] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'usage_churn_subs'

[2016-02-15 13:38:28.414] [010130] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6115285

[2016-02-15 13:43:54.120] [008422] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 13:43:54.233] [008422] [dwh-prod] [PGSQL]
drop table if exists tmp.usage_churn_subs;


create table tmp.usage_churn_subs as
select t2.*,
   case when paid_through_age >  0 then 1 else 0 end sub_120_day,
   case when paid_through_age >= 118 and
             anniversary_120_date < '2016-02-15'::date and
             churn_120_day = 0 
        then 1 
        else 0
   end sub_395_day,
   case when paid_through_age >= 393 and
             anniversary_395_date < '2016-02-15'::date and
             churn_395_day = 0 
        then 1 
        else churn_400_day   -- if they are counted as a churner, make sure they are counted as a sub
   end sub_400_day
from
   (select t1.*,
       case when cancel_age <= 124 then 1 
                        when paid_through_age <= 121 and cancel_age is not null then 1
            else 0
       end   churn_120_day,
       case when cancel_age >  124 and cancel_age <= 399 then 1 
            when paid_through_age > 121 and paid_through_age  <= 396 and cancel_age is not null then 1
            else 0
       end   churn_395_day,
       case --when cancel_age >  399  then 1 
            when paid_through_age > 396 and cancel_age is not null then 1
            else 0
       end   churn_400_day
    from
        (select ud.gcsi_user_id, ud.drupal_user_id, 
           sd.subscription_id, 
           ud.user_behavior_segment, 
           pd.gcsi_plan_id,
           pd.plan_period, 
           sd.start_date::date start_date,
           sd.cancel_date::date cancel_date,
           sd.paid_through_date::date, 
           sd.start_date::date + 120 anniversary_120_date,
           sd.start_date::date + 395 anniversary_395_date,
           sd.cancel_date::date - start_date::date cancel_age,
           paid_through_date::date - start_date::date paid_through_age
        from common.subscription_d sd
        join common.user_dim ud 
           on sd.gcsi_user_id  = ud.gcsi_user_id
        join common.plan_d pd
           on sd.dwh_plan_id = pd.dwh_plan_id
        where status in ('Active','Lapsed','Cancelled')) t1 ) t2
;

select sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day, count(1)
from tmp.usage_churn_subs
group by sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day;


[2016-02-15 13:43:56.538] [008422] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 13:43:56.827] [008422] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6115291

[2016-02-15 13:45:44.556] [010130] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."usage_churn_subs" WHERE "sub_395_day" = '1' AND "sub_400_day" = '1' LIMIT 1000 OFFSET 0

[2016-02-15 13:45:45.047] [010130] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'usage_churn_subs'

[2016-02-15 13:45:45.144] [010130] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6115291

[2016-02-15 13:46:18.174] [010130] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."usage_churn_subs" WHERE "churn_395_day" = '1' AND "sub_395_day" = '1' AND "sub_400_day" = '1' LIMIT 1000 OFFSET 0

[2016-02-15 13:46:18.742] [010130] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'usage_churn_subs'

[2016-02-15 13:46:18.836] [010130] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6115291

[2016-02-15 13:49:33.093] [008422] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 13:49:33.217] [008422] [dwh-prod] [PGSQL]
drop table if exists tmp.usage_churn_subs;


create table tmp.usage_churn_subs as
select t2.*,
   case when paid_through_age >  0 then 1 else 0 end sub_120_day,
   case when paid_through_age >= 118 and
             anniversary_120_date < '2016-02-15'::date and
             churn_120_day = 0 
        then 1 
        else 0
   end sub_395_day,
   case when paid_through_age >= 393 and
             anniversary_395_date < '2016-02-15'::date and
             churn_395_day = 0 
        then 1 
        when churn_395_day = 1 then 0
        else churn_400_day   -- if they are counted as a churner, make sure they are counted as a sub
   end sub_400_day
from
   (select t1.*,
       case when cancel_age <= 124 then 1 
                        when paid_through_age <= 121 and cancel_age is not null then 1
            else 0
       end   churn_120_day,
       case when cancel_age >  124 and cancel_age <= 399 then 1 
            when paid_through_age > 121 and paid_through_age  <= 396 and cancel_age is not null then 1
            else 0
       end   churn_395_day,
       case --when cancel_age >  399  then 1 
            when paid_through_age > 396 and cancel_age is not null then 1
            else 0
       end   churn_400_day
    from
        (select ud.gcsi_user_id, ud.drupal_user_id, 
           sd.subscription_id, 
           ud.user_behavior_segment, 
           pd.gcsi_plan_id,
           pd.plan_period, 
           sd.start_date::date start_date,
           sd.cancel_date::date cancel_date,
           sd.paid_through_date::date, 
           sd.start_date::date + 120 anniversary_120_date,
           sd.start_date::date + 395 anniversary_395_date,
           sd.cancel_date::date - start_date::date cancel_age,
           paid_through_date::date - start_date::date paid_through_age
        from common.subscription_d sd
        join common.user_dim ud 
           on sd.gcsi_user_id  = ud.gcsi_user_id
        join common.plan_d pd
           on sd.dwh_plan_id = pd.dwh_plan_id
        where status in ('Active','Lapsed','Cancelled')) t1 ) t2
;

select sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day, count(1)
from tmp.usage_churn_subs
group by sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day;


[2016-02-15 13:49:35.628] [008422] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 13:49:35.911] [008422] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6115297

[2016-02-15 13:50:49.086] [010130] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."usage_churn_subs" WHERE "sub_120_day" = '1' AND "sub_395_day" = '0' AND "sub_400_day" = '1' LIMIT 1000 OFFSET 0

[2016-02-15 13:50:49.266] [010130] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'usage_churn_subs'

[2016-02-15 13:50:49.361] [010130] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6115297

[2016-02-15 15:53:55.417] [021750] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 15:53:55.496] [021750] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-15 15:53:55.606] [021750] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-15 15:53:55.699] [021750] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-15 15:53:56.225] [021750] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-15 15:53:56.304] [021750] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-15 15:53:56.400] [021750] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-15 15:53:57.061] [021751] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 15:53:57.145] [021751] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='subscription_d' ORDER BY ordinal_position

[2016-02-15 15:53:57.828] [021758] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 15:53:57.911] [021758] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='user_dim' ORDER BY ordinal_position

[2016-02-15 15:53:58.587] [021759] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 15:53:58.666] [021759] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='plan_d' ORDER BY ordinal_position

[2016-02-15 15:54:52.103] [008422] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 15:54:52.103] [008422] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-15 15:54:52.683] [022063] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 15:54:52.762] [022063] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 15:54:52.871] [022063] [dwh-prod] [PGSQL]
drop table if exists tmp.usage_churn_subs;


create table tmp.usage_churn_subs as
select t2.*,
   case when paid_through_age >  0 then 1 else 0 end sub_120_day,
   case when paid_through_age >= 118 and
             anniversary_120_date < '2016-02-15'::date and
             churn_120_day = 0 
        then 1 
        else 0
   end sub_395_day,
   case when paid_through_age >= 393 and
             anniversary_395_date < '2016-02-15'::date and
             churn_120_day = 0 
             churn_395_day = 0 
        then 1 
        when churn_395_day = 1 then 0
        else churn_400_day   -- if they are counted as a churner, make sure they are counted as a sub
   end sub_400_day
from
   (select t1.*,
       case when paid_through_age <= 121 and cancel_age is not null 
            then 1
            else 0
       end   churn_120_day,
       case when paid_through_age > 121 and paid_through_age  <= 396 and cancel_age is not null 
            then 1
            else 0
       end   churn_395_day,
       case --when cancel_age >  399  then 1 
            when paid_through_age > 396 and cancel_age is not null then 1
            else 0
       end   churn_400_day
    from
        (select ud.gcsi_user_id, ud.drupal_user_id, 
           sd.subscription_id, 
           ud.user_behavior_segment, 
           pd.gcsi_plan_id,
           pd.plan_period, 
           sd.start_date::date start_date,
           sd.cancel_date::date cancel_date,
           sd.paid_through_date::date, 
           sd.start_date::date + 120 anniversary_120_date,
           sd.start_date::date + 395 anniversary_395_date,
           sd.cancel_date::date - start_date::date cancel_age,
           paid_through_date::date - start_date::date paid_through_age
        from common.subscription_d sd
        join common.user_dim ud 
           on sd.gcsi_user_id  = ud.gcsi_user_id
        join common.plan_d pd
           on sd.dwh_plan_id = pd.dwh_plan_id
        where status in ('Active','Lapsed','Cancelled')) t1 ) t2
;

select sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day, count(1)
from tmp.usage_churn_subs
group by sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day;


[2016-02-15 15:54:52.951] [022063] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "churn_395_day"
LINE 16:              churn_395_day = 0 
                      ^


[2016-02-15 15:54:52.971] [022063] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 15:55:01.834] [022063] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 15:55:01.948] [022063] [dwh-prod] [PGSQL]
drop table if exists tmp.usage_churn_subs;


create table tmp.usage_churn_subs as
select t2.*,
   case when paid_through_age >  0 then 1 else 0 end sub_120_day,
   case when paid_through_age >= 118 and
             anniversary_120_date < '2016-02-15'::date and
             churn_120_day = 0 
        then 1 
        else 0
   end sub_395_day,
   case when paid_through_age >= 393 and
             anniversary_395_date < '2016-02-15'::date and
             churn_395_day = 0 
        then 1 
        when churn_395_day = 1 then 0
        else churn_400_day   -- if they are counted as a churner, make sure they are counted as a sub
   end sub_400_day
from
   (select t1.*,
       case when paid_through_age <= 121 and cancel_age is not null 
            then 1
            else 0
       end   churn_120_day,
       case when paid_through_age > 121 and paid_through_age  <= 396 and cancel_age is not null 
            then 1
            else 0
       end   churn_395_day,
       case --when cancel_age >  399  then 1 
            when paid_through_age > 396 and cancel_age is not null then 1
            else 0
       end   churn_400_day
    from
        (select ud.gcsi_user_id, ud.drupal_user_id, 
           sd.subscription_id, 
           ud.user_behavior_segment, 
           pd.gcsi_plan_id,
           pd.plan_period, 
           sd.start_date::date start_date,
           sd.cancel_date::date cancel_date,
           sd.paid_through_date::date, 
           sd.start_date::date + 120 anniversary_120_date,
           sd.start_date::date + 395 anniversary_395_date,
           sd.cancel_date::date - start_date::date cancel_age,
           paid_through_date::date - start_date::date paid_through_age
        from common.subscription_d sd
        join common.user_dim ud 
           on sd.gcsi_user_id  = ud.gcsi_user_id
        join common.plan_d pd
           on sd.dwh_plan_id = pd.dwh_plan_id
        where status in ('Active','Lapsed','Cancelled')) t1 ) t2
;

select sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day, count(1)
from tmp.usage_churn_subs
group by sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day;


[2016-02-15 15:55:04.743] [022063] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 15:55:05.047] [022063] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6115305

[2016-02-15 15:55:54.169] [010130] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."usage_churn_subs" WHERE "sub_120_day" = '1' AND "sub_395_day" = '0' AND "sub_400_day" = '1' LIMIT 1000 OFFSET 0

[2016-02-15 15:55:54.176] [010130] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-15 15:55:54.762] [022427] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 15:55:54.840] [022427] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."usage_churn_subs" WHERE "sub_120_day" = '1' AND "sub_395_day" = '0' AND "sub_400_day" = '1' LIMIT 1000 OFFSET 0

[2016-02-15 15:55:55.056] [022427] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'usage_churn_subs'

[2016-02-15 15:55:55.161] [022427] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6115305

[2016-02-15 15:58:20.335] [022063] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 15:58:20.450] [022063] [dwh-prod] [PGSQL]
drop table if exists tmp.usage_churn_subs;


create table tmp.usage_churn_subs as
select t2.*,
   case when paid_through_age >  0 then 1 else 0 end sub_120_day,
   case when paid_through_age >= 118 and
             anniversary_120_date < '2016-02-15'::date and
             churn_120_day = 0 
        then 1 
        else 0
   end sub_395_day,
   case when paid_through_age >= 393 and
             anniversary_395_date < '2016-02-15'::date and
             churn_395_day = 0 
        then 1 
      --  when churn_395_day = 1 then 0
        else 0   -- if they are counted as a churner, make sure they are counted as a sub
   end sub_400_day
from
   (select t1.*,
       case when paid_through_age <= 121 and cancel_age is not null 
            then 1
            else 0
       end   churn_120_day,
       case when paid_through_age > 121 and paid_through_age  <= 396 and cancel_age is not null 
            then 1
            else 0
       end   churn_395_day,
       case --when cancel_age >  399  then 1 
            when paid_through_age > 396 and cancel_age is not null then 1
            else 0
       end   churn_400_day
    from
        (select ud.gcsi_user_id, ud.drupal_user_id, 
           sd.subscription_id, 
           ud.user_behavior_segment, 
           pd.gcsi_plan_id,
           pd.plan_period, 
           sd.start_date::date start_date,
           sd.cancel_date::date cancel_date,
           sd.paid_through_date::date, 
           sd.start_date::date + 120 anniversary_120_date,
           sd.start_date::date + 395 anniversary_395_date,
           sd.cancel_date::date - start_date::date cancel_age,
           paid_through_date::date - start_date::date paid_through_age
        from common.subscription_d sd
        join common.user_dim ud 
           on sd.gcsi_user_id  = ud.gcsi_user_id
        join common.plan_d pd
           on sd.dwh_plan_id = pd.dwh_plan_id
        where status in ('Active','Lapsed','Cancelled')) t1 ) t2
;

select sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day, count(1)
from tmp.usage_churn_subs
group by sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day;


[2016-02-15 15:58:22.607] [022063] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 15:58:22.907] [022063] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6115311

[2016-02-15 15:59:12.801] [022427] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."usage_churn_subs" WHERE "churn_400_day" = '1' AND "sub_400_day" = '0' LIMIT 1000 OFFSET 0

[2016-02-15 15:59:13.034] [022427] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'usage_churn_subs'

[2016-02-15 15:59:13.129] [022427] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6115311

[2016-02-15 16:44:48.350] [005135] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 16:44:48.429] [005135] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-15 16:44:48.637] [005136] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 16:44:48.716] [005136] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-15 16:44:48.812] [005136] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-15 16:44:48.899] [005136] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-15 16:44:48.981] [005136] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-15 16:44:49.505] [005136] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-15 16:44:49.583] [005136] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-15 16:44:49.669] [005136] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-15 16:44:49.750] [005136] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-15 16:44:49.831] [005136] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-15 16:44:49.911] [005136] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-15 16:44:50.190] [005136] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-15 16:44:50.269] [005136] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-15 16:44:50.351] [005136] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-15 16:44:50.432] [005136] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-15 16:45:24.669] [005135] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 16:45:24.771] [005135] [dwh-prod] [PGSQL]
select * from video_d limit 1


[2016-02-15 16:45:24.866] [005135] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 16:45:25.108] [005135] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6114196

[2016-02-15 16:45:53.401] [005135] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 16:45:53.496] [005135] [dwh-prod] [PGSQL]
select count(1)  from video_d where facet_level_gid is not null;


[2016-02-15 16:45:53.621] [005135] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 16:46:11.210] [005135] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 16:46:11.304] [005135] [dwh-prod] [PGSQL]
select count(1)  from video_d where facet_level_gid is not null and feature = 'Feature';


[2016-02-15 16:46:11.395] [005135] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 16:46:47.676] [005135] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 16:46:47.773] [005135] [dwh-prod] [PGSQL]
select * from video_d;


[2016-02-15 16:46:56.119] [005788] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 16:46:56.359] [005788] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6114196

[2016-02-15 16:47:08.216] [005788] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 16:47:08.310] [005788] [dwh-prod] [PGSQL]
select * from video_d limit 1;


[2016-02-15 16:47:08.405] [005788] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 16:47:08.641] [005788] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6114196

[2016-02-15 17:15:19.740] [022063] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:15:19.854] [022063] [dwh-prod] [PGSQL]
drop table if exists tmp.usage_churn_subs;


create table tmp.usage_churn_subs as
select t2.*,
   case when paid_through_age >  0 then 1 else 0 end sub_120_day,
   case when paid_through_age >= 118 and
             anniversary_120_date < '2016-02-15'::date and
             churn_120_day = 0 
        then 1 
        else 0
   end sub_395_day,
   case when paid_through_age >= 393 and
             anniversary_395_date < '2016-02-15'::date and
             churn_395_day = 0 
        then 1 
      --  when churn_395_day = 1 then 0
        else 0   -- if they are counted as a churner, make sure they are counted as a sub
   end sub_400_day
from
   (select t1.*,
       case when paid_through_age <= 121 and cancel_age is not null 
            then 1
            else 0
       end   churn_120_day,
       case when paid_through_age > 121 and paid_through_age  <= 396 and cancel_age is not null 
            then 1
            else 0
       end   churn_395_day,
       case --when cancel_age >  399  then 1 
            when paid_through_age > 396 and cancel_age is not null then 1
            else 0
       end   churn_400_day
    from
        (select ud.gcsi_user_id, ud.drupal_user_id, 
           sd.subscription_id, 
           ud.user_behavior_segment, 
           pd.gcsi_plan_id,
           pd.plan_period, 
           sd.start_date::date start_date,
           sd.cancel_date::date cancel_date,
           sd.paid_through_date::date, 
           sd.start_date::date + 120 anniversary_120_date,
           sd.start_date::date + 395 anniversary_395_date,
           sd.cancel_date::date - start_date::date cancel_age,
           paid_through_date::date - start_date::date paid_through_age
        from common.subscription_d sd
        join common.user_dim ud 
           on sd.gcsi_user_id  = ud.gcsi_user_id
        join common.plan_d pd
           on sd.dwh_plan_id = pd.dwh_plan_id
        where status in ('Active','Lapsed','Cancelled')) t1 ) t2
;


drop table if exists video_views_smry;

create table video_views_smry as 
select
    drupal_user_id,
    period, 
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       period,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched
    from
    (select vv.*,
            case when view_120_day = 1 then 1
                 when view_395_day =1 then 2
                 when view_400_day = 1 then 3
                 else 0
            end period,
    from
        (select vdc.user_id drupal_user_id,
           vdc.created_date,
           vdc.num_views, 
           vdc.watched, 
           vdc.completion_ratio,
           v.duration,
           case when vdc.created_date <= sm3.anniversary_120_date then 1 else 0 end      view_120_day,
           case when vdc.created_date <= sm3.anniversary_395_date then 1 else 0 end      view_395_day,
           case when vdc.created_date > sm3.anniversary_395_date then 1 else 0 end      view_400_day,
           case when fl.level_1 = 1 then num_views else 0 end                           level_1_views,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration
        from sub_master_30_60_90 sm3
        left join  common.video_daily_cube vdc
            on sm3.drupal_user_id = vdc.user_id
        left join common.video_d v
           on vdc.media_nid = v.media_nid
        left join common.facet_levels fl 
           on v.facet_level_gid = fl.gid
        left join common.guide_d g
           on vdc.media_nid = g.media_nid) vv ) v2
    group by drupal_user_id, period) vxc;

   

create table video_views_master as
select 
    v1.drupal_user_id,
    v1.num_views                       num_views_1,                             
    v1.hrs_watched                     hrs_watched_1,
    v1.engagement_ratio                engagement_ratio_1,
    v1.yoga_engagement_ratio           yoga_engagement_ratio_1,
    v1.sg_engagement_ratio             sg_engagement_ratio_1,
    v1.st_engagement_ratio             st_engagement_ratio_1,
    v1.yoga_views                      yoga_views_1,
    v1.yoga_watched                    yoga_watched_1,
    v1.sg_views                        sg_views_1,
    v1.sg_watched                      sg_watched_1,
    v1.st_views                        st_views_1,
    v1.st_watched                      st_watched_1,
    v1.num_days_watched               num_days_watched_1,
    v2.num_views                       num_views_2,                             
    v2.hrs_watched                     hrs_watched_2,
    v2.engagement_ratio                engagement_ratio_2,
    v2.yoga_engagement_ratio           yoga_engagement_ratio_2,
    v2.sg_engagement_ratio             sg_engagement_ratio_2,
    v2.st_engagement_ratio             st_engagement_ratio_2,
    v2.yoga_views                      yoga_views_2,
    v2.yoga_watched                    yoga_watched_2,
    v2.sg_views                        sg_views_2,
    v2.sg_watched                      sg_watched_2,
    v2.st_views                        st_views_2,
    v2.st_watched                      st_watched_2,
    v2.num_days_watched               num_days_watched_2,
    v3.num_views                       num_views_3,                             
    v3.hrs_watched                     hrs_watched_3,
    v3.engagement_ratio                engagement_ratio_3,
    v3.yoga_engagement_ratio           yoga_engagement_ratio_3,
    v3.sg_engagement_ratio             sg_engagement_ratio_3,
    v3.st_engagement_ratio             st_engagement_ratio_3,
    v3.yoga_views                      yoga_views_3,
    v3.yoga_watched                    yoga_watched_3,
    v3.sg_views                        sg_views_3,
    v3.sg_watched                      sg_watched_3,
    v3.st_views                        st_views_3,
    v3.st_watched                      st_watched_3,
    v3.guide_day_views                 guide_day_views_3,
    v3.num_days_watched               num_days_watched_3
from sub_master_30_60_90 sm 
left join 
     (select * from video_views_smry where period = 1) v1
     on sm.drupal_user_id = v1.drupal_user_id
left join 
     (select * from video_views_smry where period = 2) v2
     on sm.drupal_user_id = v2.drupal_user_id
left join 
     (select * from video_views_smry where period = 3) v3
     on sm.drupal_user_id = v3.drupal_user_id;

select sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day, count(1)
from tmp.usage_churn_subs
group by sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day;


[2016-02-15 17:15:19.936] [022063] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "from"
LINE 110:     from
              ^


[2016-02-15 17:15:19.954] [022063] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:15:31.177] [022063] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:15:31.290] [022063] [dwh-prod] [PGSQL]
drop table if exists tmp.usage_churn_subs;


create table tmp.usage_churn_subs as
select t2.*,
   case when paid_through_age >  0 then 1 else 0 end sub_120_day,
   case when paid_through_age >= 118 and
             anniversary_120_date < '2016-02-15'::date and
             churn_120_day = 0 
        then 1 
        else 0
   end sub_395_day,
   case when paid_through_age >= 393 and
             anniversary_395_date < '2016-02-15'::date and
             churn_395_day = 0 
        then 1 
      --  when churn_395_day = 1 then 0
        else 0   -- if they are counted as a churner, make sure they are counted as a sub
   end sub_400_day
from
   (select t1.*,
       case when paid_through_age <= 121 and cancel_age is not null 
            then 1
            else 0
       end   churn_120_day,
       case when paid_through_age > 121 and paid_through_age  <= 396 and cancel_age is not null 
            then 1
            else 0
       end   churn_395_day,
       case --when cancel_age >  399  then 1 
            when paid_through_age > 396 and cancel_age is not null then 1
            else 0
       end   churn_400_day
    from
        (select ud.gcsi_user_id, ud.drupal_user_id, 
           sd.subscription_id, 
           ud.user_behavior_segment, 
           pd.gcsi_plan_id,
           pd.plan_period, 
           sd.start_date::date start_date,
           sd.cancel_date::date cancel_date,
           sd.paid_through_date::date, 
           sd.start_date::date + 120 anniversary_120_date,
           sd.start_date::date + 395 anniversary_395_date,
           sd.cancel_date::date - start_date::date cancel_age,
           paid_through_date::date - start_date::date paid_through_age
        from common.subscription_d sd
        join common.user_dim ud 
           on sd.gcsi_user_id  = ud.gcsi_user_id
        join common.plan_d pd
           on sd.dwh_plan_id = pd.dwh_plan_id
        where status in ('Active','Lapsed','Cancelled')) t1 ) t2
;


drop table if exists video_views_smry;

create table video_views_smry as 
select
    drupal_user_id,
    period, 
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       period,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched
    from
    (select vv.*,
            case when view_120_day = 1 then 1
                 when view_395_day =1 then 2
                 when view_400_day = 1 then 3
                 else 0
            end period
    from
        (select vdc.user_id drupal_user_id,
           vdc.created_date,
           vdc.num_views, 
           vdc.watched, 
           vdc.completion_ratio,
           v.duration,
           case when vdc.created_date <= sm3.anniversary_120_date then 1 else 0 end      view_120_day,
           case when vdc.created_date <= sm3.anniversary_395_date then 1 else 0 end      view_395_day,
           case when vdc.created_date > sm3.anniversary_395_date then 1 else 0 end      view_400_day,
           case when fl.level_1 = 1 then num_views else 0 end                           level_1_views,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration
        from sub_master_30_60_90 sm3
        left join  common.video_daily_cube vdc
            on sm3.drupal_user_id = vdc.user_id
        left join common.video_d v
           on vdc.media_nid = v.media_nid
        left join common.facet_levels fl 
           on v.facet_level_gid = fl.gid
        left join common.guide_d g
           on vdc.media_nid = g.media_nid) vv ) v2
    group by drupal_user_id, period) vxc;

   

create table video_views_master as
select 
    v1.drupal_user_id,
    v1.num_views                       num_views_1,                             
    v1.hrs_watched                     hrs_watched_1,
    v1.engagement_ratio                engagement_ratio_1,
    v1.yoga_engagement_ratio           yoga_engagement_ratio_1,
    v1.sg_engagement_ratio             sg_engagement_ratio_1,
    v1.st_engagement_ratio             st_engagement_ratio_1,
    v1.yoga_views                      yoga_views_1,
    v1.yoga_watched                    yoga_watched_1,
    v1.sg_views                        sg_views_1,
    v1.sg_watched                      sg_watched_1,
    v1.st_views                        st_views_1,
    v1.st_watched                      st_watched_1,
    v1.num_days_watched               num_days_watched_1,
    v2.num_views                       num_views_2,                             
    v2.hrs_watched                     hrs_watched_2,
    v2.engagement_ratio                engagement_ratio_2,
    v2.yoga_engagement_ratio           yoga_engagement_ratio_2,
    v2.sg_engagement_ratio             sg_engagement_ratio_2,
    v2.st_engagement_ratio             st_engagement_ratio_2,
    v2.yoga_views                      yoga_views_2,
    v2.yoga_watched                    yoga_watched_2,
    v2.sg_views                        sg_views_2,
    v2.sg_watched                      sg_watched_2,
    v2.st_views                        st_views_2,
    v2.st_watched                      st_watched_2,
    v2.num_days_watched               num_days_watched_2,
    v3.num_views                       num_views_3,                             
    v3.hrs_watched                     hrs_watched_3,
    v3.engagement_ratio                engagement_ratio_3,
    v3.yoga_engagement_ratio           yoga_engagement_ratio_3,
    v3.sg_engagement_ratio             sg_engagement_ratio_3,
    v3.st_engagement_ratio             st_engagement_ratio_3,
    v3.yoga_views                      yoga_views_3,
    v3.yoga_watched                    yoga_watched_3,
    v3.sg_views                        sg_views_3,
    v3.sg_watched                      sg_watched_3,
    v3.st_views                        st_views_3,
    v3.st_watched                      st_watched_3,
    v3.guide_day_views                 guide_day_views_3,
    v3.num_days_watched               num_days_watched_3
from sub_master_30_60_90 sm 
left join 
     (select * from video_views_smry where period = 1) v1
     on sm.drupal_user_id = v1.drupal_user_id
left join 
     (select * from video_views_smry where period = 2) v2
     on sm.drupal_user_id = v2.drupal_user_id
left join 
     (select * from video_views_smry where period = 3) v3
     on sm.drupal_user_id = v3.drupal_user_id;

select sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day, count(1)
from tmp.usage_churn_subs
group by sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day;


[2016-02-15 17:15:33.110] [022063] [dwh-prod] [PGSQL]
ERROR:  relation "sub_master_30_60_90" does not exist
LINE 130:         from sub_master_30_60_90 sm3
                       ^


[2016-02-15 17:15:33.135] [022063] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:16:50.397] [022063] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:16:50.551] [022063] [dwh-prod] [PGSQL]
drop table if exists tmp.usage_churn_subs;


create table tmp.usage_churn_subs as
select t2.*,
   case when paid_through_age >  0 then 1 else 0 end sub_120_day,
   case when paid_through_age >= 118 and
             anniversary_120_date < '2016-02-15'::date and
             churn_120_day = 0 
        then 1 
        else 0
   end sub_395_day,
   case when paid_through_age >= 393 and
             anniversary_395_date < '2016-02-15'::date and
             churn_395_day = 0 
        then 1 
      --  when churn_395_day = 1 then 0
        else 0   -- if they are counted as a churner, make sure they are counted as a sub
   end sub_400_day
from
   (select t1.*,
       case when paid_through_age <= 121 and cancel_age is not null 
            then 1
            else 0
       end   churn_120_day,
       case when paid_through_age > 121 and paid_through_age  <= 396 and cancel_age is not null 
            then 1
            else 0
       end   churn_395_day,
       case --when cancel_age >  399  then 1 
            when paid_through_age > 396 and cancel_age is not null then 1
            else 0
       end   churn_400_day
    from
        (select ud.gcsi_user_id, ud.drupal_user_id, 
           sd.subscription_id, 
           ud.user_behavior_segment, 
           pd.gcsi_plan_id,
           pd.plan_period, 
           sd.start_date::date start_date,
           sd.cancel_date::date cancel_date,
           sd.paid_through_date::date, 
           sd.start_date::date + 120 anniversary_120_date,
           sd.start_date::date + 395 anniversary_395_date,
           sd.cancel_date::date - start_date::date cancel_age,
           paid_through_date::date - start_date::date paid_through_age
        from common.subscription_d sd
        join common.user_dim ud 
           on sd.gcsi_user_id  = ud.gcsi_user_id
        join common.plan_d pd
           on sd.dwh_plan_id = pd.dwh_plan_id
        where status in ('Active','Lapsed','Cancelled')) t1 ) t2
;


drop table if exists tmp.video_views_smry;
drop table if exists tmp.video_views_master;

create table tmp.video_views_smry as 
select
    drupal_user_id,
    period, 
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       period,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched
    from
    (select vv.*,
            case when view_120_day = 1 then 1
                 when view_395_day =1 then 2
                 when view_400_day = 1 then 3
                 else 0
            end period
    from
        (select vdc.user_id drupal_user_id,
           vdc.created_date,
           vdc.num_views, 
           vdc.watched, 
           vdc.completion_ratio,
           v.duration,
           case when vdc.created_date <= sm3.anniversary_120_date then 1 else 0 end      view_120_day,
           case when vdc.created_date <= sm3.anniversary_395_date then 1 else 0 end      view_395_day,
           case when vdc.created_date > sm3.anniversary_395_date then 1 else 0 end      view_400_day,
           case when fl.level_1 = 1 then num_views else 0 end                           level_1_views,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration
        from tmp.usage_churn_subs
        left join  common.video_daily_cube vdc
            on sm3.drupal_user_id = vdc.user_id
        left join common.video_d v
           on vdc.media_nid = v.media_nid
        left join common.facet_levels fl 
           on v.facet_level_gid = fl.gid
        left join common.guide_d g
           on vdc.media_nid = g.media_nid) vv ) v2
    group by drupal_user_id, period) vxc;

   

create table tmp.video_views_master as
select 
    v1.drupal_user_id,
    v1.num_views                       num_views_1,                             
    v1.hrs_watched                     hrs_watched_1,
    v1.engagement_ratio                engagement_ratio_1,
    v1.yoga_engagement_ratio           yoga_engagement_ratio_1,
    v1.sg_engagement_ratio             sg_engagement_ratio_1,
    v1.st_engagement_ratio             st_engagement_ratio_1,
    v1.yoga_views                      yoga_views_1,
    v1.yoga_watched                    yoga_watched_1,
    v1.sg_views                        sg_views_1,
    v1.sg_watched                      sg_watched_1,
    v1.st_views                        st_views_1,
    v1.st_watched                      st_watched_1,
    v1.num_days_watched               num_days_watched_1,
    v2.num_views                       num_views_2,                             
    v2.hrs_watched                     hrs_watched_2,
    v2.engagement_ratio                engagement_ratio_2,
    v2.yoga_engagement_ratio           yoga_engagement_ratio_2,
    v2.sg_engagement_ratio             sg_engagement_ratio_2,
    v2.st_engagement_ratio             st_engagement_ratio_2,
    v2.yoga_views                      yoga_views_2,
    v2.yoga_watched                    yoga_watched_2,
    v2.sg_views                        sg_views_2,
    v2.sg_watched                      sg_watched_2,
    v2.st_views                        st_views_2,
    v2.st_watched                      st_watched_2,
    v2.num_days_watched               num_days_watched_2,
    v3.num_views                       num_views_3,                             
    v3.hrs_watched                     hrs_watched_3,
    v3.engagement_ratio                engagement_ratio_3,
    v3.yoga_engagement_ratio           yoga_engagement_ratio_3,
    v3.sg_engagement_ratio             sg_engagement_ratio_3,
    v3.st_engagement_ratio             st_engagement_ratio_3,
    v3.yoga_views                      yoga_views_3,
    v3.yoga_watched                    yoga_watched_3,
    v3.sg_views                        sg_views_3,
    v3.sg_watched                      sg_watched_3,
    v3.st_views                        st_views_3,
    v3.st_watched                      st_watched_3,
    v3.guide_day_views                 guide_day_views_3,
    v3.num_days_watched               num_days_watched_3
from sub_master_30_60_90 sm 
left join 
     (select * from video_views_smry where period = 1) v1
     on sm.drupal_user_id = v1.drupal_user_id
left join 
     (select * from video_views_smry where period = 2) v2
     on sm.drupal_user_id = v2.drupal_user_id
left join 
     (select * from video_views_smry where period = 3) v3
     on sm.drupal_user_id = v3.drupal_user_id;

select sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day, count(1)
from tmp.usage_churn_subs
group by sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day;


[2016-02-15 17:16:52.387] [022063] [dwh-prod] [PGSQL]
ERROR:  missing FROM-clause entry for table "sm3"
LINE 133:             on sm3.drupal_user_id = vdc.user_id
                         ^


[2016-02-15 17:16:52.403] [022063] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:17:08.950] [022063] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:17:09.063] [022063] [dwh-prod] [PGSQL]
drop table if exists tmp.usage_churn_subs;


create table tmp.usage_churn_subs as
select t2.*,
   case when paid_through_age >  0 then 1 else 0 end sub_120_day,
   case when paid_through_age >= 118 and
             anniversary_120_date < '2016-02-15'::date and
             churn_120_day = 0 
        then 1 
        else 0
   end sub_395_day,
   case when paid_through_age >= 393 and
             anniversary_395_date < '2016-02-15'::date and
             churn_395_day = 0 
        then 1 
      --  when churn_395_day = 1 then 0
        else 0   -- if they are counted as a churner, make sure they are counted as a sub
   end sub_400_day
from
   (select t1.*,
       case when paid_through_age <= 121 and cancel_age is not null 
            then 1
            else 0
       end   churn_120_day,
       case when paid_through_age > 121 and paid_through_age  <= 396 and cancel_age is not null 
            then 1
            else 0
       end   churn_395_day,
       case --when cancel_age >  399  then 1 
            when paid_through_age > 396 and cancel_age is not null then 1
            else 0
       end   churn_400_day
    from
        (select ud.gcsi_user_id, ud.drupal_user_id, 
           sd.subscription_id, 
           ud.user_behavior_segment, 
           pd.gcsi_plan_id,
           pd.plan_period, 
           sd.start_date::date start_date,
           sd.cancel_date::date cancel_date,
           sd.paid_through_date::date, 
           sd.start_date::date + 120 anniversary_120_date,
           sd.start_date::date + 395 anniversary_395_date,
           sd.cancel_date::date - start_date::date cancel_age,
           paid_through_date::date - start_date::date paid_through_age
        from common.subscription_d sd
        join common.user_dim ud 
           on sd.gcsi_user_id  = ud.gcsi_user_id
        join common.plan_d pd
           on sd.dwh_plan_id = pd.dwh_plan_id
        where status in ('Active','Lapsed','Cancelled')) t1 ) t2
;


drop table if exists tmp.video_views_smry;
drop table if exists tmp.video_views_master;

create table tmp.video_views_smry as 
select
    drupal_user_id,
    period, 
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       period,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched
    from
    (select vv.*,
            case when view_120_day = 1 then 1
                 when view_395_day =1 then 2
                 when view_400_day = 1 then 3
                 else 0
            end period
    from
        (select vdc.user_id drupal_user_id,
           vdc.created_date,
           vdc.num_views, 
           vdc.watched, 
           vdc.completion_ratio,
           v.duration,
           case when vdc.created_date <= sm3.anniversary_120_date then 1 else 0 end      view_120_day,
           case when vdc.created_date <= sm3.anniversary_395_date then 1 else 0 end      view_395_day,
           case when vdc.created_date > sm3.anniversary_395_date then 1 else 0 end      view_400_day,
           case when fl.level_1 = 1 then num_views else 0 end                           level_1_views,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration
        from tmp.usage_churn_subs sm3
        left join  common.video_daily_cube vdc
            on sm3.drupal_user_id = vdc.user_id
        left join common.video_d v
           on vdc.media_nid = v.media_nid
        left join common.facet_levels fl 
           on v.facet_level_gid = fl.gid
        left join common.guide_d g
           on vdc.media_nid = g.media_nid) vv ) v2
    group by drupal_user_id, period) vxc;

   

create table tmp.video_views_master as
select 
    v1.drupal_user_id,
    v1.num_views                       num_views_1,                             
    v1.hrs_watched                     hrs_watched_1,
    v1.engagement_ratio                engagement_ratio_1,
    v1.yoga_engagement_ratio           yoga_engagement_ratio_1,
    v1.sg_engagement_ratio             sg_engagement_ratio_1,
    v1.st_engagement_ratio             st_engagement_ratio_1,
    v1.yoga_views                      yoga_views_1,
    v1.yoga_watched                    yoga_watched_1,
    v1.sg_views                        sg_views_1,
    v1.sg_watched                      sg_watched_1,
    v1.st_views                        st_views_1,
    v1.st_watched                      st_watched_1,
    v1.num_days_watched               num_days_watched_1,
    v2.num_views                       num_views_2,                             
    v2.hrs_watched                     hrs_watched_2,
    v2.engagement_ratio                engagement_ratio_2,
    v2.yoga_engagement_ratio           yoga_engagement_ratio_2,
    v2.sg_engagement_ratio             sg_engagement_ratio_2,
    v2.st_engagement_ratio             st_engagement_ratio_2,
    v2.yoga_views                      yoga_views_2,
    v2.yoga_watched                    yoga_watched_2,
    v2.sg_views                        sg_views_2,
    v2.sg_watched                      sg_watched_2,
    v2.st_views                        st_views_2,
    v2.st_watched                      st_watched_2,
    v2.num_days_watched               num_days_watched_2,
    v3.num_views                       num_views_3,                             
    v3.hrs_watched                     hrs_watched_3,
    v3.engagement_ratio                engagement_ratio_3,
    v3.yoga_engagement_ratio           yoga_engagement_ratio_3,
    v3.sg_engagement_ratio             sg_engagement_ratio_3,
    v3.st_engagement_ratio             st_engagement_ratio_3,
    v3.yoga_views                      yoga_views_3,
    v3.yoga_watched                    yoga_watched_3,
    v3.sg_views                        sg_views_3,
    v3.sg_watched                      sg_watched_3,
    v3.st_views                        st_views_3,
    v3.st_watched                      st_watched_3,
    v3.guide_day_views                 guide_day_views_3,
    v3.num_days_watched               num_days_watched_3
from sub_master_30_60_90 sm 
left join 
     (select * from video_views_smry where period = 1) v1
     on sm.drupal_user_id = v1.drupal_user_id
left join 
     (select * from video_views_smry where period = 2) v2
     on sm.drupal_user_id = v2.drupal_user_id
left join 
     (select * from video_views_smry where period = 3) v3
     on sm.drupal_user_id = v3.drupal_user_id;

select sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day, count(1)
from tmp.usage_churn_subs
group by sub_120_day, churn_120_day, sub_395_day, churn_395_day, sub_400_day, churn_400_day;


[2016-02-15 17:19:23.580] [018029] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:21:10.384] [018958] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 17:21:10.463] [018958] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-15 17:21:10.666] [018957] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 17:21:10.745] [018957] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-15 17:21:10.841] [018957] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-15 17:21:10.927] [018957] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-15 17:21:11.007] [018957] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-15 17:21:11.522] [018957] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-15 17:21:11.602] [018957] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-15 17:21:11.687] [018957] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-15 17:21:11.767] [018957] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-15 17:21:11.867] [018957] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-15 17:21:11.949] [018957] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-15 17:21:12.221] [018957] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-15 17:21:12.300] [018957] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-15 17:21:12.383] [018957] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-15 17:21:12.465] [018957] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-15 17:23:32.279] [019651] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 17:23:32.359] [019651] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-15 17:23:32.462] [019651] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-15 17:23:32.546] [019651] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-15 17:23:33.058] [019651] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-15 17:23:33.138] [019651] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-15 17:23:33.226] [019651] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-15 17:23:33.885] [019671] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 17:23:33.999] [019671] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='user_dim' ORDER BY ordinal_position

[2016-02-15 17:23:34.672] [019672] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 17:23:34.752] [019672] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='daily_status_snapshot' ORDER BY ordinal_position

[2016-02-15 17:23:35.448] [019673] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 17:23:35.526] [019673] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='subscription_d' ORDER BY ordinal_position

[2016-02-15 17:25:20.832] [020248] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 17:25:20.912] [020248] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='engagement_subs' ORDER BY ordinal_position

[2016-02-15 17:25:21.578] [020249] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 17:25:21.657] [020249] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='engagement_idx' ORDER BY ordinal_position

[2016-02-15 17:32:52.484] [018958] [dwh-prod] [PGSQL]
SET search_path TO "tmp",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:32:52.602] [018958] [dwh-prod] [PGSQL]
drop table if exists tmp.engagement_subs;

create table tmp.engagement_subs as
(select subscription_id,
   user_behavior_segment,
   trunc(subscription_age/30) subscription_months,
   cancel_date,
   churner
from
    (SELECT
       sd.gcsi_user_id, 
       subscription_id,
       user_behavior_segment,
       coalesce(cancel_date,end_date) cancel_date,
       case when cancel_date is not null then cancel_date::date - start_date::date
            when end_date is not null then end_date::date - start_date::date
            else current_date::date - start_date::date
        end subscription_age,
       case when cancel_date is null and end_date is null then 0 else 1 end churner
       from common.subscription_d sd   
       join common.user_dim ud 
         on sd.gcsi_user_id = ud.gcsi_user_id
       where cancel_date  >= '20140101' or cancel_date is null)foo
);



drop table if exists tmp.engagement_idx;

create table tmp.engagement_idx as
select ud.drupal_user_id, 
       ud.gcsi_user_id, 
       ud.user_behavior_segment,
       dss.subscription_id, 
       dss.paid_through_date::date - vdc.created_date::date days_left,
       sd.start_date,
       vdc.created_date,
       vdc.watched,
       trunc((vdc.created_date::date - sd.start_date::date)/30) view_months
from common.user_dim ud
join 
     (select user_id drupal_user_id,
               created_date,
               sum(watched) watched
         from common.video_daily_cube 
        where watched > 150 and
              engagement_ratio >= .25
        group by user_id, created_date) vdc
    on ud.drupal_user_id = vdc.drupal_user_id
join common.daily_status_snapshot dss
   on ud.gcsi_user_id = dss.gcsi_user_id and
      vdc.created_date::date = dss.day_timestamp::date
join common.subscription_d sd
   on dss.subscription_id = sd.subscription_id;

drop table if exists tmp.engagement_smry;

create table tmp.engagement_smry
as
  select subscription_id,
         month,
         min(days_left) days_since_last_video_view
         sum(watched) watched,
         max(churner) churner
from
(select
    es.subscription_id,
    month,
    coalesce(days_left,30) days_since_last_video_view,
    coalesce(watched,0) watched, 
    case when gs.month = es.subscription_months
         then churner
         else 0
    end churner
from 
   (select generate_series(1,30) as month)gs
join tmp.engagement_subs es
   on gs.month <= es.subscription_months
left join tmp.engagement_idx ei
  on ei.subscription_id = es.subscription_id and 
     ei.view_months = gs.month) foo
group by subscription_id, month;


[2016-02-15 17:32:52.682] [018958] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "sum"
LINE 63:          sum(watched) watched,
                  ^


[2016-02-15 17:32:52.698] [018958] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:33:13.766] [018958] [dwh-prod] [PGSQL]
SET search_path TO "tmp",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:33:13.873] [018958] [dwh-prod] [PGSQL]
drop table if exists tmp.engagement_subs;

create table tmp.engagement_subs as
(select subscription_id,
   user_behavior_segment,
   trunc(subscription_age/30) subscription_months,
   cancel_date,
   churner
from
    (SELECT
       sd.gcsi_user_id, 
       subscription_id,
       user_behavior_segment,
       coalesce(cancel_date,end_date) cancel_date,
       case when cancel_date is not null then cancel_date::date - start_date::date
            when end_date is not null then end_date::date - start_date::date
            else current_date::date - start_date::date
        end subscription_age,
       case when cancel_date is null and end_date is null then 0 else 1 end churner
       from common.subscription_d sd   
       join common.user_dim ud 
         on sd.gcsi_user_id = ud.gcsi_user_id
       where cancel_date  >= '20140101' or cancel_date is null)foo
);



drop table if exists tmp.engagement_idx;

create table tmp.engagement_idx as
select ud.drupal_user_id, 
       ud.gcsi_user_id, 
       ud.user_behavior_segment,
       dss.subscription_id, 
       dss.paid_through_date::date - vdc.created_date::date days_left,
       sd.start_date,
       vdc.created_date,
       vdc.watched,
       trunc((vdc.created_date::date - sd.start_date::date)/30) view_months
from common.user_dim ud
join 
     (select user_id drupal_user_id,
               created_date,
               sum(watched) watched
         from common.video_daily_cube 
        where watched > 150 and
              engagement_ratio >= .25
        group by user_id, created_date) vdc
    on ud.drupal_user_id = vdc.drupal_user_id
join common.daily_status_snapshot dss
   on ud.gcsi_user_id = dss.gcsi_user_id and
      vdc.created_date::date = dss.day_timestamp::date
join common.subscription_d sd
   on dss.subscription_id = sd.subscription_id;

drop table if exists tmp.engagement_smry;

create table tmp.engagement_smry
as
  select subscription_id,
         month,
         min(days_left) days_since_last_video_view,
         sum(watched) watched,
         max(churner) churner
from
(select
    es.subscription_id,
    month,
    coalesce(days_left,30) days_since_last_video_view,
    coalesce(watched,0) watched, 
    case when gs.month = es.subscription_months
         then churner
         else 0
    end churner
from 
   (select generate_series(1,30) as month)gs
join tmp.engagement_subs es
   on gs.month <= es.subscription_months
left join tmp.engagement_idx ei
  on ei.subscription_id = es.subscription_id and 
     ei.view_months = gs.month) foo
group by subscription_id, month;


[2016-02-15 17:35:53.928] [018958] [dwh-prod] [PGSQL]
ERROR:  column "days_left" does not exist
LINE 62:          min(days_left) days_since_last_video_view,
                      ^


[2016-02-15 17:35:54.023] [018958] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:40:54.468] [026153] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 17:40:54.547] [004162] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'engagement_idx' ORDER BY col.table_name, col.ordinal_position

[2016-02-15 17:40:54.547] [004162] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-15 17:40:55.116] [026154] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 17:40:55.195] [026154] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'engagement_idx' ORDER BY col.table_name, col.ordinal_position

[2016-02-15 17:40:55.320] [026154] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-15 17:40:55.713] [026154] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-15 17:40:55.794] [026154] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'engagement_idx' AND conname IS NOT NULL

[2016-02-15 17:40:55.877] [026154] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'engagement_idx' ORDER BY t.relname, i.oid

[2016-02-15 17:40:55.962] [026154] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'engagement_idx' ORDER BY t.relname, c.conname, a.attnum

[2016-02-15 17:40:56.126] [026153] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."engagement_idx" LIMIT 1000 OFFSET 0

[2016-02-15 17:40:56.532] [026153] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'engagement_idx'

[2016-02-15 17:40:56.631] [026153] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6001706

[2016-02-15 17:42:31.278] [026596] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-15 17:42:31.357] [026154] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'engagement_idx' ORDER BY col.table_name, col.ordinal_position

[2016-02-15 17:42:31.465] [026154] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-15 17:42:31.862] [026154] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-15 17:42:31.943] [026154] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'engagement_idx' AND conname IS NOT NULL

[2016-02-15 17:42:32.024] [026154] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'engagement_idx' ORDER BY t.relname, i.oid

[2016-02-15 17:42:32.109] [026154] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'engagement_idx' ORDER BY t.relname, c.conname, a.attnum

[2016-02-15 17:42:32.270] [026596] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."engagement_idx" LIMIT 1000 OFFSET 0

[2016-02-15 17:42:32.675] [026596] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'engagement_idx'

[2016-02-15 17:42:32.774] [026596] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6001706

[2016-02-15 17:43:24.598] [018958] [dwh-prod] [PGSQL]
SET search_path TO "tmp",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:43:24.703] [018958] [dwh-prod] [PGSQL]
drop table if exists tmp.engagement_smry;

create table tmp.engagement_smry
as
  select subscription_id,
         month,
         min(days_left) days_since_last_video_view,
         sum(watched) watched,
         max(churner) churner
from
(select
    es.subscription_id,
    month,
    coalesce(days_left,30) days_left,
    coalesce(watched,0) watched, 
    case when gs.month = es.subscription_months
         then churner
         else 0
    end churner
from 
   (select generate_series(1,30) as month)gs
join tmp.engagement_subs es
   on gs.month <= es.subscription_months
left join tmp.engagement_idx ei
  on ei.subscription_id = es.subscription_id and 
     ei.view_months = gs.month) foo
group by subscription_id, month;


[2016-02-15 17:43:24.784] [018958] [dwh-prod] [PGSQL]
ERROR:  column "days_left" does not exist
LINE 14:     coalesce(days_left,30) days_left,
                      ^


[2016-02-15 17:43:24.800] [018958] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:43:37.525] [018958] [dwh-prod] [PGSQL]
SET search_path TO "tmp",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-15 17:43:37.633] [018958] [dwh-prod] [PGSQL]
drop table if exists tmp.engagement_subs;

create table tmp.engagement_subs as
(select subscription_id,
   user_behavior_segment,
   trunc(subscription_age/30) subscription_months,
   cancel_date,
   churner
from
    (SELECT
       sd.gcsi_user_id, 
       subscription_id,
       user_behavior_segment,
       coalesce(cancel_date,end_date) cancel_date,
       case when cancel_date is not null then cancel_date::date - start_date::date
            when end_date is not null then end_date::date - start_date::date
            else current_date::date - start_date::date
        end subscription_age,
       case when cancel_date is null and end_date is null then 0 else 1 end churner
       from common.subscription_d sd   
       join common.user_dim ud 
         on sd.gcsi_user_id = ud.gcsi_user_id
       where cancel_date  >= '20140101' or cancel_date is null)foo
);



drop table if exists tmp.engagement_idx;

create table tmp.engagement_idx as
select ud.drupal_user_id, 
       ud.gcsi_user_id, 
       ud.user_behavior_segment,
       dss.subscription_id, 
       dss.paid_through_date::date - vdc.created_date::date days_left,
       sd.start_date,
       vdc.created_date,
       vdc.watched,
       trunc((vdc.created_date::date - sd.start_date::date)/30) view_months
from common.user_dim ud
join 
     (select user_id drupal_user_id,
               created_date,
               sum(watched) watched
         from common.video_daily_cube 
        where watched > 150 and
              engagement_ratio >= .25
        group by user_id, created_date) vdc
    on ud.drupal_user_id = vdc.drupal_user_id
join common.daily_status_snapshot dss
   on ud.gcsi_user_id = dss.gcsi_user_id and
      vdc.created_date::date = dss.day_timestamp::date
join common.subscription_d sd
   on dss.subscription_id = sd.subscription_id;

drop table if exists tmp.engagement_smry;

create table tmp.engagement_smry
as
  select subscription_id,
         month,
         min(days_left) days_since_last_video_view,
         sum(watched) watched,
         max(churner) churner
from
(select
    es.subscription_id,
    month,
    coalesce(days_left,30) days_left,
    coalesce(watched,0) watched, 
    case when gs.month = es.subscription_months
         then churner
         else 0
    end churner
from 
   (select generate_series(1,30) as month)gs
join tmp.engagement_subs es
   on gs.month <= es.subscription_months
left join tmp.engagement_idx ei
  on ei.subscription_id = es.subscription_id and 
     ei.view_months = gs.month) foo
group by subscription_id, month;


drop table if exists tmp.engagement_master;

create table tmp.engagement_master
as 
select e1.subscription_id,
   e1.subscription_months,
   e1.cancel_date,
   e1.churner,
    round(e2.watched/3600,3) watched_0,
    round(e3.watched/3600,3) watched_1,
    round(e4.watched/3600,3) watched_2,
    round(e5.watched/3600,3) watched_3,
    round(e6.watched/3600,3) watched_4,
    round(e7.watched/3600,3) watched_5,
    round(e8.watched/3600,3) watched_6

from tmp.engagement_subs e1
left join 
    (select subscription_id, max(created_date) created_date
     from tmp.engagement_idx
     group by subscription_id) ei
   on e1.subscription_id = ei.subscription_id
join tmp.engagement_smry e2
   on e1.subscription_id = e2.subscription_id and
      e1.subscription_months = e2.month
join tmp.engagement_smry e3
   on e1.subscription_id = e3.subscription_id and
      e1.subscription_months -1 = e3.month
join tmp.engagement_smry e4
     on e1.subscription_id = e4.subscription_id and
      e1.subscription_months -2 = e4.month
join tmp.engagement_smry e5
     on e1.subscription_id = e5.subscription_id and
      e1.subscription_months -3 = e5.month
join tmp.engagement_smry e6
     on e1.subscription_id = e6.subscription_id and
      e1.subscription_months -4 = e6.month
join tmp.engagement_smry e7
     on e1.subscription_id = e7.subscription_id and
      e1.subscription_months -5 = e7.month
join tmp.engagement_smry e8
     on e1.subscription_id = e8.subscription_id and
      e1.subscription_months -6 = e8.month;


[2016-02-15 17:48:40.803] [018958] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 09:00:09.538] [007242] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 09:00:09.622] [007242] [dwh-prod] [PGSQL]
SELECT nspname, oid, pg_get_userbyid(nspowner) AS owner, nspacl, obj_description(oid) FROM pg_namespace

[2016-02-16 09:00:13.244] [007242] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'drupal'

[2016-02-16 09:00:22.647] [007242] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common'

[2016-02-16 09:00:39.341] [019853] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 09:00:39.420] [019853] [dwh-dev] [PGSQL]
SELECT nspname, oid, pg_get_userbyid(nspowner) AS owner, nspacl, obj_description(oid) FROM pg_namespace

[2016-02-16 09:00:41.969] [019853] [dwh-dev] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'drupal'

[2016-02-16 10:29:13.313] [006864] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:29:13.313] [006864] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-16 10:29:13.989] [002254] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 10:29:14.071] [002254] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:29:14.160] [002254] [dwh-prod] [PGSQL]
select count(1) from video_tmp where nid = '117856';


[2016-02-16 10:29:14.288] [002254] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:29:54.913] [002484] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 10:29:54.995] [002484] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-16 10:29:55.103] [002484] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-16 10:29:55.187] [002484] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-16 10:29:55.721] [002484] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-16 10:29:56.005] [002484] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-16 10:29:56.442] [002484] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-16 10:30:59.498] [002867] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 10:30:59.580] [002867] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='moiram' AND table_name='dss_test' ORDER BY ordinal_position

[2016-02-16 10:44:40.301] [006994] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 10:44:40.382] [006994] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-16 10:44:40.485] [006994] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-16 10:44:40.569] [006994] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-16 10:44:46.948] [006994] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-16 10:44:47.030] [006994] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-16 10:44:47.120] [006994] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-16 10:47:25.669] [002254] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:47:25.776] [002254] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss_test.gcsi_user_id,  
          '20150114' ivend,
          ud.user_behavior_segment,
          '20150114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150114' 
  and status = 'Active';
          


[2016-02-16 10:47:25.865] [002254] [dwh-prod] [PGSQL]
ERROR:  missing FROM-clause entry for table "dss_test"
LINE 6:           dss_test.gcsi_user_id,  
                  ^


[2016-02-16 10:47:25.882] [002254] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:47:42.433] [002254] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:47:42.547] [002254] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          '20150114' ivend,
          ud.user_behavior_segment,
          '20150114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150114' 
  and status = 'Active';
          


[2016-02-16 10:47:42.650] [002254] [dwh-prod] [PGSQL]
ERROR:  column reference "status" is ambiguous
LINE 14:   and status = 'Active';
               ^


[2016-02-16 10:47:42.665] [002254] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:47:55.284] [002254] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:47:55.390] [002254] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          '20150114' ivend,
          ud.user_behavior_segment,
          '20150114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150114' 
  and dss.status = 'Active';
          


[2016-02-16 10:48:27.598] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:48:37.433] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:48:37.542] [008199] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          '20150114'::date ivend,
          ud.user_behavior_segment,
          '20150114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150114' 
  and dss.status = 'Active';
          


[2016-02-16 10:48:38.914] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:53:19.225] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:53:19.336] [008199] [dwh-prod] [PGSQL]
create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         '20150114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date;


[2016-02-16 10:53:19.426] [008199] [dwh-prod] [PGSQL]
ERROR:  missing FROM-clause entry for table "sd"
LINE 3:   select sd.subscription_id,
                 ^


[2016-02-16 10:53:19.439] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:53:37.629] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:53:37.742] [008199] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          '20160114'::date ivend,
          ud.user_behavior_segment,
          '20160114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20160114' 
  and dss.status = 'Active';

drop table if exists tmp.sub_targetsl

create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         '20160114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date;


[2016-02-16 10:53:37.822] [008199] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "create"
LINE 18: create table tmp.sub_targets
         ^


[2016-02-16 10:53:37.837] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:53:46.685] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 10:53:46.793] [008199] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          '20160114'::date ivend,
          ud.user_behavior_segment,
          '20160114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20160114' 
  and dss.status = 'Active';

drop table if exists tmp.sub_targets;

create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         '20160114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date;


[2016-02-16 10:53:48.618] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:06:24.431] [013921] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 11:06:24.513] [013921] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='subscription_d' ORDER BY ordinal_position

[2016-02-16 11:08:04.763] [014433] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 11:08:04.842] [014433] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_daily_cube' ORDER BY ordinal_position

[2016-02-16 11:34:28.968] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:34:29.087] [008199] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20160114'::date ivend,
          ud.user_behavior_segment,
          '20160114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20160114' 
  and dss.status = 'Active';

drop table if exists tmp.sub_targets;

create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20160114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date;

drop table if exists tmp.video_views_master;


-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
create table tmp.video_views_master
as 
select sm.drupal_user_id,
    '20160114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    (select drupal_user_id,
        $[ivend]::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(to_timestamp(created))::date video_view_date,
         from tmp.sub_master sm 
         join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 AND
         to_timestamp(created)::date <= '20160114'
         group by st.drupal_user_id) v1 ) v2
left join
     (select drupal_user_id,
        $[dvend]::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(to_timestamp(created))::date video_view_date,
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND to_timestamp(created)::date <= '20160214'::date
         group by st.drupal_user_id) v3 ) v4;
  

        


[2016-02-16 11:34:29.170] [008199] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "$"
LINE 43:         $[ivend]::date - video_view_date days_since_last_vid...
                 ^


[2016-02-16 11:34:29.186] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:34:45.612] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:34:45.726] [008199] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20160114'::date ivend,
          ud.user_behavior_segment,
          '20160114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20160114' 
  and dss.status = 'Active';

drop table if exists tmp.sub_targets;

create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20160114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date;

drop table if exists tmp.video_views_master;


-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
create table tmp.video_views_master
as 
select sm.drupal_user_id,
    '20160114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    (select drupal_user_id,
        '20160114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(to_timestamp(created))::date video_view_date,
         from tmp.sub_master sm 
         join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 AND
         to_timestamp(created)::date <= '20160114'
         group by st.drupal_user_id) v1 ) v2
left join
     (select drupal_user_id,
        $[dvend]::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(to_timestamp(created))::date video_view_date,
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND to_timestamp(created)::date <= '20160214'::date
         group by st.drupal_user_id) v3 ) v4;
  

        


[2016-02-16 11:34:45.812] [008199] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "from"
LINE 47:          from tmp.sub_master sm 
                  ^


[2016-02-16 11:34:45.829] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:34:56.022] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:34:56.135] [008199] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20160114'::date ivend,
          ud.user_behavior_segment,
          '20160114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20160114' 
  and dss.status = 'Active';

drop table if exists tmp.sub_targets;

create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20160114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date;

drop table if exists tmp.video_views_master;


-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
create table tmp.video_views_master
as 
select sm.drupal_user_id,
    '20160114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    (select drupal_user_id,
        '20160114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(to_timestamp(created))::date video_view_date
         from tmp.sub_master sm 
         join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 AND
         to_timestamp(created)::date <= '20160114'
         group by st.drupal_user_id) v1 ) v2
left join
     (select drupal_user_id,
        $[dvend]::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(to_timestamp(created))::date video_view_date,
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND to_timestamp(created)::date <= '20160214'::date
         group by st.drupal_user_id) v3 ) v4;
  

        


[2016-02-16 11:34:56.216] [008199] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "$"
LINE 55:         $[dvend]::date - video_view_date days_since_last_vid...
                 ^


[2016-02-16 11:34:56.232] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:35:14.424] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:35:14.540] [008199] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20160114'::date ivend,
          ud.user_behavior_segment,
          '20160114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20160114' 
  and dss.status = 'Active';

drop table if exists tmp.sub_targets;

create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20160114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date;

drop table if exists tmp.video_views_master;


-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
create table tmp.video_views_master
as 
select sm.drupal_user_id,
    '20160114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    (select drupal_user_id,
        '20160114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(to_timestamp(created))::date video_view_date
         from tmp.sub_master sm 
         join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 AND
         to_timestamp(created)::date <= '20160114'
         group by st.drupal_user_id) v1 ) v2
left join
     (select drupal_user_id,
        '20160214'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(to_timestamp(created))::date video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND to_timestamp(created)::date <= '20160214'::date
         group by st.drupal_user_id) v3 ) v4;
  

        


[2016-02-16 11:35:14.622] [008199] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near ";"
LINE 64:          group by st.drupal_user_id) v3 ) v4;
                                                     ^


[2016-02-16 11:35:14.638] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:37:21.378] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:37:21.492] [008199] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20160114'::date ivend,
          ud.user_behavior_segment,
          '20160114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20160114' 
  and dss.status = 'Active';

drop table if exists tmp.sub_targets;

create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20160114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date;

drop table if exists tmp.video_views_master;


-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
create table tmp.video_views_master
as 
select sm.drupal_user_id,
    '20160114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    (select drupal_user_id,
        '20160114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(to_timestamp(created))::date video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 AND
         to_timestamp(created)::date <= '20160114'
         group by st.drupal_user_id) v1 ) v2
left join
     (select drupal_user_id,
        '20160214'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(to_timestamp(created))::date video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND to_timestamp(created)::date <= '20160214'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id;
  

        


[2016-02-16 11:37:22.182] [008199] [dwh-prod] [PGSQL]
ERROR:  column "created" does not exist
LINE 46:                max(to_timestamp(created))::date video_view_d...
                                         ^


[2016-02-16 11:37:22.207] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:38:55.804] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:38:55.919] [008199] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20160114'::date ivend,
          ud.user_behavior_segment,
          '20160114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20160114' 
  and dss.status = 'Active';

drop table if exists tmp.sub_targets;

create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20160114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date;

drop table if exists tmp.video_views_master;


-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
create table tmp.video_views_master
as 
select sm.drupal_user_id,
    '20160114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    (select drupal_user_id,
        '20160114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20160114'
         group by st.drupal_user_id) v1 ) v2
left join
     (select drupal_user_id,
        '20160214'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20160214'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id;
  

        


[2016-02-16 11:38:56.591] [008199] [dwh-prod] [PGSQL]
ERROR:  missing FROM-clause entry for table "st"
LINE 52:          group by st.drupal_user_id) v1 ) v2
                           ^


[2016-02-16 11:38:56.608] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:39:19.268] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:39:19.381] [008199] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20160114'::date ivend,
          ud.user_behavior_segment,
          '20160114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20160114' 
  and dss.status = 'Active';

drop table if exists tmp.sub_targets;

create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20160114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date;

drop table if exists tmp.video_views_master;


-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
create table tmp.video_views_master
as 
select sm.drupal_user_id,
    '20160114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    (select drupal_user_id,
        '20160114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20160114'
         group by sm.drupal_user_id) v1 ) v2
left join
     (select drupal_user_id,
        '20160214'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20160214'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id;
  

        


[2016-02-16 11:39:20.052] [008199] [dwh-prod] [PGSQL]
ERROR:  missing FROM-clause entry for table "sm"
LINE 38: select sm.drupal_user_id,
                ^


[2016-02-16 11:39:20.073] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:43:32.618] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:43:32.732] [008199] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20160114'::date ivend,
          ud.user_behavior_segment,
          '20160114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20160114' 
  and dss.status = 'Active';

drop table if exists tmp.sub_targets;

create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20160114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date;

drop table if exists tmp.video_views_master;


-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
create table tmp.video_views_master
as 
select sm.drupal_user_id,
    '20160114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    (select drupal_user_id,
        '20160114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20160114'
         group by sm.drupal_user_id) v1 ) v2
left join
     (select drupal_user_id,
        '20160214'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20160214'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id;
  
drop table if exists tmp.sfss;

create table tmp.sfss
as 
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,1) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend;
        


[2016-02-16 11:43:32.814] [008199] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near ";"
LINE 80:        sm.ivend = st.ivend;
                                   ^


[2016-02-16 11:43:32.830] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:44:04.732] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:44:04.853] [008199] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20160114'::date ivend,
          ud.user_behavior_segment,
          '20160114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20160114' 
  and dss.status = 'Active';

drop table if exists tmp.sub_targets;

create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20160114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date;

drop table if exists tmp.video_views_master;


-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
create table tmp.video_views_master
as 
select sm.drupal_user_id,
    '20160114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    (select drupal_user_id,
        '20160114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20160114'
         group by sm.drupal_user_id) v1 ) v2
left join
     (select drupal_user_id,
        '20160214'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20160214'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id;
  
drop table if exists tmp.sfss;

create table tmp.sfss
as 
select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,1) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend;
        


[2016-02-16 11:44:05.533] [008199] [dwh-prod] [PGSQL]
ERROR:  missing FROM-clause entry for table "sm"
LINE 38: select sm.drupal_user_id,
                ^


[2016-02-16 11:44:05.551] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:44:35.629] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:44:35.742] [008199] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20160114'::date ivend,
          ud.user_behavior_segment,
          '20160114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20160114' 
  and dss.status = 'Active';

drop table if exists tmp.sub_targets;

create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20160114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date;

drop table if exists tmp.video_views_master;


-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
create table tmp.video_views_master
as 
select v2.drupal_user_id,
    '20160114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    (select drupal_user_id,
        '20160114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20160114'
         group by sm.drupal_user_id) v1 ) v2
left join
     (select drupal_user_id,
        '20160214'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20160214'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id;
  
drop table if exists tmp.sfss;

create table tmp.sfss
as 
select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,1) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend;
        


[2016-02-16 11:45:42.076] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:47:45.502] [026154] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'tmp'

[2016-02-16 11:47:45.503] [026154] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-16 11:47:46.099] [028779] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 11:47:46.472] [028779] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'tmp'

[2016-02-16 11:47:50.567] [028806] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 11:47:50.647] [028779] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'video_views_master' ORDER BY col.table_name, col.ordinal_position

[2016-02-16 11:47:50.751] [028779] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-16 11:47:51.136] [028779] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-16 11:47:51.376] [028779] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'video_views_master' AND conname IS NOT NULL

[2016-02-16 11:47:51.461] [028779] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'video_views_master' ORDER BY t.relname, i.oid

[2016-02-16 11:47:51.546] [028779] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'video_views_master' ORDER BY t.relname, c.conname, a.attnum

[2016-02-16 11:47:51.722] [028806] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."video_views_master" LIMIT 1000 OFFSET 0

[2016-02-16 11:47:51.968] [028806] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'video_views_master'

[2016-02-16 11:47:52.066] [028806] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134138

[2016-02-16 11:51:16.538] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:51:16.653] [008199] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_master;

create table tmp.sub_master
as
   select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20160114'::date ivend,
          ud.user_behavior_segment,
          '20160114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20160114' 
  and dss.status = 'Active';

drop table if exists tmp.sub_targets;

create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20160114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date;

drop table if exists tmp.video_views_master;


-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
create table tmp.video_views_master
as 
select sm .drupal_user_id,
    '20160114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20160114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20160114'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20160214'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20160214'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id;
  
drop table if exists tmp.sfss;

create table tmp.sfss
as 
select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,1) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend;
        


[2016-02-16 11:51:38.689] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:55:56.036] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 11:55:56.152] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151214'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151214'::date ivend,
          ud.user_behavior_segment,
          '20151214'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151214' 
  and dss.status = 'Active');

delete from tmp.sub_targets where ivend = '20151214'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151214'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151215'
    and cancel_date <= '20160114'
    and cancel_date <= paid_through_date);

delete from tmp.video_views_master where ivend = '20151214'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151214'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151214'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151214'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20160114'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20160114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id);
  
delete from tmp.sfss where ivend = '20151214'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,1) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend);
        


[2016-02-16 11:56:49.961] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:01:46.932] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:01:47.112] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151214'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151214'::date ivend,
          ud.user_behavior_segment,
          '20151214'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151214' 
  and dss.status = 'Active');

delete from tmp.sub_targets where ivend = '20151214'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151214'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151215'
    and cancel_date <= '20160114'
    and cancel_date <= paid_through_date);

delete from tmp.video_views_master where ivend = '20151214'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151214'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151214'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151214'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20160114'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20160114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151214');
  
delete from tmp.sfss where ivend = '20151214'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,1) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend)
where sm.ivend = '20151214');
        


[2016-02-16 12:01:47.250] [008199] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "where"
LINE 83: where sm.ivend = '20151214');
         ^


[2016-02-16 12:01:47.266] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:02:10.068] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:02:10.182] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151214'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151214'::date ivend,
          ud.user_behavior_segment,
          '20151214'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151214' 
  and dss.status = 'Active');

delete from tmp.sub_targets where ivend = '20151214'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151214'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151215'
    and cancel_date <= '20160114'
    and cancel_date <= paid_through_date);

delete from tmp.video_views_master where ivend = '20151214'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151214'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151214'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151214'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20160114'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20160114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151214');
  
delete from tmp.sfss where ivend = '20151214'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,1) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151214');
        


[2016-02-16 12:02:23.918] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:02:57.647] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:02:57.775] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151114'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151114'::date ivend,
          ud.user_behavior_segment,
          '20151114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151114' 
  and dss.status = 'Active');

delete from tmp.sub_targets where ivend = '20151114'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151115'
    and cancel_date <= '20151214'
    and cancel_date <= paid_through_date);

delete from tmp.video_views_master where ivend = '20151114'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151114'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20151214'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20151214'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151114');
  
delete from tmp.sfss where ivend = '20151114'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,1) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151114');
        


[2016-02-16 12:09:16.707] [003540] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 12:09:16.787] [003540] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-16 12:09:16.989] [003539] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 12:09:17.074] [003539] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-16 12:09:17.170] [003539] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-16 12:09:17.260] [003539] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-16 12:09:17.343] [003539] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-16 12:09:17.899] [003539] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-16 12:09:17.978] [003539] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-16 12:09:18.066] [003539] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-16 12:09:18.149] [003539] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-16 12:09:18.231] [003539] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-16 12:09:18.317] [003539] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-16 12:09:18.634] [003539] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-16 12:09:18.726] [003539] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-16 12:09:18.810] [003539] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-16 12:09:18.892] [003539] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-16 12:10:16.341] [003540] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:10:16.441] [003540] [dwh-prod] [PGSQL]
select pid, query from pg_stat_activity
WHERE state = 'active'


[2016-02-16 12:10:16.538] [003540] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:10:16.766] [003540] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 11283

[2016-02-16 12:10:32.563] [003540] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:10:32.663] [003540] [dwh-prod] [PGSQL]
select pid, query from pg_stat_activity
WHERE state = 'active'



SELECT pg_cancel_backend(8199);


[2016-02-16 12:10:32.750] [003540] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "SELECT"
LINE 6: SELECT pg_cancel_backend(8199);
        ^


[2016-02-16 12:10:32.759] [003540] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:10:46.375] [003540] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:10:46.470] [003540] [dwh-prod] [PGSQL]


[2016-02-16 12:10:46.557] [003540] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:11:20.779] [003540] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:11:20.896] [003540] [dwh-prod] [PGSQL]
select pid, query from pg_stat_activity
WHERE state = 'active'


[2016-02-16 12:11:20.989] [003540] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:11:21.224] [003540] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 11283

[2016-02-16 12:11:27.340] [003540] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:11:27.441] [003540] [dwh-prod] [PGSQL]
SELECT pg_cancel_backend(8199);


[2016-02-16 12:11:27.521] [008199] [dwh-prod] [PGSQL]
ERROR:  canceling statement due to user request


[2016-02-16 12:11:27.529] [003540] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:11:27.530] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:11:56.158] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:11:56.257] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151114'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151114'::date ivend,
          ud.user_behavior_segment,
          '20151114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151114' 
  and dss.status = 'Active');


[2016-02-16 12:11:56.992] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:12:37.429] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:12:37.533] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151114'::date;


[2016-02-16 12:12:37.717] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:12:49.467] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:12:49.564] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151115'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151115'::date ivend,
          ud.user_behavior_segment,
          '20151115'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151115' 
  and dss.status = 'Active');


[2016-02-16 12:12:50.528] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:13:23.610] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:13:23.718] [008199] [dwh-prod] [PGSQL]
select ivend, count(1)
from tmp.sub_master
group by ivend;


[2016-02-16 12:13:23.868] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:13:24.094] [008199] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-16 12:13:37.874] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:13:37.965] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151115'::date;


[2016-02-16 12:13:38.147] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:13:45.762] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:13:45.860] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151114'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151114'::date ivend,
          ud.user_behavior_segment,
          '20151114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151114' 
  and dss.status = 'Active');


[2016-02-16 12:13:46.560] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:14:10.585] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:14:10.680] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_targets where ivend = '20151114'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151115'
    and cancel_date <= '20151214'
    and cancel_date <= paid_through_date);


[2016-02-16 12:14:10.786] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:14:42.456] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:14:42.575] [008199] [dwh-prod] [PGSQL]
delete from tmp.video_views_master where ivend = '20151114'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151114'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20151214'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20151214'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151114');


[2016-02-16 12:14:56.258] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:15:06.310] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:15:06.408] [008199] [dwh-prod] [PGSQL]
delete from tmp.sfss where ivend = '20151114'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,1) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151114');


[2016-02-16 12:15:06.827] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:15:28.165] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:15:28.292] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151014'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151014'::date ivend,
          ud.user_behavior_segment,
          '20151014'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151014' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20151014'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151014'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151015'
    and cancel_date <= '20151114'
    and cancel_date <= paid_through_date);

delete from tmp.video_views_master where ivend = '20151014'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151014'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151014'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20151114'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20151114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151014');
  
delete from tmp.sfss where ivend = '20151014'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,1) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151014');
        


[2016-02-16 12:25:18.160] [003540] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:25:18.260] [003540] [dwh-prod] [PGSQL]
select pid, query from pg_stat_activity
WHERE state = 'active'


[2016-02-16 12:25:18.349] [003540] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:25:18.596] [003540] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 11283

[2016-02-16 12:25:28.334] [003540] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:25:28.428] [003540] [dwh-prod] [PGSQL]
SELECT pg_cancel_backend(8199);


[2016-02-16 12:25:28.511] [008199] [dwh-prod] [PGSQL]
ERROR:  canceling statement due to user request


[2016-02-16 12:25:28.520] [003540] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:25:28.521] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:25:28.952] [008199] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-16 12:26:12.149] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:26:12.246] [008199] [dwh-prod] [PGSQL]
select ivend, count(1)
from tmp.sub_targets
group by ivend;


[2016-02-16 12:26:12.339] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:26:12.567] [008199] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134153

[2016-02-16 12:26:56.082] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:26:56.188] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_targets where ivend = '20151014'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151014'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151015'
    and cancel_date <= '20151114'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;


[2016-02-16 12:26:56.304] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:26:56.554] [008199] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134153

[2016-02-16 12:27:31.206] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:27:31.317] [008199] [dwh-prod] [PGSQL]

delete from tmp.video_views_master where ivend = '20151014'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151014'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151014'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20151114'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20151114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151014');


[2016-02-16 12:27:31.459] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:27:45.128] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:27:45.227] [008199] [dwh-prod] [PGSQL]
select ivend, count(1)
from tmp.sub_master
group by ivend;


[2016-02-16 12:27:45.381] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:27:45.612] [008199] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-16 12:27:53.825] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:27:53.923] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151014'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151014'::date ivend,
          ud.user_behavior_segment,
          '20151014'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151014' 
  and dss.status = 'Active');


[2016-02-16 12:27:54.588] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:28:13.491] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:28:13.606] [008199] [dwh-prod] [PGSQL]
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151014'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151014'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20151114'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20151114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151014');


[2016-02-16 12:28:27.976] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:28:46.553] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:28:46.661] [008199] [dwh-prod] [PGSQL]
delete from tmp.sfss where ivend = '20151014'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,1) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151014');
        


[2016-02-16 12:28:47.116] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:29:10.767] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:29:10.867] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20150914'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20150914'::date ivend,
          ud.user_behavior_segment,
          '20150914'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150914' 
  and dss.status = 'Active');


[2016-02-16 12:29:48.210] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:30:09.073] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:30:09.171] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_targets where ivend = '20150914'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150914'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150915'
    and cancel_date <= '20150814'
    and cancel_date <= paid_through_date);


[2016-02-16 12:30:09.263] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:31:07.899] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:31:07.997] [008199] [dwh-prod] [PGSQL]
insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150914'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150915'
    and cancel_date <= '20151014'
    and cancel_date <= paid_through_date);


[2016-02-16 12:31:08.105] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:31:26.779] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:31:26.893] [008199] [dwh-prod] [PGSQL]
delete from tmp.video_views_master where ivend = '20150914'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20150914'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20150914'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20150914'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20151014'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20151014'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20150914');


[2016-02-16 12:31:42.214] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:32:02.495] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:32:03.120] [008199] [dwh-prod] [PGSQL]
delete from tmp.sfss where ivend = '20150914'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,1) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150914');


[2016-02-16 12:32:03.725] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:32:31.662] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:32:31.759] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20150814'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20150814'::date ivend,
          ud.user_behavior_segment,
          '20150814'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150814' 
  and dss.status = 'Active');


[2016-02-16 12:32:33.749] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:32:52.662] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:32:52.770] [008199] [dwh-prod] [PGSQL]
delete from tmp.sub_targets where ivend = '20150814'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150814'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150815'
    and cancel_date <= '20150914'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;


[2016-02-16 12:32:52.887] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:32:53.134] [008199] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134153

[2016-02-16 12:33:41.096] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:33:41.212] [008199] [dwh-prod] [PGSQL]
delete from tmp.video_views_master where ivend = '20150814'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20150814'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20150814'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20150814'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20150914'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           AND created_date <= '20150914'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20150814');


[2016-02-16 12:34:01.790] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:34:11.566] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:34:11.678] [008199] [dwh-prod] [PGSQL]
delete from tmp.sfss where ivend = '20150814'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,1) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150814');


[2016-02-16 12:34:12.232] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:44:25.953] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:44:26.060] [008199] [dwh-prod] [PGSQL]
  
delete from tmp.sfss where ivend = '20150814'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150814');


[2016-02-16 12:44:26.761] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:44:37.781] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:44:37.888] [008199] [dwh-prod] [PGSQL]
  
delete from tmp.sfss where ivend = '20150914'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150914');


[2016-02-16 12:44:38.532] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:44:46.117] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:44:46.224] [008199] [dwh-prod] [PGSQL]
  
delete from tmp.sfss where ivend = '20151014'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151014');


[2016-02-16 12:44:46.747] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:44:52.981] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:44:53.089] [008199] [dwh-prod] [PGSQL]
  
delete from tmp.sfss where ivend = '20151114'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151114');


[2016-02-16 12:44:53.649] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:45:00.430] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:45:00.542] [008199] [dwh-prod] [PGSQL]
  
delete from tmp.sfss where ivend = '20151214'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151214');


[2016-02-16 12:45:01.160] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:45:13.822] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 12:45:13.932] [008199] [dwh-prod] [PGSQL]
  
delete from tmp.sfss where ivend = '20160114'::date;

insert into tmp.sfss
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20160114');


[2016-02-16 12:45:14.629] [008199] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 14:19:36.819] [008199] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 14:19:36.820] [008199] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-16 14:19:37.415] [011840] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 14:19:37.497] [011840] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 14:19:37.601] [011840] [dwh-prod] [PGSQL]
rename tmp.sfss to tmp.sfss_bak;


[2016-02-16 14:19:37.684] [011840] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "rename"
LINE 1: rename tmp.sfss to tmp.sfss_bak;
        ^


[2016-02-16 14:19:37.696] [011840] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 14:20:02.291] [028779] [dwh-prod] [PGSQL]
ALTER TABLE "tmp"."sfss" RENAME TO "sfss_bak"

[2016-02-16 14:20:02.291] [028779] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-16 14:20:02.926] [012004] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 14:20:03.011] [012004] [dwh-prod] [PGSQL]
ALTER TABLE "tmp"."sfss" RENAME TO "sfss_bak"

[2016-02-16 14:20:33.608] [012004] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'tmp' AND c.relname = 'sfss_bak'

[2016-02-16 14:20:33.700] [012004] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'sfss_bak' ORDER BY col.table_name, col.ordinal_position

[2016-02-16 14:20:33.823] [012004] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-16 14:20:34.167] [012004] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-16 14:20:34.249] [012004] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'sfss_bak' AND conname IS NOT NULL

[2016-02-16 14:20:34.334] [012004] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'sfss_bak' ORDER BY t.relname, i.oid

[2016-02-16 14:20:34.421] [012004] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'sfss_bak' ORDER BY t.relname, c.conname, a.attnum

[2016-02-16 14:20:34.506] [012004] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-16 14:20:34.587] [012004] [dwh-prod] [PGSQL]
SELECT oid, collname FROM pg_collation

[2016-02-16 14:20:34.755] [012004] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS table_name, am.amname, i.indexrelid, i.indisunique, i.indisclustered, i.indisprimary, i.indkey, i.indclass, obj_description(indexrelid) , i.indnatts, pg_get_expr(indpred, indrelid, true) AS indconstraint, pa.rolname AS owner, ts.spcname, ci.reloptions, i.indoption, i.indcollation FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid LEFT JOIN pg_roles pa ON pa.oid = ci.relowner WHERE tns.nspname = 'tmp' AND ct.relname = 'sfss_bak' AND conname IS NULL ORDER BY ct.relname, ins.nspname, ci.relname

[2016-02-16 14:20:34.840] [012004] [dwh-prod] [PGSQL]
SELECT t.oid, (current_database())::information_schema.sql_identifier AS trigger_catalog, (n.nspname)::information_schema.sql_identifier AS trigger_schema, (t.tgname)::information_schema.sql_identifier AS trigger_name, (c.relname)::information_schema.sql_identifier AS trigger_table_name, (em.text)::information_schema.character_data AS event_manipulation, (current_database())::information_schema.sql_identifier AS event_object_catalog, (n.nspname)::information_schema.sql_identifier AS event_object_schema, (c.relname)::information_schema.sql_identifier AS event_object_table, (c.relkind)::information_schema.sql_identifier AS event_object_table_type, (nsp.nspname)::information_schema.sql_identifier AS constraint_referenced_table_schema, (cs.relname)::information_schema.sql_identifier AS constraint_referenced_table_name, (t.tgdeferrable) AS constraint_deferrable_identifier, (t.tginitdeferred) AS constraint_deferred_type, (NULL::information_schema.cardinal_number)::information_schema.cardinal_number AS action_order, (CASE WHEN pg_has_role(c.relowner, 'USAGE'::text) THEN (SELECT rm.m[1] AS m FROM regexp_matches(pg_get_triggerdef(t.oid), (E'.{35,} WHEN \\((.+)\\) EXECUTE PROCEDURE'::text)) rm(m) LIMIT 1) ELSE NULL::text END)::information_schema.character_data AS action_condition, (NULL::information_schema.character_data)::information_schema.character_data AS action_condition, ("substring"(pg_get_triggerdef(t.oid), ("position"("substring"(pg_get_triggerdef(t.oid), 48), 'EXECUTE PROCEDURE'::text) + 47)))::information_schema.character_data AS action_statement, (CASE WHEN (((t.tgtype)::integer & 1) = 1) THEN 'ROW'::text ELSE 'STATEMENT'::text END)::information_schema.character_data AS action_orientation, (CASE WHEN (((t.tgtype)::integer & 2) = 2) THEN 'BEFORE'::text ELSE 'AFTER'::text END)::information_schema.character_data AS condition_timing, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_old_table, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_new_table, (t.tgconstraint) AS constraint_identifier, tc.event_object_column, obj_description(t.oid) FROM pg_namespace n LEFT JOIN pg_class c ON (n.oid = c.relnamespace) INNER JOIN pg_trigger t ON (c.oid = t.tgrelid) LEFT JOIN information_schema.triggered_update_columns tc ON (tc.trigger_schema = n.nspname) AND (tc.trigger_name = t.tgname) AND (tc.event_object_schema = n.nspname) AND (tc.event_object_table = c.relname)LEFT JOIN pg_user u ON (c.relowner = u.usesysid) LEFT JOIN (((SELECT 4, 'INSERT' UNION ALL SELECT 8, 'DELETE') UNION ALL SELECT 16, 'UPDATE') UNION ALL SELECT 32, 'TRUNCATE') em(num, text) ON (((t.tgtype)::integer & em.num) <> 0) LEFT OUTER JOIN (SELECT oid, relnamespace, relname FROM pg_class) cs ON (t.tgconstrrelid = cs.oid) LEFT OUTER JOIN (SELECT oid, nspname FROM pg_namespace) nsp ON (cs.relnamespace = nsp.oid) WHERE true AND n.nspname = 'tmp' AND c.relname = 'sfss_bak' AND (not t.tgisinternal) ORDER BY c.relname, t.tgname

[2016-02-16 14:20:34.948] [012004] [dwh-prod] [PGSQL]
SELECT n.nspname AS rule_schema, c.relname, r.rulename, r.oid, r.ev_type, r.is_instead, pg_get_ruledef(r.oid) AS definition, obj_description(r.oid) AS comment FROM ((pg_rewrite r JOIN pg_class c ON ((c.oid = r.ev_class))) LEFT JOIN pg_namespace n ON ((n.oid = c.relnamespace))) WHERE (r.rulename <> '_RETURN'::name) AND (n.nspname='tmp') AND (c.relname='sfss_bak')

[2016-02-16 14:21:02.133] [011840] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 14:21:02.235] [011840] [dwh-prod] [PGSQL]
CREATE TABLE "tmp"."sfss" (
"id" identity,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


[2016-02-16 14:21:02.326] [011840] [dwh-prod] [PGSQL]
ERROR:  type "identity" does not exist
LINE 2: "id" identity,
             ^


[2016-02-16 14:21:02.348] [011840] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 14:21:18.929] [011840] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 14:21:19.033] [011840] [dwh-prod] [PGSQL]
CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


[2016-02-16 14:21:19.162] [011840] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 14:22:51.135] [011840] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 14:22:51.260] [011840] [dwh-prod] [PGSQL]
insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);


[2016-02-16 14:22:53.285] [011840] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 16:45:53.457] [012004] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common' AND c.relname = 'plan_d'

[2016-02-16 16:45:53.546] [012004] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'plan_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-16 16:45:53.651] [012004] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-16 16:45:54.051] [012004] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-16 16:45:54.157] [012004] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'plan_d' AND conname IS NOT NULL

[2016-02-16 16:45:54.241] [012004] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'plan_d' ORDER BY t.relname, i.oid

[2016-02-16 16:45:54.330] [012004] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'plan_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-16 16:45:54.412] [012004] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-16 16:45:54.494] [012004] [dwh-prod] [PGSQL]
SELECT oid, collname FROM pg_collation

[2016-02-16 16:45:54.662] [012004] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS table_name, am.amname, i.indexrelid, i.indisunique, i.indisclustered, i.indisprimary, i.indkey, i.indclass, obj_description(indexrelid) , i.indnatts, pg_get_expr(indpred, indrelid, true) AS indconstraint, pa.rolname AS owner, ts.spcname, ci.reloptions, i.indoption, i.indcollation FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid LEFT JOIN pg_roles pa ON pa.oid = ci.relowner WHERE tns.nspname = 'common' AND ct.relname = 'plan_d' AND conname IS NULL ORDER BY ct.relname, ins.nspname, ci.relname

[2016-02-16 16:45:54.748] [012004] [dwh-prod] [PGSQL]
SELECT t.oid, (current_database())::information_schema.sql_identifier AS trigger_catalog, (n.nspname)::information_schema.sql_identifier AS trigger_schema, (t.tgname)::information_schema.sql_identifier AS trigger_name, (c.relname)::information_schema.sql_identifier AS trigger_table_name, (em.text)::information_schema.character_data AS event_manipulation, (current_database())::information_schema.sql_identifier AS event_object_catalog, (n.nspname)::information_schema.sql_identifier AS event_object_schema, (c.relname)::information_schema.sql_identifier AS event_object_table, (c.relkind)::information_schema.sql_identifier AS event_object_table_type, (nsp.nspname)::information_schema.sql_identifier AS constraint_referenced_table_schema, (cs.relname)::information_schema.sql_identifier AS constraint_referenced_table_name, (t.tgdeferrable) AS constraint_deferrable_identifier, (t.tginitdeferred) AS constraint_deferred_type, (NULL::information_schema.cardinal_number)::information_schema.cardinal_number AS action_order, (CASE WHEN pg_has_role(c.relowner, 'USAGE'::text) THEN (SELECT rm.m[1] AS m FROM regexp_matches(pg_get_triggerdef(t.oid), (E'.{35,} WHEN \\((.+)\\) EXECUTE PROCEDURE'::text)) rm(m) LIMIT 1) ELSE NULL::text END)::information_schema.character_data AS action_condition, (NULL::information_schema.character_data)::information_schema.character_data AS action_condition, ("substring"(pg_get_triggerdef(t.oid), ("position"("substring"(pg_get_triggerdef(t.oid), 48), 'EXECUTE PROCEDURE'::text) + 47)))::information_schema.character_data AS action_statement, (CASE WHEN (((t.tgtype)::integer & 1) = 1) THEN 'ROW'::text ELSE 'STATEMENT'::text END)::information_schema.character_data AS action_orientation, (CASE WHEN (((t.tgtype)::integer & 2) = 2) THEN 'BEFORE'::text ELSE 'AFTER'::text END)::information_schema.character_data AS condition_timing, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_old_table, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_new_table, (t.tgconstraint) AS constraint_identifier, tc.event_object_column, obj_description(t.oid) FROM pg_namespace n LEFT JOIN pg_class c ON (n.oid = c.relnamespace) INNER JOIN pg_trigger t ON (c.oid = t.tgrelid) LEFT JOIN information_schema.triggered_update_columns tc ON (tc.trigger_schema = n.nspname) AND (tc.trigger_name = t.tgname) AND (tc.event_object_schema = n.nspname) AND (tc.event_object_table = c.relname)LEFT JOIN pg_user u ON (c.relowner = u.usesysid) LEFT JOIN (((SELECT 4, 'INSERT' UNION ALL SELECT 8, 'DELETE') UNION ALL SELECT 16, 'UPDATE') UNION ALL SELECT 32, 'TRUNCATE') em(num, text) ON (((t.tgtype)::integer & em.num) <> 0) LEFT OUTER JOIN (SELECT oid, relnamespace, relname FROM pg_class) cs ON (t.tgconstrrelid = cs.oid) LEFT OUTER JOIN (SELECT oid, nspname FROM pg_namespace) nsp ON (cs.relnamespace = nsp.oid) WHERE true AND n.nspname = 'common' AND c.relname = 'plan_d' AND (not t.tgisinternal) ORDER BY c.relname, t.tgname

[2016-02-16 16:45:54.835] [012004] [dwh-prod] [PGSQL]
SELECT n.nspname AS rule_schema, c.relname, r.rulename, r.oid, r.ev_type, r.is_instead, pg_get_ruledef(r.oid) AS definition, obj_description(r.oid) AS comment FROM ((pg_rewrite r JOIN pg_class c ON ((c.oid = r.ev_class))) LEFT JOIN pg_namespace n ON ((n.oid = c.relnamespace))) WHERE (r.rulename <> '_RETURN'::name) AND (n.nspname='common') AND (c.relname='plan_d')

[2016-02-16 16:46:03.191] [024796] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 16:46:03.276] [012004] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'plan_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-16 16:46:03.379] [012004] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-16 16:46:03.826] [012004] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-16 16:46:03.910] [012004] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'plan_d' AND conname IS NOT NULL

[2016-02-16 16:46:03.993] [012004] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'plan_d' ORDER BY t.relname, i.oid

[2016-02-16 16:46:04.086] [012004] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'plan_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-16 16:46:04.296] [024796] [dwh-prod] [PGSQL]
SELECT * FROM "common"."plan_d" LIMIT 1000 OFFSET 0

[2016-02-16 16:46:04.466] [024796] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'plan_d'

[2016-02-16 16:46:04.583] [024796] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6133980

[2016-02-16 16:48:25.223] [024796] [dwh-prod] [PGSQL]
SELECT * FROM "common"."plan_d" ORDER BY "plan_name" LIMIT 1000 OFFSET 0

[2016-02-16 16:48:25.397] [024796] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'plan_d'

[2016-02-16 16:48:25.490] [024796] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6133980

[2016-02-16 17:02:41.508] [005788] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 17:02:41.508] [005788] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-16 17:02:42.090] [029869] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-16 17:02:42.169] [029869] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-16 17:02:42.284] [029869] [dwh-prod] [PGSQL]
select subscription_months, churner, count(1) from 
(select subscription_id,
   subscription_age,
   trunc(subscription_age/30) subscription_months,
   churner
from
(SELECT
   subscription_id,
   case when cancel_date is null then current_date::date - start_date::date
        else cancel_date::date - start_date::date
    end subscription_age,
   case when cancel_date is null then 0 else 1 end churner
   from common.subscription_d sd
   join common.plan_d pd
     on sd.dwh_plan_id = pd.dwh_plan_id AND
        pd.plan_period = '1 mon'::interval
   where cancel_date  >= '20150101' or cancel_date is null)foo
) bar
group by subscription_months, churner;


[2016-02-16 17:02:42.613] [029869] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 12:42:57.641] [026808] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 12:42:57.724] [026808] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-17 12:42:58.013] [026809] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 12:42:58.094] [026809] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-17 12:42:58.194] [026809] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-17 12:42:58.283] [026809] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-17 12:42:58.364] [026809] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-17 12:42:58.876] [026809] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-17 12:42:58.956] [026809] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-17 12:42:59.042] [026809] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-17 12:42:59.125] [026809] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-17 12:42:59.206] [026809] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-17 12:42:59.286] [026809] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-17 12:42:59.561] [026809] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-17 12:42:59.640] [026809] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-17 12:42:59.723] [026809] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-17 12:42:59.806] [026809] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-17 12:45:35.363] [027612] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 12:45:35.444] [027612] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-17 12:45:35.724] [027611] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 12:45:35.803] [027611] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-17 12:45:35.902] [027611] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-17 12:45:35.997] [027611] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-17 12:45:36.079] [027611] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-17 12:45:36.599] [027611] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-17 12:45:36.679] [027611] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-17 12:45:36.765] [027611] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-17 12:45:36.848] [027611] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-17 12:45:36.932] [027611] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-17 12:45:37.014] [027611] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-17 12:45:37.294] [027611] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-17 12:45:37.373] [027611] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-17 12:45:37.456] [027611] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-17 12:45:37.539] [027611] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-17 12:45:42.605] [027633] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 12:45:42.684] [027633] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-17 12:45:42.794] [027633] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-17 12:45:42.875] [027633] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-17 12:45:43.389] [027633] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-17 12:45:43.469] [027633] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-17 12:45:43.558] [027633] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-17 12:47:18.324] [028151] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 12:47:18.404] [028151] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='sfss' ORDER BY ordinal_position

[2016-02-17 12:47:19.078] [028159] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 12:47:19.159] [028159] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-17 12:47:19.262] [028159] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-17 12:47:19.348] [028159] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-17 12:47:19.867] [028159] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-17 12:47:19.947] [028159] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-17 12:47:20.036] [028159] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-17 12:47:20.707] [028167] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 12:47:20.789] [028167] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_daily_cube' ORDER BY ordinal_position

[2016-02-17 12:47:21.469] [028168] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 12:47:21.548] [028168] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_d' ORDER BY ordinal_position

[2016-02-17 12:54:18.643] [027612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 12:54:18.780] [027612] [dwh-prod] [PGSQL]
drop table if exists tmp.st395_video;

create table tmp.st395_video as
(select sf.drupal_user_id,
        vdc.media_nid,
				vdc.extra_nid,
        vdc.created_date, 
        vdc.player_name,
        coalesce(vdc.watched,0) watched,
        coalesce(vdc.num_views,0) num_views,
        vdc.engagement_ratio completion_ratio,
           case when engagement_ratio >= .25 then 1 else 0 end engaged_view,
    v.title,
    v.series_title,
    v.episode,
    v.duration, 
    v.reporting_segment
from tmp.sfss sf
left join common.video_daily_cube vdc
   on sf.drupal_user_id = vdc.user_id and 
      vdc.created_date > '2015-01-01'::date
left join common.video_d v on vdc.media_nid = v.media_nid
where sf.ivend = '2016-01-14'
  and sf.user_behavior_segment = 'Seeking Truth'
  and sf.subscription_age >= 395;

drop table if exists tmp.st395_video_cube;

create table tmp.st395_video_cube as 
select
    drupal_user_id,
    engaged_view,  
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       engaged_view,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched,
    from
        (select un. drupal_user_id,
           nv.created_date,
           nv.num_views, 
           nv.watched, 
           nv.completion_ratio,
           case when completion_ratio >= .25 then 1 else 0 end engaged_view,
           nv.duration,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration    
        from tmp.st395_video nv  ) v   
    group by drupal_user_id, engaged_view) vxc;


[2016-02-17 12:54:18.949] [027612] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near ";"
LINE 25:   and sf.subscription_age >= 395;
                                         ^


[2016-02-17 12:54:18.970] [027612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 12:54:40.495] [027612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 12:54:40.616] [027612] [dwh-prod] [PGSQL]
drop table if exists tmp.st395_video;

create table tmp.st395_video as
(select sf.drupal_user_id,
        vdc.media_nid,
				vdc.extra_nid,
        vdc.created_date, 
        vdc.player_name,
        coalesce(vdc.watched,0) watched,
        coalesce(vdc.num_views,0) num_views,
        vdc.engagement_ratio completion_ratio,
           case when engagement_ratio >= .25 then 1 else 0 end engaged_view,
    v.title,
    v.series_title,
    v.episode,
    v.duration, 
    v.reporting_segment
from tmp.sfss sf
left join common.video_daily_cube vdc
   on sf.drupal_user_id = vdc.user_id and 
      vdc.created_date > '2015-01-01'::date
left join common.video_d v on vdc.media_nid = v.media_nid
where sf.ivend = '2016-01-14'
  and sf.user_behavior_segment = 'Seeking Truth'
  and sf.subscription_age >= 395);

drop table if exists tmp.st395_video_cube;

create table tmp.st395_video_cube as 
select
    drupal_user_id,
    engaged_view,  
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       engaged_view,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched,
    from
        (select un. drupal_user_id,
           nv.created_date,
           nv.num_views, 
           nv.watched, 
           nv.completion_ratio,
           case when completion_ratio >= .25 then 1 else 0 end engaged_view,
           nv.duration,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration    
        from tmp.st395_video nv  ) v   
    group by drupal_user_id, engaged_view) vxc;


[2016-02-17 12:54:40.698] [027612] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "from"
LINE 74:     from
             ^


[2016-02-17 12:54:40.716] [027612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 12:55:30.340] [027612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 12:55:30.459] [027612] [dwh-prod] [PGSQL]
drop table if exists tmp.st395_video;

create table tmp.st395_video as
(select sf.drupal_user_id,
        vdc.media_nid,
				vdc.extra_nid,
        vdc.created_date, 
        vdc.player_name,
        coalesce(vdc.watched,0) watched,
        coalesce(vdc.num_views,0) num_views,
        vdc.engagement_ratio completion_ratio,
           case when engagement_ratio >= .25 then 1 else 0 end engaged_view,
    v.title,
    v.series_title,
    v.episode,
    v.duration, 
    v.reporting_segment
from tmp.sfss sf
left join common.video_daily_cube vdc
   on sf.drupal_user_id = vdc.user_id and 
      vdc.created_date > '2015-01-01'::date
left join common.video_d v on vdc.media_nid = v.media_nid
where sf.ivend = '2016-01-14'
  and sf.user_behavior_segment = 'Seeking Truth'
  and sf.subscription_age >= 395);

drop table if exists tmp.st395_video_cube;

create table tmp.st395_video_cube as 
select
    drupal_user_id,
    engaged_view,  
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       engaged_view,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched
    from
        (select un. drupal_user_id,
           nv.created_date,
           nv.num_views, 
           nv.watched, 
           nv.completion_ratio,
           case when completion_ratio >= .25 then 1 else 0 end engaged_view,
           nv.duration,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration    
        from tmp.st395_video nv  ) v   
    group by drupal_user_id, engaged_view) vxc;


[2016-02-17 12:56:45.159] [027612] [dwh-prod] [PGSQL]
ERROR:  missing FROM-clause entry for table "un"
LINE 75:         (select un. drupal_user_id,
                         ^


[2016-02-17 12:56:45.425] [027612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:02:18.091] [027612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:02:18.205] [027612] [dwh-prod] [PGSQL]
drop table if exists tmp.st395_video;

create table tmp.st395_video as
(select sf.drupal_user_id,
        vdc.media_nid,
				vdc.extra_nid,
        vdc.created_date, 
        vdc.player_name,
        coalesce(vdc.watched,0) watched,
        coalesce(vdc.num_views,0) num_views,
        vdc.engagement_ratio completion_ratio,
           case when engagement_ratio >= .25 then 1 else 0 end engaged_view,
    v.title,
    v.series_title,
    v.episode,
    v.duration, 
    v.reporting_segment
from tmp.sfss sf
left join common.video_daily_cube vdc
   on sf.drupal_user_id = vdc.user_id and 
      vdc.created_date > '2015-01-01'::date
left join common.video_d v on vdc.media_nid = v.media_nid
where sf.ivend = '2016-01-14'
  and sf.user_behavior_segment = 'Seeking Truth'
  and sf.subscription_age >= 395);

drop table if exists tmp.st395_video_cube;

create table tmp.st395_video_cube as 
select
    drupal_user_id,
    engaged_view,  
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       engaged_view,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched
    from
        (select nv. drupal_user_id,
           nv.created_date,
           nv.num_views, 
           nv.watched, 
           nv.completion_ratio,
           case when completion_ratio >= .25 then 1 else 0 end engaged_view,
           nv.duration,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration    
        from tmp.st395_video nv  ) v   
    group by drupal_user_id, engaged_view) vxc;


[2016-02-17 13:02:51.422] [027612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:04:28.408] [004466] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 13:04:28.490] [004466] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-17 13:04:28.600] [004466] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-17 13:04:28.683] [004466] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-17 13:04:29.205] [004466] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-17 13:04:29.296] [004466] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-17 13:04:29.386] [004466] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-17 13:04:30.060] [004474] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 13:04:30.140] [004474] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='sfss' ORDER BY ordinal_position

[2016-02-17 13:05:14.036] [029869] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:05:14.037] [029869] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-17 13:05:14.618] [004920] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 13:05:14.698] [004920] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:05:14.820] [004920] [dwh-prod] [PGSQL]
select count(1) from tmp.sfss
where sf.ivend = '2016-01-14'
  and sf.user_behavior_segment = 'Seeking Truth'
  and sf.subscription_age >= 395);


[2016-02-17 13:05:14.900] [004920] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near ")"
LINE 4:   and sf.subscription_age >= 395);
                                        ^


[2016-02-17 13:05:14.912] [004920] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:05:28.976] [004920] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:05:29.078] [004920] [dwh-prod] [PGSQL]
select count(1) from tmp.sfss sf
where sf.ivend = '2016-01-14'
  and sf.user_behavior_segment = 'Seeking Truth'
  and sf.subscription_age >= 395;


[2016-02-17 13:05:29.342] [004920] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:13:07.354] [007465] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 13:13:07.433] [007465] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='daily_status_snapshot' ORDER BY ordinal_position

[2016-02-17 13:13:08.099] [007466] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 13:13:08.178] [007466] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='user_dim' ORDER BY ordinal_position

[2016-02-17 13:13:08.860] [007468] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 13:13:08.939] [007468] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='subscription_d' ORDER BY ordinal_position

[2016-02-17 13:18:10.271] [009020] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 13:18:10.381] [009020] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-17 13:18:10.486] [009020] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-17 13:18:10.571] [009020] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-17 13:18:11.572] [009020] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-17 13:18:11.654] [009020] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-17 13:18:11.743] [009020] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-17 13:18:23.905] [004920] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:18:24.012] [004920] [dwh-prod] [PGSQL]
select * from common.user_dim limit 1;


[2016-02-17 13:18:24.119] [004920] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:18:24.485] [004920] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6152990

[2016-02-17 13:19:56.133] [004920] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:19:56.236] [004920] [dwh-prod] [PGSQL]
select * from common.campaign_tracking limit 1;


[2016-02-17 13:19:56.678] [004920] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:19:56.991] [004920] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4507261

[2016-02-17 13:21:41.424] [010081] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 13:21:41.505] [010081] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='campaign_tracking' ORDER BY ordinal_position

[2016-02-17 13:22:52.472] [027612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:22:52.591] [027612] [dwh-prod] [PGSQL]
drop table if exists tmp.st395_sub_master;

create table tmp.st395_sub_master as 
select subscription_id, 
       gcsi_user_id,
       drupal_user_id,
       subscription_age,
       acquisition_channel,
       ct.department marketing_channel
from 
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          ud.user_behavior_segment,
					ud.acquisition_channel,
          '20160114'::date - sd.start_date::date subscription_age
   from common.daily_status_snapshot dss 
   join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
   join common.subscription_d sd on dss.subscription_id = sd.subscription_id
   where dss.day_timestamp = '20160114'
     and dss.paid_through_date >=  '20160114') foo
left join common.campaign_tracking ct
   on foo.acquisition_channel = ct.reported_channel
where user_behavior_segment = 'Seeking Truth'
  and subscription_age >=395;


drop table if exists tmp.st395_video;

create table tmp.st395_video as
(select sf.drupal_user_id,
        vdc.media_nid,
				vdc.extra_nid,
        vdc.created_date, 
        vdc.player_name,
        coalesce(vdc.watched,0) watched,
        coalesce(vdc.num_views,0) num_views,
        vdc.engagement_ratio completion_ratio,
           case when engagement_ratio >= .25 then 1 else 0 end engaged_view,
    v.title,
    v.series_title,
    v.episode,
    v.duration, 
    v.reporting_segment
from tmp.sfss sf
left join common.video_daily_cube vdc
   on sf.drupal_user_id = vdc.user_id and 
      vdc.created_date > '2015-01-01'::date
left join common.video_d v on vdc.media_nid = v.media_nid
where sf.ivend = '2016-01-14'
  and sf.user_behavior_segment = 'Seeking Truth'
  and sf.subscription_age >= 395);

drop table if exists tmp.st395_video_cube;

create table tmp.st395_video_cube as 
select
    drupal_user_id,
    engaged_view,  
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       engaged_view,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched
    from
        (select nv. drupal_user_id,
           nv.created_date,
           nv.num_views, 
           nv.watched, 
           nv.completion_ratio,
           case when completion_ratio >= .25 then 1 else 0 end engaged_view,
           nv.duration,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration    
        from tmp.st395_video nv  ) v   
    group by drupal_user_id, engaged_view) vxc;

select count(1), from tmp.tmp.st395_video_cube


[2016-02-17 13:22:52.671] [027612] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "from"
LINE 121: select count(1), from tmp.tmp.st395_video_cube
                           ^


[2016-02-17 13:22:52.691] [027612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:23:05.020] [027612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:23:05.138] [027612] [dwh-prod] [PGSQL]
drop table if exists tmp.st395_sub_master;

create table tmp.st395_sub_master as 
select subscription_id, 
       gcsi_user_id,
       drupal_user_id,
       subscription_age,
       acquisition_channel,
       ct.department marketing_channel
from 
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          ud.user_behavior_segment,
					ud.acquisition_channel,
          '20160114'::date - sd.start_date::date subscription_age
   from common.daily_status_snapshot dss 
   join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
   join common.subscription_d sd on dss.subscription_id = sd.subscription_id
   where dss.day_timestamp = '20160114'
     and dss.paid_through_date >=  '20160114') foo
left join common.campaign_tracking ct
   on foo.acquisition_channel = ct.reported_channel
where user_behavior_segment = 'Seeking Truth'
  and subscription_age >=395;


drop table if exists tmp.st395_video;

create table tmp.st395_video as
(select sf.drupal_user_id,
        vdc.media_nid,
				vdc.extra_nid,
        vdc.created_date, 
        vdc.player_name,
        coalesce(vdc.watched,0) watched,
        coalesce(vdc.num_views,0) num_views,
        vdc.engagement_ratio completion_ratio,
           case when engagement_ratio >= .25 then 1 else 0 end engaged_view,
    v.title,
    v.series_title,
    v.episode,
    v.duration, 
    v.reporting_segment
from tmp.sfss sf
left join common.video_daily_cube vdc
   on sf.drupal_user_id = vdc.user_id and 
      vdc.created_date > '2015-01-01'::date
left join common.video_d v on vdc.media_nid = v.media_nid
where sf.ivend = '2016-01-14'
  and sf.user_behavior_segment = 'Seeking Truth'
  and sf.subscription_age >= 395);

drop table if exists tmp.st395_video_cube;

create table tmp.st395_video_cube as 
select
    drupal_user_id,
    engaged_view,  
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       engaged_view,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched
    from
        (select nv. drupal_user_id,
           nv.created_date,
           nv.num_views, 
           nv.watched, 
           nv.completion_ratio,
           case when completion_ratio >= .25 then 1 else 0 end engaged_view,
           nv.duration,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration    
        from tmp.st395_video nv  ) v   
    group by drupal_user_id, engaged_view) vxc;




[2016-02-17 13:23:39.541] [027612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:34:17.932] [027612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:34:18.046] [027612] [dwh-prod] [PGSQL]
drop table if exists tmp.st395_sub_master;

create table tmp.st395_sub_master as 
select subscription_id, 
       gcsi_user_id,
       drupal_user_id,
       subscription_age,
       acquisition_channel,
       ct.department marketing_channel,
       case when dss2.paid_through_date::date >= '20160115' and 
                 dss2.paid_through_date::date <= '20160214' and
                 dss2.status <> 'Hold'
            then 1
            else 0
       end churner
from 
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          ud.user_behavior_segment,
					ud.acquisition_channel,
          '20160114'::date - sd.start_date::date subscription_age
   from common.daily_status_snapshot dss 
   join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
   join common.subscription_d sd on dss.subscription_id = sd.subscription_id
   where dss.day_timestamp = '20160114'
     and dss.paid_through_date >=  '20160114') foo
   left join common.daily_status_snapshot dss2 
      on foo.subscription_id = dss2.subscription_id and 
         dss2.dss.day_timestamp = '20160214'
left join common.campaign_tracking ct
   on foo.acquisition_channel = ct.reported_channel
where user_behavior_segment = 'Seeking Truth'
  and subscription_age >=395;


drop table if exists tmp.st395_video;

create table tmp.st395_video as
(select sf.drupal_user_id,
        vdc.media_nid,
				vdc.extra_nid,
        vdc.created_date, 
        vdc.player_name,
        coalesce(vdc.watched,0) watched,
        coalesce(vdc.num_views,0) num_views,
        vdc.engagement_ratio completion_ratio,
           case when engagement_ratio >= .25 then 1 else 0 end engaged_view,
    v.title,
    v.series_title,
    v.episode,
    v.duration, 
    v.reporting_segment
from tmp.st395 sf
left join common.video_daily_cube vdc
   on sf.drupal_user_id = vdc.user_id and 
      vdc.created_date > '2015-01-01'::date
left join common.video_d v on vdc.media_nid = v.media_nid);

drop table if exists tmp.st395_video_cube;

create table tmp.st395_video_cube as 
select
    drupal_user_id,
    engaged_view,  
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       engaged_view,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched
    from
        (select nv. drupal_user_id,
           nv.created_date,
           nv.num_views, 
           nv.watched, 
           nv.completion_ratio,
           case when completion_ratio >= .25 then 1 else 0 end engaged_view,
           nv.duration,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration    
        from tmp.st395_video nv  ) v   
    group by drupal_user_id, engaged_view) vxc;




[2016-02-17 13:34:18.132] [027612] [dwh-prod] [PGSQL]
ERROR:  missing FROM-clause entry for table "dss"
LINE 30:          dss2.dss.day_timestamp = '20160214'
                  ^


[2016-02-17 13:34:18.154] [027612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:34:45.010] [027612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:34:45.124] [027612] [dwh-prod] [PGSQL]
drop table if exists tmp.st395_sub_master;

create table tmp.st395_sub_master as 
select subscription_id, 
       gcsi_user_id,
       drupal_user_id,
       subscription_age,
       acquisition_channel,
       ct.department marketing_channel,
       case when dss2.paid_through_date::date >= '20160115' and 
                 dss2.paid_through_date::date <= '20160214' and
                 dss2.status <> 'Hold'
            then 1
            else 0
       end churner
from 
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          ud.user_behavior_segment,
					ud.acquisition_channel,
          '20160114'::date - sd.start_date::date subscription_age
   from common.daily_status_snapshot dss 
   join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
   join common.subscription_d sd on dss.subscription_id = sd.subscription_id
   where dss.day_timestamp = '20160114'
     and dss.paid_through_date >=  '20160114') foo
   left join common.daily_status_snapshot dss2 
      on foo.subscription_id = dss2.subscription_id and 
         dss2.day_timestamp = '20160214'
left join common.campaign_tracking ct
   on foo.acquisition_channel = ct.reported_channel
where user_behavior_segment = 'Seeking Truth'
  and subscription_age >=395;


drop table if exists tmp.st395_video;

create table tmp.st395_video as
(select sf.drupal_user_id,
        vdc.media_nid,
				vdc.extra_nid,
        vdc.created_date, 
        vdc.player_name,
        coalesce(vdc.watched,0) watched,
        coalesce(vdc.num_views,0) num_views,
        vdc.engagement_ratio completion_ratio,
           case when engagement_ratio >= .25 then 1 else 0 end engaged_view,
    v.title,
    v.series_title,
    v.episode,
    v.duration, 
    v.reporting_segment
from tmp.st395 sf
left join common.video_daily_cube vdc
   on sf.drupal_user_id = vdc.user_id and 
      vdc.created_date > '2015-01-01'::date
left join common.video_d v on vdc.media_nid = v.media_nid);

drop table if exists tmp.st395_video_cube;

create table tmp.st395_video_cube as 
select
    drupal_user_id,
    engaged_view,  
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       engaged_view,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched
    from
        (select nv. drupal_user_id,
           nv.created_date,
           nv.num_views, 
           nv.watched, 
           nv.completion_ratio,
           case when completion_ratio >= .25 then 1 else 0 end engaged_view,
           nv.duration,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration    
        from tmp.st395_video nv  ) v   
    group by drupal_user_id, engaged_view) vxc;




[2016-02-17 13:34:45.209] [027612] [dwh-prod] [PGSQL]
ERROR:  column reference "subscription_id" is ambiguous
LINE 4: select subscription_id, 
               ^


[2016-02-17 13:34:45.227] [027612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:35:00.374] [027612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:35:00.492] [027612] [dwh-prod] [PGSQL]
drop table if exists tmp.st395_sub_master;

create table tmp.st395_sub_master as 
select foo.subscription_id, 
       gcsi_user_id,
       drupal_user_id,
       subscription_age,
       acquisition_channel,
       ct.department marketing_channel,
       case when dss2.paid_through_date::date >= '20160115' and 
                 dss2.paid_through_date::date <= '20160214' and
                 dss2.status <> 'Hold'
            then 1
            else 0
       end churner
from 
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          ud.user_behavior_segment,
					ud.acquisition_channel,
          '20160114'::date - sd.start_date::date subscription_age
   from common.daily_status_snapshot dss 
   join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
   join common.subscription_d sd on dss.subscription_id = sd.subscription_id
   where dss.day_timestamp = '20160114'
     and dss.paid_through_date >=  '20160114') foo
   left join common.daily_status_snapshot dss2 
      on foo.subscription_id = dss2.subscription_id and 
         dss2.day_timestamp = '20160214'
left join common.campaign_tracking ct
   on foo.acquisition_channel = ct.reported_channel
where user_behavior_segment = 'Seeking Truth'
  and subscription_age >=395;


drop table if exists tmp.st395_video;

create table tmp.st395_video as
(select sf.drupal_user_id,
        vdc.media_nid,
				vdc.extra_nid,
        vdc.created_date, 
        vdc.player_name,
        coalesce(vdc.watched,0) watched,
        coalesce(vdc.num_views,0) num_views,
        vdc.engagement_ratio completion_ratio,
           case when engagement_ratio >= .25 then 1 else 0 end engaged_view,
    v.title,
    v.series_title,
    v.episode,
    v.duration, 
    v.reporting_segment
from tmp.st395 sf
left join common.video_daily_cube vdc
   on sf.drupal_user_id = vdc.user_id and 
      vdc.created_date > '2015-01-01'::date
left join common.video_d v on vdc.media_nid = v.media_nid);

drop table if exists tmp.st395_video_cube;

create table tmp.st395_video_cube as 
select
    drupal_user_id,
    engaged_view,  
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       engaged_view,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched
    from
        (select nv. drupal_user_id,
           nv.created_date,
           nv.num_views, 
           nv.watched, 
           nv.completion_ratio,
           case when completion_ratio >= .25 then 1 else 0 end engaged_view,
           nv.duration,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration    
        from tmp.st395_video nv  ) v   
    group by drupal_user_id, engaged_view) vxc;




[2016-02-17 13:35:00.574] [027612] [dwh-prod] [PGSQL]
ERROR:  column reference "gcsi_user_id" is ambiguous
LINE 5:        gcsi_user_id,
               ^


[2016-02-17 13:35:00.598] [027612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:35:07.685] [027612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:35:07.801] [027612] [dwh-prod] [PGSQL]
drop table if exists tmp.st395_sub_master;

create table tmp.st395_sub_master as 
select foo.subscription_id, 
       foo.gcsi_user_id,
       drupal_user_id,
       subscription_age,
       acquisition_channel,
       ct.department marketing_channel,
       case when dss2.paid_through_date::date >= '20160115' and 
                 dss2.paid_through_date::date <= '20160214' and
                 dss2.status <> 'Hold'
            then 1
            else 0
       end churner
from 
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          ud.user_behavior_segment,
					ud.acquisition_channel,
          '20160114'::date - sd.start_date::date subscription_age
   from common.daily_status_snapshot dss 
   join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
   join common.subscription_d sd on dss.subscription_id = sd.subscription_id
   where dss.day_timestamp = '20160114'
     and dss.paid_through_date >=  '20160114') foo
   left join common.daily_status_snapshot dss2 
      on foo.subscription_id = dss2.subscription_id and 
         dss2.day_timestamp = '20160214'
left join common.campaign_tracking ct
   on foo.acquisition_channel = ct.reported_channel
where user_behavior_segment = 'Seeking Truth'
  and subscription_age >=395;


drop table if exists tmp.st395_video;

create table tmp.st395_video as
(select sf.drupal_user_id,
        vdc.media_nid,
				vdc.extra_nid,
        vdc.created_date, 
        vdc.player_name,
        coalesce(vdc.watched,0) watched,
        coalesce(vdc.num_views,0) num_views,
        vdc.engagement_ratio completion_ratio,
           case when engagement_ratio >= .25 then 1 else 0 end engaged_view,
    v.title,
    v.series_title,
    v.episode,
    v.duration, 
    v.reporting_segment
from tmp.st395 sf
left join common.video_daily_cube vdc
   on sf.drupal_user_id = vdc.user_id and 
      vdc.created_date > '2015-01-01'::date
left join common.video_d v on vdc.media_nid = v.media_nid);

drop table if exists tmp.st395_video_cube;

create table tmp.st395_video_cube as 
select
    drupal_user_id,
    engaged_view,  
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       engaged_view,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched
    from
        (select nv. drupal_user_id,
           nv.created_date,
           nv.num_views, 
           nv.watched, 
           nv.completion_ratio,
           case when completion_ratio >= .25 then 1 else 0 end engaged_view,
           nv.duration,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration    
        from tmp.st395_video nv  ) v   
    group by drupal_user_id, engaged_view) vxc;




[2016-02-17 13:35:08.348] [027612] [dwh-prod] [PGSQL]
ERROR:  relation "tmp.st395" does not exist
LINE 54: from tmp.st395 sf
              ^


[2016-02-17 13:35:08.374] [027612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:38:00.677] [027612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:38:00.799] [027612] [dwh-prod] [PGSQL]
drop table if exists tmp.st395_sub_master;

create table tmp.st395_sub_master as 
select foo.subscription_id, 
       foo.gcsi_user_id,
       drupal_user_id,
       subscription_age,
       acquisition_channel,
       ct.department marketing_channel,
       case when dss2.paid_through_date::date >= '20160115' and 
                 dss2.paid_through_date::date <= '20160214' and
                 dss2.status <> 'Hold'
            then 1
            else 0
       end churner
from 
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          ud.user_behavior_segment,
					ud.acquisition_channel,
          '20160114'::date - sd.start_date::date subscription_age
   from common.daily_status_snapshot dss 
   join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
   join common.subscription_d sd on dss.subscription_id = sd.subscription_id
   where dss.day_timestamp = '20160114'
     and dss.paid_through_date >=  '20160114') foo
   left join common.daily_status_snapshot dss2 
      on foo.subscription_id = dss2.subscription_id and 
         dss2.day_timestamp = '20160214'
left join common.campaign_tracking ct
   on foo.acquisition_channel = ct.reported_channel
where user_behavior_segment = 'Seeking Truth'
  and subscription_age >=395;


drop table if exists tmp.st395_video;

create table tmp.st395_video as
(select sf.drupal_user_id,
        vdc.media_nid,
				vdc.extra_nid,
        vdc.created_date, 
        vdc.player_name,
        coalesce(vdc.watched,0) watched,
        coalesce(vdc.num_views,0) num_views,
        vdc.engagement_ratio completion_ratio,
           case when engagement_ratio >= .25 then 1 else 0 end engaged_view,
    v.title,
    v.series_title,
    v.episode,
    v.duration, 
    v.reporting_segment
from tmp.st395_sub_master sf
left join common.video_daily_cube vdc
   on sf.drupal_user_id = vdc.user_id and 
      vdc.created_date > '2015-01-01'::date
left join common.video_d v on vdc.media_nid = v.media_nid);

drop table if exists tmp.st395_video_cube;

create table tmp.st395_video_cube as 
select
    drupal_user_id,
    engaged_view,  
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched
from
    (select drupal_user_id,
       engaged_view,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched
    from
        (select nv. drupal_user_id,
           nv.created_date,
           nv.num_views, 
           nv.watched, 
           nv.completion_ratio,
           case when completion_ratio >= .25 then 1 else 0 end engaged_view,
           nv.duration,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration    
        from tmp.st395_video nv  ) v   
    group by drupal_user_id, engaged_view) vxc;




[2016-02-17 13:38:32.360] [027612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:42:50.472] [027612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 13:42:50.573] [027612] [dwh-prod] [PGSQL]
select sum(churner) from tmp.st395_sub_master;


[2016-02-17 13:42:50.665] [027612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 14:17:42.876] [029455] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 14:17:42.956] [029455] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-17 14:17:43.227] [029454] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 14:17:43.308] [029454] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-17 14:17:43.405] [029454] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-17 14:17:43.497] [029454] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-17 14:17:43.585] [029454] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-17 14:17:44.126] [029454] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-17 14:17:44.209] [029454] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-17 14:17:44.297] [029454] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-17 14:17:44.387] [029454] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-17 14:17:44.667] [029454] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-17 14:17:44.749] [029454] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-17 14:17:45.532] [029454] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-17 14:17:46.223] [029454] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-17 14:17:46.308] [029454] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-17 14:17:46.394] [029454] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-17 14:18:18.340] [029659] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 14:18:18.420] [029659] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-17 14:18:18.686] [029658] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 14:18:18.769] [029658] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-17 14:18:18.866] [029658] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-17 14:18:18.956] [029658] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-17 14:18:19.039] [029658] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-17 14:18:19.561] [029658] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-17 14:18:19.642] [029658] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-17 14:18:19.745] [029658] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-17 14:18:19.830] [029658] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-17 14:18:19.914] [029658] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-17 14:18:19.997] [029658] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-17 14:18:20.276] [029658] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-17 14:18:20.358] [029658] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-17 14:18:20.450] [029658] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-17 14:18:20.534] [029658] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-17 14:19:45.692] [027612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 14:19:45.822] [027612] [dwh-prod] [PGSQL]
create table tmp.st395_video_series as
(select vdc.*,
    v.title,
    v.series_title,
    v.episode,
    case when v.series_title = 'Disclosure'
              then v.series_title || ' ' || season
         when v.series_title in ('Disclosure', 'Wisdom Teachings','Beyond Belief','Open Minds','Healing Matrix',
                   'Arcanum','Secrets to Health','Spirit Talk' ,'On the Road With Lilou' ,
                   'Eleventh House','Mind Shift','Inspirations', 'Cosmic Disclosure')
             then v.series_title
         when v.site_segment in('My Yoga', 'Spiritual Growth', 'Film & Series') then v.site_segment
         when series_title is null then 'Standalone'
         else 'Other ST Series'
    end series_of_interest
from common.video_daily_cube vdc
join common.video_d v on vdc.media_nid = v.media_nid
where vdc.created_date > '2015-01-01'::date);


[2016-02-17 14:20:58.979] [027612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 14:32:00.083] [027612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 14:32:00.194] [027612] [dwh-prod] [PGSQL]
drop table if exists  tmp.st395_video_series;
create table tmp.st395_video_series as
(select vdc.*,
    v.title,
    v.series_title,
    v.season,
    v.episode,
    case when v.series_title = 'Disclosure'
              then v.series_title || ' ' || season
         when v.series_title in ('Disclosure', 'Wisdom Teachings','Beyond Belief','Open Minds','Healing Matrix',
                   'Arcanum','Secrets to Health','Spirit Talk' ,'On the Road With Lilou' ,
                   'Eleventh House','Mind Shift','Inspirations', 'Cosmic Disclosure')
             then v.series_title
         when v.site_segment in('My Yoga', 'Spiritual Growth', 'Film & Series') then v.site_segment
         when series_title is null then 'Standalone'
         else 'Other ST Series'
    end series_of_interest
from common.video_daily_cube vdc
join common.video_d v on vdc.media_nid = v.media_nid
where vdc.created_date > '2015-01-01'::date);


[2016-02-17 14:33:16.988] [027612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-17 14:47:12.151] [015945] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 14:47:12.235] [012004] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'video_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-17 14:47:12.236] [012004] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-17 14:47:12.822] [015946] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-17 14:47:12.901] [015946] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'video_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-17 14:47:13.110] [015946] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-17 14:47:13.524] [015946] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-17 14:47:13.607] [015946] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'video_d' AND conname IS NOT NULL

[2016-02-17 14:47:13.690] [015946] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'video_d' ORDER BY t.relname, i.oid

[2016-02-17 14:47:13.779] [015946] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'video_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-17 14:47:13.973] [015945] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" LIMIT 1000 OFFSET 0

[2016-02-17 14:47:17.526] [015945] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-17 14:47:17.641] [015945] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6152921

[2016-02-17 14:48:43.440] [015945] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "series_title" LIKE '%Beyond Belief%' AND "season" >= '13' LIMIT 1000 OFFSET 0

[2016-02-17 14:48:43.558] [015945] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-17 14:48:43.661] [015945] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6152921

[2016-02-17 14:48:50.928] [015945] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "series_title" LIKE '%Beyond Belief%' LIMIT 1000 OFFSET 0

[2016-02-17 14:48:52.382] [015945] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-17 14:48:52.499] [015945] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6152921

[2016-02-17 15:02:49.385] [015945] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "series_title" LIKE '%Beyond Belief%' ORDER BY "season" LIMIT 1000 OFFSET 0

[2016-02-17 15:02:50.627] [015945] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-17 15:02:50.731] [015945] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6152921

[2016-02-17 15:03:53.116] [015945] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "series_title" LIKE '%Beyond Belief%' AND "feature" LIKE '%Feature%' ORDER BY "season" LIMIT 1000 OFFSET 0

[2016-02-17 15:03:53.934] [015945] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-17 15:03:54.043] [015945] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6152921

[2016-02-17 16:40:15.580] [015945] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "series_title" LIKE '%Open Minds%' AND "feature" LIKE '%Feature%' ORDER BY "season" LIMIT 1000 OFFSET 0

[2016-02-17 16:40:16.321] [015945] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-17 16:40:16.428] [015945] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6152921

[2016-02-17 16:51:20.355] [015945] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "series_title" LIKE '%Cosmic Disclosure%' AND "feature" LIKE '%Feature%' ORDER BY "season" LIMIT 1000 OFFSET 0

[2016-02-17 16:51:20.701] [015945] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-17 16:51:20.808] [015945] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6152921

[2016-02-18 10:47:13.925] [018674] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 10:47:14.027] [018674] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 10:47:14.131] [018674] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-18 10:47:14.219] [018674] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 10:47:14.736] [018674] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 10:47:14.816] [018674] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 10:47:14.917] [018674] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-18 10:48:58.254] [006798] [dwh-prod] [PGSQL]
SELECT oid, spcname, pg_get_userbyid(spcowner) AS owner, pg_tablespace_location(oid) As spclocation, spcacl, shobj_description(oid, 'pg_tablespace') AS comment FROM pg_tablespace

[2016-02-18 10:48:58.255] [006798] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-18 10:48:58.845] [019229] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 10:48:58.924] [019229] [dwh-prod] [PGSQL]
SELECT oid, spcname, pg_get_userbyid(spcowner) AS owner, pg_tablespace_location(oid) As spclocation, spcacl, shobj_description(oid, 'pg_tablespace') AS comment FROM pg_tablespace

[2016-02-18 10:48:59.012] [019229] [dwh-prod] [PGSQL]
SELECT rolname, rolsuper, rolinherit, rolcreaterole, rolcreatedb, rolcatupdate, rolcanlogin, rolconnlimit, rolvaliduntil, rolconfig, oid , pg_catalog.shobj_description(oid, 'pg_authid') AS comment FROM pg_roles 

[2016-02-18 10:48:59.145] [015946] [dwh-prod] [PGSQL]
SELECT t.oid, ns.nspname, t.typname, t.typtype, t.typrelid, t.typinput, t.typoutput, t.typlen, t.typdefault, t.typelem, t.typdelim, t.typalign, t.typstorage, t.typbyval, pg_get_userbyid(t.typowner) AS typeowner, e.typname AS element, e.typnamespace AS elementschemaoid, description, ct.oid AS taboid FROM pg_type t JOIN pg_namespace ns ON ns.oid=t.typnamespace LEFT JOIN pg_type e ON e.oid=t.typelem LEFT JOIN pg_class ct ON ct.oid=t.typrelid AND ct.relkind <> 'c' LEFT JOIN pg_description des ON des.objoid=t.oid WHERE t.typtype != 'd' AND (ct.oid IS NULL OR ct.oid = 0) ORDER BY t.typname

[2016-02-18 10:48:59.146] [015946] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-18 10:48:59.738] [019230] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 10:48:59.817] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, ns.nspname, t.typname, t.typtype, t.typrelid, t.typinput, t.typoutput, t.typlen, t.typdefault, t.typelem, t.typdelim, t.typalign, t.typstorage, t.typbyval, pg_get_userbyid(t.typowner) AS typeowner, e.typname AS element, e.typnamespace AS elementschemaoid, description, ct.oid AS taboid FROM pg_type t JOIN pg_namespace ns ON ns.oid=t.typnamespace LEFT JOIN pg_type e ON e.oid=t.typelem LEFT JOIN pg_class ct ON ct.oid=t.typrelid AND ct.relkind <> 'c' LEFT JOIN pg_description des ON des.objoid=t.oid WHERE t.typtype != 'd' AND (ct.oid IS NULL OR ct.oid = 0) ORDER BY t.typname

[2016-02-18 10:49:02.310] [019230] [dwh-prod] [PGSQL]
SELECT DISTINCT oprname FROM pg_catalog.pg_operator

[2016-02-18 10:49:02.418] [019230] [dwh-prod] [PGSQL]
SELECT collname FROM pg_collation

[2016-02-18 10:49:03.683] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 10:49:04.209] [019230] [dwh-prod] [PGSQL]
SELECT p.oid, p.proname, p.proargtypes, p.proacl, p.prorettype, p.prosecdef, p.proisstrict, p.proretset, p.provolatile, p.prosrc, p.probin, obj_description(p.oid) AS comment, pg_get_userbyid(p.proowner) AS funcowner, typ.typname, typns.nspname, lng.lanname , p.proargnames , p.proargmodes, p.proallargtypes , p.procost, p.prorows, p.proconfig , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace typns ON typns.oid=typ.typnamespace JOIN pg_namespace prons ON prons.oid=p.pronamespace JOIN pg_language lng ON lng.oid=p.prolang WHERE proisagg = false AND typ.typname = 'trigger' AND prons.nspname = 'pg_catalog' 

[2016-02-18 10:49:04.613] [019230] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common' AND c.relname = 'user_behavior_segmentation'

[2016-02-18 10:49:04.703] [019230] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'user_behavior_segmentation' ORDER BY col.table_name, col.ordinal_position

[2016-02-18 10:49:04.823] [019230] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-18 10:49:04.906] [019230] [dwh-prod] [PGSQL]
SELECT oid, collname FROM pg_collation

[2016-02-18 10:49:05.074] [019230] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS table_name, am.amname, i.indexrelid, i.indisunique, i.indisclustered, i.indisprimary, i.indkey, i.indclass, obj_description(indexrelid) , i.indnatts, pg_get_expr(indpred, indrelid, true) AS indconstraint, pa.rolname AS owner, ts.spcname, ci.reloptions, i.indoption, i.indcollation FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid LEFT JOIN pg_roles pa ON pa.oid = ci.relowner WHERE tns.nspname = 'common' AND ct.relname = 'user_behavior_segmentation' AND conname IS NULL ORDER BY ct.relname, ins.nspname, ci.relname

[2016-02-18 10:49:05.169] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(4507538, 1, true)

[2016-02-18 10:49:05.257] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(4507539, 1, true)

[2016-02-18 10:49:05.342] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(4507539, 2, true)

[2016-02-18 10:49:05.424] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(4507539, 3, true)

[2016-02-18 10:49:05.515] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(4507540, 1, true)

[2016-02-18 10:49:05.601] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(4507541, 1, true)

[2016-02-18 10:49:05.689] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(4507542, 1, true)

[2016-02-18 10:49:05.774] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, (current_database())::information_schema.sql_identifier AS trigger_catalog, (n.nspname)::information_schema.sql_identifier AS trigger_schema, (t.tgname)::information_schema.sql_identifier AS trigger_name, (c.relname)::information_schema.sql_identifier AS trigger_table_name, (em.text)::information_schema.character_data AS event_manipulation, (current_database())::information_schema.sql_identifier AS event_object_catalog, (n.nspname)::information_schema.sql_identifier AS event_object_schema, (c.relname)::information_schema.sql_identifier AS event_object_table, (c.relkind)::information_schema.sql_identifier AS event_object_table_type, (nsp.nspname)::information_schema.sql_identifier AS constraint_referenced_table_schema, (cs.relname)::information_schema.sql_identifier AS constraint_referenced_table_name, (t.tgdeferrable) AS constraint_deferrable_identifier, (t.tginitdeferred) AS constraint_deferred_type, (NULL::information_schema.cardinal_number)::information_schema.cardinal_number AS action_order, (CASE WHEN pg_has_role(c.relowner, 'USAGE'::text) THEN (SELECT rm.m[1] AS m FROM regexp_matches(pg_get_triggerdef(t.oid), (E'.{35,} WHEN \\((.+)\\) EXECUTE PROCEDURE'::text)) rm(m) LIMIT 1) ELSE NULL::text END)::information_schema.character_data AS action_condition, (NULL::information_schema.character_data)::information_schema.character_data AS action_condition, ("substring"(pg_get_triggerdef(t.oid), ("position"("substring"(pg_get_triggerdef(t.oid), 48), 'EXECUTE PROCEDURE'::text) + 47)))::information_schema.character_data AS action_statement, (CASE WHEN (((t.tgtype)::integer & 1) = 1) THEN 'ROW'::text ELSE 'STATEMENT'::text END)::information_schema.character_data AS action_orientation, (CASE WHEN (((t.tgtype)::integer & 2) = 2) THEN 'BEFORE'::text ELSE 'AFTER'::text END)::information_schema.character_data AS condition_timing, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_old_table, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_new_table, (t.tgconstraint) AS constraint_identifier, tc.event_object_column, obj_description(t.oid) FROM pg_namespace n LEFT JOIN pg_class c ON (n.oid = c.relnamespace) INNER JOIN pg_trigger t ON (c.oid = t.tgrelid) LEFT JOIN information_schema.triggered_update_columns tc ON (tc.trigger_schema = n.nspname) AND (tc.trigger_name = t.tgname) AND (tc.event_object_schema = n.nspname) AND (tc.event_object_table = c.relname)LEFT JOIN pg_user u ON (c.relowner = u.usesysid) LEFT JOIN (((SELECT 4, 'INSERT' UNION ALL SELECT 8, 'DELETE') UNION ALL SELECT 16, 'UPDATE') UNION ALL SELECT 32, 'TRUNCATE') em(num, text) ON (((t.tgtype)::integer & em.num) <> 0) LEFT OUTER JOIN (SELECT oid, relnamespace, relname FROM pg_class) cs ON (t.tgconstrrelid = cs.oid) LEFT OUTER JOIN (SELECT oid, nspname FROM pg_namespace) nsp ON (cs.relnamespace = nsp.oid) WHERE true AND n.nspname = 'common' AND c.relname = 'user_behavior_segmentation' AND (not t.tgisinternal) ORDER BY c.relname, t.tgname

[2016-02-18 10:49:05.863] [019230] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-18 10:49:06.180] [019230] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-18 10:49:06.425] [019230] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'user_behavior_segmentation' AND conname IS NOT NULL

[2016-02-18 10:49:06.510] [019230] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'user_behavior_segmentation' ORDER BY t.relname, i.oid

[2016-02-18 10:49:06.603] [019230] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'user_behavior_segmentation' ORDER BY t.relname, c.conname, a.attnum

[2016-02-18 10:49:06.686] [019230] [dwh-prod] [PGSQL]
SELECT n.nspname AS rule_schema, c.relname, r.rulename, r.oid, r.ev_type, r.is_instead, pg_get_ruledef(r.oid) AS definition, obj_description(r.oid) AS comment FROM ((pg_rewrite r JOIN pg_class c ON ((c.oid = r.ev_class))) LEFT JOIN pg_namespace n ON ((n.oid = c.relnamespace))) WHERE (r.rulename <> '_RETURN'::name) AND (n.nspname='common') AND (c.relname='user_behavior_segmentation')

[2016-02-18 10:49:06.795] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 10:49:07.748] [019230] [dwh-prod] [PGSQL]
SELECT p.oid, p.proname, p.proargtypes, p.proacl, p.prorettype, p.prosecdef, p.proisstrict, p.proretset, p.provolatile, p.prosrc, p.probin, obj_description(p.oid) AS comment, pg_get_userbyid(p.proowner) AS funcowner, typ.typname, typns.nspname, lng.lanname , p.proargnames , p.proargmodes, p.proallargtypes , p.procost, p.prorows, p.proconfig , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace typns ON typns.oid=typ.typnamespace JOIN pg_namespace prons ON prons.oid=p.pronamespace JOIN pg_language lng ON lng.oid=p.prolang WHERE proisagg = false AND typ.typname = 'trigger' AND prons.nspname = 'common' 

[2016-02-18 10:49:07.835] [019230] [dwh-prod] [PGSQL]
SELECT table_name FROM information_schema.tables WHERE table_schema = '' AND table_type = 'BASE TABLE'

[2016-02-18 10:49:14.394] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 10:49:15.282] [019230] [dwh-prod] [PGSQL]
SELECT p.oid, p.proname, p.proargtypes, p.proacl, p.prorettype, p.prosecdef, p.proisstrict, p.proretset, p.provolatile, p.prosrc, p.probin, obj_description(p.oid) AS comment, pg_get_userbyid(p.proowner) AS funcowner, typ.typname, typns.nspname, lng.lanname , p.proargnames , p.proargmodes, p.proallargtypes , p.procost, p.prorows, p.proconfig , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace typns ON typns.oid=typ.typnamespace JOIN pg_namespace prons ON prons.oid=p.pronamespace JOIN pg_language lng ON lng.oid=p.prolang WHERE proisagg = false AND typ.typname = 'trigger' AND prons.nspname = 'common' 

[2016-02-18 10:49:15.379] [019230] [dwh-prod] [PGSQL]
SELECT table_name FROM information_schema.tables WHERE table_schema = '' AND table_type = 'BASE TABLE'

[2016-02-18 11:06:20.068] [029659] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:06:20.070] [029659] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-18 11:06:20.698] [024572] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 11:06:20.779] [024572] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:06:20.923] [024572] [dwh-prod] [PGSQL]
create table common.engagement_index (
   user_behavior_segment varchar(255),
   tenure_cat_low   int2,
   tenure_cat_high  int2,
   days_since_last_video_view_low int2,
   days_since_last_video_view_high int2,
   engagement_index varchar(10);
);

insert into common.engagement_index values('My Yoga',,0,120,0,20,'High');
insert into common.engagement_index values('My Yoga',0,120,21,30,'Medium');
insert into common.engagement_index values('My Yoga',0,120,31,70,'Low');
insert into common.engagement_index values('My Yoga',0,120,71,999999,'Dormant');
insert into common.engagement_index values('My Yoga',121,395,0,20,'High');
insert into common.engagement_index values('My Yoga',121,395,21,45,'Medium');
insert into common.engagement_index values('My Yoga',121,395,46,90,'Low');
insert into common.engagement_index values('My Yoga',121,395,91,999999,'Dormant');
insert into common.engagement_index values('My Yoga',396,999999,0,20,'High');
insert into common.engagement_index values('My Yoga',396,999999,21,45,'Medium');
insert into common.engagement_index values('My Yoga',396,999999,46,90,'Low');
insert into common.engagement_index values('My Yoga',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('Spiritual Growth',,0,120,0,10,'High');
insert into common.engagement_index values('Spiritual Growth',0,120,11,25,'Medium');
insert into common.engagement_index values('Spiritual Growth',0,120,26,60,'Low');
insert into common.engagement_index values('Spiritual Growth',0,120,61,999999,'Dormant');
insert into common.engagement_index values('Spiritual Growth',121,395,0,14,'High');
insert into common.engagement_index values('Spiritual Growth',121,395,15,25,'Medium');
insert into common.engagement_index values('Spiritual Growth',121,395,26,90,'Low');
insert into common.engagement_index values('Spiritual Growth',121,395,91,999999,'Dormant');
insert into common.engagement_index values('Spiritual Growth',396,999999,0,14,'High');
insert into common.engagement_index values('Spiritual Growth',396,999999,15,30,'Medium');
insert into common.engagement_index values('Spiritual Growth',396,999999,31,90,'Low');
insert into common.engagement_index values('Spiritual Growth',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('Seeking Truth',,0,120,0,6,'High');
insert into common.engagement_index values('Seeking Truth',0,120,7,14,'Medium');
insert into common.engagement_index values('Seeking Truth',0,120,15,45,'Low');
insert into common.engagement_index values('Seeking Truth',0,120,46,999999,'Dormant');
insert into common.engagement_index values('Seeking Truth',121,395,0,10,'High');
insert into common.engagement_index values('Seeking Truth',121,395,11,17,'Medium');
insert into common.engagement_index values('Seeking Truth',121,395,18,90,'Low');
insert into common.engagement_index values('Seeking Truth',121,395,91,999999,'Dormant');
insert into common.engagement_index values('Seeking Truth',396,999999,0,10,'High');
insert into common.engagement_index values('Seeking Truth',396,999999,11,17,'Medium');
insert into common.engagement_index values('Seeking Truth',396,999999,18,90,'Low');
insert into common.engagement_index values('Seeking Truth',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('No Clear Segment',,0,120,0,10,'High');
insert into common.engagement_index values('No Clear Segment',0,120,11,25,'Medium');
insert into common.engagement_index values('No Clear Segment',0,120,26,60,'Low');
insert into common.engagement_index values('No Clear Segment',0,120,61,999999,'Dormant');
insert into common.engagement_index values('No Clear Segment',121,395,0,14,'High');
insert into common.engagement_index values('No Clear Segment',121,395,15,25,'Medium');
insert into common.engagement_index values('No Clear Segment',121,395,26,90,'Low');
insert into common.engagement_index values('No Clear Segment',121,395,91,999999,'Dormant');
insert into common.engagement_index values('No Clear Segment',396,999999,0,14,'High');
insert into common.engagement_index values('No Clear Segment',396,999999,15,30,'Medium');
insert into common.engagement_index values('No Clear Segment',396,999999,31,90,'Low');
insert into common.engagement_index values('No Clear Segment',396,999999,91,999999,'Dormant');


[2016-02-18 11:06:21.085] [024572] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near ";"
LINE 7:    engagement_index varchar(10);
                                       ^


[2016-02-18 11:06:21.121] [024572] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:06:36.627] [024572] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:06:36.755] [024572] [dwh-prod] [PGSQL]
create table common.engagement_index (
   user_behavior_segment varchar(255),
   tenure_cat_low   int2,
   tenure_cat_high  int2,
   days_since_last_video_view_low int2,
   days_since_last_video_view_high int2,
   engagement_index varchar(10)
);

insert into common.engagement_index values('My Yoga',,0,120,0,20,'High');
insert into common.engagement_index values('My Yoga',0,120,21,30,'Medium');
insert into common.engagement_index values('My Yoga',0,120,31,70,'Low');
insert into common.engagement_index values('My Yoga',0,120,71,999999,'Dormant');
insert into common.engagement_index values('My Yoga',121,395,0,20,'High');
insert into common.engagement_index values('My Yoga',121,395,21,45,'Medium');
insert into common.engagement_index values('My Yoga',121,395,46,90,'Low');
insert into common.engagement_index values('My Yoga',121,395,91,999999,'Dormant');
insert into common.engagement_index values('My Yoga',396,999999,0,20,'High');
insert into common.engagement_index values('My Yoga',396,999999,21,45,'Medium');
insert into common.engagement_index values('My Yoga',396,999999,46,90,'Low');
insert into common.engagement_index values('My Yoga',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('Spiritual Growth',,0,120,0,10,'High');
insert into common.engagement_index values('Spiritual Growth',0,120,11,25,'Medium');
insert into common.engagement_index values('Spiritual Growth',0,120,26,60,'Low');
insert into common.engagement_index values('Spiritual Growth',0,120,61,999999,'Dormant');
insert into common.engagement_index values('Spiritual Growth',121,395,0,14,'High');
insert into common.engagement_index values('Spiritual Growth',121,395,15,25,'Medium');
insert into common.engagement_index values('Spiritual Growth',121,395,26,90,'Low');
insert into common.engagement_index values('Spiritual Growth',121,395,91,999999,'Dormant');
insert into common.engagement_index values('Spiritual Growth',396,999999,0,14,'High');
insert into common.engagement_index values('Spiritual Growth',396,999999,15,30,'Medium');
insert into common.engagement_index values('Spiritual Growth',396,999999,31,90,'Low');
insert into common.engagement_index values('Spiritual Growth',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('Seeking Truth',,0,120,0,6,'High');
insert into common.engagement_index values('Seeking Truth',0,120,7,14,'Medium');
insert into common.engagement_index values('Seeking Truth',0,120,15,45,'Low');
insert into common.engagement_index values('Seeking Truth',0,120,46,999999,'Dormant');
insert into common.engagement_index values('Seeking Truth',121,395,0,10,'High');
insert into common.engagement_index values('Seeking Truth',121,395,11,17,'Medium');
insert into common.engagement_index values('Seeking Truth',121,395,18,90,'Low');
insert into common.engagement_index values('Seeking Truth',121,395,91,999999,'Dormant');
insert into common.engagement_index values('Seeking Truth',396,999999,0,10,'High');
insert into common.engagement_index values('Seeking Truth',396,999999,11,17,'Medium');
insert into common.engagement_index values('Seeking Truth',396,999999,18,90,'Low');
insert into common.engagement_index values('Seeking Truth',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('No Clear Segment',,0,120,0,10,'High');
insert into common.engagement_index values('No Clear Segment',0,120,11,25,'Medium');
insert into common.engagement_index values('No Clear Segment',0,120,26,60,'Low');
insert into common.engagement_index values('No Clear Segment',0,120,61,999999,'Dormant');
insert into common.engagement_index values('No Clear Segment',121,395,0,14,'High');
insert into common.engagement_index values('No Clear Segment',121,395,15,25,'Medium');
insert into common.engagement_index values('No Clear Segment',121,395,26,90,'Low');
insert into common.engagement_index values('No Clear Segment',121,395,91,999999,'Dormant');
insert into common.engagement_index values('No Clear Segment',396,999999,0,14,'High');
insert into common.engagement_index values('No Clear Segment',396,999999,15,30,'Medium');
insert into common.engagement_index values('No Clear Segment',396,999999,31,90,'Low');
insert into common.engagement_index values('No Clear Segment',396,999999,91,999999,'Dormant');


[2016-02-18 11:06:36.839] [024572] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near ","
LINE 10: ...ert into common.engagement_index values('My Yoga',,0,120,0,2...
                                                              ^


[2016-02-18 11:06:36.862] [024572] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:06:47.805] [024572] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:06:47.933] [024572] [dwh-prod] [PGSQL]
create table common.engagement_index (
   user_behavior_segment varchar(255),
   tenure_cat_low   int2,
   tenure_cat_high  int2,
   days_since_last_video_view_low int2,
   days_since_last_video_view_high int2,
   engagement_index varchar(10)
);

insert into common.engagement_index values('My Yoga',0,120,0,20,'High');
insert into common.engagement_index values('My Yoga',0,120,21,30,'Medium');
insert into common.engagement_index values('My Yoga',0,120,31,70,'Low');
insert into common.engagement_index values('My Yoga',0,120,71,999999,'Dormant');
insert into common.engagement_index values('My Yoga',121,395,0,20,'High');
insert into common.engagement_index values('My Yoga',121,395,21,45,'Medium');
insert into common.engagement_index values('My Yoga',121,395,46,90,'Low');
insert into common.engagement_index values('My Yoga',121,395,91,999999,'Dormant');
insert into common.engagement_index values('My Yoga',396,999999,0,20,'High');
insert into common.engagement_index values('My Yoga',396,999999,21,45,'Medium');
insert into common.engagement_index values('My Yoga',396,999999,46,90,'Low');
insert into common.engagement_index values('My Yoga',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('Spiritual Growth',,0,120,0,10,'High');
insert into common.engagement_index values('Spiritual Growth',0,120,11,25,'Medium');
insert into common.engagement_index values('Spiritual Growth',0,120,26,60,'Low');
insert into common.engagement_index values('Spiritual Growth',0,120,61,999999,'Dormant');
insert into common.engagement_index values('Spiritual Growth',121,395,0,14,'High');
insert into common.engagement_index values('Spiritual Growth',121,395,15,25,'Medium');
insert into common.engagement_index values('Spiritual Growth',121,395,26,90,'Low');
insert into common.engagement_index values('Spiritual Growth',121,395,91,999999,'Dormant');
insert into common.engagement_index values('Spiritual Growth',396,999999,0,14,'High');
insert into common.engagement_index values('Spiritual Growth',396,999999,15,30,'Medium');
insert into common.engagement_index values('Spiritual Growth',396,999999,31,90,'Low');
insert into common.engagement_index values('Spiritual Growth',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('Seeking Truth',,0,120,0,6,'High');
insert into common.engagement_index values('Seeking Truth',0,120,7,14,'Medium');
insert into common.engagement_index values('Seeking Truth',0,120,15,45,'Low');
insert into common.engagement_index values('Seeking Truth',0,120,46,999999,'Dormant');
insert into common.engagement_index values('Seeking Truth',121,395,0,10,'High');
insert into common.engagement_index values('Seeking Truth',121,395,11,17,'Medium');
insert into common.engagement_index values('Seeking Truth',121,395,18,90,'Low');
insert into common.engagement_index values('Seeking Truth',121,395,91,999999,'Dormant');
insert into common.engagement_index values('Seeking Truth',396,999999,0,10,'High');
insert into common.engagement_index values('Seeking Truth',396,999999,11,17,'Medium');
insert into common.engagement_index values('Seeking Truth',396,999999,18,90,'Low');
insert into common.engagement_index values('Seeking Truth',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('No Clear Segment',,0,120,0,10,'High');
insert into common.engagement_index values('No Clear Segment',0,120,11,25,'Medium');
insert into common.engagement_index values('No Clear Segment',0,120,26,60,'Low');
insert into common.engagement_index values('No Clear Segment',0,120,61,999999,'Dormant');
insert into common.engagement_index values('No Clear Segment',121,395,0,14,'High');
insert into common.engagement_index values('No Clear Segment',121,395,15,25,'Medium');
insert into common.engagement_index values('No Clear Segment',121,395,26,90,'Low');
insert into common.engagement_index values('No Clear Segment',121,395,91,999999,'Dormant');
insert into common.engagement_index values('No Clear Segment',396,999999,0,14,'High');
insert into common.engagement_index values('No Clear Segment',396,999999,15,30,'Medium');
insert into common.engagement_index values('No Clear Segment',396,999999,31,90,'Low');
insert into common.engagement_index values('No Clear Segment',396,999999,91,999999,'Dormant');


[2016-02-18 11:06:48.014] [024572] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near ","
LINE 23: ...common.engagement_index values('Spiritual Growth',,0,120,0,1...
                                                              ^


[2016-02-18 11:06:48.037] [024572] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:07:01.720] [024572] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:07:01.842] [024572] [dwh-prod] [PGSQL]
create table common.engagement_index (
   user_behavior_segment varchar(255),
   tenure_cat_low   int2,
   tenure_cat_high  int2,
   days_since_last_video_view_low int2,
   days_since_last_video_view_high int2,
   engagement_index varchar(10)
);

insert into common.engagement_index values('My Yoga',0,120,0,20,'High');
insert into common.engagement_index values('My Yoga',0,120,21,30,'Medium');
insert into common.engagement_index values('My Yoga',0,120,31,70,'Low');
insert into common.engagement_index values('My Yoga',0,120,71,999999,'Dormant');
insert into common.engagement_index values('My Yoga',121,395,0,20,'High');
insert into common.engagement_index values('My Yoga',121,395,21,45,'Medium');
insert into common.engagement_index values('My Yoga',121,395,46,90,'Low');
insert into common.engagement_index values('My Yoga',121,395,91,999999,'Dormant');
insert into common.engagement_index values('My Yoga',396,999999,0,20,'High');
insert into common.engagement_index values('My Yoga',396,999999,21,45,'Medium');
insert into common.engagement_index values('My Yoga',396,999999,46,90,'Low');
insert into common.engagement_index values('My Yoga',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('Spiritual Growth',0,120,0,10,'High');
insert into common.engagement_index values('Spiritual Growth',0,120,11,25,'Medium');
insert into common.engagement_index values('Spiritual Growth',0,120,26,60,'Low');
insert into common.engagement_index values('Spiritual Growth',0,120,61,999999,'Dormant');
insert into common.engagement_index values('Spiritual Growth',121,395,0,14,'High');
insert into common.engagement_index values('Spiritual Growth',121,395,15,25,'Medium');
insert into common.engagement_index values('Spiritual Growth',121,395,26,90,'Low');
insert into common.engagement_index values('Spiritual Growth',121,395,91,999999,'Dormant');
insert into common.engagement_index values('Spiritual Growth',396,999999,0,14,'High');
insert into common.engagement_index values('Spiritual Growth',396,999999,15,30,'Medium');
insert into common.engagement_index values('Spiritual Growth',396,999999,31,90,'Low');
insert into common.engagement_index values('Spiritual Growth',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('Seeking Truth',0,120,0,6,'High');
insert into common.engagement_index values('Seeking Truth',0,120,7,14,'Medium');
insert into common.engagement_index values('Seeking Truth',0,120,15,45,'Low');
insert into common.engagement_index values('Seeking Truth',0,120,46,999999,'Dormant');
insert into common.engagement_index values('Seeking Truth',121,395,0,10,'High');
insert into common.engagement_index values('Seeking Truth',121,395,11,17,'Medium');
insert into common.engagement_index values('Seeking Truth',121,395,18,90,'Low');
insert into common.engagement_index values('Seeking Truth',121,395,91,999999,'Dormant');
insert into common.engagement_index values('Seeking Truth',396,999999,0,10,'High');
insert into common.engagement_index values('Seeking Truth',396,999999,11,17,'Medium');
insert into common.engagement_index values('Seeking Truth',396,999999,18,90,'Low');
insert into common.engagement_index values('Seeking Truth',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('No Clear Segment',0,120,0,10,'High');
insert into common.engagement_index values('No Clear Segment',0,120,11,25,'Medium');
insert into common.engagement_index values('No Clear Segment',0,120,26,60,'Low');
insert into common.engagement_index values('No Clear Segment',0,120,61,999999,'Dormant');
insert into common.engagement_index values('No Clear Segment',121,395,0,14,'High');
insert into common.engagement_index values('No Clear Segment',121,395,15,25,'Medium');
insert into common.engagement_index values('No Clear Segment',121,395,26,90,'Low');
insert into common.engagement_index values('No Clear Segment',121,395,91,999999,'Dormant');
insert into common.engagement_index values('No Clear Segment',396,999999,0,14,'High');
insert into common.engagement_index values('No Clear Segment',396,999999,15,30,'Medium');
insert into common.engagement_index values('No Clear Segment',396,999999,31,90,'Low');
insert into common.engagement_index values('No Clear Segment',396,999999,91,999999,'Dormant');


[2016-02-18 11:07:01.928] [024572] [dwh-prod] [PGSQL]
ERROR:  smallint out of range


[2016-02-18 11:07:02.005] [024572] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:07:58.122] [024572] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:07:58.262] [024572] [dwh-prod] [PGSQL]
drop table if exists common.engagement_index;

create table common.engagement_index (
   user_behavior_segment varchar(255),
   tenure_cat_low   integer,
   tenure_cat_high  integer,
   days_since_last_video_view_low int2,
   days_since_last_video_view_high int2,
   engagement_index varchar(10)
);

insert into common.engagement_index values('My Yoga',0,120,0,20,'High');
insert into common.engagement_index values('My Yoga',0,120,21,30,'Medium');
insert into common.engagement_index values('My Yoga',0,120,31,70,'Low');
insert into common.engagement_index values('My Yoga',0,120,71,999999,'Dormant');
insert into common.engagement_index values('My Yoga',121,395,0,20,'High');
insert into common.engagement_index values('My Yoga',121,395,21,45,'Medium');
insert into common.engagement_index values('My Yoga',121,395,46,90,'Low');
insert into common.engagement_index values('My Yoga',121,395,91,999999,'Dormant');
insert into common.engagement_index values('My Yoga',396,999999,0,20,'High');
insert into common.engagement_index values('My Yoga',396,999999,21,45,'Medium');
insert into common.engagement_index values('My Yoga',396,999999,46,90,'Low');
insert into common.engagement_index values('My Yoga',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('Spiritual Growth',0,120,0,10,'High');
insert into common.engagement_index values('Spiritual Growth',0,120,11,25,'Medium');
insert into common.engagement_index values('Spiritual Growth',0,120,26,60,'Low');
insert into common.engagement_index values('Spiritual Growth',0,120,61,999999,'Dormant');
insert into common.engagement_index values('Spiritual Growth',121,395,0,14,'High');
insert into common.engagement_index values('Spiritual Growth',121,395,15,25,'Medium');
insert into common.engagement_index values('Spiritual Growth',121,395,26,90,'Low');
insert into common.engagement_index values('Spiritual Growth',121,395,91,999999,'Dormant');
insert into common.engagement_index values('Spiritual Growth',396,999999,0,14,'High');
insert into common.engagement_index values('Spiritual Growth',396,999999,15,30,'Medium');
insert into common.engagement_index values('Spiritual Growth',396,999999,31,90,'Low');
insert into common.engagement_index values('Spiritual Growth',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('Seeking Truth',0,120,0,6,'High');
insert into common.engagement_index values('Seeking Truth',0,120,7,14,'Medium');
insert into common.engagement_index values('Seeking Truth',0,120,15,45,'Low');
insert into common.engagement_index values('Seeking Truth',0,120,46,999999,'Dormant');
insert into common.engagement_index values('Seeking Truth',121,395,0,10,'High');
insert into common.engagement_index values('Seeking Truth',121,395,11,17,'Medium');
insert into common.engagement_index values('Seeking Truth',121,395,18,90,'Low');
insert into common.engagement_index values('Seeking Truth',121,395,91,999999,'Dormant');
insert into common.engagement_index values('Seeking Truth',396,999999,0,10,'High');
insert into common.engagement_index values('Seeking Truth',396,999999,11,17,'Medium');
insert into common.engagement_index values('Seeking Truth',396,999999,18,90,'Low');
insert into common.engagement_index values('Seeking Truth',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('No Clear Segment',0,120,0,10,'High');
insert into common.engagement_index values('No Clear Segment',0,120,11,25,'Medium');
insert into common.engagement_index values('No Clear Segment',0,120,26,60,'Low');
insert into common.engagement_index values('No Clear Segment',0,120,61,999999,'Dormant');
insert into common.engagement_index values('No Clear Segment',121,395,0,14,'High');
insert into common.engagement_index values('No Clear Segment',121,395,15,25,'Medium');
insert into common.engagement_index values('No Clear Segment',121,395,26,90,'Low');
insert into common.engagement_index values('No Clear Segment',121,395,91,999999,'Dormant');
insert into common.engagement_index values('No Clear Segment',396,999999,0,14,'High');
insert into common.engagement_index values('No Clear Segment',396,999999,15,30,'Medium');
insert into common.engagement_index values('No Clear Segment',396,999999,31,90,'Low');
insert into common.engagement_index values('No Clear Segment',396,999999,91,999999,'Dormant');


[2016-02-18 11:07:58.356] [024572] [dwh-prod] [PGSQL]
ERROR:  smallint out of range


[2016-02-18 11:07:58.378] [024572] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:08:10.741] [024572] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:08:10.898] [024572] [dwh-prod] [PGSQL]
drop table if exists common.engagement_index;

create table common.engagement_index (
   user_behavior_segment varchar(255),
   tenure_cat_low   integer,
   tenure_cat_high  integer,
   days_since_last_video_view_low integer,
   days_since_last_video_view_high integer,
   engagement_index varchar(10)
);

insert into common.engagement_index values('My Yoga',0,120,0,20,'High');
insert into common.engagement_index values('My Yoga',0,120,21,30,'Medium');
insert into common.engagement_index values('My Yoga',0,120,31,70,'Low');
insert into common.engagement_index values('My Yoga',0,120,71,999999,'Dormant');
insert into common.engagement_index values('My Yoga',121,395,0,20,'High');
insert into common.engagement_index values('My Yoga',121,395,21,45,'Medium');
insert into common.engagement_index values('My Yoga',121,395,46,90,'Low');
insert into common.engagement_index values('My Yoga',121,395,91,999999,'Dormant');
insert into common.engagement_index values('My Yoga',396,999999,0,20,'High');
insert into common.engagement_index values('My Yoga',396,999999,21,45,'Medium');
insert into common.engagement_index values('My Yoga',396,999999,46,90,'Low');
insert into common.engagement_index values('My Yoga',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('Spiritual Growth',0,120,0,10,'High');
insert into common.engagement_index values('Spiritual Growth',0,120,11,25,'Medium');
insert into common.engagement_index values('Spiritual Growth',0,120,26,60,'Low');
insert into common.engagement_index values('Spiritual Growth',0,120,61,999999,'Dormant');
insert into common.engagement_index values('Spiritual Growth',121,395,0,14,'High');
insert into common.engagement_index values('Spiritual Growth',121,395,15,25,'Medium');
insert into common.engagement_index values('Spiritual Growth',121,395,26,90,'Low');
insert into common.engagement_index values('Spiritual Growth',121,395,91,999999,'Dormant');
insert into common.engagement_index values('Spiritual Growth',396,999999,0,14,'High');
insert into common.engagement_index values('Spiritual Growth',396,999999,15,30,'Medium');
insert into common.engagement_index values('Spiritual Growth',396,999999,31,90,'Low');
insert into common.engagement_index values('Spiritual Growth',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('Seeking Truth',0,120,0,6,'High');
insert into common.engagement_index values('Seeking Truth',0,120,7,14,'Medium');
insert into common.engagement_index values('Seeking Truth',0,120,15,45,'Low');
insert into common.engagement_index values('Seeking Truth',0,120,46,999999,'Dormant');
insert into common.engagement_index values('Seeking Truth',121,395,0,10,'High');
insert into common.engagement_index values('Seeking Truth',121,395,11,17,'Medium');
insert into common.engagement_index values('Seeking Truth',121,395,18,90,'Low');
insert into common.engagement_index values('Seeking Truth',121,395,91,999999,'Dormant');
insert into common.engagement_index values('Seeking Truth',396,999999,0,10,'High');
insert into common.engagement_index values('Seeking Truth',396,999999,11,17,'Medium');
insert into common.engagement_index values('Seeking Truth',396,999999,18,90,'Low');
insert into common.engagement_index values('Seeking Truth',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('No Clear Segment',0,120,0,10,'High');
insert into common.engagement_index values('No Clear Segment',0,120,11,25,'Medium');
insert into common.engagement_index values('No Clear Segment',0,120,26,60,'Low');
insert into common.engagement_index values('No Clear Segment',0,120,61,999999,'Dormant');
insert into common.engagement_index values('No Clear Segment',121,395,0,14,'High');
insert into common.engagement_index values('No Clear Segment',121,395,15,25,'Medium');
insert into common.engagement_index values('No Clear Segment',121,395,26,90,'Low');
insert into common.engagement_index values('No Clear Segment',121,395,91,999999,'Dormant');
insert into common.engagement_index values('No Clear Segment',396,999999,0,14,'High');
insert into common.engagement_index values('No Clear Segment',396,999999,15,30,'Medium');
insert into common.engagement_index values('No Clear Segment',396,999999,31,90,'Low');
insert into common.engagement_index values('No Clear Segment',396,999999,91,999999,'Dormant');


[2016-02-18 11:08:11.022] [024572] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:08:42.612] [024572] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:08:42.716] [024572] [dwh-prod] [PGSQL]

alter table common.engagement_index owner to dw_admin;


[2016-02-18 11:08:42.812] [024572] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:09:11.478] [025442] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 11:09:11.561] [025442] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-18 11:09:11.850] [025441] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 11:09:11.932] [025441] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-18 11:09:12.034] [025441] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 11:09:12.121] [025441] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-18 11:09:12.203] [025441] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 11:09:12.725] [025441] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 11:09:12.812] [025441] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 11:09:12.901] [025441] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-18 11:09:12.984] [025441] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 11:09:13.084] [025441] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-18 11:09:13.171] [025441] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 11:09:13.376] [025441] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 11:09:13.457] [025441] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 11:09:13.557] [025441] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-18 11:09:13.642] [025441] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-18 11:10:16.576] [025777] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 11:10:16.655] [025777] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='current_users' ORDER BY ordinal_position

[2016-02-18 11:10:17.345] [025788] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 11:10:17.424] [025788] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 11:10:17.534] [025788] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-18 11:10:17.615] [025788] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 11:10:18.216] [025788] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 11:10:18.298] [025788] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 11:10:18.385] [025788] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-18 11:10:19.110] [025797] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 11:10:19.190] [025797] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='previous_user_dim' ORDER BY ordinal_position

[2016-02-18 11:10:19.873] [025798] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 11:10:19.951] [025798] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'drupal') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 11:10:20.253] [025798] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='drupal' ORDER BY schemaname, viewname

[2016-02-18 11:10:20.334] [025798] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 11:10:20.844] [025798] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 11:10:20.924] [025798] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'drupal' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 11:10:21.013] [025798] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'drupal' 

[2016-02-18 11:10:21.681] [025806] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 11:10:21.761] [025806] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='drupal' AND table_name='users' ORDER BY ordinal_position

[2016-02-18 11:23:36.529] [029861] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 11:23:36.610] [029861] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-18 11:23:36.926] [029860] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 11:23:37.021] [029860] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-18 11:23:37.126] [029860] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 11:23:37.253] [029860] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-18 11:23:37.377] [029860] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 11:23:39.219] [029860] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 11:23:39.317] [029860] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 11:23:39.434] [029860] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-18 11:23:39.574] [029860] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 11:23:39.713] [029860] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-18 11:23:39.844] [029860] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 11:23:41.367] [029860] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 11:23:41.501] [029860] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 11:23:41.639] [029860] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-18 11:23:41.770] [029860] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-18 11:23:56.398] [029984] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 11:23:56.483] [029984] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 11:23:56.593] [029984] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-18 11:23:56.675] [029984] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 11:23:57.293] [029984] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 11:23:57.405] [029984] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 11:23:57.511] [029984] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-18 11:27:12.948] [030993] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 11:27:13.027] [030993] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 11:27:13.138] [030993] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-18 11:27:13.224] [030993] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 11:27:13.819] [030993] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 11:27:13.904] [030993] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 11:27:13.993] [030993] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-18 11:27:28.851] [031058] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 11:27:28.932] [031058] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='user_dim' ORDER BY ordinal_position

[2016-02-18 11:27:29.674] [031065] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 11:27:29.755] [031065] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='subscription_d' ORDER BY ordinal_position

[2016-02-18 11:31:44.220] [024572] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:31:44.341] [024572] [dwh-prod] [PGSQL]
drop table if exists common.engagement_level;

create table common.engagement_level (
   user_behavior_segment varchar(255),
   tenure_cat_low   integer,
   tenure_cat_high  integer,
   days_since_last_video_view_low integer,
   days_since_last_video_view_high integer,
   engagement_level varchar(10)
);


alter table common.engagement_index owner to dw_admin;

insert into common.engagement_index values('My Yoga',0,120,0,20,'High');
insert into common.engagement_index values('My Yoga',0,120,21,30,'Medium');
insert into common.engagement_index values('My Yoga',0,120,31,70,'Low');
insert into common.engagement_index values('My Yoga',0,120,71,999999,'Dormant');
insert into common.engagement_index values('My Yoga',121,395,0,20,'High');
insert into common.engagement_index values('My Yoga',121,395,21,45,'Medium');
insert into common.engagement_index values('My Yoga',121,395,46,90,'Low');
insert into common.engagement_index values('My Yoga',121,395,91,999999,'Dormant');
insert into common.engagement_index values('My Yoga',396,999999,0,20,'High');
insert into common.engagement_index values('My Yoga',396,999999,21,45,'Medium');
insert into common.engagement_index values('My Yoga',396,999999,46,90,'Low');
insert into common.engagement_index values('My Yoga',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('Spiritual Growth',0,120,0,10,'High');
insert into common.engagement_index values('Spiritual Growth',0,120,11,25,'Medium');
insert into common.engagement_index values('Spiritual Growth',0,120,26,60,'Low');
insert into common.engagement_index values('Spiritual Growth',0,120,61,999999,'Dormant');
insert into common.engagement_index values('Spiritual Growth',121,395,0,14,'High');
insert into common.engagement_index values('Spiritual Growth',121,395,15,25,'Medium');
insert into common.engagement_index values('Spiritual Growth',121,395,26,90,'Low');
insert into common.engagement_index values('Spiritual Growth',121,395,91,999999,'Dormant');
insert into common.engagement_index values('Spiritual Growth',396,999999,0,14,'High');
insert into common.engagement_index values('Spiritual Growth',396,999999,15,30,'Medium');
insert into common.engagement_index values('Spiritual Growth',396,999999,31,90,'Low');
insert into common.engagement_index values('Spiritual Growth',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('Seeking Truth',0,120,0,6,'High');
insert into common.engagement_index values('Seeking Truth',0,120,7,14,'Medium');
insert into common.engagement_index values('Seeking Truth',0,120,15,45,'Low');
insert into common.engagement_index values('Seeking Truth',0,120,46,999999,'Dormant');
insert into common.engagement_index values('Seeking Truth',121,395,0,10,'High');
insert into common.engagement_index values('Seeking Truth',121,395,11,17,'Medium');
insert into common.engagement_index values('Seeking Truth',121,395,18,90,'Low');
insert into common.engagement_index values('Seeking Truth',121,395,91,999999,'Dormant');
insert into common.engagement_index values('Seeking Truth',396,999999,0,10,'High');
insert into common.engagement_index values('Seeking Truth',396,999999,11,17,'Medium');
insert into common.engagement_index values('Seeking Truth',396,999999,18,90,'Low');
insert into common.engagement_index values('Seeking Truth',396,999999,91,999999,'Dormant');

insert into common.engagement_index values('No Clear Segment',0,120,0,10,'High');
insert into common.engagement_index values('No Clear Segment',0,120,11,25,'Medium');
insert into common.engagement_index values('No Clear Segment',0,120,26,60,'Low');
insert into common.engagement_index values('No Clear Segment',0,120,61,999999,'Dormant');
insert into common.engagement_index values('No Clear Segment',121,395,0,14,'High');
insert into common.engagement_index values('No Clear Segment',121,395,15,25,'Medium');
insert into common.engagement_index values('No Clear Segment',121,395,26,90,'Low');
insert into common.engagement_index values('No Clear Segment',121,395,91,999999,'Dormant');
insert into common.engagement_index values('No Clear Segment',396,999999,0,14,'High');
insert into common.engagement_index values('No Clear Segment',396,999999,15,30,'Medium');
insert into common.engagement_index values('No Clear Segment',396,999999,31,90,'Low');
insert into common.engagement_index values('No Clear Segment',396,999999,91,999999,'Dormant');


[2016-02-18 11:31:44.454] [024572] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:31:52.569] [019230] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common'

[2016-02-18 11:32:01.186] [019230] [dwh-prod] [PGSQL]
DROP TABLE "common"."engagement_index"

[2016-02-18 11:36:52.032] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:36:52.165] [029861] [dwh-prod] [PGSQL]
create table tmp.engagement_level as 
(select gcsi_user_id,
    subscription_age,
    days_since_last_video_view,
    case when user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select gcsi_user_id,
            current_date::date - ud.last_video_view_date::date days_since_last_video_view,
            current_date::date - sd.start_date subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_vide_view >= days_since_last_video_view_low and
       u.days_since_last_vide_view <= days_since_last_video_view_high);


[2016-02-18 11:36:52.247] [029861] [dwh-prod] [PGSQL]
ERROR:  column reference "gcsi_user_id" is ambiguous
LINE 13:     (select gcsi_user_id,
                     ^


[2016-02-18 11:36:52.269] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:37:07.679] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:37:07.799] [029861] [dwh-prod] [PGSQL]
create table tmp.engagement_level as 
(select gcsi_user_id,
    subscription_age,
    days_since_last_video_view,
    case when user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            current_date::date - ud.last_video_view_date::date days_since_last_video_view,
            current_date::date - sd.start_date subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_vide_view >= days_since_last_video_view_low and
       u.days_since_last_vide_view <= days_since_last_video_view_high);


[2016-02-18 11:37:07.886] [029861] [dwh-prod] [PGSQL]
ERROR:  operator does not exist: interval >= integer
LINE 22:        u.subscription_age >= e.tenure_cat_low and
                                   ^
HINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.


[2016-02-18 11:37:07.907] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:37:32.423] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:37:32.548] [029861] [dwh-prod] [PGSQL]
create table tmp.engagement_level as 
(select gcsi_user_id,
    subscription_age,
    days_since_last_video_view,
    case when user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            current_date::date - ud.last_video_view_date::date::integer days_since_last_video_view,
            current_date::date - sd.start_date::integer subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_vide_view >= days_since_last_video_view_low and
       u.days_since_last_vide_view <= days_since_last_video_view_high);


[2016-02-18 11:37:32.628] [029861] [dwh-prod] [PGSQL]
ERROR:  cannot cast type date to integer
LINE 14: ...current_date::date - ud.last_video_view_date::date::integer ...
                                                              ^


[2016-02-18 11:37:32.648] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:40:23.638] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:40:23.766] [029861] [dwh-prod] [PGSQL]
create table tmp.engagement_level as 
(select gcsi_user_id,
    subscription_age,
    days_since_last_video_view,
    case when user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('dd',current_date,ud.last_video_view_date) days_since_last_video_view,
            date_part('dd',current_date,sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_vide_view >= days_since_last_video_view_low and
       u.days_since_last_vide_view <= days_since_last_video_view_high);


[2016-02-18 11:40:23.848] [029861] [dwh-prod] [PGSQL]
ERROR:  function date_part(unknown, date, timestamp with time zone) does not exist
LINE 14:             date_part('dd',current_date,ud.last_video_view_d...
                     ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.


[2016-02-18 11:40:23.869] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:41:19.383] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:41:19.508] [029861] [dwh-prod] [PGSQL]
create table tmp.engagement_level as 
(select gcsi_user_id,
    subscription_age,
    days_since_last_video_view,
    case when user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date,ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date,sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_vide_view >= days_since_last_video_view_low and
       u.days_since_last_vide_view <= days_since_last_video_view_high);


[2016-02-18 11:41:19.588] [029861] [dwh-prod] [PGSQL]
ERROR:  function date_part(unknown, date, timestamp with time zone) does not exist
LINE 14:             date_part('day',current_date,ud.last_video_view_...
                     ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.


[2016-02-18 11:41:19.610] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:41:54.315] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:41:54.432] [029861] [dwh-prod] [PGSQL]
create table tmp.engagement_level as 
(select gcsi_user_id,
    subscription_age,
    days_since_last_video_view,
    case when user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_vide_view >= days_since_last_video_view_low and
       u.days_since_last_vide_view <= days_since_last_video_view_high);


[2016-02-18 11:41:54.514] [029861] [dwh-prod] [PGSQL]
ERROR:  column u.days_since_last_vide_view does not exist
LINE 24:        u.days_since_last_vide_view >= days_since_last_video_...
                ^


[2016-02-18 11:41:54.535] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:42:21.694] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:42:21.823] [029861] [dwh-prod] [PGSQL]
create table tmp.engagement_level as 
(select gcsi_user_id,
    subscription_age,
    days_since_last_video_view,
    case when user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_video_view >= days_since_last_video_view_low and
       u.days_since_last_video_view <= days_since_last_video_view_high);


[2016-02-18 11:42:21.918] [029861] [dwh-prod] [PGSQL]
ERROR:  column reference "user_behavior_segment" is ambiguous
LINE 5:     case when user_behavior_segment is null then 
                      ^


[2016-02-18 11:42:21.939] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:42:44.430] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:42:44.545] [029861] [dwh-prod] [PGSQL]
create table tmp.engagement_level as 
(select gcsi_user_id,
    subscription_age,
    days_since_last_video_view,
    case when u.user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_video_view >= days_since_last_video_view_low and
       u.days_since_last_video_view <= days_since_last_video_view_high);


[2016-02-18 11:42:44.676] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:56:04.908] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:56:05.026] [029861] [dwh-prod] [PGSQL]
drop table if exists tmp.engagement_level;

create table tmp.engagement_level as 
(select gcsi_user_id,
    u.user_behavior_segment,
    subscription_age,
    days_since_last_video_view,
    case when u.user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_video_view >= days_since_last_video_view_low and
       u.days_since_last_video_view <= days_since_last_video_view_high);

select user_behavior_segment, subscription_age, days_since_last_video_view, engagement_level, count(1)
from tmp.engagement_level;


[2016-02-18 11:56:05.182] [029861] [dwh-prod] [PGSQL]
ERROR:  column "engagement_level.user_behavior_segment" must appear in the GROUP BY clause or be used in an aggregate function
LINE 30: select user_behavior_segment, subscription_age, days_since_l...
                ^


[2016-02-18 11:56:05.258] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:56:26.752] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:56:26.870] [029861] [dwh-prod] [PGSQL]
drop table if exists tmp.engagement_level;

create table tmp.engagement_level as 
(select gcsi_user_id,
    u.user_behavior_segment,
    subscription_age,
    days_since_last_video_view,
    case when u.user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_video_view >= days_since_last_video_view_low and
       u.days_since_last_video_view <= days_since_last_video_view_high);

select user_behavior_segment, subscription_age, days_since_last_video_view, engagement_level, count(1)
from tmp.engagement_level
group by user_behavior_segment, subscription_age, days_since_last_video_view, engagement_level;


[2016-02-18 11:56:26.988] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:56:27.408] [029861] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6172809

[2016-02-18 11:57:27.750] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:57:27.856] [029861] [dwh-prod] [PGSQL]
    select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id


[2016-02-18 11:57:31.203] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:57:31.554] [029861] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171993

[2016-02-18 11:58:35.202] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:58:35.317] [029861] [dwh-prod] [PGSQL]
create table t1 as
    select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id


[2016-02-18 11:58:36.640] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 11:58:59.301] [019230] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'moiram'

[2016-02-18 11:59:04.676] [019229] [dwh-prod] [PGSQL]
SELECT oid, spcname, pg_get_userbyid(spcowner) AS owner, pg_tablespace_location(oid) As spclocation, spcacl, shobj_description(oid, 'pg_tablespace') AS comment FROM pg_tablespace

[2016-02-18 11:59:04.759] [019229] [dwh-prod] [PGSQL]
SELECT rolname, rolsuper, rolinherit, rolcreaterole, rolcreatedb, rolcatupdate, rolcanlogin, rolconnlimit, rolvaliduntil, rolconfig, oid , pg_catalog.shobj_description(oid, 'pg_authid') AS comment FROM pg_roles 

[2016-02-18 11:59:04.882] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, ns.nspname, t.typname, t.typtype, t.typrelid, t.typinput, t.typoutput, t.typlen, t.typdefault, t.typelem, t.typdelim, t.typalign, t.typstorage, t.typbyval, pg_get_userbyid(t.typowner) AS typeowner, e.typname AS element, e.typnamespace AS elementschemaoid, description, ct.oid AS taboid FROM pg_type t JOIN pg_namespace ns ON ns.oid=t.typnamespace LEFT JOIN pg_type e ON e.oid=t.typelem LEFT JOIN pg_class ct ON ct.oid=t.typrelid AND ct.relkind <> 'c' LEFT JOIN pg_description des ON des.objoid=t.oid WHERE t.typtype != 'd' AND (ct.oid IS NULL OR ct.oid = 0) ORDER BY t.typname

[2016-02-18 11:59:08.234] [019230] [dwh-prod] [PGSQL]
SELECT DISTINCT oprname FROM pg_catalog.pg_operator

[2016-02-18 11:59:08.328] [019230] [dwh-prod] [PGSQL]
SELECT collname FROM pg_collation

[2016-02-18 11:59:09.468] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 11:59:10.361] [019230] [dwh-prod] [PGSQL]
SELECT p.oid, p.proname, p.proargtypes, p.proacl, p.prorettype, p.prosecdef, p.proisstrict, p.proretset, p.provolatile, p.prosrc, p.probin, obj_description(p.oid) AS comment, pg_get_userbyid(p.proowner) AS funcowner, typ.typname, typns.nspname, lng.lanname , p.proargnames , p.proargmodes, p.proallargtypes , p.procost, p.prorows, p.proconfig , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace typns ON typns.oid=typ.typnamespace JOIN pg_namespace prons ON prons.oid=p.pronamespace JOIN pg_language lng ON lng.oid=p.prolang WHERE proisagg = false AND typ.typname = 'trigger' AND prons.nspname = 'pg_catalog' 

[2016-02-18 11:59:10.750] [019230] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'moiram' AND c.relname = 't1'

[2016-02-18 11:59:10.838] [019230] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'moiram' AND col.table_name = 't1' ORDER BY col.table_name, col.ordinal_position

[2016-02-18 11:59:10.938] [019230] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-18 11:59:11.020] [019230] [dwh-prod] [PGSQL]
SELECT oid, collname FROM pg_collation

[2016-02-18 11:59:11.261] [019230] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS table_name, am.amname, i.indexrelid, i.indisunique, i.indisclustered, i.indisprimary, i.indkey, i.indclass, obj_description(indexrelid) , i.indnatts, pg_get_expr(indpred, indrelid, true) AS indconstraint, pa.rolname AS owner, ts.spcname, ci.reloptions, i.indoption, i.indcollation FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid LEFT JOIN pg_roles pa ON pa.oid = ci.relowner WHERE tns.nspname = 'moiram' AND ct.relname = 't1' AND conname IS NULL ORDER BY ct.relname, ins.nspname, ci.relname

[2016-02-18 11:59:11.346] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, (current_database())::information_schema.sql_identifier AS trigger_catalog, (n.nspname)::information_schema.sql_identifier AS trigger_schema, (t.tgname)::information_schema.sql_identifier AS trigger_name, (c.relname)::information_schema.sql_identifier AS trigger_table_name, (em.text)::information_schema.character_data AS event_manipulation, (current_database())::information_schema.sql_identifier AS event_object_catalog, (n.nspname)::information_schema.sql_identifier AS event_object_schema, (c.relname)::information_schema.sql_identifier AS event_object_table, (c.relkind)::information_schema.sql_identifier AS event_object_table_type, (nsp.nspname)::information_schema.sql_identifier AS constraint_referenced_table_schema, (cs.relname)::information_schema.sql_identifier AS constraint_referenced_table_name, (t.tgdeferrable) AS constraint_deferrable_identifier, (t.tginitdeferred) AS constraint_deferred_type, (NULL::information_schema.cardinal_number)::information_schema.cardinal_number AS action_order, (CASE WHEN pg_has_role(c.relowner, 'USAGE'::text) THEN (SELECT rm.m[1] AS m FROM regexp_matches(pg_get_triggerdef(t.oid), (E'.{35,} WHEN \\((.+)\\) EXECUTE PROCEDURE'::text)) rm(m) LIMIT 1) ELSE NULL::text END)::information_schema.character_data AS action_condition, (NULL::information_schema.character_data)::information_schema.character_data AS action_condition, ("substring"(pg_get_triggerdef(t.oid), ("position"("substring"(pg_get_triggerdef(t.oid), 48), 'EXECUTE PROCEDURE'::text) + 47)))::information_schema.character_data AS action_statement, (CASE WHEN (((t.tgtype)::integer & 1) = 1) THEN 'ROW'::text ELSE 'STATEMENT'::text END)::information_schema.character_data AS action_orientation, (CASE WHEN (((t.tgtype)::integer & 2) = 2) THEN 'BEFORE'::text ELSE 'AFTER'::text END)::information_schema.character_data AS condition_timing, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_old_table, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_new_table, (t.tgconstraint) AS constraint_identifier, tc.event_object_column, obj_description(t.oid) FROM pg_namespace n LEFT JOIN pg_class c ON (n.oid = c.relnamespace) INNER JOIN pg_trigger t ON (c.oid = t.tgrelid) LEFT JOIN information_schema.triggered_update_columns tc ON (tc.trigger_schema = n.nspname) AND (tc.trigger_name = t.tgname) AND (tc.event_object_schema = n.nspname) AND (tc.event_object_table = c.relname)LEFT JOIN pg_user u ON (c.relowner = u.usesysid) LEFT JOIN (((SELECT 4, 'INSERT' UNION ALL SELECT 8, 'DELETE') UNION ALL SELECT 16, 'UPDATE') UNION ALL SELECT 32, 'TRUNCATE') em(num, text) ON (((t.tgtype)::integer & em.num) <> 0) LEFT OUTER JOIN (SELECT oid, relnamespace, relname FROM pg_class) cs ON (t.tgconstrrelid = cs.oid) LEFT OUTER JOIN (SELECT oid, nspname FROM pg_namespace) nsp ON (cs.relnamespace = nsp.oid) WHERE true AND n.nspname = 'moiram' AND c.relname = 't1' AND (not t.tgisinternal) ORDER BY c.relname, t.tgname

[2016-02-18 11:59:11.432] [019230] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-18 11:59:11.762] [019230] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-18 11:59:11.847] [019230] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'moiram' AND ct.relname = 't1' AND conname IS NOT NULL

[2016-02-18 11:59:11.932] [019230] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'moiram' AND t.relname = 't1' ORDER BY t.relname, i.oid

[2016-02-18 11:59:12.016] [019230] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'moiram' AND t.relname = 't1' ORDER BY t.relname, c.conname, a.attnum

[2016-02-18 11:59:12.097] [019230] [dwh-prod] [PGSQL]
SELECT n.nspname AS rule_schema, c.relname, r.rulename, r.oid, r.ev_type, r.is_instead, pg_get_ruledef(r.oid) AS definition, obj_description(r.oid) AS comment FROM ((pg_rewrite r JOIN pg_class c ON ((c.oid = r.ev_class))) LEFT JOIN pg_namespace n ON ((n.oid = c.relnamespace))) WHERE (r.rulename <> '_RETURN'::name) AND (n.nspname='moiram') AND (c.relname='t1')

[2016-02-18 11:59:12.190] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 11:59:12.860] [019230] [dwh-prod] [PGSQL]
SELECT p.oid, p.proname, p.proargtypes, p.proacl, p.prorettype, p.prosecdef, p.proisstrict, p.proretset, p.provolatile, p.prosrc, p.probin, obj_description(p.oid) AS comment, pg_get_userbyid(p.proowner) AS funcowner, typ.typname, typns.nspname, lng.lanname , p.proargnames , p.proargmodes, p.proallargtypes , p.procost, p.prorows, p.proconfig , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace typns ON typns.oid=typ.typnamespace JOIN pg_namespace prons ON prons.oid=p.pronamespace JOIN pg_language lng ON lng.oid=p.prolang WHERE proisagg = false AND typ.typname = 'trigger' AND prons.nspname = 'moiram' 

[2016-02-18 11:59:12.952] [019230] [dwh-prod] [PGSQL]
SELECT table_name FROM information_schema.tables WHERE table_schema = '' AND table_type = 'BASE TABLE'

[2016-02-18 11:59:30.534] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 11:59:31.220] [019230] [dwh-prod] [PGSQL]
SELECT p.oid, p.proname, p.proargtypes, p.proacl, p.prorettype, p.prosecdef, p.proisstrict, p.proretset, p.provolatile, p.prosrc, p.probin, obj_description(p.oid) AS comment, pg_get_userbyid(p.proowner) AS funcowner, typ.typname, typns.nspname, lng.lanname , p.proargnames , p.proargmodes, p.proallargtypes , p.procost, p.prorows, p.proconfig , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace typns ON typns.oid=typ.typnamespace JOIN pg_namespace prons ON prons.oid=p.pronamespace JOIN pg_language lng ON lng.oid=p.prolang WHERE proisagg = false AND typ.typname = 'trigger' AND prons.nspname = 'moiram' 

[2016-02-18 11:59:31.313] [019230] [dwh-prod] [PGSQL]
SELECT table_name FROM information_schema.tables WHERE table_schema = '' AND table_type = 'BASE TABLE'

[2016-02-18 12:00:03.436] [008755] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 12:00:03.515] [019230] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'moiram' AND col.table_name = 't1' ORDER BY col.table_name, col.ordinal_position

[2016-02-18 12:00:03.615] [019230] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-18 12:00:03.980] [019230] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-18 12:00:04.062] [019230] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'moiram' AND ct.relname = 't1' AND conname IS NOT NULL

[2016-02-18 12:00:04.143] [019230] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'moiram' AND t.relname = 't1' ORDER BY t.relname, i.oid

[2016-02-18 12:00:04.231] [019230] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'moiram' AND t.relname = 't1' ORDER BY t.relname, c.conname, a.attnum

[2016-02-18 12:00:04.446] [008755] [dwh-prod] [PGSQL]
SELECT * FROM "moiram"."t1" LIMIT 1000 OFFSET 0

[2016-02-18 12:00:04.693] [008755] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'moiram' AND cl.table_name = 't1'

[2016-02-18 12:00:04.793] [008755] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6172815

[2016-02-18 12:01:05.045] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:01:05.226] [029861] [dwh-prod] [PGSQL]
select t1.user_behavior_segment, count(1)
from t1
join common.engagement_level e
 on t1.user_behavior_segment = e.user_behavior_segment;


[2016-02-18 12:01:05.313] [029861] [dwh-prod] [PGSQL]
ERROR:  column "t1.user_behavior_segment" must appear in the GROUP BY clause or be used in an aggregate function
LINE 1: select t1.user_behavior_segment, count(1)
               ^


[2016-02-18 12:01:05.326] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:01:26.427] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:01:26.531] [029861] [dwh-prod] [PGSQL]
select t1.user_behavior_segment, count(1)
from t1
join common.engagement_level e
 on t1.user_behavior_segment = e.user_behavior_segment
group by t1.user_behavior_segment;


[2016-02-18 12:01:26.622] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:01:26.955] [029861] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6172815

[2016-02-18 12:02:09.368] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:02:09.470] [029861] [dwh-prod] [PGSQL]
select distinct user_behavior_segment from t1;
select distinct user_behavior_segment from common.engagement_level;


[2016-02-18 12:02:09.615] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:02:09.940] [029861] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6172815

[2016-02-18 12:02:10.318] [029861] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6172794

[2016-02-18 12:02:36.810] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:02:36.931] [029861] [dwh-prod] [PGSQL]

select * from common.engagement_level;


[2016-02-18 12:02:37.022] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:02:37.351] [029861] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6172794

[2016-02-18 12:03:51.353] [024572] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:03:51.472] [024572] [dwh-prod] [PGSQL]
drop table if exists common.engagement_level;

create table common.engagement_level (
   user_behavior_segment varchar(255),
   tenure_cat_low   integer,
   tenure_cat_high  integer,
   days_since_last_video_view_low integer,
   days_since_last_video_view_high integer,
   engagement_level varchar(10)
);


alter table common.engagement_level owner to dw_admin;

insert into common.engagement_level values('My Yoga',0,120,0,20,'High');
insert into common.engagement_level values('My Yoga',0,120,21,30,'Medium');
insert into common.engagement_level values('My Yoga',0,120,31,70,'Low');
insert into common.engagement_level values('My Yoga',0,120,71,999999,'Dormant');
insert into common.engagement_level values('My Yoga',121,395,0,20,'High');
insert into common.engagement_level values('My Yoga',121,395,21,45,'Medium');
insert into common.engagement_level values('My Yoga',121,395,46,90,'Low');
insert into common.engagement_level values('My Yoga',121,395,91,999999,'Dormant');
insert into common.engagement_level values('My Yoga',396,999999,0,20,'High');
insert into common.engagement_level values('My Yoga',396,999999,21,45,'Medium');
insert into common.engagement_level values('My Yoga',396,999999,46,90,'Low');
insert into common.engagement_level values('My Yoga',396,999999,91,999999,'Dormant');

insert into common.engagement_level values('Spiritual Growth',0,120,0,10,'High');
insert into common.engagement_level values('Spiritual Growth',0,120,11,25,'Medium');
insert into common.engagement_level values('Spiritual Growth',0,120,26,60,'Low');
insert into common.engagement_level values('Spiritual Growth',0,120,61,999999,'Dormant');
insert into common.engagement_level values('Spiritual Growth',121,395,0,14,'High');
insert into common.engagement_level values('Spiritual Growth',121,395,15,25,'Medium');
insert into common.engagement_level values('Spiritual Growth',121,395,26,90,'Low');
insert into common.engagement_level values('Spiritual Growth',121,395,91,999999,'Dormant');
insert into common.engagement_level values('Spiritual Growth',396,999999,0,14,'High');
insert into common.engagement_level values('Spiritual Growth',396,999999,15,30,'Medium');
insert into common.engagement_level values('Spiritual Growth',396,999999,31,90,'Low');
insert into common.engagement_level values('Spiritual Growth',396,999999,91,999999,'Dormant');

insert into common.engagement_level values('Seeking Truth',0,120,0,6,'High');
insert into common.engagement_level values('Seeking Truth',0,120,7,14,'Medium');
insert into common.engagement_level values('Seeking Truth',0,120,15,45,'Low');
insert into common.engagement_level values('Seeking Truth',0,120,46,999999,'Dormant');
insert into common.engagement_level values('Seeking Truth',121,395,0,10,'High');
insert into common.engagement_level values('Seeking Truth',121,395,11,17,'Medium');
insert into common.engagement_level values('Seeking Truth',121,395,18,90,'Low');
insert into common.engagement_level values('Seeking Truth',121,395,91,999999,'Dormant');
insert into common.engagement_level values('Seeking Truth',396,999999,0,10,'High');
insert into common.engagement_level values('Seeking Truth',396,999999,11,17,'Medium');
insert into common.engagement_level values('Seeking Truth',396,999999,18,90,'Low');
insert into common.engagement_level values('Seeking Truth',396,999999,91,999999,'Dormant');

insert into common.engagement_level values('No Clear Segment',0,120,0,10,'High');
insert into common.engagement_level values('No Clear Segment',0,120,11,25,'Medium');
insert into common.engagement_level values('No Clear Segment',0,120,26,60,'Low');
insert into common.engagement_level values('No Clear Segment',0,120,61,999999,'Dormant');
insert into common.engagement_level values('No Clear Segment',121,395,0,14,'High');
insert into common.engagement_level values('No Clear Segment',121,395,15,25,'Medium');
insert into common.engagement_level values('No Clear Segment',121,395,26,90,'Low');
insert into common.engagement_level values('No Clear Segment',121,395,91,999999,'Dormant');
insert into common.engagement_level values('No Clear Segment',396,999999,0,14,'High');
insert into common.engagement_level values('No Clear Segment',396,999999,15,30,'Medium');
insert into common.engagement_level values('No Clear Segment',396,999999,31,90,'Low');
insert into common.engagement_level values('No Clear Segment',396,999999,91,999999,'Dormant');


[2016-02-18 12:03:51.591] [024572] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:04:03.244] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:04:03.370] [029861] [dwh-prod] [PGSQL]
drop table if exists tmp.engagement_level;

create table tmp.engagement_level as 
(select gcsi_user_id,
    u.user_behavior_segment,
    subscription_age,
    days_since_last_video_view,
    case when u.user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_video_view >= days_since_last_video_view_low and
       u.days_since_last_video_view <= days_since_last_video_view_high);



select user_behavior_segment, subscription_age, days_since_last_video_view, engagement_level, count(1)
from tmp.engagement_level
group by user_behavior_segment, subscription_age, days_since_last_video_view, engagement_level;

/*
select t1.user_behavior_segment, count(1)
from t1
join common.engagement_level e
 on t1.user_behavior_segment = e.user_behavior_segment
group by t1.user_behavior_segment;

select distinct user_behavior_segment from t1;
select distinct user_behavior_segment from common.engagement_level;

select * from common.engagement_level;
*/


[2016-02-18 12:04:17.427] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:04:17.808] [029861] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6172824

[2016-02-18 12:21:11.859] [015343] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 12:21:11.939] [015343] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-18 12:21:12.278] [015342] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 12:21:12.358] [015342] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-18 12:21:12.451] [015342] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 12:21:12.562] [015342] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-18 12:21:12.653] [015342] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 12:21:13.253] [015342] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 12:21:13.332] [015342] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 12:21:13.418] [015342] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-18 12:21:13.504] [015342] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 12:21:13.587] [015342] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-18 12:21:13.669] [015342] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 12:21:13.950] [015342] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 12:21:14.029] [015342] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 12:21:14.113] [015342] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-18 12:21:14.195] [015342] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-18 12:21:40.412] [015465] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 12:21:40.492] [015465] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 12:21:40.596] [015465] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-18 12:21:40.682] [015465] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 12:21:41.277] [015465] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 12:21:41.357] [015465] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 12:21:41.446] [015465] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-18 12:22:07.405] [015630] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 12:22:07.491] [015630] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='user_dim' ORDER BY ordinal_position

[2016-02-18 12:22:19.597] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:22:19.735] [015343] [dwh-prod] [PGSQL]
drop table if exists t1;

create table t1 as
(select * from common.user_dim 
 order by random()
 limit 100);


[2016-02-18 12:22:20.216] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:23:04.145] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:23:04.242] [015343] [dwh-prod] [PGSQL]
select user_behavior_segment, Count(1) from t1;


[2016-02-18 12:23:04.322] [015343] [dwh-prod] [PGSQL]
ERROR:  column "t1.user_behavior_segment" must appear in the GROUP BY clause or be used in an aggregate function
LINE 1: select user_behavior_segment, Count(1) from t1;
               ^


[2016-02-18 12:23:04.334] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:23:10.616] [015935] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 12:23:10.696] [015935] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='moiram' AND table_name='t1' ORDER BY ordinal_position

[2016-02-18 12:23:20.125] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:23:20.222] [015343] [dwh-prod] [PGSQL]
select user_behavior_segment, Count(1) from t1
group by user_behavior_segment;


[2016-02-18 12:23:20.313] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:23:20.632] [015343] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6172830

[2016-02-18 12:23:39.204] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:23:39.306] [015343] [dwh-prod] [PGSQL]
drop table if exists t1;

create table t1 as
(select * from common.user_dim 
 where user_behavior_segment is not null
 order by random()
 limit 100);

select user_behavior_segment, Count(1) from t1
group by user_behavior_segment;


[2016-02-18 12:23:39.600] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:23:39.948] [015343] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6172836

[2016-02-18 12:29:35.171] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:29:35.290] [015343] [dwh-prod] [PGSQL]
with engagement_level as 
((select gcsi_user_id,
    case when u.user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_video_view >= days_since_last_video_view_low and
       u.days_since_last_video_view <= days_since_last_video_view_high)
update t1 set engagement_level = e.engagement_level
from t1, engagement_level e
where t1.gcsi_user_id = e.gcsi_user_id;


[2016-02-18 12:29:35.370] [015343] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "update"
LINE 24: update t1 set engagement_level = e.engagement_level
         ^


[2016-02-18 12:29:35.391] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:29:54.498] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:29:54.619] [015343] [dwh-prod] [PGSQL]
with engagement_level as 
(select gcsi_user_id,
    case when u.user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_video_view >= days_since_last_video_view_low and
       u.days_since_last_video_view <= days_since_last_video_view_high)
update t1 set engagement_level = e.engagement_level
from t1, engagement_level e
where t1.gcsi_user_id = e.gcsi_user_id;


[2016-02-18 12:29:54.701] [015343] [dwh-prod] [PGSQL]
ERROR:  table name "t1" specified more than once


[2016-02-18 12:29:54.722] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:30:20.531] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:30:20.670] [015343] [dwh-prod] [PGSQL]
with engagement_level as 
(select gcsi_user_id,
    case when u.user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_video_view >= days_since_last_video_view_low and
       u.days_since_last_video_view <= days_since_last_video_view_high)
update t1 set engagement_level = e.engagement_level
from  engagement_level e
where t1.gcsi_user_id = e.gcsi_user_id;


[2016-02-18 12:30:20.769] [015343] [dwh-prod] [PGSQL]
ERROR:  column "engagement_level" of relation "t1" does not exist
LINE 24: update t1 set engagement_level = e.engagement_level
                       ^


[2016-02-18 12:30:20.789] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:31:01.182] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:31:01.288] [015343] [dwh-prod] [PGSQL]
alter table t1 add engagement_level (varchar(10);


[2016-02-18 12:31:01.428] [015343] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "("
LINE 1: alter table t1 add engagement_level (varchar(10);
                                            ^


[2016-02-18 12:31:01.439] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:31:14.934] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:31:15.042] [015343] [dwh-prod] [PGSQL]
alter table t1 add (engagement_level varchar(10));


[2016-02-18 12:31:15.123] [015343] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "("
LINE 1: alter table t1 add (engagement_level varchar(10));
                           ^


[2016-02-18 12:31:15.134] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:31:36.439] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:31:36.546] [015343] [dwh-prod] [PGSQL]
alter table t1 add engagement_level varchar(10);


[2016-02-18 12:31:36.639] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:31:42.382] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:31:42.507] [015343] [dwh-prod] [PGSQL]
with engagement_level as 
(select gcsi_user_id,
    case when u.user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_video_view >= days_since_last_video_view_low and
       u.days_since_last_video_view <= days_since_last_video_view_high)
update t1 set engagement_level = e.engagement_level
from  engagement_level e
where t1.gcsi_user_id = e.gcsi_user_id;


[2016-02-18 12:31:48.343] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:32:05.915] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:32:06.026] [015343] [dwh-prod] [PGSQL]
select * from t1;


[2016-02-18 12:32:06.278] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:32:06.598] [015343] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6172836

[2016-02-18 12:33:10.334] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:33:10.440] [015343] [dwh-prod] [PGSQL]
select user_start_date, user_behavior_segment, last_video_view_date, engagement_level from t1;


[2016-02-18 12:33:10.531] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:33:10.842] [015343] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6172836

[2016-02-18 12:34:30.832] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:34:30.960] [015343] [dwh-prod] [PGSQL]
drop table if exists t1;

create table t1 as
(select * from common.user_dim 
 where user_behavior_segment is not null AND
       last_video_view_date > '20151215'::date
 order by random()
 limit 100);



with engagement_level as 
(select gcsi_user_id,
    case when u.user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_video_view >= days_since_last_video_view_low and
       u.days_since_last_video_view <= days_since_last_video_view_high)
update t1 set engagement_level = e.engagement_level
from  engagement_level e
where t1.gcsi_user_id = e.gcsi_user_id;

alter table t1 add engagement_level varchar(10);

select user_start_date, user_behavior_segment, last_video_view_date, engagement_level from t1;


[2016-02-18 12:34:31.164] [015343] [dwh-prod] [PGSQL]
ERROR:  column "engagement_level" of relation "t1" does not exist
LINE 35: update t1 set engagement_level = e.engagement_level
                       ^


[2016-02-18 12:34:31.193] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:34:50.594] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:34:50.713] [015343] [dwh-prod] [PGSQL]
drop table if exists t1;

create table t1 as
(select * from common.user_dim 
 where user_behavior_segment is not null AND
       last_video_view_date > '20151215'::date
 order by random()
 limit 100);

alter table t1 add engagement_level varchar(10);

with engagement_level as 
(select gcsi_user_id,
    case when u.user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_video_view >= days_since_last_video_view_low and
       u.days_since_last_video_view <= days_since_last_video_view_high)
update t1 set engagement_level = e.engagement_level
from  engagement_level e
where t1.gcsi_user_id = e.gcsi_user_id;



select user_start_date, user_behavior_segment, last_video_view_date, engagement_level from t1;


[2016-02-18 12:34:56.651] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:34:57.030] [015343] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6172848

[2016-02-18 12:36:43.695] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:36:43.801] [015343] [dwh-prod] [PGSQL]
alter table common.user_dim add engagement_level varchar(10);


[2016-02-18 12:36:43.900] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:36:58.852] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:36:58.971] [029861] [dwh-prod] [PGSQL]
with engagement_level as 
(select gcsi_user_id,
    case when u.user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_video_view >= days_since_last_video_view_low and
       u.days_since_last_video_view <= days_since_last_video_view_high)
update common.user_dim u set engagement_level = e.engagement_level
from  engagement_level e
where u.gcsi_user_id = e.gcsi_user_id;


[2016-02-18 12:37:11.716] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:38:01.004] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:38:01.115] [015343] [dwh-prod] [PGSQL]
select engagement_level, count(1)
from common.user_dim
group by engagement_level;


[2016-02-18 12:38:01.396] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:38:01.708] [015343] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171993

[2016-02-18 12:38:41.809] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:38:41.926] [015343] [dwh-prod] [PGSQL]
select * from common.user_dim where engagement_level is null;


[2016-02-18 12:38:45.753] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:38:46.066] [015343] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171993

[2016-02-18 12:39:55.466] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:39:55.577] [015343] [dwh-prod] [PGSQL]
select status, count(1)
 from common.user_dim  ud
join subscription_d sd
on ud.current_subscription = sd.subscription_id
where engagement_level is null;


[2016-02-18 12:39:55.658] [015343] [dwh-prod] [PGSQL]
ERROR:  column "sd.status" must appear in the GROUP BY clause or be used in an aggregate function
LINE 1: select status, count(1)
               ^


[2016-02-18 12:39:55.671] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:40:06.655] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:40:06.758] [015343] [dwh-prod] [PGSQL]
select status, count(1)
 from common.user_dim  ud
join subscription_d sd
on ud.current_subscription = sd.subscription_id
where engagement_level is null
group by status;


[2016-02-18 12:40:06.998] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:40:07.255] [015343] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6172011

[2016-02-18 12:41:46.597] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:41:46.701] [015343] [dwh-prod] [PGSQL]
select user_behavior_segment, count(1)
from common.user_dim
where engagement_level is null
group by user_behavior_segment;


[2016-02-18 12:41:46.867] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:41:47.178] [015343] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171993

[2016-02-18 12:44:16.659] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:44:16.762] [015343] [dwh-prod] [PGSQL]
select status, date_part('day',current_date - sd.start_date) subscription_age,count(1)
 from common.user_dim  ud
join subscription_d sd
on ud.current_subscription = sd.subscription_id
where engagement_level is null
group by status,date_part('day',current_date - sd.start_date);


[2016-02-18 12:44:17.643] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:44:17.957] [015343] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6172011

[2016-02-18 12:45:56.750] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:45:56.854] [015343] [dwh-prod] [PGSQL]
create table t2 as 
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id);


[2016-02-18 12:45:57.995] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:47:49.020] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:47:49.131] [015343] [dwh-prod] [PGSQL]
select count(1) from common.user_dim;


[2016-02-18 12:47:49.268] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:49:07.830] [024180] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 12:49:07.913] [024180] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='subscription_d' ORDER BY ordinal_position

[2016-02-18 12:49:45.862] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:49:45.964] [015343] [dwh-prod] [PGSQL]
select count(1)
from common.user_dim ud
join common.subscription_d sd
on ud.current_subscription = sd.subscription_id;


[2016-02-18 12:49:46.291] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:58:47.394] [029861] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 12:58:47.518] [029861] [dwh-prod] [PGSQL]
with engagement_level as 
(select gcsi_user_id,
    case when u.user_behavior_segment is null then 
         case when subscription_age <= 90 
              then 'Low' 
              else 'Dormant'
         end
         else e.engagement_level
    end engagement_level
from
    (select ud.gcsi_user_id,
            date_part('day',current_date - ud.last_video_view_date) days_since_last_video_view,
            date_part('day',current_date - sd.start_date) subscription_age,
            ud.user_behavior_segment
     from common.user_dim ud
     join common.subscription_d sd
        on ud.current_subscription = sd.subscription_id) u
left join common.engagement_level e
    on u.user_behavior_segment = e.user_behavior_segment and
       u.subscription_age >= e.tenure_cat_low and
       u.subscription_age <= e.tenure_cat_high and
       u.days_since_last_video_view >= days_since_last_video_view_low and
       u.days_since_last_video_view <= days_since_last_video_view_high)
update common.user_dim u set engagement_level = e.engagement_level
from  engagement_level e
where u.gcsi_user_id = e.gcsi_user_id;


[2016-02-18 12:58:58.280] [029861] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 13:00:11.372] [015343] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 13:00:11.479] [015343] [dwh-prod] [PGSQL]
select engagement_level, count(1)
from  common.user_dim
group by engagement_level;


[2016-02-18 13:00:11.704] [015343] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 13:00:12.016] [015343] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171993

[2016-02-18 13:57:19.836] [017918] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 13:57:19.913] [017918] [dwh-dev] [PGSQL]
SHOW search_path

[2016-02-18 13:57:20.188] [017917] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 13:57:20.266] [017917] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-18 13:57:20.386] [017917] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 13:57:20.488] [017917] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-18 13:57:20.576] [017917] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 13:57:21.005] [017917] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 13:57:21.084] [017917] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 13:57:21.189] [017917] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-18 13:57:21.269] [017917] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 13:57:21.364] [017917] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-18 13:57:21.459] [017917] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 13:57:21.728] [017917] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 13:57:21.807] [017917] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 13:57:21.891] [017917] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-18 13:57:21.971] [017917] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-18 13:57:25.026] [017918] [dwh-dev] [PGSQL]
SET search_path TO "common","$user", gcsi, drupal, public

[2016-02-18 13:57:25.165] [017918] [dwh-dev] [PGSQL]
drop table if exists common.engagement_level;

create table common.engagement_level (
   user_behavior_segment varchar(255),
   tenure_cat_low   integer,
   tenure_cat_high  integer,
   days_since_last_video_view_low integer,
   days_since_last_video_view_high integer,
   engagement_level varchar(10)
);


alter table common.engagement_level owner to dw_admin;

insert into common.engagement_level values('My Yoga',0,120,0,20,'High');
insert into common.engagement_level values('My Yoga',0,120,21,30,'Medium');
insert into common.engagement_level values('My Yoga',0,120,31,70,'Low');
insert into common.engagement_level values('My Yoga',0,120,71,999999,'Dormant');
insert into common.engagement_level values('My Yoga',121,395,0,20,'High');
insert into common.engagement_level values('My Yoga',121,395,21,45,'Medium');
insert into common.engagement_level values('My Yoga',121,395,46,90,'Low');
insert into common.engagement_level values('My Yoga',121,395,91,999999,'Dormant');
insert into common.engagement_level values('My Yoga',396,999999,0,20,'High');
insert into common.engagement_level values('My Yoga',396,999999,21,45,'Medium');
insert into common.engagement_level values('My Yoga',396,999999,46,90,'Low');
insert into common.engagement_level values('My Yoga',396,999999,91,999999,'Dormant');

insert into common.engagement_level values('Spiritual Growth',0,120,0,10,'High');
insert into common.engagement_level values('Spiritual Growth',0,120,11,25,'Medium');
insert into common.engagement_level values('Spiritual Growth',0,120,26,60,'Low');
insert into common.engagement_level values('Spiritual Growth',0,120,61,999999,'Dormant');
insert into common.engagement_level values('Spiritual Growth',121,395,0,14,'High');
insert into common.engagement_level values('Spiritual Growth',121,395,15,25,'Medium');
insert into common.engagement_level values('Spiritual Growth',121,395,26,90,'Low');
insert into common.engagement_level values('Spiritual Growth',121,395,91,999999,'Dormant');
insert into common.engagement_level values('Spiritual Growth',396,999999,0,14,'High');
insert into common.engagement_level values('Spiritual Growth',396,999999,15,30,'Medium');
insert into common.engagement_level values('Spiritual Growth',396,999999,31,90,'Low');
insert into common.engagement_level values('Spiritual Growth',396,999999,91,999999,'Dormant');

insert into common.engagement_level values('Seeking Truth',0,120,0,6,'High');
insert into common.engagement_level values('Seeking Truth',0,120,7,14,'Medium');
insert into common.engagement_level values('Seeking Truth',0,120,15,45,'Low');
insert into common.engagement_level values('Seeking Truth',0,120,46,999999,'Dormant');
insert into common.engagement_level values('Seeking Truth',121,395,0,10,'High');
insert into common.engagement_level values('Seeking Truth',121,395,11,17,'Medium');
insert into common.engagement_level values('Seeking Truth',121,395,18,90,'Low');
insert into common.engagement_level values('Seeking Truth',121,395,91,999999,'Dormant');
insert into common.engagement_level values('Seeking Truth',396,999999,0,10,'High');
insert into common.engagement_level values('Seeking Truth',396,999999,11,17,'Medium');
insert into common.engagement_level values('Seeking Truth',396,999999,18,90,'Low');
insert into common.engagement_level values('Seeking Truth',396,999999,91,999999,'Dormant');

insert into common.engagement_level values('No Clear Segment',0,120,0,10,'High');
insert into common.engagement_level values('No Clear Segment',0,120,11,25,'Medium');
insert into common.engagement_level values('No Clear Segment',0,120,26,60,'Low');
insert into common.engagement_level values('No Clear Segment',0,120,61,999999,'Dormant');
insert into common.engagement_level values('No Clear Segment',121,395,0,14,'High');
insert into common.engagement_level values('No Clear Segment',121,395,15,25,'Medium');
insert into common.engagement_level values('No Clear Segment',121,395,26,90,'Low');
insert into common.engagement_level values('No Clear Segment',121,395,91,999999,'Dormant');
insert into common.engagement_level values('No Clear Segment',396,999999,0,14,'High');
insert into common.engagement_level values('No Clear Segment',396,999999,15,30,'Medium');
insert into common.engagement_level values('No Clear Segment',396,999999,31,90,'Low');
insert into common.engagement_level values('No Clear Segment',396,999999,91,999999,'Dormant');


[2016-02-18 13:57:25.396] [017918] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-18 14:38:57.989] [025937] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 14:38:58.069] [025937] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-18 14:38:58.299] [025936] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 14:38:58.380] [025936] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-18 14:38:58.477] [025936] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 14:38:58.568] [025936] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-18 14:38:58.651] [025936] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 14:38:59.256] [025936] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 14:38:59.338] [025936] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 14:38:59.425] [025936] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-18 14:38:59.508] [025936] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 14:38:59.589] [025936] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-18 14:38:59.671] [025936] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 14:38:59.952] [025936] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 14:39:00.033] [025936] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 14:39:00.117] [025936] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-18 14:39:00.203] [025936] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-18 14:41:42.402] [026750] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 14:41:42.488] [026750] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 14:41:42.597] [026750] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-18 14:41:42.686] [026750] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 14:41:43.289] [026750] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 14:41:43.370] [026750] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 14:41:43.459] [026750] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-18 14:41:47.340] [026834] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 14:41:47.421] [026834] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_d' ORDER BY ordinal_position

[2016-02-18 14:41:59.584] [025937] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 14:41:59.690] [025937] [dwh-prod] [PGSQL]
select count(1) from common.video_d where admin_category = 'Yoga';


[2016-02-18 14:41:59.845] [025937] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 14:42:39.752] [027042] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 14:42:39.835] [027042] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'drupal') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-18 14:42:40.161] [027042] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='drupal' ORDER BY schemaname, viewname

[2016-02-18 14:42:40.244] [027042] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 14:42:40.766] [027042] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-18 14:42:40.845] [027042] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'drupal' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-18 14:42:40.935] [027042] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'drupal' 

[2016-02-18 14:43:00.156] [027172] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 14:43:00.235] [027172] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='drupal' AND table_name='node' ORDER BY ordinal_position

[2016-02-18 14:43:22.592] [025937] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 14:43:22.709] [025937] [dwh-prod] [PGSQL]
select count(1) from common.video_d v
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1;


[2016-02-18 14:43:22.838] [025937] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:02:47.329] [000853] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 15:02:47.409] [019230] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'category_groups' ORDER BY col.table_name, col.ordinal_position

[2016-02-18 15:02:47.508] [019230] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-18 15:02:47.903] [019230] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-18 15:02:47.988] [019230] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'category_groups' AND conname IS NOT NULL

[2016-02-18 15:02:48.070] [019230] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'category_groups' ORDER BY t.relname, i.oid

[2016-02-18 15:02:48.154] [019230] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'category_groups' ORDER BY t.relname, c.conname, a.attnum

[2016-02-18 15:02:48.348] [000853] [dwh-prod] [PGSQL]
SELECT * FROM "common"."category_groups" LIMIT 1000 OFFSET 0

[2016-02-18 15:02:48.595] [000853] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'category_groups'

[2016-02-18 15:02:48.694] [000853] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171815

[2016-02-18 15:03:52.294] [001167] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 15:03:52.373] [001167] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='category_groups' ORDER BY ordinal_position

[2016-02-18 15:07:50.187] [025937] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:07:50.300] [025937] [dwh-prod] [PGSQL]
select media_nid
from common.video_d v
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
except select media_nid
from common.video_d
where category_gid in 
(select distinct gid 
from common.category_groups 
where name in ('Yoga Talks', 
'Yoga Tutorials', 
'Meditation', 
'Mind Body TV', 
'Pilates & Dance', 
'Tai Chi & Eastern Arts',
'All Fitness'))


[2016-02-18 15:07:50.380] [025937] [dwh-prod] [PGSQL]
ERROR:  column "category_gid" does not exist
LINE 9: where category_gid in 
              ^


[2016-02-18 15:07:50.397] [025937] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:08:11.835] [019229] [dwh-prod] [PGSQL]
SELECT oid, spcname, pg_get_userbyid(spcowner) AS owner, pg_tablespace_location(oid) As spclocation, spcacl, shobj_description(oid, 'pg_tablespace') AS comment FROM pg_tablespace

[2016-02-18 15:08:11.917] [019229] [dwh-prod] [PGSQL]
SELECT rolname, rolsuper, rolinherit, rolcreaterole, rolcreatedb, rolcatupdate, rolcanlogin, rolconnlimit, rolvaliduntil, rolconfig, oid , pg_catalog.shobj_description(oid, 'pg_authid') AS comment FROM pg_roles 

[2016-02-18 15:08:12.042] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, ns.nspname, t.typname, t.typtype, t.typrelid, t.typinput, t.typoutput, t.typlen, t.typdefault, t.typelem, t.typdelim, t.typalign, t.typstorage, t.typbyval, pg_get_userbyid(t.typowner) AS typeowner, e.typname AS element, e.typnamespace AS elementschemaoid, description, ct.oid AS taboid FROM pg_type t JOIN pg_namespace ns ON ns.oid=t.typnamespace LEFT JOIN pg_type e ON e.oid=t.typelem LEFT JOIN pg_class ct ON ct.oid=t.typrelid AND ct.relkind <> 'c' LEFT JOIN pg_description des ON des.objoid=t.oid WHERE t.typtype != 'd' AND (ct.oid IS NULL OR ct.oid = 0) ORDER BY t.typname

[2016-02-18 15:08:15.148] [019230] [dwh-prod] [PGSQL]
SELECT DISTINCT oprname FROM pg_catalog.pg_operator

[2016-02-18 15:08:15.757] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 15:08:16.368] [019230] [dwh-prod] [PGSQL]
SELECT p.oid, p.proname, p.proargtypes, p.proacl, p.prorettype, p.prosecdef, p.proisstrict, p.proretset, p.provolatile, p.prosrc, p.probin, obj_description(p.oid) AS comment, pg_get_userbyid(p.proowner) AS funcowner, typ.typname, typns.nspname, lng.lanname , p.proargnames , p.proargmodes, p.proallargtypes , p.procost, p.prorows, p.proconfig , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace typns ON typns.oid=typ.typnamespace JOIN pg_namespace prons ON prons.oid=p.pronamespace JOIN pg_language lng ON lng.oid=p.prolang WHERE proisagg = false AND typ.typname = 'trigger' AND prons.nspname = 'pg_catalog' 

[2016-02-18 15:08:16.722] [019230] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common' AND c.relname = 'video_d'

[2016-02-18 15:08:16.808] [019230] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'video_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-18 15:08:16.988] [019230] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-18 15:08:17.069] [019230] [dwh-prod] [PGSQL]
SELECT oid, collname FROM pg_collation

[2016-02-18 15:08:17.231] [019230] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS table_name, am.amname, i.indexrelid, i.indisunique, i.indisclustered, i.indisprimary, i.indkey, i.indclass, obj_description(indexrelid) , i.indnatts, pg_get_expr(indpred, indrelid, true) AS indconstraint, pa.rolname AS owner, ts.spcname, ci.reloptions, i.indoption, i.indcollation FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid LEFT JOIN pg_roles pa ON pa.oid = ci.relowner WHERE tns.nspname = 'common' AND ct.relname = 'video_d' AND conname IS NULL ORDER BY ct.relname, ins.nspname, ci.relname

[2016-02-18 15:08:17.320] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6172057, 1, true)

[2016-02-18 15:08:17.422] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6172054, 1, true)

[2016-02-18 15:08:17.534] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6172062, 1, true)

[2016-02-18 15:08:17.621] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6172063, 1, true)

[2016-02-18 15:08:17.706] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6172055, 1, true)

[2016-02-18 15:08:17.794] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6172059, 1, true)

[2016-02-18 15:08:17.882] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6172061, 1, true)

[2016-02-18 15:08:17.967] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6172060, 1, true)

[2016-02-18 15:08:18.052] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6172058, 1, true)

[2016-02-18 15:08:18.146] [019230] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6172056, 1, true)

[2016-02-18 15:08:18.229] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, (current_database())::information_schema.sql_identifier AS trigger_catalog, (n.nspname)::information_schema.sql_identifier AS trigger_schema, (t.tgname)::information_schema.sql_identifier AS trigger_name, (c.relname)::information_schema.sql_identifier AS trigger_table_name, (em.text)::information_schema.character_data AS event_manipulation, (current_database())::information_schema.sql_identifier AS event_object_catalog, (n.nspname)::information_schema.sql_identifier AS event_object_schema, (c.relname)::information_schema.sql_identifier AS event_object_table, (c.relkind)::information_schema.sql_identifier AS event_object_table_type, (nsp.nspname)::information_schema.sql_identifier AS constraint_referenced_table_schema, (cs.relname)::information_schema.sql_identifier AS constraint_referenced_table_name, (t.tgdeferrable) AS constraint_deferrable_identifier, (t.tginitdeferred) AS constraint_deferred_type, (NULL::information_schema.cardinal_number)::information_schema.cardinal_number AS action_order, (CASE WHEN pg_has_role(c.relowner, 'USAGE'::text) THEN (SELECT rm.m[1] AS m FROM regexp_matches(pg_get_triggerdef(t.oid), (E'.{35,} WHEN \\((.+)\\) EXECUTE PROCEDURE'::text)) rm(m) LIMIT 1) ELSE NULL::text END)::information_schema.character_data AS action_condition, (NULL::information_schema.character_data)::information_schema.character_data AS action_condition, ("substring"(pg_get_triggerdef(t.oid), ("position"("substring"(pg_get_triggerdef(t.oid), 48), 'EXECUTE PROCEDURE'::text) + 47)))::information_schema.character_data AS action_statement, (CASE WHEN (((t.tgtype)::integer & 1) = 1) THEN 'ROW'::text ELSE 'STATEMENT'::text END)::information_schema.character_data AS action_orientation, (CASE WHEN (((t.tgtype)::integer & 2) = 2) THEN 'BEFORE'::text ELSE 'AFTER'::text END)::information_schema.character_data AS condition_timing, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_old_table, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_new_table, (t.tgconstraint) AS constraint_identifier, tc.event_object_column, obj_description(t.oid) FROM pg_namespace n LEFT JOIN pg_class c ON (n.oid = c.relnamespace) INNER JOIN pg_trigger t ON (c.oid = t.tgrelid) LEFT JOIN information_schema.triggered_update_columns tc ON (tc.trigger_schema = n.nspname) AND (tc.trigger_name = t.tgname) AND (tc.event_object_schema = n.nspname) AND (tc.event_object_table = c.relname)LEFT JOIN pg_user u ON (c.relowner = u.usesysid) LEFT JOIN (((SELECT 4, 'INSERT' UNION ALL SELECT 8, 'DELETE') UNION ALL SELECT 16, 'UPDATE') UNION ALL SELECT 32, 'TRUNCATE') em(num, text) ON (((t.tgtype)::integer & em.num) <> 0) LEFT OUTER JOIN (SELECT oid, relnamespace, relname FROM pg_class) cs ON (t.tgconstrrelid = cs.oid) LEFT OUTER JOIN (SELECT oid, nspname FROM pg_namespace) nsp ON (cs.relnamespace = nsp.oid) WHERE true AND n.nspname = 'common' AND c.relname = 'video_d' AND (not t.tgisinternal) ORDER BY c.relname, t.tgname

[2016-02-18 15:08:18.315] [019230] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-18 15:08:18.623] [019230] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-18 15:08:18.871] [019230] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'video_d' AND conname IS NOT NULL

[2016-02-18 15:08:18.954] [019230] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'video_d' ORDER BY t.relname, i.oid

[2016-02-18 15:08:19.039] [019230] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'video_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-18 15:08:19.120] [019230] [dwh-prod] [PGSQL]
SELECT n.nspname AS rule_schema, c.relname, r.rulename, r.oid, r.ev_type, r.is_instead, pg_get_ruledef(r.oid) AS definition, obj_description(r.oid) AS comment FROM ((pg_rewrite r JOIN pg_class c ON ((c.oid = r.ev_class))) LEFT JOIN pg_namespace n ON ((n.oid = c.relnamespace))) WHERE (r.rulename <> '_RETURN'::name) AND (n.nspname='common') AND (c.relname='video_d')

[2016-02-18 15:08:19.226] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 15:08:20.147] [019230] [dwh-prod] [PGSQL]
SELECT p.oid, p.proname, p.proargtypes, p.proacl, p.prorettype, p.prosecdef, p.proisstrict, p.proretset, p.provolatile, p.prosrc, p.probin, obj_description(p.oid) AS comment, pg_get_userbyid(p.proowner) AS funcowner, typ.typname, typns.nspname, lng.lanname , p.proargnames , p.proargmodes, p.proallargtypes , p.procost, p.prorows, p.proconfig , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace typns ON typns.oid=typ.typnamespace JOIN pg_namespace prons ON prons.oid=p.pronamespace JOIN pg_language lng ON lng.oid=p.prolang WHERE proisagg = false AND typ.typname = 'trigger' AND prons.nspname = 'common' 

[2016-02-18 15:08:20.234] [019230] [dwh-prod] [PGSQL]
SELECT table_name FROM information_schema.tables WHERE table_schema = '' AND table_type = 'BASE TABLE'

[2016-02-18 15:08:30.921] [019230] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-18 15:08:31.693] [019230] [dwh-prod] [PGSQL]
SELECT p.oid, p.proname, p.proargtypes, p.proacl, p.prorettype, p.prosecdef, p.proisstrict, p.proretset, p.provolatile, p.prosrc, p.probin, obj_description(p.oid) AS comment, pg_get_userbyid(p.proowner) AS funcowner, typ.typname, typns.nspname, lng.lanname , p.proargnames , p.proargmodes, p.proallargtypes , p.procost, p.prorows, p.proconfig , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace typns ON typns.oid=typ.typnamespace JOIN pg_namespace prons ON prons.oid=p.pronamespace JOIN pg_language lng ON lng.oid=p.prolang WHERE proisagg = false AND typ.typname = 'trigger' AND prons.nspname = 'common' 

[2016-02-18 15:08:31.780] [019230] [dwh-prod] [PGSQL]
SELECT table_name FROM information_schema.tables WHERE table_schema = '' AND table_type = 'BASE TABLE'

[2016-02-18 15:08:50.358] [025937] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:08:50.510] [025937] [dwh-prod] [PGSQL]
select media_nid
from common.video_d v
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
except select media_nid
from common.video_d
where video_category_gid in 
(select distinct gid 
from common.category_groups 
where name in ('Yoga Talks', 
'Yoga Tutorials', 
'Meditation', 
'Mind Body TV', 
'Pilates & Dance', 
'Tai Chi & Eastern Arts',
'All Fitness'))


[2016-02-18 15:08:50.801] [025937] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:10:37.607] [025937] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:10:37.705] [025937] [dwh-prod] [PGSQL]
select distinct name from common.category_groups
where gid in (select video_category_gid from common.video_d where admin_category = 'Yoga');


[2016-02-18 15:10:37.804] [025937] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:10:38.095] [025937] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171815

[2016-02-18 15:11:15.222] [025937] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:11:15.382] [025937] [dwh-prod] [PGSQL]
select media_nid
from common.video_d v
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
except select media_nid
from common.video_d
where video_category_gid in 
(select distinct gid 
from common.category_groups 
where name in ('Yoga Talks', 
'Yoga Tutorials', 
'Meditation', 
'Mind Body TV', 
'Pilates & Dance', 
'Tai Chi & Eastern Arts',
'All Fitness',
'Spirituality',
'Documentaries'))


[2016-02-18 15:11:15.838] [025937] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:13:01.118] [025937] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:13:01.223] [025937] [dwh-prod] [PGSQL]
select distinct video_category_gid
from common.video_d
where media_nid in 
(select media_nid
from common.video_d v
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
except select media_nid
from common.video_d
where video_category_gid in 
(select distinct gid 
from common.category_groups 
where name in ('Yoga Talks', 
'Yoga Tutorials', 
'Meditation', 
'Mind Body TV', 
'Pilates & Dance', 
'Tai Chi & Eastern Arts',
'All Fitness',
'Spirituality',
'Documentaries')))


[2016-02-18 15:13:01.350] [025937] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:13:01.580] [025937] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171924

[2016-02-18 15:13:13.942] [000853] [dwh-prod] [PGSQL]
SELECT * FROM "common"."category_groups" WHERE "gid" = '23' LIMIT 1000 OFFSET 0

[2016-02-18 15:13:14.024] [000853] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'category_groups'

[2016-02-18 15:13:14.116] [000853] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171815

[2016-02-18 15:13:24.213] [000853] [dwh-prod] [PGSQL]
SELECT * FROM "common"."category_groups" WHERE "gid" = '149' LIMIT 1000 OFFSET 0

[2016-02-18 15:13:24.294] [000853] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'category_groups'

[2016-02-18 15:13:24.385] [000853] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171815

[2016-02-18 15:16:05.188] [015945] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" ORDER BY "season" LIMIT 1000 OFFSET 0

[2016-02-18 15:16:05.188] [015945] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-18 15:16:05.798] [004990] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 15:16:05.878] [004990] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" ORDER BY "season" LIMIT 1000 OFFSET 0

[2016-02-18 15:16:07.830] [004990] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-18 15:16:07.945] [004990] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171924

[2016-02-18 15:16:10.380] [004990] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "video_category_gid" LIKE '%149%' ORDER BY "season" LIMIT 1000 OFFSET 0

[2016-02-18 15:16:10.461] [004990] [dwh-prod] [PGSQL]
ERROR:  operator does not exist: integer ~~ unknown
LINE 1: ...ROM "common"."video_d" WHERE "video_category_gid" LIKE '%149...
                                                             ^
HINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.


[2016-02-18 15:16:16.141] [004990] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "video_category_gid" = '149' ORDER BY "season" LIMIT 1000 OFFSET 0

[2016-02-18 15:16:17.496] [004990] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-18 15:16:17.600] [004990] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171924

[2016-02-18 15:16:22.607] [004990] [dwh-prod] [PGSQL]
SELECT COUNT(1) FROM "common"."video_d" WHERE "video_category_gid" = '149'

[2016-02-18 15:16:22.726] [004990] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "video_category_gid" = '149' ORDER BY "season" LIMIT 1000 OFFSET 1000

[2016-02-18 15:16:24.141] [004990] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-18 15:16:24.244] [004990] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171924

[2016-02-18 15:16:32.349] [004990] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "video_category_gid" = '149' AND "feature" LIKE '%Feature%' ORDER BY "season" LIMIT 1000 OFFSET 0

[2016-02-18 15:16:33.684] [004990] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-18 15:16:33.788] [004990] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171924

[2016-02-18 15:19:28.362] [025937] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:19:28.471] [025937] [dwh-prod] [PGSQL]
select media_nid
from common.video_d v
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
except select media_nid
from common.video_d
where video_category_gid in 
(select distinct gid 
from common.category_groups 
where name in ('Yoga Talks', 
'Yoga Tutorials', 
'Meditation', 
'Mind Body TV', 
'Pilates & Dance', 
'Tai Chi & Eastern Arts',
'All Fitness',
'Spirituality',
'Documentaries'))


[2016-02-18 15:19:28.752] [025937] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:20:03.187] [025937] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:20:03.292] [025937] [dwh-prod] [PGSQL]
select media_nid
from common.video_d v
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
except select media_nid
from common.video_d
where video_category_gid in 
(select distinct gid 
from common.category_groups 
where name in (
--'Yoga Talks', 
--'Yoga Tutorials', 
'Meditation', 
'Mind Body TV', 
'Pilates & Dance', 
'Tai Chi & Eastern Arts',
'All Fitness',
'Spirituality',
'Documentaries'))


[2016-02-18 15:20:03.648] [025937] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:24:02.811] [025937] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:24:02.942] [025937] [dwh-prod] [PGSQL]
select media_nid
from common.video_d v
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
except select media_nid
from common.video_d
where video_category_gid in 
(select distinct gid 
from common.category_groups 
where name in (
--'Yoga Talks', 
'Yoga Tutorials', 
'Meditation', 
'Mind Body TV', 
'Pilates & Dance', 
'Tai Chi & Eastern Arts',
'All Fitness',
'Spirituality',
'Documentaries'))


[2016-02-18 15:24:03.284] [025937] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:24:28.816] [025937] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:24:28.924] [025937] [dwh-prod] [PGSQL]
select media_nid
from common.video_d v
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
except select media_nid
from common.video_d
where video_category_gid in 
(select distinct gid 
from common.category_groups 
where name in (
'Yoga Talks', 
--'Yoga Tutorials', 
'Meditation', 
'Mind Body TV', 
'Pilates & Dance', 
'Tai Chi & Eastern Arts',
'All Fitness',
'Spirituality',
'Documentaries'))


[2016-02-18 15:24:29.206] [025937] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:26:13.726] [025937] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:26:13.827] [025937] [dwh-prod] [PGSQL]
select media_nid
from common.video_d v
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'


[2016-02-18 15:26:14.173] [025937] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-18 15:26:14.452] [025937] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6171924

[2016-02-18 15:29:53.446] [009214] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-18 15:29:53.526] [009214] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_tmp' ORDER BY ordinal_position

[2016-02-19 10:23:57.288] [025937] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 10:23:57.291] [025937] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-19 10:23:58.364] [025937] [dwh-prod] [PGSQL]
could not connect to server: Connection refused (0x0000274D/10061)
	Is the server running on host "172.16.2.166" and accepting
	TCP/IP connections on port 5432?


[2016-02-19 10:23:58.383] [025937] [dwh-prod] [PGSQL]
select v.title, 
       v.page_nid,
       v.duration,
       count(1)total_views, 
       sum(round(watched/3600,3)) hours_watched
from common.video_tmp vt 
join common.video_d v
on vt.nid = v.media_nid
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
where vt.created > 1420070400
group by v.title, v.page_nid, v.duration;


[2016-02-19 10:23:58.383] [025937] [dwh-prod] [PGSQL]
no connection to the server


[2016-02-19 10:23:59.470] [025937] [dwh-prod] [PGSQL]
could not connect to server: Connection refused (0x0000274D/10061)
	Is the server running on host "172.16.2.166" and accepting
	TCP/IP connections on port 5432?


[2016-02-19 10:23:59.495] [025937] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 10:23:59.496] [025937] [dwh-prod] [PGSQL]
no connection to the server


[2016-02-19 10:24:00.566] [025937] [dwh-prod] [PGSQL]
could not connect to server: Connection refused (0x0000274D/10061)
	Is the server running on host "172.16.2.166" and accepting
	TCP/IP connections on port 5432?


[2016-02-19 10:54:45.794] [025937] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 10:54:45.794] [025937] [dwh-prod] [PGSQL]
no connection to the server


[2016-02-19 10:54:46.389] [002575] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 10:54:46.470] [002575] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 10:54:46.568] [002575] [dwh-prod] [PGSQL]
select v.title, 
       v.page_nid,
       v.duration,
       count(1)total_views, 
       sum(round(watched/3600,3)) hours_watched
from common.video_tmp vt 
join common.video_d v
on vt.nid = v.media_nid
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
where vt.created > 1420070400
group by v.title, v.page_nid, v.duration;


[2016-02-19 10:54:46.648] [002575] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "where"
LINE 14: where vt.created > 1420070400
         ^


[2016-02-19 10:54:46.667] [002575] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 10:54:56.752] [002575] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 10:54:56.850] [002575] [dwh-prod] [PGSQL]
select v.title, 
       v.page_nid,
       v.duration,
       count(1)total_views, 
       sum(round(watched/3600,3)) hours_watched
from common.video_tmp vt 
join common.video_d v
on vt.nid = v.media_nid
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
 and  vt.created > 1420070400
group by v.title, v.page_nid, v.duration;


[2016-02-19 10:55:35.646] [002575] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 10:55:35.944] [002575] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192193

[2016-02-19 11:01:21.545] [004638] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 11:01:21.623] [004638] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-19 11:01:21.860] [004637] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 11:01:21.939] [004637] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 11:01:22.034] [004637] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 11:01:22.119] [004637] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-19 11:01:22.203] [004637] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 11:01:22.805] [004637] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 11:01:22.888] [004637] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 11:01:22.974] [004637] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-19 11:01:23.054] [004637] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 11:01:23.150] [004637] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-19 11:01:23.235] [004637] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 11:01:23.521] [004637] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 11:01:23.601] [004637] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 11:01:23.685] [004637] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-19 11:01:23.768] [004637] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 11:02:06.425] [019230] [dwh-prod] [PGSQL]
SELECT c.oid, c.relname, c.relacl, pg_get_userbyid(c.relowner) AS viewowner, pg_get_viewdef(c.oid) AS definition, obj_description(c.oid), n.nspname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'v'::"char" AND n.nspname = 'common' 

[2016-02-19 11:02:06.426] [019230] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-19 11:02:07.026] [004866] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 11:02:07.109] [004866] [dwh-prod] [PGSQL]
SELECT c.oid, c.relname, c.relacl, pg_get_userbyid(c.relowner) AS viewowner, pg_get_viewdef(c.oid) AS definition, obj_description(c.oid), n.nspname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'v'::"char" AND n.nspname = 'common' 

[2016-02-19 11:02:11.409] [004880] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 11:02:11.589] [004880] [dwh-prod] [PGSQL]
SELECT * FROM "common"."v_node" LIMIT 1000 OFFSET 0

[2016-02-19 11:02:11.956] [004880] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'v_node'

[2016-02-19 11:02:12.062] [004880] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6191971

[2016-02-19 11:02:28.502] [019229] [dwh-prod] [PGSQL]
SELECT rolname, rolsuper, rolinherit, rolcreaterole, rolcreatedb, rolcatupdate, rolcanlogin, rolconnlimit, rolvaliduntil, rolconfig, oid , pg_catalog.shobj_description(oid, 'pg_authid') AS comment FROM pg_roles 

[2016-02-19 11:02:28.502] [019229] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-19 11:02:29.106] [004958] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 11:02:29.184] [004958] [dwh-prod] [PGSQL]
SELECT rolname, rolsuper, rolinherit, rolcreaterole, rolcreatedb, rolcatupdate, rolcanlogin, rolconnlimit, rolvaliduntil, rolconfig, oid , pg_catalog.shobj_description(oid, 'pg_authid') AS comment FROM pg_roles 

[2016-02-19 11:02:29.948] [004960] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 11:02:30.036] [004960] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-19 11:02:30.115] [004866] [dwh-prod] [PGSQL]
SELECT c.oid, c.relname, c.relacl, pg_get_userbyid(c.relowner) AS viewowner, pg_get_viewdef(c.oid) AS definition, obj_description(c.oid), n.nspname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'v'::"char" AND n.nspname = 'common' AND c.relname = 'v_node' 

[2016-02-19 11:02:30.196] [004866] [dwh-prod] [PGSQL]
SELECT n.nspname AS rule_schema, c.relname, r.rulename, r.oid, r.ev_type, r.is_instead, pg_get_ruledef(r.oid) AS definition, obj_description(r.oid) AS comment FROM ((pg_rewrite r JOIN pg_class c ON ((c.oid = r.ev_class))) LEFT JOIN pg_namespace n ON ((n.oid = c.relnamespace))) WHERE (r.rulename <> '_RETURN'::name) AND (n.nspname='common') AND (c.relname='v_node')

[2016-02-19 11:02:30.414] [004959] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 11:02:30.492] [004959] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 11:02:30.586] [004959] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 11:02:30.673] [004959] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-19 11:02:30.754] [004959] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 11:02:31.347] [004959] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 11:02:31.427] [004959] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 11:02:31.513] [004959] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-19 11:02:31.594] [004959] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 11:02:31.689] [004959] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-19 11:02:31.772] [004959] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 11:02:32.048] [004959] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 11:02:32.127] [004959] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 11:02:32.212] [004959] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-19 11:02:32.297] [004959] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 11:22:28.932] [011124] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 11:22:29.042] [011124] [dwh-prod] [PGSQL]
SELECT * FROM "common"."v_node" LIMIT 1000 OFFSET 0

[2016-02-19 11:22:29.461] [011124] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'v_node'

[2016-02-19 11:22:29.560] [011124] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6191971

[2016-02-19 11:23:17.413] [004990] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" ORDER BY "season" LIMIT 1000 OFFSET 0

[2016-02-19 11:23:17.415] [004990] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-19 11:23:18.009] [011417] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 11:23:18.090] [011417] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" ORDER BY "season" LIMIT 1000 OFFSET 0

[2016-02-19 11:23:19.252] [011417] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-19 11:23:19.363] [011417] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192193

[2016-02-19 11:23:25.774] [011417] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "page_nid" = '78321' ORDER BY "season" LIMIT 1000 OFFSET 0

[2016-02-19 11:23:25.864] [011417] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-19 11:23:25.967] [011417] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192193

[2016-02-19 11:27:17.008] [002575] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 11:27:17.009] [002575] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-19 11:27:17.604] [012672] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 11:27:17.688] [012672] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 11:27:17.796] [012672] [dwh-prod] [PGSQL]
select v.title, 
       v.page_nid,
       v.duration,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join common.video_d v
on vt.nid = v.media_nid
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
 and  vt.created > 1420070400
group by v.title, v.page_nid, v.duration;


[2016-02-19 11:27:34.890] [012672] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 11:27:35.247] [012672] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192193

[2016-02-19 11:32:26.680] [012672] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 11:32:26.790] [012672] [dwh-prod] [PGSQL]

create table avg_yoga_completion as
(select v.title, 
       v.page_nid,
       v.duration,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join common.video_d v
on vt.nid = v.media_nid
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
 and  vt.created > 1420070400
group by v.title, v.page_nid, v.duration);


[2016-02-19 11:32:37.892] [012672] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 12:10:08.838] [004866] [dwh-prod] [PGSQL]
SELECT c.oid, c.relname, c.relacl, pg_get_userbyid(c.relowner) AS viewowner, pg_get_viewdef(c.oid) AS definition, obj_description(c.oid), n.nspname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'v'::"char" AND n.nspname = 'moiram' 

[2016-02-19 12:10:08.839] [004866] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-19 12:10:09.418] [025833] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:10:09.497] [025833] [dwh-prod] [PGSQL]
SELECT c.oid, c.relname, c.relacl, pg_get_userbyid(c.relowner) AS viewowner, pg_get_viewdef(c.oid) AS definition, obj_description(c.oid), n.nspname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'v'::"char" AND n.nspname = 'moiram' 

[2016-02-19 12:10:11.841] [025835] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:10:11.921] [025835] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-19 12:10:12.153] [025834] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:10:12.232] [025834] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 12:10:12.326] [025834] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 12:10:12.412] [025834] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-19 12:10:12.494] [025834] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 12:10:13.081] [025834] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 12:10:13.161] [025834] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 12:10:13.247] [025834] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-19 12:10:13.328] [025834] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 12:10:13.415] [025834] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-19 12:10:13.495] [025834] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 12:10:13.768] [025834] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 12:10:13.847] [025834] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 12:10:13.930] [025834] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-19 12:10:14.012] [025834] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 12:10:33.581] [025970] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:10:33.660] [025970] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-19 12:10:33.929] [025969] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:10:34.009] [025969] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 12:10:34.103] [025969] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 12:10:34.188] [025969] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-19 12:10:34.270] [025969] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 12:10:34.861] [025969] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 12:10:34.941] [025969] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 12:10:35.028] [025969] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-19 12:10:35.108] [025969] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 12:10:35.194] [025969] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-19 12:10:35.274] [025969] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 12:10:35.550] [025969] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 12:10:35.629] [025969] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 12:10:35.712] [025969] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-19 12:10:35.798] [025969] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 12:10:53.523] [026109] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:10:53.605] [026109] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-19 12:10:53.863] [026108] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:10:53.944] [026108] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 12:10:54.038] [026108] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 12:10:54.124] [026108] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-19 12:10:54.205] [026108] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 12:10:54.792] [026108] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 12:10:54.871] [026108] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 12:10:54.957] [026108] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-19 12:10:55.038] [026108] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 12:10:55.122] [026108] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-19 12:10:55.220] [026108] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 12:10:55.503] [026108] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 12:10:55.582] [026108] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 12:10:55.665] [026108] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-19 12:10:55.747] [026108] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 12:15:19.726] [025835] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 12:15:19.858] [025835] [dwh-prod] [PGSQL]
drop table if exists tmp.yoga_churn_summary;

create table tmp.yoga_churn_summary as 
select  day_timestamp measure_date, customer_days, total_cancels, total_cancels/customer_days::float churn_rate
from 
(select a.day_timestamp, a.total customer_days, coalesce(c.total ,0) total_cancels
from 
(SELECT  dd.day_timestamp,
    count(distinct dss.subscription_id) as total
    FROM common.daily_status_snapshot dss
    INNER JOIN common.subscription_d sd ON dss.subscription_id = sd.subscription_id
    inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
    WHERE dss.paid_through_date >= dd.day_timestamp::date - 1
      and sd.gcsi_user_id  in 
          (select gcsi_user_id 
           from common.user_dim
       where user_behavior_segment = 'My Yoga')
      and sd.subscription_id not in 
          (select subscription_id 
           from common.cohort_d
           where cohort_name = 'Conscious Cleanse')
    AND dss.status NOT IN ('Hold')
    and dd.day_timestamp >= '20150401' 
    and dd.day_timestamp <= current_date::date - 1
  group by  dd.day_timestamp) a
left join
    (SELECT  dd.day_timestamp,
    count(distinct dss.subscription_id) as total
      FROM common.daily_status_snapshot dss
      INNER JOIN common.subscription_d sd ON sd.subscription_id = dss.subscription_id
      inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
      WHERE
      dss.day_timestamp = dd.day_timestamp
      AND dss.paid_through_date >= dd.day_timestamp::date -1
      AND dss.paid_through_date < dd.day_timestamp::date
      AND dss.paid_through_date >= sd.paid_through_date::date - INTERVAL '15 day'
        and sd.gcsi_user_id  in 
            (select gcsi_user_id 
             from common.user_dim
             where user_behavior_segment = 'My Yoga')
        and sd.subscription_id in 
          (select subscription_id 
           from common.cohort_d
           where cohort_name = 'Conscious Cleanse')
    group by  dd.day_timestamp
    ) c
on a.day_timestamp = c.day_timestamp)foo;

SELECT 
measure_date,
sum(churn_rate) over(order by measure_date rows 30 PRECEDING) as trailing_30_day_churn_sum
FROM tmp.yoga_churn_summary;

select * from tmp.yoga_churn_summary;


[2016-02-19 12:16:28.046] [025835] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 12:16:28.419] [025835] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192376

[2016-02-19 12:16:28.711] [025835] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192376

[2016-02-19 12:17:31.834] [025835] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 12:17:31.951] [025835] [dwh-prod] [PGSQL]
drop table if exists tmp.yoga_churn_summary;

create table tmp.yoga_churn_summary as 
select  day_timestamp measure_date, customer_days, total_cancels, total_cancels/customer_days::float churn_rate
from 
(select a.day_timestamp, a.total customer_days, coalesce(c.total ,0) total_cancels
from 
(SELECT  dd.day_timestamp,
    count(distinct dss.subscription_id) as total
    FROM common.daily_status_snapshot dss
    INNER JOIN common.subscription_d sd ON dss.subscription_id = sd.subscription_id
    inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
    WHERE dss.paid_through_date >= dd.day_timestamp::date - 1
      and sd.gcsi_user_id  in 
          (select gcsi_user_id 
           from common.user_dim
       where user_behavior_segment = 'My Yoga')
      and sd.subscription_id not in 
          (select subscription_id 
           from common.cohort_d
           where cohort_name = 'Conscious Cleanse')
    AND dss.status NOT IN ('Hold')
    and dd.day_timestamp >= '20150101' 
    and dd.day_timestamp <= current_date::date - 1
  group by  dd.day_timestamp) a
left join
    (SELECT  dd.day_timestamp,
    count(distinct dss.subscription_id) as total
      FROM common.daily_status_snapshot dss
      INNER JOIN common.subscription_d sd ON sd.subscription_id = dss.subscription_id
      inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
      WHERE
      dss.day_timestamp = dd.day_timestamp
      AND dss.paid_through_date >= dd.day_timestamp::date -1
      AND dss.paid_through_date < dd.day_timestamp::date
      AND dss.paid_through_date >= sd.paid_through_date::date - INTERVAL '15 day'
        and sd.gcsi_user_id  in 
            (select gcsi_user_id 
             from common.user_dim
             where user_behavior_segment = 'My Yoga')
        and sd.subscription_id in 
          (select subscription_id 
           from common.cohort_d
           where cohort_name = 'Conscious Cleanse')
    group by  dd.day_timestamp
    ) c
on a.day_timestamp = c.day_timestamp)foo;

SELECT 
measure_date,
sum(churn_rate) over(order by measure_date rows 30 PRECEDING) as trailing_30_day_churn_sum
FROM tmp.yoga_churn_summary;

select * from tmp.yoga_churn_summary;


[2016-02-19 12:18:25.827] [025835] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 12:18:26.151] [025835] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192379

[2016-02-19 12:18:26.455] [025835] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192379

[2016-02-19 12:31:07.927] [032469] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:31:08.007] [032469] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 12:31:08.107] [032469] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-19 12:31:08.191] [032469] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 12:31:08.783] [032469] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 12:31:08.867] [032469] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 12:31:08.955] [032469] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-19 12:31:09.615] [032477] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:31:09.695] [032477] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='daily_status_snapshot' ORDER BY ordinal_position

[2016-02-19 12:31:10.387] [032478] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:31:10.475] [032478] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='subscription_d' ORDER BY ordinal_position

[2016-02-19 12:31:11.158] [032479] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:31:11.239] [032479] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='date_d' ORDER BY ordinal_position

[2016-02-19 12:31:15.149] [025835] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 12:31:15.150] [025835] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-19 12:31:15.746] [032493] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:31:15.825] [032493] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 12:31:15.950] [032493] [dwh-prod] [PGSQL]
drop table if exists tmp.yoga_churn_summary;

create table tmp.yoga_churn_summary as 
select  day_timestamp measure_date, customer_days, total_cancels, total_cancels/customer_days::float churn_rate
from 
(select a.day_timestamp, a.total customer_days, coalesce(c.total ,0) total_cancels
from 
(SELECT  dd.day_timestamp,
    count(distinct dss.subscription_id) as total
    FROM common.daily_status_snapshot dss
    INNER JOIN common.subscription_d sd ON dss.subscription_id = sd.subscription_id
    inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
    WHERE dss.paid_through_date >= dd.day_timestamp::date - 1
      and sd.gcsi_user_id  in 
          (select gcsi_user_id 
           from common.user_dim
       where user_behavior_segment = 'My Yoga')
      and sd.subscription_id not in 
          (select subscription_id 
           from common.cohort_d
           where cohort_name = 'Conscious Cleanse')
    AND dss.status NOT IN ('Hold')
    and dd.day_timestamp >= '20150101' 
    and dd.day_timestamp <= current_date::date - 1
  group by  dd.day_timestamp) a
left join
    (SELECT  dd.day_timestamp,
    count(distinct dss.subscription_id) as total
      FROM common.daily_status_snapshot dss
      INNER JOIN common.subscription_d sd ON sd.subscription_id = dss.subscription_id
      inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
      WHERE
      dss.day_timestamp = dd.day_timestamp
      AND dss.paid_through_date >= dd.day_timestamp::date -1
      AND dss.paid_through_date < dd.day_timestamp::date
      AND dss.paid_through_date >= sd.paid_through_date::date - INTERVAL '15 day'
        and sd.gcsi_user_id  in 
            (select gcsi_user_id 
             from common.user_dim
             where user_behavior_segment = 'My Yoga')
        and sd.subscription_id not in 
          (select subscription_id 
           from common.cohort_d
           where cohort_name = 'Conscious Cleanse')
    group by  dd.day_timestamp
    ) c
on a.day_timestamp = c.day_timestamp)foo;

SELECT 
measure_date,
sum(churn_rate) over(order by measure_date rows 30 PRECEDING) as trailing_30_day_churn_sum
FROM tmp.yoga_churn_summary;

select * from tmp.yoga_churn_summary;


[2016-02-19 12:32:40.719] [032493] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 12:32:41.039] [032493] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192389

[2016-02-19 12:32:41.344] [032493] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192389

[2016-02-19 12:56:18.006] [007792] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:56:18.087] [007792] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 12:56:18.198] [007792] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-19 12:56:18.280] [007792] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 12:56:18.885] [007792] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 12:56:18.966] [007792] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 12:56:19.054] [007792] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-19 12:57:05.389] [032493] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 12:57:05.389] [032493] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-19 12:57:05.974] [008043] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:57:06.054] [008043] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 12:57:06.173] [008043] [dwh-prod] [PGSQL]
drop table if exists tmp.yoga_with_cc_churn_summary;

create table tmp.yoga_with_cc_churn_summary as 
select  day_timestamp measure_date, customer_days, total_cancels, total_cancels/customer_days::float churn_rate
from 
(select a.day_timestamp, a.total customer_days, coalesce(c.total ,0) total_cancels
from 
(SELECT  dd.day_timestamp,
    count(distinct dss.subscription_id) as total
    FROM common.daily_status_snapshot dss
    INNER JOIN common.subscription_d sd ON dss.subscription_id = sd.subscription_id
    inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
    WHERE dss.paid_through_date >= dd.day_timestamp::date - 1
      and sd.gcsi_user_id  in 
          (select gcsi_user_id 
           from common.user_dim
       where user_behavior_segment = 'My Yoga')
    AND dss.status NOT IN ('Hold')
    and dd.day_timestamp >= '20150101' 
    and dd.day_timestamp <= current_date::date - 1
  group by  dd.day_timestamp) a
left join
    (SELECT  dd.day_timestamp,
    count(distinct dss.subscription_id) as total
      FROM common.daily_status_snapshot dss
      INNER JOIN common.subscription_d sd ON sd.subscription_id = dss.subscription_id
      inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
      WHERE
      dss.day_timestamp = dd.day_timestamp
      AND dss.paid_through_date >= dd.day_timestamp::date -1
      AND dss.paid_through_date < dd.day_timestamp::date
      AND dss.paid_through_date >= sd.paid_through_date::date - INTERVAL '15 day'
        and sd.gcsi_user_id  in 
            (select gcsi_user_id 
             from common.user_dim
             where user_behavior_segment = 'My Yoga')
    group by  dd.day_timestamp
    ) c
on a.day_timestamp = c.day_timestamp)foo;


[2016-02-19 12:58:30.382] [008043] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 12:59:14.279] [008660] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 12:59:14.358] [008660] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='yoga_churn_summary' ORDER BY ordinal_position

[2016-02-19 13:00:56.596] [008043] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 13:00:56.702] [008043] [dwh-prod] [PGSQL]
select foo.measure_date, yoga_churn_sum, yoga_with_cc_churn_sum
from
(SELECT 
measure_date,
sum(churn_rate) over(order by measure_date rows 30 PRECEDING) as yoga_churn_sum
FROM tmp.yoga_churn_summary) foo
join
(SELECT 
measure_date,
sum(churn_rate) over(order by measure_date rows 30 PRECEDING) as yoga_with_cc_churn_sum
FROM tmp.yoga_with_cc_churn_summary) bar
on foo.measure_date = bar.measure_date ;


[2016-02-19 13:00:56.965] [008043] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 13:00:57.257] [008043] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192389

[2016-02-19 14:08:49.526] [030193] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:08:49.605] [030193] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-19 14:08:49.898] [030192] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:08:49.977] [030192] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 14:08:50.069] [030192] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 14:08:50.154] [030192] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-19 14:08:50.235] [030192] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 14:08:50.879] [030192] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 14:08:51.010] [030192] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 14:08:51.096] [030192] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-19 14:08:51.177] [030192] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 14:08:51.266] [030192] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-19 14:08:51.353] [030192] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 14:08:51.631] [030192] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 14:08:51.719] [030192] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 14:08:51.802] [030192] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-19 14:08:51.884] [030192] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 14:09:31.152] [025833] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'tmp'

[2016-02-19 14:09:31.152] [025833] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-19 14:09:31.725] [030357] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:09:31.807] [030357] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'tmp'

[2016-02-19 14:09:47.648] [030487] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:09:47.727] [030357] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'sfss' ORDER BY col.table_name, col.ordinal_position

[2016-02-19 14:09:47.845] [030357] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-19 14:09:48.211] [030357] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-19 14:09:48.292] [030357] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'sfss' AND conname IS NOT NULL

[2016-02-19 14:09:48.397] [030357] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'sfss' ORDER BY t.relname, i.oid

[2016-02-19 14:09:48.482] [030357] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'sfss' ORDER BY t.relname, c.conname, a.attnum

[2016-02-19 14:09:48.698] [030487] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."sfss" LIMIT 1000 OFFSET 0

[2016-02-19 14:09:49.103] [030487] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'sfss'

[2016-02-19 14:09:49.203] [030487] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134188

[2016-02-19 14:10:32.983] [030487] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' LIMIT 1000 OFFSET 0

[2016-02-19 14:10:33.400] [030487] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'sfss'

[2016-02-19 14:10:33.491] [030487] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134188

[2016-02-19 14:11:37.624] [031026] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:11:37.705] [030357] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'user_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-19 14:11:37.862] [030357] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-19 14:11:38.247] [030357] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-19 14:11:38.333] [030357] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'user_d' AND conname IS NOT NULL

[2016-02-19 14:11:38.415] [030357] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'user_d' ORDER BY t.relname, i.oid

[2016-02-19 14:11:38.501] [030357] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'user_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-19 14:11:38.703] [031026] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" LIMIT 1000 OFFSET 0

[2016-02-19 14:11:39.943] [031026] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-19 14:11:40.054] [031026] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192049

[2016-02-19 14:11:59.843] [031026] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '5404338' LIMIT 1000 OFFSET 0

[2016-02-19 14:12:01.125] [031026] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-19 14:12:01.224] [031026] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192049

[2016-02-19 14:12:48.656] [030357] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'drupal'

[2016-02-19 14:13:12.693] [031517] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:13:12.773] [030357] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'drupal' AND col.table_name = 'node' ORDER BY col.table_name, col.ordinal_position

[2016-02-19 14:13:12.905] [030357] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-19 14:13:13.299] [030357] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-19 14:13:13.380] [030357] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'drupal' AND ct.relname = 'node' AND conname IS NOT NULL

[2016-02-19 14:13:13.466] [030357] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'drupal' AND t.relname = 'node' ORDER BY t.relname, i.oid

[2016-02-19 14:13:13.559] [030357] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'drupal' AND t.relname = 'node' ORDER BY t.relname, c.conname, a.attnum

[2016-02-19 14:13:13.786] [031517] [dwh-prod] [PGSQL]
SELECT * FROM "drupal"."node" LIMIT 1000 OFFSET 0

[2016-02-19 14:13:14.408] [031517] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'drupal' AND cl.table_name = 'node'

[2016-02-19 14:13:14.522] [031517] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6175394

[2016-02-19 14:13:28.163] [031583] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:13:28.242] [030357] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'drupal' AND col.table_name = 'smfplayer_user_history' ORDER BY col.table_name, col.ordinal_position

[2016-02-19 14:13:28.406] [030357] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-19 14:13:28.765] [030357] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-19 14:13:28.847] [030357] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'drupal' AND ct.relname = 'smfplayer_user_history' AND conname IS NOT NULL

[2016-02-19 14:13:28.931] [030357] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'drupal' AND t.relname = 'smfplayer_user_history' ORDER BY t.relname, i.oid

[2016-02-19 14:13:29.018] [030357] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'drupal' AND t.relname = 'smfplayer_user_history' ORDER BY t.relname, c.conname, a.attnum

[2016-02-19 14:13:29.221] [031583] [dwh-prod] [PGSQL]
SELECT * FROM "drupal"."smfplayer_user_history" LIMIT 1000 OFFSET 0

[2016-02-19 14:13:29.953] [031583] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'drupal' AND cl.table_name = 'smfplayer_user_history'

[2016-02-19 14:13:30.061] [031583] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4276053

[2016-02-19 14:13:54.414] [031583] [dwh-prod] [PGSQL]
SELECT * FROM "drupal"."smfplayer_user_history" WHERE "uid" = '5579' LIMIT 1000 OFFSET 0

[2016-02-19 14:13:54.522] [031583] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'drupal' AND cl.table_name = 'smfplayer_user_history'

[2016-02-19 14:13:54.621] [031583] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4276053

[2016-02-19 14:15:53.734] [031026] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '6252916' LIMIT 1000 OFFSET 0

[2016-02-19 14:15:53.918] [031026] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-19 14:15:54.018] [031026] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192049

[2016-02-19 14:16:46.891] [031026] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '6463507' LIMIT 1000 OFFSET 0

[2016-02-19 14:16:47.077] [031026] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-19 14:16:47.178] [031026] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192049

[2016-02-19 14:18:00.774] [030487] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' AND "days_since_last_video_view" < '40' LIMIT 1000 OFFSET 0

[2016-02-19 14:18:01.140] [030487] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'sfss'

[2016-02-19 14:18:01.232] [030487] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134188

[2016-02-19 14:19:11.081] [031026] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '8233260' LIMIT 1000 OFFSET 0

[2016-02-19 14:19:11.266] [031026] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-19 14:19:11.372] [031026] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192049

[2016-02-19 14:19:45.239] [031583] [dwh-prod] [PGSQL]
SELECT * FROM "drupal"."smfplayer_user_history" WHERE "uid" = '26393' LIMIT 1000 OFFSET 0

[2016-02-19 14:19:45.407] [031583] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'drupal' AND cl.table_name = 'smfplayer_user_history'

[2016-02-19 14:19:45.506] [031583] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4276053

[2016-02-19 14:26:48.419] [003327] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:26:48.498] [003327] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-19 14:26:48.784] [003326] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:26:48.866] [003326] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 14:26:48.962] [003326] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 14:26:49.047] [003326] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-19 14:26:49.128] [003326] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 14:26:49.727] [003326] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 14:26:49.807] [003326] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 14:26:49.893] [003326] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-19 14:26:49.974] [003326] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 14:26:50.059] [003326] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-19 14:26:50.140] [003326] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 14:26:50.418] [003326] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 14:26:50.498] [003326] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 14:26:50.581] [003326] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-19 14:26:50.663] [003326] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 14:27:32.719] [003516] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:27:32.799] [003516] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 14:27:32.909] [003516] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-19 14:27:32.990] [003516] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 14:27:33.579] [003516] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 14:27:33.667] [003516] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 14:27:33.759] [003516] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-19 14:27:34.431] [003523] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:27:34.512] [003523] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='sub_master' ORDER BY ordinal_position

[2016-02-19 14:27:35.202] [003524] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:27:35.281] [003524] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 14:27:35.384] [003524] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-19 14:27:35.468] [003524] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 14:27:35.987] [003524] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 14:27:36.068] [003524] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 14:27:36.156] [003524] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-19 14:27:36.834] [003525] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:27:36.913] [003525] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_daily_cube' ORDER BY ordinal_position

[2016-02-19 14:28:06.545] [003327] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:28:06.667] [003327] [dwh-prod] [PGSQL]
 select *
from
       (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id)
where drupal_user_id = 26393;


[2016-02-19 14:28:06.747] [003327] [dwh-prod] [PGSQL]
ERROR:  subquery in FROM must have an alias
LINE 3:        (select distinct  sm .drupal_user_id,
               ^
HINT:  For example, FROM (SELECT ...) [AS] foo.


[2016-02-19 14:28:06.771] [003327] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:28:12.806] [003327] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:28:12.904] [003327] [dwh-prod] [PGSQL]
 select *
from
       (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id) foo
where drupal_user_id = 26393;


[2016-02-19 14:29:00.964] [003327] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:29:01.308] [003327] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 14:33:06.342] [007466] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:33:06.432] [007466] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 14:33:06.545] [007466] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-19 14:33:06.628] [007466] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 14:33:07.220] [007466] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 14:33:07.300] [007466] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 14:33:07.387] [007466] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-19 14:33:42.841] [030193] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:33:42.977] [030193] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20150814'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20150814'::date ivend,
          ud.user_behavior_segment,
          '20150814'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150814' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20150814'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150814'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150815'
    and cancel_date <= '20140914'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20150814'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20150814'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20150814'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20150814'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20140914'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20150814'
         where engagement_ratio > .25 
           AND created_date <= '20140914'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20150814');
  
delete from tmp.sfss_bak where ivend = '20150814'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150814');

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 14:34:04.849] [030193] [dwh-prod] [PGSQL]
ERROR:  relation "sfss" already exists


[2016-02-19 14:34:04.879] [030193] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:34:05.266] [030193] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 14:34:05.672] [030193] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134153

[2016-02-19 14:34:21.103] [030487] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' AND "days_since_last_video_view" < '40' LIMIT 1000 OFFSET 0

[2016-02-19 14:34:21.461] [030487] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'sfss'

[2016-02-19 14:34:21.554] [030487] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134188

[2016-02-19 14:34:42.643] [030193] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:34:42.773] [030193] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20150914'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20150914'::date ivend,
          ud.user_behavior_segment,
          '20150914'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150914' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20150914'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150914'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150915'
    and cancel_date <= '20141014'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20150914'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20150914'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20150914'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20150914'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20141014'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20150914'
         where engagement_ratio > .25 
           AND created_date <= '20141014'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20150914');
  
delete from tmp.sfss_bak where ivend = '20150914'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150914');

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 14:35:01.518] [030193] [dwh-prod] [PGSQL]
ERROR:  relation "sfss" already exists


[2016-02-19 14:35:01.540] [030193] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:35:01.942] [030193] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 14:35:02.355] [030193] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134153

[2016-02-19 14:35:20.619] [030193] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:35:20.749] [030193] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151014'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151014'::date ivend,
          ud.user_behavior_segment,
          '20151014'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151014' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20151014'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151014'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151015'
    and cancel_date <= '20141014'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20151014'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151014'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151014'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20141014'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151014'
         where engagement_ratio > .25 
           AND created_date <= '20141014'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151014');
  
delete from tmp.sfss_bak where ivend = '20151014'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151014');

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 14:35:41.086] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:38:38.784] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:38:38.929] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151014'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151014'::date ivend,
          ud.user_behavior_segment,
          '20151014'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151014' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20151014'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151014'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151015'
    and cancel_date <= '20141114'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20151014'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151014'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151014'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20141114'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151014'
         where engagement_ratio > .25 
           AND created_date <= '20141114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151014');
  
delete from tmp.sfss_bak where ivend = '20151014'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151014');

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 14:39:01.150] [008612] [dwh-prod] [PGSQL]
ERROR:  relation "sfss" already exists


[2016-02-19 14:39:01.174] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:39:01.568] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 14:39:01.972] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134153

[2016-02-19 14:39:40.302] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:39:40.431] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151114'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151114'::date ivend,
          ud.user_behavior_segment,
          '20151114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151114' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20151114'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151115'
    and cancel_date <= '20141214'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20151114'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151114'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20141214'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151114'
         where engagement_ratio > .25 
           AND created_date <= '20141214'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151114');
  
delete from tmp.sfss_bak where ivend = '20151114'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151114');

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 14:39:52.237] [030487] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' AND "days_since_last_video_view" < '40' AND "churn_flag" = '0' LIMIT 1000 OFFSET 0

[2016-02-19 14:39:52.547] [030487] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'sfss'

[2016-02-19 14:39:52.640] [030487] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134188

[2016-02-19 14:40:01.347] [008612] [dwh-prod] [PGSQL]
ERROR:  relation "sfss" already exists


[2016-02-19 14:40:01.370] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:40:01.760] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 14:40:02.166] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134153

[2016-02-19 14:40:37.160] [030487] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' AND "days_since_last_video_view" < '40' AND "ivend" = '2015-12-15' AND "churn_flag" = '0' LIMIT 1000 OFFSET 0

[2016-02-19 14:40:37.344] [030487] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'sfss'

[2016-02-19 14:40:37.435] [030487] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134188

[2016-02-19 14:40:50.679] [030487] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' AND "days_since_last_video_view" < '40' AND "ivend" = '2015-12-14' AND "churn_flag" = '0' LIMIT 1000 OFFSET 0

[2016-02-19 14:40:50.885] [030487] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'sfss'

[2016-02-19 14:40:50.976] [030487] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134188

[2016-02-19 14:40:58.175] [030487] [dwh-prod] [PGSQL]
SELECT COUNT(1) FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' AND "days_since_last_video_view" < '40' AND "ivend" = '2015-12-14' AND "churn_flag" = '0'

[2016-02-19 14:40:58.382] [030487] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' AND "days_since_last_video_view" < '40' AND "ivend" = '2015-12-14' AND "churn_flag" = '0' LIMIT 1000 OFFSET 0

[2016-02-19 14:40:58.557] [030487] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'sfss'

[2016-02-19 14:40:58.648] [030487] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134188

[2016-02-19 14:40:59.577] [030487] [dwh-prod] [PGSQL]
SELECT COUNT(1) FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' AND "days_since_last_video_view" < '40' AND "ivend" = '2015-12-14' AND "churn_flag" = '0'

[2016-02-19 14:40:59.775] [030487] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' AND "days_since_last_video_view" < '40' AND "ivend" = '2015-12-14' AND "churn_flag" = '0' LIMIT 1000 OFFSET 0

[2016-02-19 14:40:59.950] [030487] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'sfss'

[2016-02-19 14:41:00.040] [030487] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134188

[2016-02-19 14:41:53.976] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:41:54.101] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20150814'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20150814'::date ivend,
          ud.user_behavior_segment,
          '20150814'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150814' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20150814'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150814'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150815'
    and cancel_date <= '20150915'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20150814'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20150814'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20150814'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20150814'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20150915'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20150814'
         where engagement_ratio > .25 
           AND created_date <= '20150915'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20150814');
  
delete from tmp.sfss_bak where ivend = '20150814'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150814');

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 14:42:16.448] [008612] [dwh-prod] [PGSQL]
ERROR:  relation "sfss" already exists


[2016-02-19 14:42:16.475] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:42:16.912] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 14:42:17.352] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134153

[2016-02-19 14:43:45.059] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:43:45.190] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20150914'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20150914'::date ivend,
          ud.user_behavior_segment,
          '20150914'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150914' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20150914'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150914'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150915'
    and cancel_date <= '20151014'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20150914'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20150914'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20150914'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20150914'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20151014'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20150914'
         where engagement_ratio > .25 
           AND created_date <= '20151014'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20150914');
  
delete from tmp.sfss_bak where ivend = '20150914'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150914');

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 14:44:08.176] [008612] [dwh-prod] [PGSQL]
ERROR:  relation "sfss" already exists


[2016-02-19 14:44:08.197] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:44:08.595] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 14:44:08.997] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134153

[2016-02-19 14:45:26.957] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:45:27.085] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151014'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151014'::date ivend,
          ud.user_behavior_segment,
          '20151014'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151014' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20151014'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151014'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151015'
    and cancel_date <= '20151114'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20151014'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151014'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151014'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20151114'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151014'
         where engagement_ratio > .25 
           AND created_date <= '20151114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151014');
  
delete from tmp.sfss_bak where ivend = '20151014'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151014');

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 14:45:50.860] [008612] [dwh-prod] [PGSQL]
ERROR:  relation "sfss" already exists


[2016-02-19 14:45:50.885] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:45:51.274] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 14:45:51.670] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134153

[2016-02-19 14:46:41.999] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:46:42.131] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151114'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151114'::date ivend,
          ud.user_behavior_segment,
          '20151114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151114' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20151114'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151114'::date ivend,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151115'
    and cancel_date <= '20151214'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20151114'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151114'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        '20151214'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151114'
         where engagement_ratio > .25 
           AND created_date <= '20151214'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151114');
  
delete from tmp.sfss_bak where ivend = '20151114'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151114');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 14:47:09.216] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:47:09.596] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 14:47:09.994] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134153

[2016-02-19 14:47:26.991] [030487] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' AND "days_since_last_video_view" < '40' AND "ivend" = '2015-10-14' AND "churn_flag" = '0' LIMIT 1000 OFFSET 0

[2016-02-19 14:47:27.215] [030487] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'sfss'

[2016-02-19 14:47:27.307] [030487] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192430

[2016-02-19 14:48:42.043] [031026] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '8233260' LIMIT 1000 OFFSET 0

[2016-02-19 14:48:42.231] [031026] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-19 14:48:42.344] [031026] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192049

[2016-02-19 14:51:28.928] [014272] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:51:29.008] [014272] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='video_views_master' ORDER BY ordinal_position

[2016-02-19 14:51:44.483] [003327] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:51:44.587] [003327] [dwh-prod] [PGSQL]
select * from tmp.video_views_master where drupal_user_id =26393;


[2016-02-19 14:51:44.732] [003327] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:51:45.088] [003327] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134156

[2016-02-19 14:52:58.663] [003327] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:52:58.818] [003327] [dwh-prod] [PGSQL]
select '20151014'::date -38;


[2016-02-19 14:52:58.917] [003327] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:54:30.654] [015198] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 14:54:30.740] [030357] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'video_daily_cube' ORDER BY col.table_name, col.ordinal_position

[2016-02-19 14:54:30.890] [030357] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-19 14:54:31.373] [030357] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-19 14:54:31.456] [030357] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'video_daily_cube' AND conname IS NOT NULL

[2016-02-19 14:54:31.537] [030357] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'video_daily_cube' ORDER BY t.relname, i.oid

[2016-02-19 14:54:31.621] [030357] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'video_daily_cube' ORDER BY t.relname, c.conname, a.attnum

[2016-02-19 14:54:31.864] [015198] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_daily_cube" LIMIT 1000 OFFSET 0

[2016-02-19 14:54:32.288] [015198] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_daily_cube'

[2016-02-19 14:54:32.394] [015198] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192218

[2016-02-19 14:54:51.147] [015198] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_daily_cube" WHERE "user_id" = '26393' LIMIT 1000 OFFSET 0

[2016-02-19 14:54:54.358] [015198] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_daily_cube'

[2016-02-19 14:54:54.449] [015198] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192218

[2016-02-19 14:55:10.456] [015198] [dwh-prod] [PGSQL]
SELECT * FROM "common"."video_daily_cube" WHERE "user_id" = '26393' ORDER BY "created_date" DESC LIMIT 1000 OFFSET 0

[2016-02-19 14:55:11.914] [015198] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'video_daily_cube'

[2016-02-19 14:55:12.005] [015198] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192218

[2016-02-19 14:56:30.063] [003327] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:56:30.168] [003327] [dwh-prod] [PGSQL]
 select *
from
       (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id) foo
where drupal_user_id = 26393;


[2016-02-19 14:56:34.165] [003327] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 14:56:34.522] [003327] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:01:19.008] [003327] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:01:19.136] [003327] [dwh-prod] [PGSQL]
select v2.video_view_date vv_date_1, v4.video_view_date vv_date_2,
     v2.days_since_last_video_view_1, v4.days_since_last_video_view_2,          
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    (select drupal_user_id,video_view_date,
        '20151014'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,video_view_date,
        '20151114'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151014'
         where engagement_ratio > .25 
           AND created_date <= '20151114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where drupal_user_id = 26393;


[2016-02-19 15:01:19.216] [003327] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "on"
LINE 16:    on sm .drupal_user_id = v2.drupal_user_id
            ^


[2016-02-19 15:01:19.235] [003327] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:01:53.125] [003327] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:01:53.249] [003327] [dwh-prod] [PGSQL]
select v2.video_view_date vv_date_1, v4.video_view_date vv_date_2,
     v2.days_since_last_video_view_1, v4.days_since_last_video_view_2,          
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    (select drupal_user_id,video_view_date,
        '20151014'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id) v1 ) v2
left join
     (select drupal_user_id,video_view_date,
        '20151114'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151014'
         where engagement_ratio > .25 
           AND created_date <= '20151114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where drupal_user_id = 26393;

select * from tmp.video_views_master where drupal_user_id =26393;

select '20151014'::date -38;


[2016-02-19 15:01:53.329] [003327] [dwh-prod] [PGSQL]
ERROR:  column v2.days_since_last_video_view_1 does not exist
LINE 2:      v2.days_since_last_video_view_1, v4.days_since_last_vid...
             ^


[2016-02-19 15:01:53.349] [003327] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:02:38.248] [003327] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:02:38.359] [003327] [dwh-prod] [PGSQL]
select v2.video_view_date vv_date_1, v4.video_view_date vv_date_2,
     v2.days_since_last_video_view days_since_last_video_view_1, v4.days_since_last_video_view days_since_last_video_view_2,          
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    (select drupal_user_id,video_view_date,
        '20151014'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id) v1 ) v2
left join
     (select drupal_user_id,video_view_date,
        '20151114'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151014'
         where engagement_ratio > .25 
           AND created_date <= '20151114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where drupal_user_id = 26393;

select * from tmp.video_views_master where drupal_user_id =26393;

select '20151014'::date -38;


[2016-02-19 15:02:38.439] [003327] [dwh-prod] [PGSQL]
ERROR:  column reference "drupal_user_id" is ambiguous
LINE 30: where drupal_user_id = 26393;
               ^


[2016-02-19 15:02:38.455] [003327] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:02:56.086] [003327] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:02:56.214] [003327] [dwh-prod] [PGSQL]
select v2.video_view_date vv_date_1, v4.video_view_date vv_date_2,
     v2.days_since_last_video_view days_since_last_video_view_1, v4.days_since_last_video_view days_since_last_video_view_2,          
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    (select drupal_user_id,video_view_date,
        '20151014'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id) v1 ) v2
left join
     (select drupal_user_id,video_view_date,
        '20151114'::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151014'
         where engagement_ratio > .25 
           AND created_date <= '20151114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where v2.drupal_user_id = 26393;

select * from tmp.video_views_master where drupal_user_id =26393;

select '20151014'::date -38;


[2016-02-19 15:03:00.239] [003327] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:03:00.811] [003327] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134156

[2016-02-19 15:03:31.829] [018003] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 15:03:31.911] [018003] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 15:03:32.033] [018003] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-19 15:03:32.119] [018003] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 15:03:32.816] [018003] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 15:03:32.897] [018003] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 15:03:32.986] [018003] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-19 15:03:33.675] [018022] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 15:03:33.756] [018022] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='subscription_d' ORDER BY ordinal_position

[2016-02-19 15:05:00.325] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:05:00.453] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20150814'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20150814'::date ivend,
          ud.user_behavior_segment,
          '20150814'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150814' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20150814'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150814'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150914'
    and cancel_date <= '20151014'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20150814'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20150814'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20150814'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20150814'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20150814'
         where engagement_ratio > .25 
           AND created_date <= '20151014'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20150814');
  
delete from tmp.sfss_bak where ivend = '20150814'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150814');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:05:01.334] [008612] [dwh-prod] [PGSQL]
ERROR:  INSERT has more expressions than target columns
LINE 28:          1 hard_cancel_flag
                  ^


[2016-02-19 15:05:01.356] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:05:01.753] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:05:33.967] [018661] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 15:05:34.053] [018661] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-19 15:05:34.349] [018660] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 15:05:34.427] [018660] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 15:05:34.522] [018660] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 15:05:34.615] [018660] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-19 15:05:34.698] [018660] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 15:05:35.287] [018660] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 15:05:35.369] [018660] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 15:05:35.454] [018660] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-19 15:05:35.535] [018660] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 15:05:35.619] [018660] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-19 15:05:35.701] [018660] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 15:05:35.979] [018660] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 15:05:36.058] [018660] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 15:05:36.141] [018660] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-19 15:05:36.224] [018660] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 15:05:44.116] [018686] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 15:05:44.195] [018686] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 15:05:44.297] [018686] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-19 15:05:44.381] [018686] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 15:05:44.969] [018686] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 15:05:45.066] [018686] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 15:05:45.162] [018686] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-19 15:05:45.815] [018747] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 15:05:45.894] [018747] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='subscription_d' ORDER BY ordinal_position

[2016-02-19 15:06:37.233] [018661] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:06:37.352] [018661] [dwh-prod] [PGSQL]
drop table if exists tmp.sub_targets;

create table tmp.sub_targets
as 
  select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150814'::date ivend,
         cancel_date,
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150915'
    and cancel_date <= '20150914'
    and cancel_date <= paid_through_date;


[2016-02-19 15:06:37.522] [018661] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:06:53.396] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:06:53.520] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20150814'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20150814'::date ivend,
          ud.user_behavior_segment,
          '20150814'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150814' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20150814'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150814'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150914'
    and cancel_date <= '20151014'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20150814'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20150814'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20150814'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20150814'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20150814'
         where engagement_ratio > .25 
           AND created_date <= '20151014'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20150814');
  
delete from tmp.sfss_bak where ivend = '20150814'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150814');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:06:54.500] [008612] [dwh-prod] [PGSQL]
ERROR:  column "st.cancel_date" must appear in the GROUP BY clause or be used in an aggregate function
LINE 68:         (select  st .drupal_user_id, cancel_date,
                                              ^


[2016-02-19 15:06:54.519] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:06:54.936] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:06:55.352] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:07:05.446] [030487] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' AND "days_since_last_video_view" < '40' AND "ivend" = '2015-08-14' AND "churn_flag" = '0' LIMIT 1000 OFFSET 0

[2016-02-19 15:07:05.622] [030487] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'sfss'

[2016-02-19 15:07:05.712] [030487] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192430

[2016-02-19 15:08:39.526] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:08:39.656] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20150814'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20150814'::date ivend,
          ud.user_behavior_segment,
          '20150814'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150814' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20150814'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150814'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150815'
    and cancel_date <= '20150914'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20150814'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20150814'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20150814'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20150814'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20150814'
         where engagement_ratio > .25 
           AND created_date <= '20150914'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20150814');
  
delete from tmp.sfss_bak where ivend = '20150814'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150814');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:08:40.634] [008612] [dwh-prod] [PGSQL]
ERROR:  column "st.cancel_date" must appear in the GROUP BY clause or be used in an aggregate function
LINE 68:         (select  st .drupal_user_id, cancel_date,
                                              ^


[2016-02-19 15:08:40.654] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:08:41.057] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:08:41.469] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:08:50.571] [030487] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' AND "ivend" = '2015-08-14' AND "churn_flag" = '0' LIMIT 1000 OFFSET 0

[2016-02-19 15:08:50.855] [030487] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'sfss'

[2016-02-19 15:08:50.950] [030487] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192430

[2016-02-19 15:09:44.097] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:09:44.226] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20150914'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20150914'::date ivend,
          ud.user_behavior_segment,
          '20150914'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150914' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20150914'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150914'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150915'
    and cancel_date <= '20151014'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20150914'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20150914'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20150914'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20150914'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20150914'
         where engagement_ratio > .25 
           AND created_date <= '20151014'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20150914');
  
delete from tmp.sfss_bak where ivend = '20150914'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150914');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:09:45.389] [008612] [dwh-prod] [PGSQL]
ERROR:  column "st.cancel_date" must appear in the GROUP BY clause or be used in an aggregate function
LINE 68:         (select  st .drupal_user_id, cancel_date,
                                              ^


[2016-02-19 15:09:45.410] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:09:45.808] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:09:46.214] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:10:06.260] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:10:06.388] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151014'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151014'::date ivend,
          ud.user_behavior_segment,
          '20151014'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151014' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20151014'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151014'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151015'
    and cancel_date <= '20151114'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20151014'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151014'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151014'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151014'
         where engagement_ratio > .25 
           AND created_date <= '20151114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151014');
  
delete from tmp.sfss_bak where ivend = '20151014'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151014');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:10:07.459] [008612] [dwh-prod] [PGSQL]
ERROR:  column "st.cancel_date" must appear in the GROUP BY clause or be used in an aggregate function
LINE 68:         (select  st .drupal_user_id, cancel_date,
                                              ^


[2016-02-19 15:10:07.477] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:10:07.874] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:10:08.285] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:10:22.179] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:10:22.312] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151114'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151114'::date ivend,
          ud.user_behavior_segment,
          '20151114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151114' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20151114'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151114'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151115'
    and cancel_date <= '20151214'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20151114'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151114'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151114'
         where engagement_ratio > .25 
           AND created_date <= '20151214'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151114');
  
delete from tmp.sfss_bak where ivend = '20151114'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151114');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:10:23.424] [008612] [dwh-prod] [PGSQL]
ERROR:  column "st.cancel_date" must appear in the GROUP BY clause or be used in an aggregate function
LINE 68:         (select  st .drupal_user_id, cancel_date,
                                              ^


[2016-02-19 15:10:23.443] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:10:23.837] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:10:24.242] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:10:45.684] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:10:45.821] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151214'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151214'::date ivend,
          ud.user_behavior_segment,
          '20151214'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151214' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20151214'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151214'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151215'
    and cancel_date <= '20160114'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20151214'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151214'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151214'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151214'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151214'
         where engagement_ratio > .25 
           AND created_date <= '20160114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151214');
  
delete from tmp.sfss_bak where ivend = '20151214'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151214');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:10:47.476] [008612] [dwh-prod] [PGSQL]
ERROR:  column "st.cancel_date" must appear in the GROUP BY clause or be used in an aggregate function
LINE 68:         (select  st .drupal_user_id, cancel_date,
                                              ^


[2016-02-19 15:10:47.494] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:10:47.893] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:10:48.300] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:10:58.506] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:10:58.638] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151214'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151214'::date ivend,
          ud.user_behavior_segment,
          '20151214'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151214' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20151214'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151214'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151215'
    and cancel_date <= '20160114'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20151214'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151214'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151214'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151214'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151214'
         where engagement_ratio > .25 
           AND created_date <= '20160114'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151214');
  
delete from tmp.sfss_bak where ivend = '20151214'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151214');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:10:59.683] [008612] [dwh-prod] [PGSQL]
ERROR:  column "st.cancel_date" must appear in the GROUP BY clause or be used in an aggregate function
LINE 68:         (select  st .drupal_user_id, cancel_date,
                                              ^


[2016-02-19 15:10:59.705] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:11:00.111] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:11:00.435] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:12:07.218] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:12:07.349] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20150814'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20150814'::date ivend,
          ud.user_behavior_segment,
          '20150814'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150814' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20150814'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150814'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150815'
    and cancel_date <= '20150914'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20150814'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20150814'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20150814'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20150814'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20150814'
         where engagement_ratio > .25 
           AND created_date <= '20150914'::date
         group by st.drupal_user_id) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20150814');
  
delete from tmp.sfss_bak where ivend = '20150814'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150814');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:12:08.387] [008612] [dwh-prod] [PGSQL]
ERROR:  column "st.cancel_date" must appear in the GROUP BY clause or be used in an aggregate function
LINE 68:         (select  st .drupal_user_id, cancel_date,
                                              ^


[2016-02-19 15:12:08.407] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:12:08.808] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:12:09.214] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:12:53.804] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:12:53.933] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20150814'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20150814'::date ivend,
          ud.user_behavior_segment,
          '20150814'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150814' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20150814'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150814'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150815'
    and cancel_date <= '20150914'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20150814'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20150814'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20150814'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20150814'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20150814'
         where engagement_ratio > .25 
           AND created_date <= '20150914'::date
         group by st.drupal_user_id, cancel_date) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20150814');
  
delete from tmp.sfss_bak where ivend = '20150814'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150814');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:13:13.159] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:13:13.598] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:13:13.969] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:14:10.483] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:14:10.609] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20150914'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20150914'::date ivend,
          ud.user_behavior_segment,
          '20150914'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20150914' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20150914'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20150914'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20150915'
    and cancel_date <= '20151014'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20150914'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20150914'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20150914'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20150914'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20150914'
         where engagement_ratio > .25 
           AND created_date <= '20151014'::date
         group by st.drupal_user_id, cancel_date) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20150914');
  
delete from tmp.sfss_bak where ivend = '20150914'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20150914');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:14:30.955] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:14:31.299] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:14:31.732] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:17:00.663] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:17:00.799] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151014'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151014'::date ivend,
          ud.user_behavior_segment,
          '20151014'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151014' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20151014'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151014'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151015'
    and cancel_date <= '20151114'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20151014'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151014'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151014'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151014'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151014'
         where engagement_ratio > .25 
           AND created_date <= '20151114'::date
         group by st.drupal_user_id, cancel_date) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151014');
  
delete from tmp.sfss_bak where ivend = '20151014'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151014');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:17:14.293] [030487] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' AND "ivend" = '2015-08-14' AND "churn_flag" = '0' LIMIT 1000 OFFSET 0

[2016-02-19 15:17:14.474] [030487] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'sfss'

[2016-02-19 15:17:14.566] [030487] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192451

[2016-02-19 15:17:26.426] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:17:26.829] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:17:27.230] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:18:00.242] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:18:00.371] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151114'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151114'::date ivend,
          ud.user_behavior_segment,
          '20151114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151114' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20151114'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151114'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151115'
    and cancel_date <= '20151214'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20151114'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151114'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151114'
         where engagement_ratio > .25 
           AND created_date <= '20151214'::date
         group by st.drupal_user_id, cancel_date) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151114');
  
delete from tmp.sfss_bak where ivend = '20151114'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151114');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:18:27.203] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:18:27.641] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:18:28.046] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:18:48.984] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:18:49.111] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151214'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151214'::date ivend,
          ud.user_behavior_segment,
          '20151214'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151214' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20151214'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151214'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151215'
    and cancel_date <= '20160114'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20151214'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151214'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151214'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151214'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151214'
         where engagement_ratio > .25 
           AND created_date <= '20160114'::date
         group by st.drupal_user_id, cancel_date) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151214');
  
delete from tmp.sfss_bak where ivend = '20151214'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151214');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:47:23.517] [000421] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 15:47:23.596] [000421] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-19 15:47:23.899] [000420] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 15:47:23.984] [000420] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 15:47:24.080] [000420] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 15:47:24.165] [000420] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-19 15:47:24.249] [000420] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 15:47:24.846] [000420] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 15:47:24.928] [000420] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 15:47:25.013] [000420] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-19 15:47:25.096] [000420] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 15:47:25.181] [000420] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-19 15:47:25.263] [000420] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 15:47:25.633] [000420] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 15:47:25.713] [000420] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 15:47:25.799] [000420] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-19 15:47:25.882] [000420] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 15:47:27.176] [000421] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:47:27.296] [000421] [dwh-prod] [PGSQL]
select pid, query from pg_stat_activity
WHERE state = 'active'


[2016-02-19 15:47:27.391] [000421] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:47:27.761] [000421] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 11283

[2016-02-19 15:47:39.844] [000421] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:47:39.954] [000421] [dwh-prod] [PGSQL]
SELECT pg_cancel_backend(8612);


[2016-02-19 15:47:40.034] [008612] [dwh-prod] [PGSQL]
ERROR:  canceling statement due to user request


[2016-02-19 15:47:40.045] [000421] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:47:40.047] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:47:40.788] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:47:41.167] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:48:01.788] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:48:01.921] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151214'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151214'::date ivend,
          ud.user_behavior_segment,
          '20151214'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151214' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20151214'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151214'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151215'
    and cancel_date <= '20160114'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20151214'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151214'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151214'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151214'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151214'
         where engagement_ratio > .25 
           AND created_date <= '20160114'::date
         group by st.drupal_user_id, cancel_date) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151214');
  
delete from tmp.sfss_bak where ivend = '20151214'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151214');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:55:48.164] [000421] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:55:48.271] [000421] [dwh-prod] [PGSQL]
SELECT pg_cancel_backend(8612);


[2016-02-19 15:55:48.351] [008612] [dwh-prod] [PGSQL]
ERROR:  canceling statement due to user request


[2016-02-19 15:55:48.362] [000421] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:55:48.364] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:55:48.974] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:55:49.352] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:56:00.851] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:56:00.966] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20151214'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20151214'::date ivend,
          ud.user_behavior_segment,
          '20151214'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20151214' 
  and dss.status = 'Active');


[2016-02-19 15:56:01.889] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:56:25.346] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:56:25.462] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_targets where ivend = '20151214'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20151214'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20151215'
    and cancel_date <= '20160114'
    and cancel_date <= paid_through_date);


[2016-02-19 15:56:25.577] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:56:50.611] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:56:50.742] [008612] [dwh-prod] [PGSQL]
delete from tmp.video_views_master where ivend = '20151214'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20151214'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20151214'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20151214'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20151214'
         where engagement_ratio > .25 
           AND created_date <= '20160114'::date
         group by st.drupal_user_id, cancel_date) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20151214');


[2016-02-19 15:57:09.245] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:57:41.484] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:57:41.598] [008612] [dwh-prod] [PGSQL]
delete from tmp.sfss_bak where ivend = '20151214'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20151214');


[2016-02-19 15:57:42.228] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:58:28.358] [008612] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:58:28.507] [008612] [dwh-prod] [PGSQL]
delete from tmp.sub_master where ivend = '20160114'::date;

insert into tmp.sub_master
   (select dss.subscription_id,
          dss.gcsi_user_id,  
          ud.drupal_user_id, 
          '20160114'::date ivend,
          ud.user_behavior_segment,
          '20160114'::date - sd.start_date::date subscription_age
  from common.daily_status_snapshot dss 
  join common.user_dim ud on dss.gcsi_user_id = ud.gcsi_user_id
  join common.subscription_d sd on dss.subscription_id = sd.subscription_id
where dss.day_timestamp = '20160114' 
  and dss.status = 'Active');

select ivend, count(1)
from tmp.sub_master
group by ivend;

delete from tmp.sub_targets where ivend = '20160114'::date;

insert into tmp.sub_targets
  (select sd.subscription_id,
         sd.gcsi_user_id,
         sd.drupal_user_id,
         '20160114'::date ivend,
         sd.cancel_date::date, 
         1 hard_cancel_flag
  from common.subscription_d sd
  where cancel_date >= '20160115'
    and cancel_date <= '20160214'
    and cancel_date <= paid_through_date);

select ivend, count(1)
from tmp.sub_targets
group by ivend;

delete from tmp.video_views_master where ivend = '20160114'::date;




-- this is a little odd, but right now I think I want 
-- days since last video view as of the cancel date if they have one
insert into tmp.video_views_master
(select sm .drupal_user_id,
    '20160114'::date ivend,
    coalesce(v4.days_since_last_video_view, v2.days_since_last_video_view) days_since_last_video_view
from
    tmp.sub_master sm 
left join
    (select drupal_user_id,
        '20160114'::date - video_view_date days_since_last_video_view
     from
        (select distinct  sm .drupal_user_id,
               max(created_date) video_view_date
         from tmp.sub_master sm 
         left join common.video_daily_cube vdc
            on sm .drupal_user_id = vdc.user_id
         where engagement_ratio > .25 
           and created_date <= '20160114'
         group by sm.drupal_user_id) v1 ) v2
   on sm .drupal_user_id = v2.drupal_user_id
left join
     (select drupal_user_id,
        cancel_date::date - video_view_date days_since_last_video_view
      from
        (select  st .drupal_user_id, cancel_date,
               max(created_date) video_view_date
         from tmp.sub_targets st 
         left join common.video_daily_cube vdc
            on st .drupal_user_id = vdc.user_id and 
               st .ivend = '20160114'
         where engagement_ratio > .25 
           AND created_date <= '20160214'::date
         group by st.drupal_user_id, cancel_date) v3 ) v4 
   on v2.drupal_user_id = v4.drupal_user_id
where sm.ivend = '20160114');
  
delete from tmp.sfss_bak where ivend = '20160114'::date;

insert into tmp.sfss_bak
(select sm .*,
        vv.days_since_last_video_view,
        coalesce(st .hard_cancel_flag,0) churn_flag
 from tmp.sub_master sm 
 left join tmp.video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id and 
       sm.ivend = vv.ivend
 left join tmp.sub_targets st 
    on sm.drupal_user_id = st.drupal_user_id and 
       sm.ivend = st.ivend
where sm.ivend = '20160114');

drop table if exists tmp.sfss;

CREATE TABLE "tmp"."sfss" (
"id" serial,
"subscription_id" int8,
"gcsi_user_id" int8,
"drupal_user_id" int8,
"ivend" date,
"user_behavior_segment" text COLLATE "default",
"subscription_age" int4,
"days_since_last_video_view" int4,
"churn_flag" int4
)
WITH (OIDS=FALSE)
;


insert into tmp.sfss(subscription_id, gcsi_user_id, drupal_user_id, ivend, 
    user_behavior_segment, subscription_age,days_since_last_video_view,churn_flag)
(select * from tmp.sfss_bak);
        


[2016-02-19 15:58:51.048] [008612] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 15:58:51.447] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6134147

[2016-02-19 15:58:51.861] [008612] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192437

[2016-02-19 15:59:06.272] [030487] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."sfss" WHERE "user_behavior_segment" LIKE '%Yoga%' AND "subscription_age" < '30' AND "days_since_last_video_view" > '30' AND "ivend" = '2015-08-14' AND "churn_flag" = '0' LIMIT 1000 OFFSET 0

[2016-02-19 15:59:06.467] [030487] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'sfss'

[2016-02-19 15:59:06.566] [030487] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6192481

[2016-02-19 16:23:26.865] [011930] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 16:23:26.944] [011930] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-19 16:23:27.325] [011929] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 16:23:27.414] [011929] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 16:23:27.511] [011929] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 16:23:27.596] [011929] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-19 16:23:27.678] [011929] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 16:23:28.303] [011929] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 16:23:28.419] [011929] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 16:23:28.518] [011929] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-19 16:23:28.600] [011929] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 16:23:28.685] [011929] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-19 16:23:28.766] [011929] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 16:23:29.121] [011929] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 16:23:29.201] [011929] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 16:23:29.290] [011929] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-19 16:23:29.374] [011929] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 16:26:12.222] [011930] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 16:26:12.378] [011930] [dwh-prod] [PGSQL]
drop table if exists common.engagement_level;

create table common.engagement_level (
   user_behavior_segment varchar(255),
   tenure_cat_low   integer,
   tenure_cat_high  integer,
   days_since_last_video_view_low integer,
   days_since_last_video_view_high integer,
   engagement_level varchar(10)
);


alter table common.engagement_level owner to dw_admin;

insert into common.engagement_level values('My Yoga',0,120,0,15,'High');
insert into common.engagement_level values('My Yoga',0,120,16,40,'Medium');
insert into common.engagement_level values('My Yoga',0,120,41,70,'Low');
insert into common.engagement_level values('My Yoga',0,120,71,999999,'Dormant');
insert into common.engagement_level values('My Yoga',121,395,0,20,'High');
insert into common.engagement_level values('My Yoga',121,395,21,45,'Medium');
insert into common.engagement_level values('My Yoga',121,395,46,90,'Low');
insert into common.engagement_level values('My Yoga',121,395,91,999999,'Dormant');
insert into common.engagement_level values('My Yoga',396,999999,0,20,'High');
insert into common.engagement_level values('My Yoga',396,999999,21,45,'Medium');
insert into common.engagement_level values('My Yoga',396,999999,46,90,'Low');
insert into common.engagement_level values('My Yoga',396,999999,91,999999,'Dormant');

insert into common.engagement_level values('Spiritual Growth',0,120,0,9,'High');
insert into common.engagement_level values('Spiritual Growth',0,120,10,40,'Medium');
insert into common.engagement_level values('Spiritual Growth',0,120,41,60,'Low');
insert into common.engagement_level values('Spiritual Growth',0,120,61,999999,'Dormant');
insert into common.engagement_level values('Spiritual Growth',121,395,0,20,'High');
insert into common.engagement_level values('Spiritual Growth',121,395,21,40,'Medium');
insert into common.engagement_level values('Spiritual Growth',121,395,41,90,'Low');
insert into common.engagement_level values('Spiritual Growth',121,395,91,999999,'Dormant');
insert into common.engagement_level values('Spiritual Growth',396,999999,0,14,'High');
insert into common.engagement_level values('Spiritual Growth',396,999999,15,30,'Medium');
insert into common.engagement_level values('Spiritual Growth',396,999999,31,90,'Low');
insert into common.engagement_level values('Spiritual Growth',396,999999,91,999999,'Dormant');

insert into common.engagement_level values('Seeking Truth',0,120,0,6,'High');
insert into common.engagement_level values('Seeking Truth',0,120,7,14,'Medium');
insert into common.engagement_level values('Seeking Truth',0,120,15,45,'Low');
insert into common.engagement_level values('Seeking Truth',0,120,46,999999,'Dormant');
insert into common.engagement_level values('Seeking Truth',121,395,0,12,'High');
insert into common.engagement_level values('Seeking Truth',121,395,13,21,'Medium');
insert into common.engagement_level values('Seeking Truth',121,395,22,90,'Low');
insert into common.engagement_level values('Seeking Truth',121,395,91,999999,'Dormant');
insert into common.engagement_level values('Seeking Truth',396,999999,0,10,'High');
insert into common.engagement_level values('Seeking Truth',396,999999,11,17,'Medium');
insert into common.engagement_level values('Seeking Truth',396,999999,18,90,'Low');
insert into common.engagement_level values('Seeking Truth',396,999999,91,999999,'Dormant');

insert into common.engagement_level values('No Clear Segment',0,120,0,10,'High');
insert into common.engagement_level values('No Clear Segment',0,120,11,25,'Medium');
insert into common.engagement_level values('No Clear Segment',0,120,26,60,'Low');
insert into common.engagement_level values('No Clear Segment',0,120,61,999999,'Dormant');
insert into common.engagement_level values('No Clear Segment',121,395,0,14,'High');
insert into common.engagement_level values('No Clear Segment',121,395,15,25,'Medium');
insert into common.engagement_level values('No Clear Segment',121,395,26,90,'Low');
insert into common.engagement_level values('No Clear Segment',121,395,91,999999,'Dormant');
insert into common.engagement_level values('No Clear Segment',396,999999,0,14,'High');
insert into common.engagement_level values('No Clear Segment',396,999999,15,30,'Medium');
insert into common.engagement_level values('No Clear Segment',396,999999,31,90,'Low');
insert into common.engagement_level values('No Clear Segment',396,999999,91,999999,'Dormant');


[2016-02-19 16:26:12.637] [011930] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-19 16:26:35.815] [015447] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 16:26:35.892] [015447] [dwh-dev] [PGSQL]
SHOW search_path

[2016-02-19 16:26:36.200] [015446] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-19 16:26:36.278] [015446] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 16:26:36.388] [015446] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 16:26:36.529] [015446] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-19 16:26:36.617] [015446] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 16:26:37.050] [015446] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 16:26:37.130] [015446] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 16:26:37.237] [015446] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-19 16:26:37.321] [015446] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-19 16:26:37.402] [015446] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-19 16:26:37.482] [015446] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-19 16:26:37.757] [015446] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-19 16:26:37.835] [015446] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-19 16:26:37.918] [015446] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-19 16:26:38.000] [015446] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-19 16:26:39.807] [015447] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-19 16:26:39.947] [015447] [dwh-dev] [PGSQL]
drop table if exists common.engagement_level;

create table common.engagement_level (
   user_behavior_segment varchar(255),
   tenure_cat_low   integer,
   tenure_cat_high  integer,
   days_since_last_video_view_low integer,
   days_since_last_video_view_high integer,
   engagement_level varchar(10)
);


alter table common.engagement_level owner to dw_admin;

insert into common.engagement_level values('My Yoga',0,120,0,15,'High');
insert into common.engagement_level values('My Yoga',0,120,16,40,'Medium');
insert into common.engagement_level values('My Yoga',0,120,41,70,'Low');
insert into common.engagement_level values('My Yoga',0,120,71,999999,'Dormant');
insert into common.engagement_level values('My Yoga',121,395,0,20,'High');
insert into common.engagement_level values('My Yoga',121,395,21,45,'Medium');
insert into common.engagement_level values('My Yoga',121,395,46,90,'Low');
insert into common.engagement_level values('My Yoga',121,395,91,999999,'Dormant');
insert into common.engagement_level values('My Yoga',396,999999,0,20,'High');
insert into common.engagement_level values('My Yoga',396,999999,21,45,'Medium');
insert into common.engagement_level values('My Yoga',396,999999,46,90,'Low');
insert into common.engagement_level values('My Yoga',396,999999,91,999999,'Dormant');

insert into common.engagement_level values('Spiritual Growth',0,120,0,9,'High');
insert into common.engagement_level values('Spiritual Growth',0,120,10,40,'Medium');
insert into common.engagement_level values('Spiritual Growth',0,120,41,60,'Low');
insert into common.engagement_level values('Spiritual Growth',0,120,61,999999,'Dormant');
insert into common.engagement_level values('Spiritual Growth',121,395,0,20,'High');
insert into common.engagement_level values('Spiritual Growth',121,395,21,40,'Medium');
insert into common.engagement_level values('Spiritual Growth',121,395,41,90,'Low');
insert into common.engagement_level values('Spiritual Growth',121,395,91,999999,'Dormant');
insert into common.engagement_level values('Spiritual Growth',396,999999,0,14,'High');
insert into common.engagement_level values('Spiritual Growth',396,999999,15,30,'Medium');
insert into common.engagement_level values('Spiritual Growth',396,999999,31,90,'Low');
insert into common.engagement_level values('Spiritual Growth',396,999999,91,999999,'Dormant');

insert into common.engagement_level values('Seeking Truth',0,120,0,6,'High');
insert into common.engagement_level values('Seeking Truth',0,120,7,14,'Medium');
insert into common.engagement_level values('Seeking Truth',0,120,15,45,'Low');
insert into common.engagement_level values('Seeking Truth',0,120,46,999999,'Dormant');
insert into common.engagement_level values('Seeking Truth',121,395,0,12,'High');
insert into common.engagement_level values('Seeking Truth',121,395,13,21,'Medium');
insert into common.engagement_level values('Seeking Truth',121,395,22,90,'Low');
insert into common.engagement_level values('Seeking Truth',121,395,91,999999,'Dormant');
insert into common.engagement_level values('Seeking Truth',396,999999,0,10,'High');
insert into common.engagement_level values('Seeking Truth',396,999999,11,17,'Medium');
insert into common.engagement_level values('Seeking Truth',396,999999,18,90,'Low');
insert into common.engagement_level values('Seeking Truth',396,999999,91,999999,'Dormant');

insert into common.engagement_level values('No Clear Segment',0,120,0,10,'High');
insert into common.engagement_level values('No Clear Segment',0,120,11,25,'Medium');
insert into common.engagement_level values('No Clear Segment',0,120,26,60,'Low');
insert into common.engagement_level values('No Clear Segment',0,120,61,999999,'Dormant');
insert into common.engagement_level values('No Clear Segment',121,395,0,14,'High');
insert into common.engagement_level values('No Clear Segment',121,395,15,25,'Medium');
insert into common.engagement_level values('No Clear Segment',121,395,26,90,'Low');
insert into common.engagement_level values('No Clear Segment',121,395,91,999999,'Dormant');
insert into common.engagement_level values('No Clear Segment',396,999999,0,14,'High');
insert into common.engagement_level values('No Clear Segment',396,999999,15,30,'Medium');
insert into common.engagement_level values('No Clear Segment',396,999999,31,90,'Low');
insert into common.engagement_level values('No Clear Segment',396,999999,91,999999,'Dormant');


[2016-02-19 16:26:40.176] [015447] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 10:40:13.683] [026080] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 10:40:13.770] [026080] [dwh-dev] [PGSQL]
SHOW search_path

[2016-02-22 10:40:14.044] [026079] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 10:40:14.134] [026079] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 10:40:14.276] [026079] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 10:40:14.410] [026079] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-22 10:40:14.503] [026079] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 10:40:15.415] [026079] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 10:40:15.498] [026079] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 10:40:15.606] [026079] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-22 10:40:15.688] [026079] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 10:40:15.799] [026079] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-22 10:40:15.901] [026079] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 10:40:16.586] [026079] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 10:40:16.664] [026079] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 10:40:16.746] [026079] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-22 10:40:16.826] [026079] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 10:43:10.048] [027890] [dwh-dev] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common'

[2016-02-22 10:43:10.052] [027890] [dwh-dev] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-22 10:43:10.619] [026205] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 10:43:10.697] [026205] [dwh-dev] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common'

[2016-02-22 10:43:25.638] [026210] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 10:43:25.717] [026205] [dwh-dev] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'video_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-22 10:43:25.971] [026205] [dwh-dev] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-22 10:43:26.335] [026205] [dwh-dev] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-22 10:43:26.414] [026205] [dwh-dev] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'video_d' AND conname IS NOT NULL

[2016-02-22 10:43:26.505] [026205] [dwh-dev] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'video_d' ORDER BY t.relname, i.oid

[2016-02-22 10:43:26.598] [026205] [dwh-dev] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'video_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-22 10:43:26.832] [026210] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" LIMIT 1000 OFFSET 0

[2016-02-22 10:43:29.955] [026210] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-22 10:43:30.077] [026210] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12286149

[2016-02-22 10:45:59.412] [026287] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 10:45:59.494] [026287] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 10:45:59.595] [026287] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-22 10:45:59.677] [026287] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 10:46:00.698] [026287] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 10:46:00.778] [026287] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 10:46:00.868] [026287] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-22 10:46:01.544] [026289] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 10:46:01.632] [026289] [dwh-dev] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_tmp' ORDER BY ordinal_position

[2016-02-22 10:46:02.455] [026290] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 10:46:02.556] [026290] [dwh-dev] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_d' ORDER BY ordinal_position

[2016-02-22 10:46:03.645] [026292] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 10:46:03.729] [026292] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'drupal') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 10:46:04.127] [026292] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='drupal' ORDER BY schemaname, viewname

[2016-02-22 10:46:04.214] [026292] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 10:46:05.634] [026292] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 10:46:05.716] [026292] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'drupal' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 10:46:05.813] [026292] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'drupal' 

[2016-02-22 10:46:06.585] [026293] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 10:46:06.710] [026293] [dwh-dev] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='drupal' AND table_name='node' ORDER BY ordinal_position

[2016-02-22 10:50:17.507] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 10:50:17.645] [026080] [dwh-dev] [PGSQL]
select v.title, 
       date_part(month,(current_date - v.created_date)::interval)) video_age,
       v.page_nid,
       v.duration,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join common.video_d v
on vt.nid = v.media_nid
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
 and  vt.created > 1420070400
group by v.title, date_part(month,(current_date - v.created_date)::interval)),v.page_nid, v.duration;


[2016-02-22 10:50:17.723] [026080] [dwh-dev] [PGSQL]
ERROR:  syntax error at or near ")"
LINE 2: ...t(month,(current_date - v.created_date)::interval)) video_ag...
                                                             ^


[2016-02-22 10:50:17.742] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 10:50:48.589] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 10:50:48.712] [026080] [dwh-dev] [PGSQL]
select v.title, 
       date_part(month,current_date - v.created_date) video_age,
       v.page_nid,
       v.duration,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join common.video_d v
on vt.nid = v.media_nid
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
 and  vt.created > 1420070400
group by v.title, date_part(month,current_date - v.created_date),v.page_nid, v.duration;


[2016-02-22 10:50:48.807] [026080] [dwh-dev] [PGSQL]
ERROR:  column "month" does not exist
LINE 2:        date_part(month,current_date - v.created_date) video_...
                         ^


[2016-02-22 10:50:48.826] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 10:51:05.651] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 10:51:05.778] [026080] [dwh-dev] [PGSQL]
select v.title, 
       date_part('month',current_date - v.created_date) video_age,
       v.page_nid,
       v.duration,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join common.video_d v
on vt.nid = v.media_nid
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
 and  vt.created > 1420070400
group by v.title, date_part('month',current_date - v.created_date),v.page_nid, v.duration;


[2016-02-22 10:51:05.884] [026080] [dwh-dev] [PGSQL]
ERROR:  function date_part(unknown, integer) does not exist
LINE 2:        date_part('month',current_date - v.created_date) vide...
               ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.


[2016-02-22 10:51:05.903] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 10:51:38.797] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 10:51:38.921] [026080] [dwh-dev] [PGSQL]
select v.title, 
       date_part('month',(current_date - v.created_date)::interval) video_age,
       v.page_nid,
       v.duration,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join common.video_d v
on vt.nid = v.media_nid
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
 and  vt.created > 1420070400
group by v.title, date_part('month',(current_date - v.created_date)::INTERVAL),v.page_nid, v.duration;


[2016-02-22 10:51:39.005] [026080] [dwh-dev] [PGSQL]
ERROR:  cannot cast type integer to interval
LINE 2: ... date_part('month',(current_date - v.created_date)::interval...
                                                             ^


[2016-02-22 10:51:39.026] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 10:52:48.312] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 10:52:48.410] [026080] [dwh-dev] [PGSQL]
select date_part('month',(current_date::timestamp - v.created_date::timestamp) from common.video_d;


[2016-02-22 10:52:48.501] [026080] [dwh-dev] [PGSQL]
ERROR:  syntax error at or near "from"
LINE 1: ...rent_date::timestamp - v.created_date::timestamp) from commo...
                                                             ^


[2016-02-22 10:52:48.516] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 10:53:06.407] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 10:53:06.506] [026080] [dwh-dev] [PGSQL]

select date_part('month',current_date::timestamp - v.created_date::timestamp) from common.video_d;


[2016-02-22 10:53:06.585] [026080] [dwh-dev] [PGSQL]
ERROR:  missing FROM-clause entry for table "v"
LINE 2: ...elect date_part('month',current_date::timestamp - v.created_...
                                                             ^


[2016-02-22 10:53:06.595] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 10:53:16.117] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 10:53:16.769] [026080] [dwh-dev] [PGSQL]

select date_part('month',current_date::timestamp - created_date::timestamp) from common.video_d;


[2016-02-22 10:53:18.125] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 10:53:54.185] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 10:53:54.288] [026080] [dwh-dev] [PGSQL]
select date_part('month',current_date::timestamp - created_date::timestamp) from common.video_d, count(1)
group by date_part('month',current_date::timestamp - created_date::timestamp)
limit 10


[2016-02-22 10:53:54.367] [026080] [dwh-dev] [PGSQL]
ERROR:  aggregate functions are not allowed in functions in FROM
LINE 1: ...amp - created_date::timestamp) from common.video_d, count(1)
                                                               ^


[2016-02-22 10:53:54.378] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 10:54:15.511] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 10:54:15.609] [026080] [dwh-dev] [PGSQL]
select date_part('month',current_date::timestamp - created_date::timestamp), count(1) from common.video_d
group by date_part('month',current_date::timestamp - created_date::timestamp)
limit 10


[2016-02-22 10:54:15.720] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 10:55:27.079] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 10:55:27.183] [026080] [dwh-dev] [PGSQL]
select current_date::date - created_date, count(1) from common.video_d
group by (current_date::date - created_date)
limit 10


[2016-02-22 10:55:27.295] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 10:57:56.793] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 10:57:56.937] [026080] [dwh-dev] [PGSQL]
with v as 
(select title, 
        (current_date::date - created_date)/30 video_age
        page_nid, 
        duration
 from common.video_d)
select v.*
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v
on vt.nid = v.media_nid
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
 and  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration;



[2016-02-22 10:57:57.018] [026080] [dwh-dev] [PGSQL]
ERROR:  syntax error at or near "page_nid"
LINE 4:         page_nid, 
                ^


[2016-02-22 10:57:57.038] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 10:58:04.112] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 10:58:04.229] [026080] [dwh-dev] [PGSQL]
with v as 
(select title, 
        (current_date::date - created_date)/30 video_age,
        page_nid, 
        duration
 from common.video_d)
select v.*
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v
on vt.nid = v.media_nid
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
 and  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration;



[2016-02-22 10:58:04.308] [026080] [dwh-dev] [PGSQL]
ERROR:  syntax error at or near "("
LINE 8:        count(1)total_views, 
                    ^


[2016-02-22 10:58:04.327] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 10:58:10.571] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 10:58:10.709] [026080] [dwh-dev] [PGSQL]
with v as 
(select title, 
        (current_date::date - created_date)/30 video_age,
        page_nid, 
        duration
 from common.video_d)
select v.*,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v
on vt.nid = v.media_nid
join drupal.node n
  on v.page_nid = n.nid
where admin_category = 'Yoga'
  and n.status = 1
  and feature = 'Feature'
 and  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration;



[2016-02-22 10:58:10.814] [026080] [dwh-dev] [PGSQL]
ERROR:  column v.media_nid does not exist
LINE 12: on vt.nid = v.media_nid
                     ^


[2016-02-22 10:58:10.832] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 11:00:03.638] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 11:00:03.755] [026080] [dwh-dev] [PGSQL]
with v as 
    (select title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid
     from common.video_d
     where admin_category = 'Yoga'
      and n.status = 1
      and feature = 'Feature')
select v.*,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v
on vt.nid = v.media_nid
join drupal.node n
  on v.page_nid = n.nid
 and  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration;



[2016-02-22 11:00:03.837] [026080] [dwh-dev] [PGSQL]
ERROR:  missing FROM-clause entry for table "n"
LINE 9:       and n.status = 1
                  ^


[2016-02-22 11:00:03.855] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 11:00:59.528] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 11:00:59.642] [026080] [dwh-dev] [PGSQL]
with v as 
    (select title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid
     from common.video_d
     join drupal.node n on v.page_nid = n.nid
     where admin_category = 'Yoga'
      and n.status = 1
      and feature = 'Feature')
select v.*,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v on vt.nid = v.media_nid
where  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration;



[2016-02-22 11:00:59.722] [026080] [dwh-dev] [PGSQL]
ERROR:  missing FROM-clause entry for table "v"
LINE 8:      join drupal.node n on v.page_nid = n.nid
                                   ^


[2016-02-22 11:00:59.743] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 11:01:18.754] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 11:01:18.869] [026080] [dwh-dev] [PGSQL]
with v as 
    (select title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category = 'Yoga'
      and n.status = 1
      and feature = 'Feature')
select v.*,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v on vt.nid = v.media_nid
where  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration;



[2016-02-22 11:01:18.991] [026080] [dwh-dev] [PGSQL]
ERROR:  column reference "title" is ambiguous
LINE 2:     (select title, 
                    ^


[2016-02-22 11:01:19.011] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 11:01:26.978] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 11:01:27.095] [026080] [dwh-dev] [PGSQL]
with v as 
    (select v.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category = 'Yoga'
      and n.status = 1
      and feature = 'Feature')
select v.*,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v on vt.nid = v.media_nid
where  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration;



[2016-02-22 11:01:27.175] [026080] [dwh-dev] [PGSQL]
ERROR:  missing FROM-clause entry for table "v"
LINE 2:     (select v.title, 
                    ^


[2016-02-22 11:01:27.229] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 11:01:34.316] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 11:01:34.441] [026080] [dwh-dev] [PGSQL]
with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category = 'Yoga'
      and n.status = 1
      and feature = 'Feature')
select v.*,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v on vt.nid = v.media_nid
where  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration;



[2016-02-22 11:01:34.525] [026080] [dwh-dev] [PGSQL]
ERROR:  column "v.media_nid" must appear in the GROUP BY clause or be used in an aggregate function


[2016-02-22 11:01:34.543] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 11:02:32.560] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 11:02:32.675] [026080] [dwh-dev] [PGSQL]
with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category = 'Yoga'
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v on vt.nid = v.media_nid
where  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration;



[2016-02-22 11:04:28.767] [015939] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 11:04:28.859] [015939] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-22 11:04:29.139] [015938] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 11:04:29.221] [015938] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 11:04:29.314] [015938] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 11:04:29.405] [015938] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-22 11:04:29.488] [015938] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 11:04:30.031] [015938] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 11:04:30.112] [015938] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 11:04:30.200] [015938] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-22 11:04:30.285] [015938] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 11:04:30.372] [015938] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-22 11:04:30.454] [015938] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 11:04:30.664] [015938] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 11:04:30.752] [015938] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 11:04:30.839] [015938] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-22 11:04:30.926] [015938] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 11:04:38.235] [015939] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 11:04:38.373] [015939] [dwh-prod] [PGSQL]
with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category = 'Fitness'
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v on vt.nid = v.media_nid
where  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration;


[2016-02-22 11:04:58.866] [015939] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 11:04:59.296] [015939] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6251015

[2016-02-22 11:05:36.661] [026080] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 11:05:37.058] [026080] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12286149

[2016-02-22 12:29:55.057] [028313] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:29:55.133] [028313] [dwh-dev] [PGSQL]
SHOW search_path

[2016-02-22 12:29:55.274] [028312] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:29:55.350] [028312] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 12:29:55.443] [028312] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 12:29:55.534] [028312] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-22 12:29:55.614] [028312] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 12:29:56.727] [028312] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 12:29:56.805] [028312] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 12:29:56.897] [028312] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-22 12:29:56.975] [028312] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 12:29:57.054] [028312] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-22 12:29:57.132] [028312] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 12:29:58.075] [028312] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 12:29:58.158] [028312] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 12:29:58.237] [028312] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-22 12:29:58.316] [028312] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 12:33:47.557] [028382] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:33:47.641] [026205] [dwh-dev] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'plan_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-22 12:33:47.641] [026205] [dwh-dev] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-22 12:33:48.217] [028383] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:33:48.295] [028383] [dwh-dev] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'plan_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-22 12:33:48.438] [028383] [dwh-dev] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-22 12:33:48.827] [028383] [dwh-dev] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-22 12:33:48.956] [028383] [dwh-dev] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'plan_d' AND conname IS NOT NULL

[2016-02-22 12:33:49.064] [028383] [dwh-dev] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'plan_d' ORDER BY t.relname, i.oid

[2016-02-22 12:33:49.183] [028383] [dwh-dev] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'plan_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-22 12:33:49.409] [028382] [dwh-dev] [PGSQL]
SELECT * FROM "common"."plan_d" LIMIT 1000 OFFSET 0

[2016-02-22 12:33:49.573] [028382] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'plan_d'

[2016-02-22 12:33:49.669] [028382] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12286264

[2016-02-22 12:36:15.669] [028438] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:36:15.749] [028438] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 12:36:15.853] [028438] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-22 12:36:15.939] [028438] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 12:36:16.372] [028438] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 12:36:16.453] [028438] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 12:36:16.542] [028438] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-22 12:36:17.185] [028439] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:36:17.265] [028439] [dwh-dev] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='current_users' ORDER BY ordinal_position

[2016-02-22 12:40:16.429] [028383] [dwh-dev] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'tmp'

[2016-02-22 12:40:41.766] [028515] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:40:41.844] [028383] [dwh-dev] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'facet_groups' ORDER BY col.table_name, col.ordinal_position

[2016-02-22 12:40:41.943] [028383] [dwh-dev] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-22 12:40:42.317] [028383] [dwh-dev] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-22 12:40:42.396] [028383] [dwh-dev] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'facet_groups' AND conname IS NOT NULL

[2016-02-22 12:40:42.476] [028383] [dwh-dev] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'facet_groups' ORDER BY t.relname, i.oid

[2016-02-22 12:40:42.559] [028383] [dwh-dev] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'facet_groups' ORDER BY t.relname, c.conname, a.attnum

[2016-02-22 12:40:42.775] [028515] [dwh-dev] [PGSQL]
SELECT * FROM "common"."facet_groups" LIMIT 1000 OFFSET 0

[2016-02-22 12:40:43.019] [028515] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'facet_groups'

[2016-02-22 12:40:43.118] [028515] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12286052

[2016-02-22 12:40:59.678] [028518] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:40:59.770] [028383] [dwh-dev] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'facet_levels' ORDER BY col.table_name, col.ordinal_position

[2016-02-22 12:40:59.869] [028383] [dwh-dev] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-22 12:41:00.274] [028383] [dwh-dev] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-22 12:41:00.353] [028383] [dwh-dev] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'facet_levels' AND conname IS NOT NULL

[2016-02-22 12:41:00.434] [028383] [dwh-dev] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'facet_levels' ORDER BY t.relname, i.oid

[2016-02-22 12:41:00.517] [028383] [dwh-dev] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'facet_levels' ORDER BY t.relname, c.conname, a.attnum

[2016-02-22 12:41:00.738] [028518] [dwh-dev] [PGSQL]
SELECT * FROM "common"."facet_levels" LIMIT 1000 OFFSET 0

[2016-02-22 12:41:00.820] [028518] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'facet_levels'

[2016-02-22 12:41:00.916] [028518] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12286070

[2016-02-22 12:46:38.967] [028637] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:46:39.044] [028637] [dwh-dev] [PGSQL]
SHOW search_path

[2016-02-22 12:46:39.321] [028636] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:46:39.398] [028636] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 12:46:39.512] [028636] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 12:46:39.599] [028636] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-22 12:46:39.680] [028636] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 12:46:40.108] [028636] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 12:46:40.187] [028636] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 12:46:40.271] [028636] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-22 12:46:40.352] [028636] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 12:46:40.448] [028636] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-22 12:46:40.530] [028636] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 12:46:40.726] [028636] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 12:46:40.808] [028636] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 12:46:40.891] [028636] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-22 12:46:40.971] [028636] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 12:46:49.317] [028640] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:46:49.394] [028640] [dwh-dev] [PGSQL]
SHOW search_path

[2016-02-22 12:46:49.681] [028639] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:46:49.760] [028639] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 12:46:49.868] [028639] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 12:46:49.957] [028639] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-22 12:46:50.037] [028639] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 12:46:50.485] [028639] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 12:46:50.564] [028639] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 12:46:50.650] [028639] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-22 12:46:50.729] [028639] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 12:46:50.827] [028639] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-22 12:46:50.910] [028639] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 12:46:51.182] [028639] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 12:46:51.262] [028639] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 12:46:51.346] [028639] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-22 12:46:51.427] [028639] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 12:48:07.630] [015526] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:48:07.905] [030357] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'drupal' AND col.table_name = 'content_field_facet_yoga_style' ORDER BY col.table_name, col.ordinal_position

[2016-02-22 12:48:07.906] [030357] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-22 12:48:08.497] [015527] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:48:08.579] [015527] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'drupal' AND col.table_name = 'content_field_facet_yoga_style' ORDER BY col.table_name, col.ordinal_position

[2016-02-22 12:48:08.696] [015527] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-22 12:48:09.338] [015527] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-22 12:48:09.454] [015527] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'drupal' AND ct.relname = 'content_field_facet_yoga_style' AND conname IS NOT NULL

[2016-02-22 12:48:09.543] [015527] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'drupal' AND t.relname = 'content_field_facet_yoga_style' ORDER BY t.relname, i.oid

[2016-02-22 12:48:09.632] [015527] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'drupal' AND t.relname = 'content_field_facet_yoga_style' ORDER BY t.relname, c.conname, a.attnum

[2016-02-22 12:48:09.854] [015526] [dwh-prod] [PGSQL]
SELECT * FROM "drupal"."content_field_facet_yoga_style" LIMIT 1000 OFFSET 0

[2016-02-22 12:48:10.364] [015526] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'drupal' AND cl.table_name = 'content_field_facet_yoga_style'

[2016-02-22 12:48:10.463] [015526] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6232330

[2016-02-22 12:50:12.571] [016146] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:50:12.651] [015527] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'facets_tmp' ORDER BY col.table_name, col.ordinal_position

[2016-02-22 12:50:12.757] [015527] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-22 12:50:13.162] [015527] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-22 12:50:13.429] [015527] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'facets_tmp' AND conname IS NOT NULL

[2016-02-22 12:50:13.523] [015527] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'facets_tmp' ORDER BY t.relname, i.oid

[2016-02-22 12:50:13.608] [015527] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'facets_tmp' ORDER BY t.relname, c.conname, a.attnum

[2016-02-22 12:50:13.796] [016146] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."facets_tmp" LIMIT 1000 OFFSET 0

[2016-02-22 12:50:14.444] [016146] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'facets_tmp'

[2016-02-22 12:50:14.545] [016146] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6250912

[2016-02-22 12:50:40.940] [016297] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:50:41.021] [016297] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 12:50:41.132] [016297] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-22 12:50:41.213] [016297] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 12:50:41.812] [016297] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 12:50:41.891] [016297] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 12:50:41.977] [016297] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-22 12:50:44.502] [016311] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:50:44.582] [016311] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='facets_tmp' ORDER BY ordinal_position

[2016-02-22 12:51:45.073] [015939] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 12:51:45.074] [015939] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-22 12:51:45.668] [016668] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 12:51:45.750] [016668] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 12:51:45.876] [016668] [dwh-prod] [PGSQL]
select distinct name from tmp.facets_tmp
where facet_name = 'style';


[2016-02-22 12:51:45.980] [016668] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 12:51:46.311] [016668] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6250912

[2016-02-22 12:52:51.457] [016668] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 12:52:51.588] [016668] [dwh-prod] [PGSQL]
drop table if exists sub_master_30_60_90;


create table sub_master_30_60_90 as
select t3.*,
   case when paid_through_age >= 28 then 1 else 0 end sub_30_day,
   case when paid_through_age >= 58 and
             anniversary_60_date < '2016-02-15'::date and
             churn_30_day = 0 
        then 1 
        else  churn_60_day  -- if they are counted as a churner, make sure they are counted as a sub
   end sub_60_day,
   case when paid_through_age >= 88 and
             anniversary_90_date < '2016-02-15'::date and
             churn_60_day = 0 
        then 1 
        else churn_90_day   -- if they are counted as a churner, make sure they are counted as a sub
   end sub_90_day
from
   (select t2.*,
       case when cancel_age <= 34 then 1 
						when paid_through_age <= 31 and cancel_age is not null then 1
            when cancel_age between 118 and 122 AND
                 long_hold = 1 then 1 
            else 0
       end   churn_30_day,
       case when cancel_age >  34 and cancel_age <= 64 then 1 
            when paid_through_age > 31 and paid_through_age  <= 61 and cancel_age is not null then 1
            when cancel_age between 148 and 152 AND
                 long_hold = 1 then 1 
            else 0
       end   churn_60_day,
       case when cancel_age >  64 and cancel_age <= 94 then 1 
            when paid_through_age > 61 and paid_through_age  <= 91 and cancel_age is not null then 1
            when cancel_age between 178 and 182 AND
                 long_hold = 1 then 1 
            else 0
       end   churn_90_day
    from
        (select t1.*,
           case when hold_age > 15  
            then 1
            else 0
           end long_hold
        from
        (select gcsi_user_id, drupal_user_id, 
           subscription_id, 
           onboarding_segment,
           onboarding_parent,
           user_behavior_segment, 
           campaign_dept,
           case when status = 'Hold'
                then '2016-02-15'::date - valid_from 
           end hold_age,
           subscription_start_date::date subscription_start_date,
           cancel_date::date cancel_date,
           paid_through_date::date, 
           subscription_start_date::date + 30 anniversary_30_date,
           subscription_start_date::date + 60 anniversary_60_date,
           subscription_start_date::date + 90 anniversary_90_date,
           subscription_start_date::date + 1200 anniversary_120_date,
           cancel_date::date - subscription_start_date::date cancel_age,
           paid_through_date::date - subscription_start_date::date paid_through_age,
           '2016-01-15'::date - subscription_start_date::date iv_age
        from common.current_users
        where plan_id = 21891276
          and winback = 'New User'
          and subscription_start_date <= '2015-01-15'
           and (onboarding_parent = 'Yoga' or 
                user_behavior_segment = 'My Yoga' OR
                source_name = 'MYO')) t1
        where paid_through_age > 0) t2 )t3
;



drop table if exists video_views_master;
drop table if exists video_view_days;
drop table if exists video_views_30_60_90;

create table video_views_30_60_90 as 
select
    drupal_user_id,
    period, 
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.level_1_views,0)                   level_1_views,
    coalesce(vxc.level_1_watched,0)                 level_1_watched,
    coalesce(vxc.level_2_views,0)                   level_2_views,
    coalesce(vxc.level_2_watched,0)                 level_2_watched,
    coalesce(vxc.level_3_views,0)                   level_3_views,
    coalesce(vxc.level_3_watched,0)                 level_3_watched,
    coalesce(vxc.duration_lt_15_views,0)            duration_lt_15_views,
    coalesce(vxc.duration_lt_15_watched,0)          duration_lt_15_watched,
    coalesce(vxc.duration_15_to_29_views,0)         duration_15_to_29_views,
    coalesce(vxc.duration_15_to_29_watched,0)       duration_15_to_29_watched,
    coalesce(vxc.duration_30_to_59_views,0)         duration_30_to_59_views,
    coalesce(vxc.duration_30_to_59_watched,0)       duration_30_to_59_watched,
    coalesce(vxc.duration_ge_60_views,0)            duration_ge_60_views,
    coalesce(vxc.duration_ge_60_watched,0)          duration_ge_60_watched,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched,
    coalesce(vxc.guide_day_views,0)                 guide_day_views,
    coalesce(vxc.first_quartile_complete_rat,0)     first_quartile_complete_rat,
    coalesce(vxc.second_quartile_complete_rat,0)    second_quartile_complete_rat,
    coalesce(vxc.third_quartile_complete_rat,0)     third_quartile_complete_rat,
    coalesce(vxc.fourth_quartile_complete_rat,0)    fourth_quartile_complete_rat
from
    (select drupal_user_id,
       period,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(level_1_views)                                   level_1_views, 
       sum(level_1_watched)                                 level_1_watched,   
       sum(level_2_views)                                   level_2_views,   
       sum(level_2_watched)                                 level_2_watched,
       sum(level_3_views)                                   level_3_views,
       sum(level_3_watched)                                 level_3_watched,
       sum(duration_lt_15_views)                            duration_lt_15_views,
       sum(duration_lt_15_watched)                          duration_lt_15_watched, 
       sum(duration_15_to_29_views)                         duration_15_to_29_views,
       sum(duration_15_to_29_watched)                       duration_15_to_29_watched,  
       sum(duration_30_to_59_views)                         duration_30_to_59_views,
       sum(duration_30_to_59_watched)                       duration_30_to_59_watched,  
       sum(duration_ge_60_views)                            duration_ge_60_views,
       sum(duration_ge_60_watched)                          duration_ge_60_watched,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched,
       sum(guide_day_views)                                 guide_day_views,
       sum(first_quartile_complete_rat)                     first_quartile_complete_rat,
       sum(second_quartile_complete_rat)                    second_quartile_complete_rat,
       sum(third_quartile_complete_rat)                     third_quartile_complete_rat,
       sum(fourth_quartile_complete_rat)                    fourth_quartile_complete_rat
    from
    (select vv.*,
            case when view_30_day = 1 then 1
                 when view_60_day =1 then 2
                 when view_90_day = 1 then 3
                 else 0
            end period,
            case when completion_ratio <= .25 then 1 else 0 end     first_quartile_complete_rat,
            case when completion_ratio >  .25 
                  and completion_ratio <= .5 then 1 else 0 end      second_quartile_complete_rat,
            case when completion_ratio > .5 
                  and completion_ratio <= .75 then 1 else 0 end     third_quartile_complete_rat,
            case when completion_ratio > .75 then 1 else 0 end      fourth_quartile_complete_rat
    from
        (select vdc.user_id drupal_user_id,
           vdc.created_date,
           vdc.num_views, 
           vdc.watched, 
           vdc.completion_ratio,
           v.duration,
           case when vdc.created_date <= sm3.anniversary_30_date then 1 else 0 end      view_30_day,
           case when vdc.created_date <= sm3.anniversary_60_date then 1 else 0 end      view_60_day,
           case when vdc.created_date <= sm3.anniversary_90_date then 1 else 0 end      view_90_day,
           case when fl.level_1 = 1 then num_views else 0 end                           level_1_views,
           case when fl.level_1 = 1 then watched else 0 end                             level_1_watched,
           case when fl.level_2 = 1 then num_views else 0 end                           level_2_views,
           case when fl.level_2 = 1 then watched else 0 end                             level_2_watched,
           case when fl.level_3 = 1 then num_views else 0 end                           level_3_views,
           case when fl.level_3 = 1 then watched else 0 end                             level_3_watched,
           case when facet_duration = '0-14 minutes' then num_views else 0 end          duration_lt_15_views,
           case when facet_duration = '0-14 minutes' then watched else 0 end            duration_lt_15_watched, 
           case when facet_duration = '15-29 minutes' then num_views else 0 end         duration_15_to_29_views,
           case when facet_duration = '15-29 minutes' then watched else 0 end           duration_15_to_29_watched,  
           case when facet_duration = '30-59 minutes' then num_views else 0 end         duration_30_to_59_views,
           case when facet_duration = '30-59 minutes' then watched else 0 end           duration_30_to_59_watched,  
           case when facet_duration = '60+ minutes' then num_views else 0 end           duration_ge_60_views,
           case when facet_duration = '60+ minutes' then watched else 0 end             duration_ge_60_watched,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration,
           case when guide_day is null then 0 else 1 end                                guide_day_views
        from sub_master_30_60_90 sm3
        left join  common.video_daily_cube vdc
            on sm3.drupal_user_id = vdc.user_id
        left join common.video_d v
           on vdc.media_nid = v.media_nid
        left join common.facet_levels fl 
           on v.facet_level_gid = fl.gid
        left join common.guide_d g
           on vdc.media_nid = g.media_nid) vv ) v2
    group by drupal_user_id, period) vxc;

   

create table video_views_master as
select 
    v1.drupal_user_id,
    v1.num_views                       num_views_1,                             
    v1.hrs_watched                     hrs_watched_1,
    v1.engagement_ratio                engagement_ratio_1,
    v1.yoga_engagement_ratio           yoga_engagement_ratio_1,
    v1.sg_engagement_ratio             sg_engagement_ratio_1,
    v1.st_engagement_ratio             st_engagement_ratio_1,
    v1.level_1_views                   level_1_views_1,
    v1.level_1_watched                 level_1_watched_1,
    v1.level_2_views                   level_2_views_1,
    v1.level_2_watched                 level_2_watched_1,
    v1.level_3_views                   level_3_views_1,
    v1.level_3_watched                 level_3_watched_1,
    v1.duration_lt_15_views            duration_lt_15_views_1,
    v1.duration_lt_15_watched          duration_lt_15_watched_1,
    v1.duration_15_to_29_views         duration_15_to_29_views_1,
    v1.duration_15_to_29_watched       duration_15_to_29_watched_1,
    v1.duration_30_to_59_views         duration_30_to_59_views_1,
    v1.duration_30_to_59_watched       duration_30_to_59_watched_1,
    v1.duration_ge_60_views            duration_ge_60_views_1,
    v1.duration_ge_60_watched          duration_ge_60_watched_1,
    v1.yoga_views                      yoga_views_1,
    v1.yoga_watched                    yoga_watched_1,
    v1.sg_views                        sg_views_1,
    v1.sg_watched                      sg_watched_1,
    v1.st_views                        st_views_1,
    v1.st_watched                      st_watched_1,
    v1.guide_day_views                 guide_day_views_1,
    v1.first_quartile_complete_rat     first_quartile_complete_rat_1,
    v1.second_quartile_complete_rat    second_quartile_complete_rat_1,
    v1.third_quartile_complete_rat    third_quartile_complete_rat_1,
    v1.fourth_quartile_complete_rat    fourth_quartile_complete_rat_1,
    v1.num_days_watched               num_days_watched_1,
    v2.num_views                       num_views_2,                             
    v2.hrs_watched                     hrs_watched_2,
    v2.engagement_ratio                engagement_ratio_2,
    v2.yoga_engagement_ratio           yoga_engagement_ratio_2,
    v2.sg_engagement_ratio             sg_engagement_ratio_2,
    v2.st_engagement_ratio             st_engagement_ratio_2,
    v2.level_1_views                   level_1_views_2,
    v2.level_1_watched                 level_1_watched_2,
    v2.level_2_views                   level_2_views_2,
    v2.level_2_watched                 level_2_watched_2,
    v2.level_3_views                   level_3_views_2,
    v2.level_3_watched                 level_3_watched_2,
    v2.duration_lt_15_views            duration_lt_15_views_2,
    v2.duration_lt_15_watched          duration_lt_15_watched_2,
    v2.duration_15_to_29_views         duration_15_to_29_views_2,
    v2.duration_15_to_29_watched       duration_15_to_29_watched_2,
    v2.duration_30_to_59_views         duration_30_to_59_views_2,
    v2.duration_30_to_59_watched       duration_30_to_59_watched_2,
    v2.duration_ge_60_views            duration_ge_60_views_2,
    v2.duration_ge_60_watched          duration_ge_60_watched_2,
    v2.yoga_views                      yoga_views_2,
    v2.yoga_watched                    yoga_watched_2,
    v2.sg_views                        sg_views_2,
    v2.sg_watched                      sg_watched_2,
    v2.st_views                        st_views_2,
    v2.st_watched                      st_watched_2,
    v2.guide_day_views                 guide_day_views_2,
    v2.first_quartile_complete_rat     first_quartile_complete_rat_2,
    v2.second_quartile_complete_rat    second_quartile_complete_rat_2,
    v2.third_quartile_complete_rat    third_quartile_complete_rat_2,
    v2.fourth_quartile_complete_rat    fourth_quartile_complete_rat_2,
    v2.num_days_watched               num_days_watched_2,
    v3.num_views                       num_views_3,                             
    v3.hrs_watched                     hrs_watched_3,
    v3.engagement_ratio                engagement_ratio_3,
    v3.yoga_engagement_ratio           yoga_engagement_ratio_3,
    v3.sg_engagement_ratio             sg_engagement_ratio_3,
    v3.st_engagement_ratio             st_engagement_ratio_3,
    v3.level_1_views                   level_1_views_3,
    v3.level_1_watched                 level_1_watched_3,
    v3.level_2_views                   level_2_views_3,
    v3.level_2_watched                 level_2_watched_3,
    v3.level_3_views                   level_3_views_3,
    v3.level_3_watched                 level_3_watched_3,
    v3.duration_lt_15_views            duration_lt_15_views_3,
    v3.duration_lt_15_watched          duration_lt_15_watched_3,
    v3.duration_15_to_29_views         duration_15_to_29_views_3,
    v3.duration_15_to_29_watched       duration_15_to_29_watched_3,
    v3.duration_30_to_59_views         duration_30_to_59_views_3,
    v3.duration_30_to_59_watched       duration_30_to_59_watched_3,
    v3.duration_ge_60_views            duration_ge_60_views_3,
    v3.duration_ge_60_watched          duration_ge_60_watched_3,
    v3.yoga_views                      yoga_views_3,
    v3.yoga_watched                    yoga_watched_3,
    v3.sg_views                        sg_views_3,
    v3.sg_watched                      sg_watched_3,
    v3.st_views                        st_views_3,
    v3.st_watched                      st_watched_3,
    v3.guide_day_views                 guide_day_views_3,
    v3.first_quartile_complete_rat     first_quartile_complete_rat_3,
    v3.second_quartile_complete_rat    second_quartile_complete_rat_3,
    v3.third_quartile_complete_rat     third_quartile_complete_rat_3,
    v3.fourth_quartile_complete_rat    fourth_quartile_complete_rat_3,
    v3.num_days_watched               num_days_watched_3
from sub_master_30_60_90 sm 
left join 
     (select * from video_views_30_60_90 where period = 1) v1
     on sm.drupal_user_id = v1.drupal_user_id
left join 
     (select * from video_views_30_60_90 where period = 2) v2
     on sm.drupal_user_id = v2.drupal_user_id
left join 
     (select * from video_views_30_60_90 where period = 3) v3
     on sm.drupal_user_id = v3.drupal_user_id;

drop table if exists guide_day_comp_30_60_90;

create table guide_day_comp_30_60_90 as 
select 
    drupal_user_id,
    period, 
    count(distinct gd3.guide_day_nid) num_days_completed
from (select gd2.*,
    case when complete_30_day = 1 then 1
         when complete_30_day =1 or complete_60_day =1 then 2
         when complete_30_day =1 or complete_60_day = 1 or complete_90_day = 1 then 3
         else 0
    end period
    from
        (select gd1.*,
               case when gd1.complete_day <= sm3.anniversary_30_date then 1 else 0 end      complete_30_day,
               case when gd1.complete_day <= sm3.anniversary_60_date then 1 else 0 end      complete_60_day,
               case when gd1.complete_day <= sm3.anniversary_90_date then 1 else 0 end      complete_90_day
        from 
            (select uid drupal_user_id,
                content_id guide_day_nid,
                to_timestamp(timestamp)::date complete_day
             from drupal.flag_content where fid = 6) gd1
        join sub_master_30_60_90 sm3
          on gd1.drupal_user_id = sm3.drupal_user_id) gd2) gd3
group by drupal_user_id, period;



drop table if exists guide_optins_30_60_90;

create table guide_optins_30_60_90 as
select 
    drupal_user_id,
    period, 
    count(distinct g3.guide_nid) num_opt_ins
from
    (select g2.*,
        case when opt_in_30_day = 1 then 1
             when opt_in_30_day =1 or opt_in_60_day =1 then 2
             when opt_in_30_day =1 or opt_in_60_day = 1 or opt_in_90_day = 1 then 3
             else 0
        end period
        from
            (select g1.*,
                   case when g1.opt_in_day <= sm3.anniversary_30_date then 1 else 0 end      opt_in_30_day,
                   case when g1.opt_in_day <= sm3.anniversary_60_date then 1 else 0 end      opt_in_60_day,
                   case when g1.opt_in_day <= sm3.anniversary_90_date then 1 else 0 end      opt_in_90_day
            from 
                (select uid drupal_user_id,
                    content_id guide_nid,
                    to_timestamp(timestamp)::date opt_in_day
                 from drupal.flag_content where fid = 11) g1
            join sub_master_30_60_90 sm3
              on g1.drupal_user_id = sm3.drupal_user_id) g2) g3
group by drupal_user_id, period;

drop table if exists guide_activity_master;

create table guide_activity_master as 
select gd4.*,
     coalesce(gd1.num_days_completed,0)        num_guide_days_completed_1,
     coalesce(gd2.num_days_completed,0)        num_guide_days_completed_2,
     coalesce(gd3.num_days_completed,0)        num_guide_days_completed_3
from
    (select sm.drupal_user_id,
        coalesce(g1.num_opt_ins,0)              num_guide_opt_ins_1,
        coalesce(g2.num_opt_ins,0)              num_guide_opt_ins_2,
        coalesce(g3.num_opt_ins,0)              num_guide_opt_ins_3
    from sub_master_30_60_90 sm 
   left join 
          (select * from guide_optins_30_60_90 where period = 1) g1
          on sm.drupal_user_id = g1.drupal_user_id
   left join 
          (select * from guide_optins_30_60_90 where period = 2) g2
          on sm.drupal_user_id = g2.drupal_user_id
   left join 
          (select * from guide_optins_30_60_90 where period = 3) g3
          on sm.drupal_user_id = g3.drupal_user_id) gd4   
left join 
      (select * from guide_day_comp_30_60_90 where period = 1) gd1
      on gd4.drupal_user_id = gd1.drupal_user_id
 left join 
      (select * from guide_day_comp_30_60_90 where period = 2) gd2
      on gd4.drupal_user_id = gd2.drupal_user_id
 left join 
      (select * from guide_day_comp_30_60_90 where period = 3) gd3
      on gd4.drupal_user_id = gd3.drupal_user_id;
     



drop table if exists sfss_30_60_90 cascade;

create table sfss_30_60_90 as 
select
    sm.gcsi_user_id ,
    sm.drupal_user_id ,
    sm.subscription_id, 
    sm.subscription_start_date ,
    sm.cancel_date ,
    sm.paid_through_date,
    sm.anniversary_30_date ,
    sm.anniversary_60_date ,
    sm.anniversary_90_date ,
    sm.anniversary_120_date ,
    sm.cancel_age ,
    sm.paid_through_age ,
    sm.iv_age ,
    sm.long_hold ,
    sm.churn_30_day ,
    sm.churn_60_day ,
    sm.churn_90_day ,
    sm.sub_30_day ,
    sm.sub_60_day ,
    sm.sub_90_day,
    sm.onboarding_segment,
    sm.onboarding_parent,
    sm.user_behavior_segment,
    sm.campaign_dept, 
    vv.num_views_1 ,
    vv.hrs_watched_1 ,
    vv.engagement_ratio_1 ,
    vv.yoga_engagement_ratio_1 ,
    vv.sg_engagement_ratio_1 ,
    vv.st_engagement_ratio_1 ,
    vv.level_1_views_1 ,
    vv.level_1_watched_1 ,
    vv.level_2_views_1 ,
    vv.level_2_watched_1 ,
    vv.level_3_views_1 ,
    vv.level_3_watched_1 ,
    vv.duration_lt_15_views_1 ,
    vv.duration_lt_15_watched_1 ,
    vv.duration_15_to_29_views_1 ,
    vv.duration_15_to_29_watched_1 ,
    vv.duration_30_to_59_views_1 ,
    vv.duration_30_to_59_watched_1 ,
    vv.duration_ge_60_views_1 ,
    vv.duration_ge_60_watched_1 ,
    vv.yoga_views_1 ,
    vv.yoga_watched_1 ,
    vv.sg_views_1 ,
    vv.sg_watched_1 ,
    vv.st_views_1 ,
    vv.st_watched_1 ,
    vv.guide_day_views_1 ,
    vv.first_quartile_complete_rat_1 ,
    vv.second_quartile_complete_rat_1 ,
    vv.third_quartile_complete_rat_1 ,
    vv.fourth_quartile_complete_rat_1 ,
    vv.num_days_watched_1 ,
    vv.num_views_2 ,
    vv.hrs_watched_2 ,
    vv.engagement_ratio_2 ,
    vv.yoga_engagement_ratio_2 ,
    vv.sg_engagement_ratio_2 ,
    vv.st_engagement_ratio_2 ,
    vv.level_1_views_2 ,
    vv.level_1_watched_2 ,
    vv.level_2_views_2 ,
    vv.level_2_watched_2 ,
    vv.level_3_views_2 ,
    vv.level_3_watched_2 ,
    vv.duration_lt_15_views_2 ,
    vv.duration_lt_15_watched_2 ,
    vv.duration_15_to_29_views_2 ,
    vv.duration_15_to_29_watched_2 ,
    vv.duration_30_to_59_views_2 ,
    vv.duration_30_to_59_watched_2 ,
    vv.duration_ge_60_views_2 ,
    vv.duration_ge_60_watched_2 ,
    vv.yoga_views_2 ,
    vv.yoga_watched_2 ,
    vv.sg_views_2 ,
    vv.sg_watched_2 ,
    vv.st_views_2 ,
    vv.st_watched_2 ,
    vv.guide_day_views_2 ,
    vv.first_quartile_complete_rat_2 ,
    vv.second_quartile_complete_rat_2 ,
    vv.third_quartile_complete_rat_2 ,
    vv.fourth_quartile_complete_rat_2 ,
    vv.num_days_watched_2 ,
    vv.num_views_3 ,
    vv.hrs_watched_3 ,
    vv.engagement_ratio_3 ,
    vv.yoga_engagement_ratio_3 ,
    vv.sg_engagement_ratio_3 ,
    vv.st_engagement_ratio_3 ,
    vv.level_1_views_3 ,
    vv.level_1_watched_3 ,
    vv.level_2_views_3 ,
    vv.level_2_watched_3 ,
    vv.level_3_views_3 ,
    vv.level_3_watched_3 ,
    vv.duration_lt_15_views_3 ,
    vv.duration_lt_15_watched_3 ,
    vv.duration_15_to_29_views_3 ,
    vv.duration_15_to_29_watched_3 ,
    vv.duration_30_to_59_views_3 ,
    vv.duration_30_to_59_watched_3 ,
    vv.duration_ge_60_views_3 ,
    vv.duration_ge_60_watched_3 ,
    vv.yoga_views_3 ,
    vv.yoga_watched_3 ,
    vv.sg_views_3 ,
    vv.sg_watched_3 ,
    vv.st_views_3 ,
    vv.st_watched_3 ,
    vv.guide_day_views_3 ,
    vv.first_quartile_complete_rat_3 ,
    vv.second_quartile_complete_rat_3 ,
    vv.third_quartile_complete_rat_3 ,
    vv.fourth_quartile_complete_rat_3 ,
    vv.num_days_watched_3,
    coalesce(gm.num_guide_opt_ins_1,0) 					num_guide_opt_ins_1,
    coalesce(gm.num_guide_days_completed_1,0)		num_guide_days_completed_1,
    coalesce(gm.num_guide_opt_ins_2,0)					num_guide_opt_ins_2,
    coalesce(gm.num_guide_days_completed_2,0)		num_guide_days_completed_2,
    coalesce(gm.num_guide_opt_ins_3,0)					num_guide_opt_ins_3,
    coalesce(gm.num_guide_days_completed_3,0)		num_guide_days_completed_3,
    coalesce(pl.playlist_count,0) playlist_count 
from sub_master_30_60_90 sm 
left join video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id
left join guide_activity_master gm
    on sm.drupal_user_id = gm.drupal_user_id
left join (select drupal_user_id,
           count(distinct page_nid) playlist_count
           from common.playlist_activity 
           group by drupal_user_id) pl
   on sm.drupal_user_id = pl.drupal_user_id;

create or replace view yoga_sfss as select * from sfss_30_60_90;
/*
select distinct name from tmp.facets_tmp
where facet_name = 'style';
*/


[2016-02-22 12:54:23.696] [016668] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 12:54:50.183] [016668] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 12:54:50.284] [016668] [dwh-prod] [PGSQL]
select distinct name from tmp.facets_tmp
where facet_name = 'style';


[2016-02-22 12:54:50.377] [016668] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 12:54:50.742] [016668] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6250912

[2016-02-22 13:10:42.434] [024814] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 13:10:42.513] [015527] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'nid_facets' ORDER BY col.table_name, col.ordinal_position

[2016-02-22 13:10:42.628] [015527] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-22 13:10:43.080] [015527] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-22 13:10:43.162] [015527] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'nid_facets' AND conname IS NOT NULL

[2016-02-22 13:10:43.252] [015527] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'nid_facets' ORDER BY t.relname, i.oid

[2016-02-22 13:10:43.337] [015527] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'nid_facets' ORDER BY t.relname, c.conname, a.attnum

[2016-02-22 13:10:43.562] [024814] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."nid_facets" LIMIT 1000 OFFSET 0

[2016-02-22 13:10:43.972] [024814] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'nid_facets'

[2016-02-22 13:10:44.076] [024814] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6250939

[2016-02-22 13:11:14.652] [024999] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 13:11:14.732] [015527] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'facet_groups' ORDER BY col.table_name, col.ordinal_position

[2016-02-22 13:11:14.832] [015527] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-22 13:11:15.311] [015527] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-22 13:11:15.393] [015527] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'facet_groups' AND conname IS NOT NULL

[2016-02-22 13:11:15.476] [015527] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'facet_groups' ORDER BY t.relname, i.oid

[2016-02-22 13:11:15.561] [015527] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'facet_groups' ORDER BY t.relname, c.conname, a.attnum

[2016-02-22 13:11:15.792] [024999] [dwh-prod] [PGSQL]
SELECT * FROM "common"."facet_groups" LIMIT 1000 OFFSET 0

[2016-02-22 13:11:16.046] [024999] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'facet_groups'

[2016-02-22 13:11:16.145] [024999] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6250927

[2016-02-22 13:12:04.157] [025264] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 13:12:04.277] [025264] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 13:12:04.404] [025264] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-22 13:12:04.491] [025264] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 13:12:05.139] [025264] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 13:12:05.222] [025264] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 13:12:05.323] [025264] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-22 13:12:13.682] [025291] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 13:12:13.763] [025291] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='facet_groups' ORDER BY ordinal_position

[2016-02-22 13:12:18.772] [016668] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 13:12:18.885] [016668] [dwh-prod] [PGSQL]
select distinct name from common.facet_groups
where gid = 639;


[2016-02-22 13:12:18.976] [016668] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 13:12:19.314] [016668] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6250927

[2016-02-22 13:13:51.340] [025794] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 13:13:51.438] [025794] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_daily_cube' ORDER BY ordinal_position

[2016-02-22 13:13:52.196] [025795] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 13:13:52.288] [025795] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_d' ORDER BY ordinal_position

[2016-02-22 13:13:53.011] [025808] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 13:13:53.762] [025808] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='facet_levels' ORDER BY ordinal_position

[2016-02-22 13:13:54.491] [025810] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 13:13:54.588] [025810] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='guide_d' ORDER BY ordinal_position

[2016-02-22 13:15:46.733] [016668] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 13:15:46.862] [016668] [dwh-prod] [PGSQL]
select facet_style, count(1)  c
from common.video_d
where admin_category in ('Yoga', 'Fitness')
group by facet_style
order by c desc;


[2016-02-22 13:15:46.976] [016668] [dwh-prod] [PGSQL]
ERROR:  column "facet_style" does not exist
LINE 1: select facet_style, count(1)  c
               ^


[2016-02-22 13:15:46.988] [016668] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 13:16:30.657] [016668] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 13:16:30.762] [016668] [dwh-prod] [PGSQL]
select facet_style_gid, count(1)  c
from common.video_d
where admin_category in ('Yoga', 'Fitness')
group by facet_style_gid
order by c desc;


[2016-02-22 13:16:30.862] [016668] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 13:16:31.207] [016668] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6251015

[2016-02-22 13:19:05.334] [015527] [dwh-prod] [PGSQL]
SELECT c.oid, c.relname, c.relacl, pg_get_userbyid(c.relowner) AS viewowner, pg_get_viewdef(c.oid) AS definition, obj_description(c.oid), n.nspname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'v'::"char" AND n.nspname = 'drupal' 

[2016-02-22 13:19:32.295] [027547] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 13:19:32.377] [015527] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'facet_groups' ORDER BY col.table_name, col.ordinal_position

[2016-02-22 13:19:32.488] [015527] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-22 13:19:32.975] [015527] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-22 13:19:33.215] [015527] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'facet_groups' AND conname IS NOT NULL

[2016-02-22 13:19:33.297] [015527] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'facet_groups' ORDER BY t.relname, i.oid

[2016-02-22 13:19:33.383] [015527] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'facet_groups' ORDER BY t.relname, c.conname, a.attnum

[2016-02-22 13:19:33.615] [027547] [dwh-prod] [PGSQL]
SELECT * FROM "common"."facet_groups" LIMIT 1000 OFFSET 0

[2016-02-22 13:19:33.869] [027547] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'facet_groups'

[2016-02-22 13:19:33.967] [027547] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6250927

[2016-02-22 13:26:45.473] [016668] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 13:26:45.588] [016668] [dwh-prod] [PGSQL]
select facet_style_gid, name, count(1)  c
from common.video_d v
join common.facet_groups fg
   on v.facet_style_gid = fg.gid
where admin_category in ('Yoga', 'Fitness')
group by facet_style_gid, name
order by c desc;


[2016-02-22 13:26:45.786] [016668] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 13:40:24.721] [029843] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 13:40:24.803] [028383] [dwh-dev] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'plan_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-22 13:40:24.915] [028383] [dwh-dev] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-22 13:40:25.335] [028383] [dwh-dev] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-22 13:40:25.418] [028383] [dwh-dev] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'plan_d' AND conname IS NOT NULL

[2016-02-22 13:40:25.500] [028383] [dwh-dev] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'plan_d' ORDER BY t.relname, i.oid

[2016-02-22 13:40:25.596] [028383] [dwh-dev] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'plan_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-22 13:40:25.873] [029843] [dwh-dev] [PGSQL]
SELECT * FROM "common"."plan_d" LIMIT 1000 OFFSET 0

[2016-02-22 13:40:26.036] [029843] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'plan_d'

[2016-02-22 13:40:26.151] [029843] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12286264

[2016-02-22 13:42:18.557] [029963] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 13:42:18.636] [029963] [dwh-dev] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='user_dim' ORDER BY ordinal_position

[2016-02-22 13:42:19.381] [029965] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 13:42:19.460] [029965] [dwh-dev] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='subscription_d' ORDER BY ordinal_position

[2016-02-22 13:43:05.028] [026080] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 13:43:05.029] [026080] [dwh-dev] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-22 13:43:05.587] [030015] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 13:43:05.665] [030015] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 13:43:05.767] [030015] [dwh-dev] [PGSQL]
select engagement_level, count(1)
from common.user_dim ud
join common.subscription_d sd
   on ud.current_subscription = sd.subscription_id 
where sd.dwh_plan_id = 109
group by engagement_level;


[2016-02-22 13:43:06.824] [030015] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 13:43:07.147] [030015] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12287471

[2016-02-22 13:48:42.144] [030015] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 13:48:42.261] [030015] [dwh-dev] [PGSQL]
select user_behavior_segment, engagement_level, count(1)
from common.user_dim ud
join common.subscription_d sd
   on ud.current_subscription = sd.subscription_id 
where sd.dwh_plan_id = 109
group by  user_behavior_segment,engagement_level;


[2016-02-22 13:48:42.615] [030015] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 13:48:42.927] [030015] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12287471

[2016-02-22 13:48:59.637] [030015] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 13:48:59.737] [030015] [dwh-dev] [PGSQL]
select user_behavior_segment, engagement_level, count(1)
from common.user_dim ud
join common.subscription_d sd
   on ud.current_subscription = sd.subscription_id 
where sd.dwh_plan_id = 109
group by  user_behavior_segment,engagement_level
order by user_behavior_segment;



[2016-02-22 13:48:59.944] [030015] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 13:49:00.246] [030015] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12287471

[2016-02-22 13:51:45.065] [030015] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 13:51:45.165] [030015] [dwh-dev] [PGSQL]
select count(1)
from common.user_dim ud
join common.subscription_d sd
   on ud.current_subscription = sd.subscription_id 
where sd.dwh_plan_id = 109


[2016-02-22 13:51:45.378] [030015] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 14:05:32.450] [028383] [dwh-dev] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'drupal'

[2016-02-22 14:09:40.065] [026210] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "title" LIKE '%AM Yoga for Beginners%' LIMIT 1000 OFFSET 0

[2016-02-22 14:09:40.066] [026210] [dwh-dev] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-22 14:09:40.650] [030484] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:09:40.730] [030484] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "title" LIKE '%AM Yoga for Beginners%' LIMIT 1000 OFFSET 0

[2016-02-22 14:09:40.961] [030484] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-22 14:09:41.072] [030484] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12286149

[2016-02-22 14:09:49.168] [030484] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "title" LIKE '%AM%' LIMIT 1000 OFFSET 0

[2016-02-22 14:09:49.341] [030484] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-22 14:09:49.446] [030484] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12286149

[2016-02-22 14:10:40.587] [030484] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" LIMIT 1000 OFFSET 0

[2016-02-22 14:10:42.281] [030484] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-22 14:10:42.386] [030484] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12286149

[2016-02-22 14:10:53.471] [030484] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" LIMIT 1000 OFFSET 1000

[2016-02-22 14:10:54.337] [030484] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-22 14:10:54.444] [030484] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12286149

[2016-02-22 14:10:56.345] [030484] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" LIMIT 1000 OFFSET 0

[2016-02-22 14:10:57.102] [030484] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-22 14:10:57.207] [030484] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12286149

[2016-02-22 14:11:21.952] [030484] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "page_nid" LIKE '%5276%' LIMIT 1000 OFFSET 0

[2016-02-22 14:11:22.052] [030484] [dwh-dev] [PGSQL]
ERROR:  operator does not exist: integer ~~ unknown
LINE 1: SELECT * FROM "common"."video_d" WHERE "page_nid" LIKE '%527...
                                                          ^
HINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.


[2016-02-22 14:11:28.700] [030484] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "page_nid" = '5276' LIMIT 1000 OFFSET 0

[2016-02-22 14:11:28.788] [030484] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-22 14:11:28.894] [030484] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12286149

[2016-02-22 14:11:32.445] [030484] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "page_nid" = '5276' LIMIT 1000 OFFSET 1000

[2016-02-22 14:11:32.532] [030484] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-22 14:11:32.637] [030484] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12286149

[2016-02-22 14:11:38.438] [030484] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "page_nid" = '5276' LIMIT 1000 OFFSET 0

[2016-02-22 14:11:38.526] [030484] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-22 14:11:38.630] [030484] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12286149

[2016-02-22 14:13:22.939] [030559] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:13:23.021] [028383] [dwh-dev] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'drupal' AND col.table_name = 'node' ORDER BY col.table_name, col.ordinal_position

[2016-02-22 14:13:23.160] [028383] [dwh-dev] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-22 14:13:23.607] [028383] [dwh-dev] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-22 14:13:23.686] [028383] [dwh-dev] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'drupal' AND ct.relname = 'node' AND conname IS NOT NULL

[2016-02-22 14:13:23.770] [028383] [dwh-dev] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'drupal' AND t.relname = 'node' ORDER BY t.relname, i.oid

[2016-02-22 14:13:23.859] [028383] [dwh-dev] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'drupal' AND t.relname = 'node' ORDER BY t.relname, c.conname, a.attnum

[2016-02-22 14:13:24.097] [030559] [dwh-dev] [PGSQL]
SELECT * FROM "drupal"."node" LIMIT 1000 OFFSET 0

[2016-02-22 14:13:24.665] [030559] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'drupal' AND cl.table_name = 'node'

[2016-02-22 14:13:24.766] [030559] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12267530

[2016-02-22 14:13:44.406] [030559] [dwh-dev] [PGSQL]
SELECT * FROM "drupal"."node" WHERE "nid" = '5276' LIMIT 1000 OFFSET 0

[2016-02-22 14:13:44.490] [030559] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'drupal' AND cl.table_name = 'node'

[2016-02-22 14:13:44.582] [030559] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12267530

[2016-02-22 14:14:13.297] [030559] [dwh-dev] [PGSQL]
SELECT * FROM "drupal"."node" WHERE "nid" = '12114' LIMIT 1000 OFFSET 0

[2016-02-22 14:14:13.379] [030559] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'drupal' AND cl.table_name = 'node'

[2016-02-22 14:14:13.473] [030559] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12267530

[2016-02-22 14:14:58.872] [030571] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:14:58.950] [030571] [dwh-dev] [PGSQL]
SHOW search_path

[2016-02-22 14:14:59.252] [030570] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:14:59.332] [030570] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 14:14:59.445] [030570] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 14:14:59.528] [030570] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-22 14:14:59.607] [030570] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 14:15:00.032] [030570] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 14:15:00.110] [030570] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 14:15:00.195] [030570] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-22 14:15:00.274] [030570] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 14:15:00.371] [030570] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-22 14:15:00.454] [030570] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 14:15:00.656] [030570] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 14:15:00.733] [030570] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 14:15:00.818] [030570] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-22 14:15:00.898] [030570] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 14:25:06.403] [028383] [dwh-dev] [PGSQL]
SELECT c.oid, c.relname, c.relacl, pg_get_userbyid(c.relowner) AS viewowner, pg_get_viewdef(c.oid) AS definition, obj_description(c.oid), n.nspname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'v'::"char" AND n.nspname = 'common' 

[2016-02-22 14:25:13.356] [025377] [dwh-dev] [PGSQL]
SELECT rolname, rolsuper, rolinherit, rolcreaterole, rolcreatedb, rolcatupdate, rolcanlogin, rolconnlimit, rolvaliduntil, rolconfig, oid , pg_catalog.shobj_description(oid, 'pg_authid') AS comment FROM pg_roles 

[2016-02-22 14:25:13.360] [025377] [dwh-dev] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-22 14:25:13.953] [030758] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:25:14.030] [030758] [dwh-dev] [PGSQL]
SELECT rolname, rolsuper, rolinherit, rolcreaterole, rolcreatedb, rolcatupdate, rolcanlogin, rolconnlimit, rolvaliduntil, rolconfig, oid , pg_catalog.shobj_description(oid, 'pg_authid') AS comment FROM pg_roles 

[2016-02-22 14:25:14.833] [030760] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:25:14.916] [030760] [dwh-dev] [PGSQL]
SHOW search_path

[2016-02-22 14:25:14.995] [028383] [dwh-dev] [PGSQL]
SELECT c.oid, c.relname, c.relacl, pg_get_userbyid(c.relowner) AS viewowner, pg_get_viewdef(c.oid) AS definition, obj_description(c.oid), n.nspname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'v'::"char" AND n.nspname = 'common' AND c.relname = 'v_node' 

[2016-02-22 14:25:15.076] [028383] [dwh-dev] [PGSQL]
SELECT n.nspname AS rule_schema, c.relname, r.rulename, r.oid, r.ev_type, r.is_instead, pg_get_ruledef(r.oid) AS definition, obj_description(r.oid) AS comment FROM ((pg_rewrite r JOIN pg_class c ON ((c.oid = r.ev_class))) LEFT JOIN pg_namespace n ON ((n.oid = c.relnamespace))) WHERE (r.rulename <> '_RETURN'::name) AND (n.nspname='common') AND (c.relname='v_node')

[2016-02-22 14:25:15.320] [030759] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:25:15.398] [030759] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 14:25:15.500] [030759] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 14:25:15.583] [030759] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-22 14:25:15.661] [030759] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 14:25:16.108] [030759] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 14:25:16.186] [030759] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 14:25:16.272] [030759] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-22 14:25:16.353] [030759] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 14:25:16.450] [030759] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-22 14:25:16.534] [030759] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 14:25:16.739] [030759] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 14:25:16.821] [030759] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 14:25:16.906] [030759] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-22 14:25:16.987] [030759] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 14:27:52.836] [030571] [dwh-dev] [PGSQL]
SET search_path TO "common","$user", gcsi, drupal, public

[2016-02-22 14:27:52.975] [030571] [dwh-dev] [PGSQL]
/*  documenting prerequisites
\i facet groups.sql 
\i tag_groups.sql 
\i genre_groups.sql 
\i category groups_tmp.sql 
*/



drop table if exists common.media_tmp;

create table  common.media_tmp as
select cv.field_feature_nid_nid media_nid, 
       mn.vid media_vid,
       n.nid page_nid, 
       n.vid page_vid, 
       n.title,
       n.created_ts::date as created_date,
       va.admin_category,
       ac.site_segment,
       ac.reporting_segment    
from drupal.node n
join drupal.content_field_feature_nid cv
  ON n.vid = cv.vid
join drupal.node mn
  on cv.field_feature_nid_nid = mn.nid
left join common.v_admin_category va
    on n.vid = va.vid
left join common.admin_category_mapping ac
    on va.admin_category = ac.name
where n.type = 'product_video'
 and admin_category <> 'Radio';

--unstitched media
-- these can be associated with more than one guide.  I just get the first one
insert into common.media_tmp (media_nid, media_vid, page_nid, page_vid, title, site_segment, reporting_segment)
(select distinct on (media_nid)
       gd.media_nid, 
       gd.media_vid,
       gd.guide_day_nid,
       gd.guide_day_vid, 
       gd.guide_day_title,
       gd.site_segment,
       gd.site_segment
from common.guide_d gd
where guide_status = 1
  and media_vid not in 
    (select media_vid from common.media_tmp)
order by media_nid, guide_day_nid, guide_day_vid);

alter table common.media_tmp add feature varchar(10) default 'Feature';

insert into common.media_tmp
(select distinct on (field_preview_nid_nid)
       cv.field_preview_nid_nid, 
       mn.vid ,
       n.nid page_nid, 
       n.vid page_vid, 
       n.title,
       n.created_ts::date as created_date,
       va.admin_category,
       ac.site_segment,
       ac.reporting_segment,  
       'Preview' 
from drupal.node n
join drupal.content_field_preview_nid cv
  ON n.vid = cv.vid
join drupal.node mn
  on cv.field_preview_nid_nid = mn.nid
left join common.v_admin_category va
    on n.vid = va.vid
left join common.admin_category_mapping ac
    on va.admin_category = ac.name
where n.type = 'product_video'
 and admin_category <> 'Radio'
 and mn.vid not in 
    (select media_vid from common.media_tmp)
order by field_preview_nid_nid, mn.vid , n.nid, n.vid);

drop table if exists common.video_d cascade;

create table common.video_d as 
(select m.*,
        vco.content_origin,
        vn.duration,
        vs.series_title,
        vs.series_coverart_filepath,
        vf.season, 
        vf."cast",
        vf.copyright,
        vf.director,
        vf.studio,
        vf.long_description,
        tpm.field_media_maestro_title_code_value as mm_title_code,
        tpm.field_policy_id as media_policy_id,
        tpv.field_episode_value as episode,
        tpv.field_video_lang_value video_language,
        tpv.field_video_subtype_value as video_subtype,
        img1.filepath as coverart_filepath,
        pl.segment_id onboard_playlist_segment,
        -- gids are keys to bridge tables for multi_valued fields
        ng.gid as genre_gid,
        nt.gid as tag_gid,
        vc.gid as video_category_gid,
        nf.facet_focus   facet_focus_gid,
        nf.facet_style   facet_style_gid, 
        nf.facet_level   facet_level_gid,
        nf.facet_teacher facet_teacher_gid,  
        nf.facet_guest   facet_guest_gid, 
        nf.facet_host    facet_host_gid,  
        nf.facet_duration,  
        nf.facet_interview_collection,  
        nf.facet_interview_topic
from common.media_tmp m
left join common.v_content_origin vco
    on m.page_vid = vco.vid 
left join common.v_series vs
    on m.page_nid = vs.nid
left join common.v_node vn
    on m.media_nid = vn.nid
left join common.v_fields vf
    on m.page_nid = vf.nid
left join common.user_onboard_segments_playlist pl 
    on m.page_nid = pl.video_node
left join drupal.content_type_product_media tpm
    on m.media_vid = tpm.vid
left join drupal.content_type_product_video tpv
    on m.page_vid = tpv.vid
left join drupal.files img1 
    on tpv.field_coverart_image_fid = img1.fid
left join tmp.nid_genres ng
    on m.page_nid = ng.nid
left join tmp.nid_tags nt
    on m.page_nid = nt.nid
left join tmp.nid_categories vc
    on m.page_nid = vc.nid
left join tmp.nid_facets nf
    on m.page_nid = nf.nid
left join drupal.content_field_instructor cfi
    on m.page_nid  =cfi.nid

);


-- fix up duplicate preview rows
-- this gets me 95% of the way there.  The page data 
-- (nid, vid, title) still reflects the title of the first video 
-- when maybe it should be the series?


drop table if exists common.dupe_previews_tmp;

create table common.dupe_previews_tmp as 
(select t.*, 
        case when episode = first_episode then 1 else 0 end include
from
(select media_nid, 
        media_vid, 
        page_nid, 
        page_vid, 
        episode, 
        series_title,
        first_value(episode) over (partition by series_title order by episode) first_episode
 from common.video_d
where media_nid in 
   (select media_nid from common.video_d 
     group by media_nid
     having count(1) > 1))t);

delete from common.video_d
where page_nid in 
    (select page_nid from common.dupe_previews_tmp where include = 0);

select count(1), count(distinct media_nid) from common.video_d;

-- this  uses tables created in the pre-requisite files,
-- so this seems like a good place to put it.

drop table if exists common.solr_facets;

create table common.solr_facets as
select nid, string_agg(name, ',') facets from 
    (select nid, name from tmp.facets_tmp
      union 
      select nid, genres from tmp.genres_tmp
      union 
      select nid, tags from tmp.tags_tmp
      union 
      select nid, categories from tmp.categories_tmp) foo
group by nid;
   


[2016-02-22 14:27:53.161] [030571] [dwh-dev] [PGSQL]
ERROR:  column n.created_ts does not exist
LINE 18:        n.created_ts::date as created_date,
                ^


[2016-02-22 14:27:53.182] [030571] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 14:28:56.371] [030823] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:28:56.454] [030823] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'drupal') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 14:28:56.770] [030823] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='drupal' ORDER BY schemaname, viewname

[2016-02-22 14:28:56.854] [030823] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 14:28:57.221] [030823] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 14:28:57.301] [030823] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'drupal' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 14:28:57.391] [030823] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'drupal' 

[2016-02-22 14:29:12.364] [030825] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:29:12.463] [030825] [dwh-dev] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='drupal' AND table_name='node' ORDER BY ordinal_position

[2016-02-22 14:29:19.617] [030571] [dwh-dev] [PGSQL]
SET search_path TO "common","$user", gcsi, drupal, public

[2016-02-22 14:29:19.712] [030571] [dwh-dev] [PGSQL]
select * from drupal.node where nid = 5276;


[2016-02-22 14:29:19.808] [030571] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 14:29:20.169] [030571] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12267530

[2016-02-22 14:29:20.249] [030571] [dwh-dev] [PGSQL]
SELECT nsp.nspname, cl.relname, array_upper(conkey,1) as pkeycount FROM pg_class cl LEFT JOIN pg_namespace nsp ON nsp.oid = cl.relnamespace LEFT JOIN pg_constraint con ON con.conrelid = cl.oid WHERE con.contype = 'p' AND cl.oid = 12267530

[2016-02-22 14:29:20.334] [030571] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = '' AND cl.table_schema = 'drupal' AND cl.table_name = 'node'

[2016-02-22 14:30:52.718] [030571] [dwh-dev] [PGSQL]
SET search_path TO "common","$user", gcsi, drupal, public

[2016-02-22 14:30:52.843] [030571] [dwh-dev] [PGSQL]
/*  documenting prerequisites
\i facet groups.sql 
\i tag_groups.sql 
\i genre_groups.sql 
\i category groups_tmp.sql 
*/



drop table if exists common.media_tmp;

create table  common.media_tmp as
select cv.field_feature_nid_nid media_nid, 
       mn.vid media_vid,
       n.nid page_nid, 
       n.vid page_vid, 
       n.title,
       n.created::date as created_date,
       va.admin_category,
       ac.site_segment,
       ac.reporting_segment    
from drupal.node n
join drupal.content_field_feature_nid cv
  ON n.vid = cv.vid
join drupal.node mn
  on cv.field_feature_nid_nid = mn.nid
left join common.v_admin_category va
    on n.vid = va.vid
left join common.admin_category_mapping ac
    on va.admin_category = ac.name
where n.type = 'product_video'
 and admin_category <> 'Radio';

--unstitched media
-- these can be associated with more than one guide.  I just get the first one
insert into common.media_tmp (media_nid, media_vid, page_nid, page_vid, title, site_segment, reporting_segment)
(select distinct on (media_nid)
       gd.media_nid, 
       gd.media_vid,
       gd.guide_day_nid,
       gd.guide_day_vid, 
       gd.guide_day_title,
       gd.site_segment,
       gd.site_segment
from common.guide_d gd
where guide_status = 1
  and media_vid not in 
    (select media_vid from common.media_tmp)
order by media_nid, guide_day_nid, guide_day_vid);

alter table common.media_tmp add feature varchar(10) default 'Feature';

insert into common.media_tmp
(select distinct on (field_preview_nid_nid)
       cv.field_preview_nid_nid, 
       mn.vid ,
       n.nid page_nid, 
       n.vid page_vid, 
       n.title,
       n.created::date as created_date,
       va.admin_category,
       ac.site_segment,
       ac.reporting_segment,  
       'Preview' 
from drupal.node n
join drupal.content_field_preview_nid cv
  ON n.vid = cv.vid
join drupal.node mn
  on cv.field_preview_nid_nid = mn.nid
left join common.v_admin_category va
    on n.vid = va.vid
left join common.admin_category_mapping ac
    on va.admin_category = ac.name
where n.type = 'product_video'
 and admin_category <> 'Radio'
 and mn.vid not in 
    (select media_vid from common.media_tmp)
order by field_preview_nid_nid, mn.vid , n.nid, n.vid);

drop table if exists common.video_d cascade;

create table common.video_d as 
(select m.*,
        vco.content_origin,
        vn.duration,
        vs.series_title,
        vs.series_coverart_filepath,
        vf.season, 
        vf."cast",
        vf.copyright,
        vf.director,
        vf.studio,
        vf.long_description,
        tpm.field_media_maestro_title_code_value as mm_title_code,
        tpm.field_policy_id as media_policy_id,
        tpv.field_episode_value as episode,
        tpv.field_video_lang_value video_language,
        tpv.field_video_subtype_value as video_subtype,
        img1.filepath as coverart_filepath,
        pl.segment_id onboard_playlist_segment,
        -- gids are keys to bridge tables for multi_valued fields
        ng.gid as genre_gid,
        nt.gid as tag_gid,
        vc.gid as video_category_gid,
        nf.facet_focus   facet_focus_gid,
        nf.facet_style   facet_style_gid, 
        nf.facet_level   facet_level_gid,
        nf.facet_teacher facet_teacher_gid,  
        nf.facet_guest   facet_guest_gid, 
        nf.facet_host    facet_host_gid,  
        nf.facet_duration,  
        nf.facet_interview_collection,  
        nf.facet_interview_topic
from common.media_tmp m
left join common.v_content_origin vco
    on m.page_vid = vco.vid 
left join common.v_series vs
    on m.page_nid = vs.nid
left join common.v_node vn
    on m.media_nid = vn.nid
left join common.v_fields vf
    on m.page_nid = vf.nid
left join common.user_onboard_segments_playlist pl 
    on m.page_nid = pl.video_node
left join drupal.content_type_product_media tpm
    on m.media_vid = tpm.vid
left join drupal.content_type_product_video tpv
    on m.page_vid = tpv.vid
left join drupal.files img1 
    on tpv.field_coverart_image_fid = img1.fid
left join tmp.nid_genres ng
    on m.page_nid = ng.nid
left join tmp.nid_tags nt
    on m.page_nid = nt.nid
left join tmp.nid_categories vc
    on m.page_nid = vc.nid
left join tmp.nid_facets nf
    on m.page_nid = nf.nid
left join drupal.content_field_instructor cfi
    on m.page_nid  =cfi.nid

);


alter table common.video_d owner to dw_admin;

-- fix up duplicate preview rows
-- this gets me 95% of the way there.  The page data 
-- (nid, vid, title) still reflects the title of the first video 
-- when maybe it should be the series?


drop table if exists common.dupe_previews_tmp;

create table common.dupe_previews_tmp as 
(select t.*, 
        case when episode = first_episode then 1 else 0 end include
from
(select media_nid, 
        media_vid, 
        page_nid, 
        page_vid, 
        episode, 
        series_title,
        first_value(episode) over (partition by series_title order by episode) first_episode
 from common.video_d
where media_nid in 
   (select media_nid from common.video_d 
     group by media_nid
     having count(1) > 1))t);

delete from common.video_d
where page_nid in 
    (select page_nid from common.dupe_previews_tmp where include = 0);

select count(1), count(distinct media_nid) from common.video_d;

-- this  uses tables created in the pre-requisite files,
-- so this seems like a good place to put it.

drop table if exists common.solr_facets;

create table common.solr_facets as
select nid, string_agg(name, ',') facets from 
    (select nid, name from tmp.facets_tmp
      union 
      select nid, genres from tmp.genres_tmp
      union 
      select nid, tags from tmp.tags_tmp
      union 
      select nid, categories from tmp.categories_tmp) foo
group by nid;
   
alter table common.solr_facets owner to dw_admin;


[2016-02-22 14:30:52.928] [030571] [dwh-dev] [PGSQL]
ERROR:  cannot cast type integer to date
LINE 18:        n.created::date as created_date,
                         ^


[2016-02-22 14:30:52.950] [030571] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 14:31:12.513] [030878] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:31:12.591] [030878] [dwh-dev] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='drupal' AND table_name='content_field_feature_nid' ORDER BY ordinal_position

[2016-02-22 14:31:13.245] [030879] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:31:13.325] [030879] [dwh-dev] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='v_admin_category' ORDER BY ordinal_position

[2016-02-22 14:31:13.997] [030880] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:31:14.076] [030880] [dwh-dev] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='admin_category_mapping' ORDER BY ordinal_position

[2016-02-22 14:32:14.729] [030571] [dwh-dev] [PGSQL]
SET search_path TO "common","$user", gcsi, drupal, public

[2016-02-22 14:32:14.866] [030571] [dwh-dev] [PGSQL]
/*  documenting prerequisites
\i facet groups.sql 
\i tag_groups.sql 
\i genre_groups.sql 
\i category groups_tmp.sql 
*/



drop table if exists common.media_tmp;

create table  common.media_tmp as
select cv.field_feature_nid_nid media_nid, 
       mn.vid media_vid,
       n.nid page_nid, 
       n.vid page_vid, 
       n.title,
       to_timestamp(n.created)::date created_date,
       va.admin_category,
       ac.site_segment,
       ac.reporting_segment    
from drupal.node n
join drupal.content_field_feature_nid cv
  ON n.vid = cv.vid
join drupal.node mn
  on cv.field_feature_nid_nid = mn.nid
left join common.v_admin_category va
    on n.vid = va.vid
left join common.admin_category_mapping ac
    on va.admin_category = ac.name
where n.type = 'product_video'
 and admin_category <> 'Radio';

--unstitched media
-- these can be associated with more than one guide.  I just get the first one
insert into common.media_tmp (media_nid, media_vid, page_nid, page_vid, title, site_segment, reporting_segment)
(select distinct on (media_nid)
       gd.media_nid, 
       gd.media_vid,
       gd.guide_day_nid,
       gd.guide_day_vid, 
       gd.guide_day_title,
       gd.site_segment,
       gd.site_segment
from common.guide_d gd
where guide_status = 1
  and media_vid not in 
    (select media_vid from common.media_tmp)
order by media_nid, guide_day_nid, guide_day_vid);

alter table common.media_tmp add feature varchar(10) default 'Feature';

insert into common.media_tmp
(select distinct on (field_preview_nid_nid)
       cv.field_preview_nid_nid, 
       mn.vid ,
       n.nid page_nid, 
       n.vid page_vid, 
       n.title,
       to_timestamp(n.created)::date created_date,
       va.admin_category,
       ac.site_segment,
       ac.reporting_segment,  
       'Preview' 
from drupal.node n
join drupal.content_field_preview_nid cv
  ON n.vid = cv.vid
join drupal.node mn
  on cv.field_preview_nid_nid = mn.nid
left join common.v_admin_category va
    on n.vid = va.vid
left join common.admin_category_mapping ac
    on va.admin_category = ac.name
where n.type = 'product_video'
 and admin_category <> 'Radio'
 and mn.vid not in 
    (select media_vid from common.media_tmp)
order by field_preview_nid_nid, mn.vid , n.nid, n.vid);

drop table if exists common.video_d cascade;

create table common.video_d as 
(select m.*,
        vco.content_origin,
        vn.duration,
        vs.series_title,
        vs.series_coverart_filepath,
        vf.season, 
        vf."cast",
        vf.copyright,
        vf.director,
        vf.studio,
        vf.long_description,
        tpm.field_media_maestro_title_code_value as mm_title_code,
        tpm.field_policy_id as media_policy_id,
        tpv.field_episode_value as episode,
        tpv.field_video_lang_value video_language,
        tpv.field_video_subtype_value as video_subtype,
        img1.filepath as coverart_filepath,
        pl.segment_id onboard_playlist_segment,
        -- gids are keys to bridge tables for multi_valued fields
        ng.gid as genre_gid,
        nt.gid as tag_gid,
        vc.gid as video_category_gid,
        nf.facet_focus   facet_focus_gid,
        nf.facet_style   facet_style_gid, 
        nf.facet_level   facet_level_gid,
        nf.facet_teacher facet_teacher_gid,  
        nf.facet_guest   facet_guest_gid, 
        nf.facet_host    facet_host_gid,  
        nf.facet_duration,  
        nf.facet_interview_collection,  
        nf.facet_interview_topic
from common.media_tmp m
left join common.v_content_origin vco
    on m.page_vid = vco.vid 
left join common.v_series vs
    on m.page_nid = vs.nid
left join common.v_node vn
    on m.media_nid = vn.nid
left join common.v_fields vf
    on m.page_nid = vf.nid
left join common.user_onboard_segments_playlist pl 
    on m.page_nid = pl.video_node
left join drupal.content_type_product_media tpm
    on m.media_vid = tpm.vid
left join drupal.content_type_product_video tpv
    on m.page_vid = tpv.vid
left join drupal.files img1 
    on tpv.field_coverart_image_fid = img1.fid
left join tmp.nid_genres ng
    on m.page_nid = ng.nid
left join tmp.nid_tags nt
    on m.page_nid = nt.nid
left join tmp.nid_categories vc
    on m.page_nid = vc.nid
left join tmp.nid_facets nf
    on m.page_nid = nf.nid
left join drupal.content_field_instructor cfi
    on m.page_nid  =cfi.nid

);


alter table common.video_d owner to dw_admin;

-- fix up duplicate preview rows
-- this gets me 95% of the way there.  The page data 
-- (nid, vid, title) still reflects the title of the first video 
-- when maybe it should be the series?


drop table if exists common.dupe_previews_tmp;

create table common.dupe_previews_tmp as 
(select t.*, 
        case when episode = first_episode then 1 else 0 end include
from
(select media_nid, 
        media_vid, 
        page_nid, 
        page_vid, 
        episode, 
        series_title,
        first_value(episode) over (partition by series_title order by episode) first_episode
 from common.video_d
where media_nid in 
   (select media_nid from common.video_d 
     group by media_nid
     having count(1) > 1))t);

delete from common.video_d
where page_nid in 
    (select page_nid from common.dupe_previews_tmp where include = 0);

select count(1), count(distinct media_nid) from common.video_d;

-- this  uses tables created in the pre-requisite files,
-- so this seems like a good place to put it.

drop table if exists common.solr_facets;

create table common.solr_facets as
select nid, string_agg(name, ',') facets from 
    (select nid, name from tmp.facets_tmp
      union 
      select nid, genres from tmp.genres_tmp
      union 
      select nid, tags from tmp.tags_tmp
      union 
      select nid, categories from tmp.categories_tmp) foo
group by nid;
   
alter table common.solr_facets owner to dw_admin;


[2016-02-22 14:32:17.805] [030571] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 14:33:16.022] [018477] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:33:16.103] [018477] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-22 14:33:16.392] [018476] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:33:16.472] [018476] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 14:33:16.566] [018476] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 14:33:16.682] [018476] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-22 14:33:16.783] [018476] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 14:33:17.388] [018476] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 14:33:17.469] [018476] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 14:33:17.557] [018476] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-22 14:33:17.640] [018476] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 14:33:17.742] [018476] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-22 14:33:17.828] [018476] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 14:33:18.117] [018476] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 14:33:18.198] [018476] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 14:33:18.285] [018476] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-22 14:33:18.370] [018476] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 14:33:27.370] [015527] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common' AND c.relname = 'video_d'

[2016-02-22 14:33:27.466] [015527] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'video_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-22 14:33:27.751] [015527] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-22 14:33:28.263] [015527] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-22 14:33:28.434] [015527] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'video_d' AND conname IS NOT NULL

[2016-02-22 14:33:28.518] [015527] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'video_d' ORDER BY t.relname, i.oid

[2016-02-22 14:33:28.604] [015527] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'video_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-22 14:33:28.690] [015527] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-22 14:33:28.773] [015527] [dwh-prod] [PGSQL]
SELECT oid, collname FROM pg_collation

[2016-02-22 14:33:29.103] [015527] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS table_name, am.amname, i.indexrelid, i.indisunique, i.indisclustered, i.indisprimary, i.indkey, i.indclass, obj_description(indexrelid) , i.indnatts, pg_get_expr(indpred, indrelid, true) AS indconstraint, pa.rolname AS owner, ts.spcname, ci.reloptions, i.indoption, i.indcollation FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid LEFT JOIN pg_roles pa ON pa.oid = ci.relowner WHERE tns.nspname = 'common' AND ct.relname = 'video_d' AND conname IS NULL ORDER BY ct.relname, ins.nspname, ci.relname

[2016-02-22 14:33:29.194] [015527] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6251151, 1, true)

[2016-02-22 14:33:29.296] [015527] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6251148, 1, true)

[2016-02-22 14:33:29.385] [015527] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6251156, 1, true)

[2016-02-22 14:33:29.475] [015527] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6251157, 1, true)

[2016-02-22 14:33:29.561] [015527] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6251149, 1, true)

[2016-02-22 14:33:29.650] [015527] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6251153, 1, true)

[2016-02-22 14:33:29.739] [015527] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6251155, 1, true)

[2016-02-22 14:33:29.828] [015527] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6251154, 1, true)

[2016-02-22 14:33:29.915] [015527] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6251152, 1, true)

[2016-02-22 14:33:30.002] [015527] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(6251150, 1, true)

[2016-02-22 14:33:30.084] [015527] [dwh-prod] [PGSQL]
SELECT t.oid, (current_database())::information_schema.sql_identifier AS trigger_catalog, (n.nspname)::information_schema.sql_identifier AS trigger_schema, (t.tgname)::information_schema.sql_identifier AS trigger_name, (c.relname)::information_schema.sql_identifier AS trigger_table_name, (em.text)::information_schema.character_data AS event_manipulation, (current_database())::information_schema.sql_identifier AS event_object_catalog, (n.nspname)::information_schema.sql_identifier AS event_object_schema, (c.relname)::information_schema.sql_identifier AS event_object_table, (c.relkind)::information_schema.sql_identifier AS event_object_table_type, (nsp.nspname)::information_schema.sql_identifier AS constraint_referenced_table_schema, (cs.relname)::information_schema.sql_identifier AS constraint_referenced_table_name, (t.tgdeferrable) AS constraint_deferrable_identifier, (t.tginitdeferred) AS constraint_deferred_type, (NULL::information_schema.cardinal_number)::information_schema.cardinal_number AS action_order, (CASE WHEN pg_has_role(c.relowner, 'USAGE'::text) THEN (SELECT rm.m[1] AS m FROM regexp_matches(pg_get_triggerdef(t.oid), (E'.{35,} WHEN \\((.+)\\) EXECUTE PROCEDURE'::text)) rm(m) LIMIT 1) ELSE NULL::text END)::information_schema.character_data AS action_condition, (NULL::information_schema.character_data)::information_schema.character_data AS action_condition, ("substring"(pg_get_triggerdef(t.oid), ("position"("substring"(pg_get_triggerdef(t.oid), 48), 'EXECUTE PROCEDURE'::text) + 47)))::information_schema.character_data AS action_statement, (CASE WHEN (((t.tgtype)::integer & 1) = 1) THEN 'ROW'::text ELSE 'STATEMENT'::text END)::information_schema.character_data AS action_orientation, (CASE WHEN (((t.tgtype)::integer & 2) = 2) THEN 'BEFORE'::text ELSE 'AFTER'::text END)::information_schema.character_data AS condition_timing, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_old_table, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_new_table, (t.tgconstraint) AS constraint_identifier, tc.event_object_column, obj_description(t.oid) FROM pg_namespace n LEFT JOIN pg_class c ON (n.oid = c.relnamespace) INNER JOIN pg_trigger t ON (c.oid = t.tgrelid) LEFT JOIN information_schema.triggered_update_columns tc ON (tc.trigger_schema = n.nspname) AND (tc.trigger_name = t.tgname) AND (tc.event_object_schema = n.nspname) AND (tc.event_object_table = c.relname)LEFT JOIN pg_user u ON (c.relowner = u.usesysid) LEFT JOIN (((SELECT 4, 'INSERT' UNION ALL SELECT 8, 'DELETE') UNION ALL SELECT 16, 'UPDATE') UNION ALL SELECT 32, 'TRUNCATE') em(num, text) ON (((t.tgtype)::integer & em.num) <> 0) LEFT OUTER JOIN (SELECT oid, relnamespace, relname FROM pg_class) cs ON (t.tgconstrrelid = cs.oid) LEFT OUTER JOIN (SELECT oid, nspname FROM pg_namespace) nsp ON (cs.relnamespace = nsp.oid) WHERE true AND n.nspname = 'common' AND c.relname = 'video_d' AND (not t.tgisinternal) ORDER BY c.relname, t.tgname

[2016-02-22 14:33:30.173] [015527] [dwh-prod] [PGSQL]
SELECT n.nspname AS rule_schema, c.relname, r.rulename, r.oid, r.ev_type, r.is_instead, pg_get_ruledef(r.oid) AS definition, obj_description(r.oid) AS comment FROM ((pg_rewrite r JOIN pg_class c ON ((c.oid = r.ev_class))) LEFT JOIN pg_namespace n ON ((n.oid = c.relnamespace))) WHERE (r.rulename <> '_RETURN'::name) AND (n.nspname='common') AND (c.relname='video_d')

[2016-02-22 14:33:47.889] [018477] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 14:33:48.031] [018477] [dwh-prod] [PGSQL]
/*  documenting prerequisites
\i facet groups.sql 
\i tag_groups.sql 
\i genre_groups.sql 
\i category groups_tmp.sql 
*/



drop table if exists common.media_tmp;

create table  common.media_tmp as
select cv.field_feature_nid_nid media_nid, 
       mn.vid media_vid,
       n.nid page_nid, 
       n.vid page_vid, 
       n.title,
       to_timestamp(n.created)::date created_date,
       va.admin_category,
       ac.site_segment,
       ac.reporting_segment    
from drupal.node n
join drupal.content_field_feature_nid cv
  ON n.vid = cv.vid
join drupal.node mn
  on cv.field_feature_nid_nid = mn.nid
left join common.v_admin_category va
    on n.vid = va.vid
left join common.admin_category_mapping ac
    on va.admin_category = ac.name
where n.type = 'product_video'
 and admin_category <> 'Radio';

--unstitched media
-- these can be associated with more than one guide.  I just get the first one
insert into common.media_tmp (media_nid, media_vid, page_nid, page_vid, title, site_segment, reporting_segment)
(select distinct on (media_nid)
       gd.media_nid, 
       gd.media_vid,
       gd.guide_day_nid,
       gd.guide_day_vid, 
       gd.guide_day_title,
       gd.site_segment,
       gd.site_segment
from common.guide_d gd
where guide_status = 1
  and media_vid not in 
    (select media_vid from common.media_tmp)
order by media_nid, guide_day_nid, guide_day_vid);

alter table common.media_tmp add feature varchar(10) default 'Feature';

insert into common.media_tmp
(select distinct on (field_preview_nid_nid)
       cv.field_preview_nid_nid, 
       mn.vid ,
       n.nid page_nid, 
       n.vid page_vid, 
       n.title,
       to_timestamp(n.created)::date created_date,
       va.admin_category,
       ac.site_segment,
       ac.reporting_segment,  
       'Preview' 
from drupal.node n
join drupal.content_field_preview_nid cv
  ON n.vid = cv.vid
join drupal.node mn
  on cv.field_preview_nid_nid = mn.nid
left join common.v_admin_category va
    on n.vid = va.vid
left join common.admin_category_mapping ac
    on va.admin_category = ac.name
where n.type = 'product_video'
 and admin_category <> 'Radio'
 and mn.vid not in 
    (select media_vid from common.media_tmp)
order by field_preview_nid_nid, mn.vid , n.nid, n.vid);

drop table if exists common.video_d cascade;

create table common.video_d as 
(select m.*,
        vco.content_origin,
        vn.duration,
        vs.series_title,
        vs.series_coverart_filepath,
        vf.season, 
        vf."cast",
        vf.copyright,
        vf.director,
        vf.studio,
        vf.long_description,
        tpm.field_media_maestro_title_code_value as mm_title_code,
        tpm.field_policy_id as media_policy_id,
        tpv.field_episode_value as episode,
        tpv.field_video_lang_value video_language,
        tpv.field_video_subtype_value as video_subtype,
        img1.filepath as coverart_filepath,
        pl.segment_id onboard_playlist_segment,
        -- gids are keys to bridge tables for multi_valued fields
        ng.gid as genre_gid,
        nt.gid as tag_gid,
        vc.gid as video_category_gid,
        nf.facet_focus   facet_focus_gid,
        nf.facet_style   facet_style_gid, 
        nf.facet_level   facet_level_gid,
        nf.facet_teacher facet_teacher_gid,  
        nf.facet_guest   facet_guest_gid, 
        nf.facet_host    facet_host_gid,  
        nf.facet_duration,  
        nf.facet_interview_collection,  
        nf.facet_interview_topic
from common.media_tmp m
left join common.v_content_origin vco
    on m.page_vid = vco.vid 
left join common.v_series vs
    on m.page_nid = vs.nid
left join common.v_node vn
    on m.media_nid = vn.nid
left join common.v_fields vf
    on m.page_nid = vf.nid
left join common.user_onboard_segments_playlist pl 
    on m.page_nid = pl.video_node
left join drupal.content_type_product_media tpm
    on m.media_vid = tpm.vid
left join drupal.content_type_product_video tpv
    on m.page_vid = tpv.vid
left join drupal.files img1 
    on tpv.field_coverart_image_fid = img1.fid
left join tmp.nid_genres ng
    on m.page_nid = ng.nid
left join tmp.nid_tags nt
    on m.page_nid = nt.nid
left join tmp.nid_categories vc
    on m.page_nid = vc.nid
left join tmp.nid_facets nf
    on m.page_nid = nf.nid
left join drupal.content_field_instructor cfi
    on m.page_nid  =cfi.nid

);


alter table common.video_d owner to dw_admin;

-- fix up duplicate preview rows
-- this gets me 95% of the way there.  The page data 
-- (nid, vid, title) still reflects the title of the first video 
-- when maybe it should be the series?


drop table if exists common.dupe_previews_tmp;

create table common.dupe_previews_tmp as 
(select t.*, 
        case when episode = first_episode then 1 else 0 end include
from
(select media_nid, 
        media_vid, 
        page_nid, 
        page_vid, 
        episode, 
        series_title,
        first_value(episode) over (partition by series_title order by episode) first_episode
 from common.video_d
where media_nid in 
   (select media_nid from common.video_d 
     group by media_nid
     having count(1) > 1))t);

delete from common.video_d
where page_nid in 
    (select page_nid from common.dupe_previews_tmp where include = 0);

select count(1), count(distinct media_nid) from common.video_d;

-- this  uses tables created in the pre-requisite files,
-- so this seems like a good place to put it.

drop table if exists common.solr_facets;

create table common.solr_facets as
select nid, string_agg(name, ',') facets from 
    (select nid, name from tmp.facets_tmp
      union 
      select nid, genres from tmp.genres_tmp
      union 
      select nid, tags from tmp.tags_tmp
      union 
      select nid, categories from tmp.categories_tmp) foo
group by nid;
   
alter table common.solr_facets owner to dw_admin;


[2016-02-22 14:33:48.224] [018477] [dwh-prod] [PGSQL]
ERROR:  must be owner of relation media_tmp


[2016-02-22 14:33:48.245] [018477] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 14:34:42.082] [030015] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 14:34:42.196] [030015] [dwh-dev] [PGSQL]
with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category = 'Yoga'
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v on vt.nid = v.media_nid
where  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration;






[2016-02-22 14:38:40.557] [030015] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 14:38:41.061] [030015] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12288406

[2016-02-22 14:42:08.708] [030015] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 14:42:08.820] [030015] [dwh-dev] [PGSQL]
with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category = 'Fitness'
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v on vt.nid = v.media_nid
where  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration;






[2016-02-22 14:45:18.049] [030015] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 14:45:18.325] [030015] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12288406

[2016-02-22 14:53:35.486] [024730] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:53:35.566] [024730] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-22 14:53:35.849] [024729] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 14:53:35.928] [024729] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 14:53:36.019] [024729] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 14:53:36.108] [024729] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-22 14:53:36.191] [024729] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 14:53:36.808] [024729] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 14:53:36.887] [024729] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 14:53:36.975] [024729] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-22 14:53:37.057] [024729] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 14:53:37.138] [024729] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-22 14:53:37.219] [024729] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 14:53:37.577] [024729] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 14:53:37.658] [024729] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 14:53:37.741] [024729] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-22 14:53:37.824] [024729] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 14:54:30.192] [024730] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 14:54:30.316] [024730] [dwh-prod] [PGSQL]
select user_behavior_segment, engagement_level, count(1)
from common.user_dim ud
join common.subscription_d sd
   on ud.current_subscription = sd.subscription_id 
where sd.dwh_plan_id = 109
group by  user_behavior_segment,engagement_level
order by user_behavior_segment;


[2016-02-22 14:54:30.697] [024730] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 14:54:31.102] [024730] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6251386

[2016-02-22 14:59:26.648] [024730] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 14:59:26.751] [024730] [dwh-prod] [PGSQL]
select  engagement_level, count(1)
from common.user_dim ud
join common.subscription_d sd
   on ud.current_subscription = sd.subscription_id 
where sd.dwh_plan_id = 109
group by  engagement_level;


[2016-02-22 14:59:26.957] [024730] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 14:59:27.279] [024730] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6251386

[2016-02-22 15:01:24.792] [024730] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 15:01:24.897] [024730] [dwh-prod] [PGSQL]
select user_behavior_segment, engagement_level, count(1)
from common.user_dim ud
join common.subscription_d sd
   on ud.current_subscription = sd.subscription_id 
where sd.dwh_plan_id = 109
group by  user_behavior_segment,engagement_level
order by user_behavior_segment;


[2016-02-22 15:01:25.102] [024730] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 15:01:25.421] [024730] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6251386

[2016-02-22 17:16:07.097] [028313] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 17:16:07.097] [028313] [dwh-dev] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-22 17:16:07.678] [001590] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 17:16:07.756] [001590] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-22 17:16:07.904] [001590] [dwh-dev] [PGSQL]
drop table if exists sub_master_30_60_90;


create table sub_master_30_60_90 as
select t3.*,
   case when paid_through_age >= 28 then 1 else 0 end sub_30_day,
   case when paid_through_age >= 58 and
             anniversary_60_date < '2016-01-15'::date and
             churn_30_day = 0 
        then 1 
        else  churn_60_day  -- if they are counted as a churner, make sure they are counted as a sub
   end sub_60_day,
   case when paid_through_age >= 88 and
             anniversary_90_date < '2016-01-15'::date and
             churn_60_day = 0 
        then 1 
        else churn_90_day   -- if they are counted as a churner, make sure they are counted as a sub
   end sub_90_day
from
   (select t2.*,
       case when cancel_age <= 34 then 1 
						when paid_through_age <= 31 and cancel_age is not null then 1
            when cancel_age between 118 and 122 AND
                 long_hold = 1 then 1 
            else 0
       end   churn_30_day,
       case when cancel_age >  34 and cancel_age <= 64 then 1 
            when paid_through_age > 31 and paid_through_age  <= 61 and cancel_age is not null then 1
            when cancel_age between 148 and 152 AND
                 long_hold = 1 then 1 
            else 0
       end   churn_60_day,
       case when cancel_age >  64 and cancel_age <= 94 then 1 
            when paid_through_age > 61 and paid_through_age  <= 91 and cancel_age is not null then 1
            when cancel_age between 178 and 182 AND
                 long_hold = 1 then 1 
            else 0
       end   churn_90_day
    from
        (select t1.*,
           case when hold_age > 15  
            then 1
            else 0
           end long_hold
        from
        (select gcsi_user_id, drupal_user_id, 
           subscription_id, 
           onboarding_segment,
           onboarding_parent,
           user_behavior_segment, 
           campaign_dept,
           case when status = 'Hold'
                then '2016-02-15'::date - valid_from 
           end hold_age,
           subscription_start_date::date subscription_start_date,
           cancel_date::date cancel_date,
           paid_through_date::date, 
           subscription_start_date::date + 30 anniversary_30_date,
           subscription_start_date::date + 60 anniversary_60_date,
           subscription_start_date::date + 90 anniversary_90_date,
           subscription_start_date::date + 1200 anniversary_120_date,
           cancel_date::date - subscription_start_date::date cancel_age,
           paid_through_date::date - subscription_start_date::date paid_through_age,
           '2016-01-15'::date - subscription_start_date::date iv_age
        from common.current_users
        where plan_id in  (31451044,31451363, 21891276)
          and winback = 'New User'
          and subscription_start_date <= '2016-01-15'
           and (onboarding_parent = 'Yoga' or 
                user_behavior_segment = 'My Yoga' OR
                source_name = 'MYO')) t1
        where paid_through_age > 0) t2 )t3
;



drop table if exists video_views_master;
drop table if exists video_view_days;
drop table if exists video_views_30_60_90;

create table video_views_30_60_90 as 
select
    drupal_user_id,
    period, 
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.level_1_views,0)                   level_1_views,
    coalesce(vxc.level_1_watched,0)                 level_1_watched,
    coalesce(vxc.level_2_views,0)                   level_2_views,
    coalesce(vxc.level_2_watched,0)                 level_2_watched,
    coalesce(vxc.level_3_views,0)                   level_3_views,
    coalesce(vxc.level_3_watched,0)                 level_3_watched,
    coalesce(vxc.duration_lt_15_views,0)            duration_lt_15_views,
    coalesce(vxc.duration_lt_15_watched,0)          duration_lt_15_watched,
    coalesce(vxc.duration_15_to_29_views,0)         duration_15_to_29_views,
    coalesce(vxc.duration_15_to_29_watched,0)       duration_15_to_29_watched,
    coalesce(vxc.duration_30_to_59_views,0)         duration_30_to_59_views,
    coalesce(vxc.duration_30_to_59_watched,0)       duration_30_to_59_watched,
    coalesce(vxc.duration_ge_60_views,0)            duration_ge_60_views,
    coalesce(vxc.duration_ge_60_watched,0)          duration_ge_60_watched,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched,
    coalesce(vxc.guide_day_views,0)                 guide_day_views,
    coalesce(vxc.first_quartile_complete_rat,0)     first_quartile_complete_rat,
    coalesce(vxc.second_quartile_complete_rat,0)    second_quartile_complete_rat,
    coalesce(vxc.third_quartile_complete_rat,0)     third_quartile_complete_rat,
    coalesce(vxc.fourth_quartile_complete_rat,0)    fourth_quartile_complete_rat
from
    (select drupal_user_id,
       period,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(level_1_views)                                   level_1_views, 
       sum(level_1_watched)                                 level_1_watched,   
       sum(level_2_views)                                   level_2_views,   
       sum(level_2_watched)                                 level_2_watched,
       sum(level_3_views)                                   level_3_views,
       sum(level_3_watched)                                 level_3_watched,
       sum(duration_lt_15_views)                            duration_lt_15_views,
       sum(duration_lt_15_watched)                          duration_lt_15_watched, 
       sum(duration_15_to_29_views)                         duration_15_to_29_views,
       sum(duration_15_to_29_watched)                       duration_15_to_29_watched,  
       sum(duration_30_to_59_views)                         duration_30_to_59_views,
       sum(duration_30_to_59_watched)                       duration_30_to_59_watched,  
       sum(duration_ge_60_views)                            duration_ge_60_views,
       sum(duration_ge_60_watched)                          duration_ge_60_watched,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched,
       sum(guide_day_views)                                 guide_day_views,
       sum(first_quartile_complete_rat)                     first_quartile_complete_rat,
       sum(second_quartile_complete_rat)                    second_quartile_complete_rat,
       sum(third_quartile_complete_rat)                     third_quartile_complete_rat,
       sum(fourth_quartile_complete_rat)                    fourth_quartile_complete_rat
    from
    (select vv.*,
            case when view_30_day = 1 then 1
                 when view_60_day =1 then 2
                 when view_90_day = 1 then 3
                 else 0
            end period,
            case when completion_ratio <= .25 then 1 else 0 end     first_quartile_complete_rat,
            case when completion_ratio >  .25 
                  and completion_ratio <= .5 then 1 else 0 end      second_quartile_complete_rat,
            case when completion_ratio > .5 
                  and completion_ratio <= .75 then 1 else 0 end     third_quartile_complete_rat,
            case when completion_ratio > .75 then 1 else 0 end      fourth_quartile_complete_rat
    from
        (select vdc.user_id drupal_user_id,
           vdc.created_date,
           vdc.num_views, 
           vdc.watched, 
           vdc.completion_ratio,
           v.duration,
           case when vdc.created_date <= sm3.anniversary_30_date then 1 else 0 end      view_30_day,
           case when vdc.created_date <= sm3.anniversary_60_date then 1 else 0 end      view_60_day,
           case when vdc.created_date <= sm3.anniversary_90_date then 1 else 0 end      view_90_day,
           case when fl.level_1 = 1 then num_views else 0 end                           level_1_views,
           case when fl.level_1 = 1 then watched else 0 end                             level_1_watched,
           case when fl.level_2 = 1 then num_views else 0 end                           level_2_views,
           case when fl.level_2 = 1 then watched else 0 end                             level_2_watched,
           case when fl.level_3 = 1 then num_views else 0 end                           level_3_views,
           case when fl.level_3 = 1 then watched else 0 end                             level_3_watched,
           case when facet_duration = '0-14 minutes' then num_views else 0 end          duration_lt_15_views,
           case when facet_duration = '0-14 minutes' then watched else 0 end            duration_lt_15_watched, 
           case when facet_duration = '15-29 minutes' then num_views else 0 end         duration_15_to_29_views,
           case when facet_duration = '15-29 minutes' then watched else 0 end           duration_15_to_29_watched,  
           case when facet_duration = '30-59 minutes' then num_views else 0 end         duration_30_to_59_views,
           case when facet_duration = '30-59 minutes' then watched else 0 end           duration_30_to_59_watched,  
           case when facet_duration = '60+ minutes' then num_views else 0 end           duration_ge_60_views,
           case when facet_duration = '60+ minutes' then watched else 0 end             duration_ge_60_watched,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration,
           case when guide_day is null then 0 else 1 end                                guide_day_views
        from sub_master_30_60_90 sm3
        left join  common.video_daily_cube vdc
            on sm3.drupal_user_id = vdc.user_id
        left join common.video_d v
           on vdc.media_nid = v.media_nid
        left join common.facet_levels fl 
           on v.facet_level_gid = fl.gid
        left join common.guide_d g
           on vdc.media_nid = g.media_nid) vv ) v2
    group by drupal_user_id, period) vxc;

   

create table video_views_master as
select 
    v1.drupal_user_id,
    v1.num_views                       num_views_1,                             
    v1.hrs_watched                     hrs_watched_1,
    v1.engagement_ratio                engagement_ratio_1,
    v1.yoga_engagement_ratio           yoga_engagement_ratio_1,
    v1.sg_engagement_ratio             sg_engagement_ratio_1,
    v1.st_engagement_ratio             st_engagement_ratio_1,
    v1.level_1_views                   level_1_views_1,
    v1.level_1_watched                 level_1_watched_1,
    v1.level_2_views                   level_2_views_1,
    v1.level_2_watched                 level_2_watched_1,
    v1.level_3_views                   level_3_views_1,
    v1.level_3_watched                 level_3_watched_1,
    v1.duration_lt_15_views            duration_lt_15_views_1,
    v1.duration_lt_15_watched          duration_lt_15_watched_1,
    v1.duration_15_to_29_views         duration_15_to_29_views_1,
    v1.duration_15_to_29_watched       duration_15_to_29_watched_1,
    v1.duration_30_to_59_views         duration_30_to_59_views_1,
    v1.duration_30_to_59_watched       duration_30_to_59_watched_1,
    v1.duration_ge_60_views            duration_ge_60_views_1,
    v1.duration_ge_60_watched          duration_ge_60_watched_1,
    v1.yoga_views                      yoga_views_1,
    v1.yoga_watched                    yoga_watched_1,
    v1.sg_views                        sg_views_1,
    v1.sg_watched                      sg_watched_1,
    v1.st_views                        st_views_1,
    v1.st_watched                      st_watched_1,
    v1.guide_day_views                 guide_day_views_1,
    v1.first_quartile_complete_rat     first_quartile_complete_rat_1,
    v1.second_quartile_complete_rat    second_quartile_complete_rat_1,
    v1.third_quartile_complete_rat    third_quartile_complete_rat_1,
    v1.fourth_quartile_complete_rat    fourth_quartile_complete_rat_1,
    v1.num_days_watched               num_days_watched_1,
    v2.num_views                       num_views_2,                             
    v2.hrs_watched                     hrs_watched_2,
    v2.engagement_ratio                engagement_ratio_2,
    v2.yoga_engagement_ratio           yoga_engagement_ratio_2,
    v2.sg_engagement_ratio             sg_engagement_ratio_2,
    v2.st_engagement_ratio             st_engagement_ratio_2,
    v2.level_1_views                   level_1_views_2,
    v2.level_1_watched                 level_1_watched_2,
    v2.level_2_views                   level_2_views_2,
    v2.level_2_watched                 level_2_watched_2,
    v2.level_3_views                   level_3_views_2,
    v2.level_3_watched                 level_3_watched_2,
    v2.duration_lt_15_views            duration_lt_15_views_2,
    v2.duration_lt_15_watched          duration_lt_15_watched_2,
    v2.duration_15_to_29_views         duration_15_to_29_views_2,
    v2.duration_15_to_29_watched       duration_15_to_29_watched_2,
    v2.duration_30_to_59_views         duration_30_to_59_views_2,
    v2.duration_30_to_59_watched       duration_30_to_59_watched_2,
    v2.duration_ge_60_views            duration_ge_60_views_2,
    v2.duration_ge_60_watched          duration_ge_60_watched_2,
    v2.yoga_views                      yoga_views_2,
    v2.yoga_watched                    yoga_watched_2,
    v2.sg_views                        sg_views_2,
    v2.sg_watched                      sg_watched_2,
    v2.st_views                        st_views_2,
    v2.st_watched                      st_watched_2,
    v2.guide_day_views                 guide_day_views_2,
    v2.first_quartile_complete_rat     first_quartile_complete_rat_2,
    v2.second_quartile_complete_rat    second_quartile_complete_rat_2,
    v2.third_quartile_complete_rat    third_quartile_complete_rat_2,
    v2.fourth_quartile_complete_rat    fourth_quartile_complete_rat_2,
    v2.num_days_watched               num_days_watched_2,
    v3.num_views                       num_views_3,                             
    v3.hrs_watched                     hrs_watched_3,
    v3.engagement_ratio                engagement_ratio_3,
    v3.yoga_engagement_ratio           yoga_engagement_ratio_3,
    v3.sg_engagement_ratio             sg_engagement_ratio_3,
    v3.st_engagement_ratio             st_engagement_ratio_3,
    v3.level_1_views                   level_1_views_3,
    v3.level_1_watched                 level_1_watched_3,
    v3.level_2_views                   level_2_views_3,
    v3.level_2_watched                 level_2_watched_3,
    v3.level_3_views                   level_3_views_3,
    v3.level_3_watched                 level_3_watched_3,
    v3.duration_lt_15_views            duration_lt_15_views_3,
    v3.duration_lt_15_watched          duration_lt_15_watched_3,
    v3.duration_15_to_29_views         duration_15_to_29_views_3,
    v3.duration_15_to_29_watched       duration_15_to_29_watched_3,
    v3.duration_30_to_59_views         duration_30_to_59_views_3,
    v3.duration_30_to_59_watched       duration_30_to_59_watched_3,
    v3.duration_ge_60_views            duration_ge_60_views_3,
    v3.duration_ge_60_watched          duration_ge_60_watched_3,
    v3.yoga_views                      yoga_views_3,
    v3.yoga_watched                    yoga_watched_3,
    v3.sg_views                        sg_views_3,
    v3.sg_watched                      sg_watched_3,
    v3.st_views                        st_views_3,
    v3.st_watched                      st_watched_3,
    v3.guide_day_views                 guide_day_views_3,
    v3.first_quartile_complete_rat     first_quartile_complete_rat_3,
    v3.second_quartile_complete_rat    second_quartile_complete_rat_3,
    v3.third_quartile_complete_rat     third_quartile_complete_rat_3,
    v3.fourth_quartile_complete_rat    fourth_quartile_complete_rat_3,
    v3.num_days_watched               num_days_watched_3
from sub_master_30_60_90 sm 
left join 
     (select * from video_views_30_60_90 where period = 1) v1
     on sm.drupal_user_id = v1.drupal_user_id
left join 
     (select * from video_views_30_60_90 where period = 2) v2
     on sm.drupal_user_id = v2.drupal_user_id
left join 
     (select * from video_views_30_60_90 where period = 3) v3
     on sm.drupal_user_id = v3.drupal_user_id;

drop table if exists guide_day_comp_30_60_90;

create table guide_day_comp_30_60_90 as 
select 
    drupal_user_id,
    period, 
    count(distinct gd3.guide_day_nid) num_days_completed
from (select gd2.*,
    case when complete_30_day = 1 then 1
         when complete_30_day =1 or complete_60_day =1 then 2
         when complete_30_day =1 or complete_60_day = 1 or complete_90_day = 1 then 3
         else 0
    end period
    from
        (select gd1.*,
               case when gd1.complete_day <= sm3.anniversary_30_date then 1 else 0 end      complete_30_day,
               case when gd1.complete_day <= sm3.anniversary_60_date then 1 else 0 end      complete_60_day,
               case when gd1.complete_day <= sm3.anniversary_90_date then 1 else 0 end      complete_90_day
        from 
            (select uid drupal_user_id,
                content_id guide_day_nid,
                to_timestamp(timestamp)::date complete_day
             from drupal.flag_content where fid = 6) gd1
        join sub_master_30_60_90 sm3
          on gd1.drupal_user_id = sm3.drupal_user_id) gd2) gd3
group by drupal_user_id, period;



drop table if exists guide_optins_30_60_90;

create table guide_optins_30_60_90 as
select 
    drupal_user_id,
    period, 
    count(distinct g3.guide_nid) num_opt_ins
from
    (select g2.*,
        case when opt_in_30_day = 1 then 1
             when opt_in_30_day =1 or opt_in_60_day =1 then 2
             when opt_in_30_day =1 or opt_in_60_day = 1 or opt_in_90_day = 1 then 3
             else 0
        end period
        from
            (select g1.*,
                   case when g1.opt_in_day <= sm3.anniversary_30_date then 1 else 0 end      opt_in_30_day,
                   case when g1.opt_in_day <= sm3.anniversary_60_date then 1 else 0 end      opt_in_60_day,
                   case when g1.opt_in_day <= sm3.anniversary_90_date then 1 else 0 end      opt_in_90_day
            from 
                (select uid drupal_user_id,
                    content_id guide_nid,
                    to_timestamp(timestamp)::date opt_in_day
                 from drupal.flag_content where fid = 11) g1
            join sub_master_30_60_90 sm3
              on g1.drupal_user_id = sm3.drupal_user_id) g2) g3
group by drupal_user_id, period;

drop table if exists guide_activity_master;

create table guide_activity_master as 
select gd4.*,
     coalesce(gd1.num_days_completed,0)        num_guide_days_completed_1,
     coalesce(gd2.num_days_completed,0)        num_guide_days_completed_2,
     coalesce(gd3.num_days_completed,0)        num_guide_days_completed_3
from
    (select sm.drupal_user_id,
        coalesce(g1.num_opt_ins,0)              num_guide_opt_ins_1,
        coalesce(g2.num_opt_ins,0)              num_guide_opt_ins_2,
        coalesce(g3.num_opt_ins,0)              num_guide_opt_ins_3
    from sub_master_30_60_90 sm 
   left join 
          (select * from guide_optins_30_60_90 where period = 1) g1
          on sm.drupal_user_id = g1.drupal_user_id
   left join 
          (select * from guide_optins_30_60_90 where period = 2) g2
          on sm.drupal_user_id = g2.drupal_user_id
   left join 
          (select * from guide_optins_30_60_90 where period = 3) g3
          on sm.drupal_user_id = g3.drupal_user_id) gd4   
left join 
      (select * from guide_day_comp_30_60_90 where period = 1) gd1
      on gd4.drupal_user_id = gd1.drupal_user_id
 left join 
      (select * from guide_day_comp_30_60_90 where period = 2) gd2
      on gd4.drupal_user_id = gd2.drupal_user_id
 left join 
      (select * from guide_day_comp_30_60_90 where period = 3) gd3
      on gd4.drupal_user_id = gd3.drupal_user_id;
     



drop table if exists sfss_30_60_90 cascade;

create table sfss_30_60_90 as 
select
    sm.gcsi_user_id ,
    sm.drupal_user_id ,
    sm.subscription_id, 
    sm.subscription_start_date ,
    sm.cancel_date ,
    sm.paid_through_date,
    sm.anniversary_30_date ,
    sm.anniversary_60_date ,
    sm.anniversary_90_date ,
    sm.anniversary_120_date ,
    sm.cancel_age ,
    sm.paid_through_age ,
    sm.iv_age ,
    sm.long_hold ,
    sm.churn_30_day ,
    sm.churn_60_day ,
    sm.churn_90_day ,
    sm.sub_30_day ,
    sm.sub_60_day ,
    sm.sub_90_day,
    sm.onboarding_segment,
    sm.onboarding_parent,
    sm.user_behavior_segment,
    sm.campaign_dept, 
    vv.num_views_1 ,
    vv.hrs_watched_1 ,
    vv.engagement_ratio_1 ,
    vv.yoga_engagement_ratio_1 ,
    vv.sg_engagement_ratio_1 ,
    vv.st_engagement_ratio_1 ,
    vv.level_1_views_1 ,
    vv.level_1_watched_1 ,
    vv.level_2_views_1 ,
    vv.level_2_watched_1 ,
    vv.level_3_views_1 ,
    vv.level_3_watched_1 ,
    vv.duration_lt_15_views_1 ,
    vv.duration_lt_15_watched_1 ,
    vv.duration_15_to_29_views_1 ,
    vv.duration_15_to_29_watched_1 ,
    vv.duration_30_to_59_views_1 ,
    vv.duration_30_to_59_watched_1 ,
    vv.duration_ge_60_views_1 ,
    vv.duration_ge_60_watched_1 ,
    vv.yoga_views_1 ,
    vv.yoga_watched_1 ,
    vv.sg_views_1 ,
    vv.sg_watched_1 ,
    vv.st_views_1 ,
    vv.st_watched_1 ,
    vv.guide_day_views_1 ,
    vv.first_quartile_complete_rat_1 ,
    vv.second_quartile_complete_rat_1 ,
    vv.third_quartile_complete_rat_1 ,
    vv.fourth_quartile_complete_rat_1 ,
    vv.num_days_watched_1 ,
    vv.num_views_2 ,
    vv.hrs_watched_2 ,
    vv.engagement_ratio_2 ,
    vv.yoga_engagement_ratio_2 ,
    vv.sg_engagement_ratio_2 ,
    vv.st_engagement_ratio_2 ,
    vv.level_1_views_2 ,
    vv.level_1_watched_2 ,
    vv.level_2_views_2 ,
    vv.level_2_watched_2 ,
    vv.level_3_views_2 ,
    vv.level_3_watched_2 ,
    vv.duration_lt_15_views_2 ,
    vv.duration_lt_15_watched_2 ,
    vv.duration_15_to_29_views_2 ,
    vv.duration_15_to_29_watched_2 ,
    vv.duration_30_to_59_views_2 ,
    vv.duration_30_to_59_watched_2 ,
    vv.duration_ge_60_views_2 ,
    vv.duration_ge_60_watched_2 ,
    vv.yoga_views_2 ,
    vv.yoga_watched_2 ,
    vv.sg_views_2 ,
    vv.sg_watched_2 ,
    vv.st_views_2 ,
    vv.st_watched_2 ,
    vv.guide_day_views_2 ,
    vv.first_quartile_complete_rat_2 ,
    vv.second_quartile_complete_rat_2 ,
    vv.third_quartile_complete_rat_2 ,
    vv.fourth_quartile_complete_rat_2 ,
    vv.num_days_watched_2 ,
    vv.num_views_3 ,
    vv.hrs_watched_3 ,
    vv.engagement_ratio_3 ,
    vv.yoga_engagement_ratio_3 ,
    vv.sg_engagement_ratio_3 ,
    vv.st_engagement_ratio_3 ,
    vv.level_1_views_3 ,
    vv.level_1_watched_3 ,
    vv.level_2_views_3 ,
    vv.level_2_watched_3 ,
    vv.level_3_views_3 ,
    vv.level_3_watched_3 ,
    vv.duration_lt_15_views_3 ,
    vv.duration_lt_15_watched_3 ,
    vv.duration_15_to_29_views_3 ,
    vv.duration_15_to_29_watched_3 ,
    vv.duration_30_to_59_views_3 ,
    vv.duration_30_to_59_watched_3 ,
    vv.duration_ge_60_views_3 ,
    vv.duration_ge_60_watched_3 ,
    vv.yoga_views_3 ,
    vv.yoga_watched_3 ,
    vv.sg_views_3 ,
    vv.sg_watched_3 ,
    vv.st_views_3 ,
    vv.st_watched_3 ,
    vv.guide_day_views_3 ,
    vv.first_quartile_complete_rat_3 ,
    vv.second_quartile_complete_rat_3 ,
    vv.third_quartile_complete_rat_3 ,
    vv.fourth_quartile_complete_rat_3 ,
    vv.num_days_watched_3,
    coalesce(gm.num_guide_opt_ins_1,0) 					num_guide_opt_ins_1,
    coalesce(gm.num_guide_days_completed_1,0)		num_guide_days_completed_1,
    coalesce(gm.num_guide_opt_ins_2,0)					num_guide_opt_ins_2,
    coalesce(gm.num_guide_days_completed_2,0)		num_guide_days_completed_2,
    coalesce(gm.num_guide_opt_ins_3,0)					num_guide_opt_ins_3,
    coalesce(gm.num_guide_days_completed_3,0)		num_guide_days_completed_3,
    coalesce(pl.playlist_count,0) playlist_count 
from sub_master_30_60_90 sm 
left join video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id
left join guide_activity_master gm
    on sm.drupal_user_id = gm.drupal_user_id
left join (select drupal_user_id,
           count(distinct page_nid) playlist_count
           from common.playlist_activity 
           group by drupal_user_id) pl
   on sm.drupal_user_id = pl.drupal_user_id;

create or replace view yoga_sfss as select * from sfss_30_60_90;




[2016-02-22 17:25:45.741] [001590] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-22 17:30:11.548] [008340] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 17:30:11.627] [008340] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-22 17:30:11.882] [008339] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-22 17:30:11.963] [008339] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 17:30:12.058] [008339] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 17:30:12.150] [008339] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-22 17:30:12.232] [008339] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 17:30:13.472] [008339] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 17:30:13.552] [008339] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 17:30:13.639] [008339] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-22 17:30:13.723] [008339] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-22 17:30:13.804] [008339] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-22 17:30:13.894] [008339] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-22 17:30:14.652] [008339] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-22 17:30:14.732] [008339] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-22 17:30:14.848] [008339] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-22 17:30:14.973] [008339] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-22 17:30:16.621] [008340] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-22 17:30:16.762] [008340] [dwh-prod] [PGSQL]
drop table if exists sub_master_30_60_90;


create table sub_master_30_60_90 as
select t3.*,
   case when paid_through_age >= 28 then 1 else 0 end sub_30_day,
   case when paid_through_age >= 58 and
             anniversary_60_date < '2016-01-15'::date and
             churn_30_day = 0 
        then 1 
        else  churn_60_day  -- if they are counted as a churner, make sure they are counted as a sub
   end sub_60_day,
   case when paid_through_age >= 88 and
             anniversary_90_date < '2016-01-15'::date and
             churn_60_day = 0 
        then 1 
        else churn_90_day   -- if they are counted as a churner, make sure they are counted as a sub
   end sub_90_day
from
   (select t2.*,
       case when cancel_age <= 34 then 1 
						when paid_through_age <= 31 and cancel_age is not null then 1
            when cancel_age between 118 and 122 AND
                 long_hold = 1 then 1 
            else 0
       end   churn_30_day,
       case when cancel_age >  34 and cancel_age <= 64 then 1 
            when paid_through_age > 31 and paid_through_age  <= 61 and cancel_age is not null then 1
            when cancel_age between 148 and 152 AND
                 long_hold = 1 then 1 
            else 0
       end   churn_60_day,
       case when cancel_age >  64 and cancel_age <= 94 then 1 
            when paid_through_age > 61 and paid_through_age  <= 91 and cancel_age is not null then 1
            when cancel_age between 178 and 182 AND
                 long_hold = 1 then 1 
            else 0
       end   churn_90_day
    from
        (select t1.*,
           case when hold_age > 15  
            then 1
            else 0
           end long_hold
        from
        (select gcsi_user_id, drupal_user_id, 
           subscription_id, 
           onboarding_segment,
           onboarding_parent,
           user_behavior_segment, 
           campaign_dept,
           case when status = 'Hold'
                then '2016-02-15'::date - valid_from 
           end hold_age,
           subscription_start_date::date subscription_start_date,
           cancel_date::date cancel_date,
           paid_through_date::date, 
           subscription_start_date::date + 30 anniversary_30_date,
           subscription_start_date::date + 60 anniversary_60_date,
           subscription_start_date::date + 90 anniversary_90_date,
           subscription_start_date::date + 1200 anniversary_120_date,
           cancel_date::date - subscription_start_date::date cancel_age,
           paid_through_date::date - subscription_start_date::date paid_through_age,
           '2016-01-15'::date - subscription_start_date::date iv_age
        from common.current_users
        where plan_id in  (31451044,31451363, 21891276)
          and winback = 'New User'
          and subscription_start_date <= '2016-01-15'
           and (onboarding_parent = 'Yoga' or 
                user_behavior_segment = 'My Yoga' OR
                source_name = 'MYO')) t1
        where paid_through_age > 0) t2 )t3
;



drop table if exists video_views_master;
drop table if exists video_view_days;
drop table if exists video_views_30_60_90;

create table video_views_30_60_90 as 
select
    drupal_user_id,
    period, 
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.level_1_views,0)                   level_1_views,
    coalesce(vxc.level_1_watched,0)                 level_1_watched,
    coalesce(vxc.level_2_views,0)                   level_2_views,
    coalesce(vxc.level_2_watched,0)                 level_2_watched,
    coalesce(vxc.level_3_views,0)                   level_3_views,
    coalesce(vxc.level_3_watched,0)                 level_3_watched,
    coalesce(vxc.duration_lt_15_views,0)            duration_lt_15_views,
    coalesce(vxc.duration_lt_15_watched,0)          duration_lt_15_watched,
    coalesce(vxc.duration_15_to_29_views,0)         duration_15_to_29_views,
    coalesce(vxc.duration_15_to_29_watched,0)       duration_15_to_29_watched,
    coalesce(vxc.duration_30_to_59_views,0)         duration_30_to_59_views,
    coalesce(vxc.duration_30_to_59_watched,0)       duration_30_to_59_watched,
    coalesce(vxc.duration_ge_60_views,0)            duration_ge_60_views,
    coalesce(vxc.duration_ge_60_watched,0)          duration_ge_60_watched,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched,
    coalesce(vxc.guide_day_views,0)                 guide_day_views,
    coalesce(vxc.first_quartile_complete_rat,0)     first_quartile_complete_rat,
    coalesce(vxc.second_quartile_complete_rat,0)    second_quartile_complete_rat,
    coalesce(vxc.third_quartile_complete_rat,0)     third_quartile_complete_rat,
    coalesce(vxc.fourth_quartile_complete_rat,0)    fourth_quartile_complete_rat
from
    (select drupal_user_id,
       period,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(level_1_views)                                   level_1_views, 
       sum(level_1_watched)                                 level_1_watched,   
       sum(level_2_views)                                   level_2_views,   
       sum(level_2_watched)                                 level_2_watched,
       sum(level_3_views)                                   level_3_views,
       sum(level_3_watched)                                 level_3_watched,
       sum(duration_lt_15_views)                            duration_lt_15_views,
       sum(duration_lt_15_watched)                          duration_lt_15_watched, 
       sum(duration_15_to_29_views)                         duration_15_to_29_views,
       sum(duration_15_to_29_watched)                       duration_15_to_29_watched,  
       sum(duration_30_to_59_views)                         duration_30_to_59_views,
       sum(duration_30_to_59_watched)                       duration_30_to_59_watched,  
       sum(duration_ge_60_views)                            duration_ge_60_views,
       sum(duration_ge_60_watched)                          duration_ge_60_watched,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched,
       sum(guide_day_views)                                 guide_day_views,
       sum(first_quartile_complete_rat)                     first_quartile_complete_rat,
       sum(second_quartile_complete_rat)                    second_quartile_complete_rat,
       sum(third_quartile_complete_rat)                     third_quartile_complete_rat,
       sum(fourth_quartile_complete_rat)                    fourth_quartile_complete_rat
    from
    (select vv.*,
            case when view_30_day = 1 then 1
                 when view_60_day =1 then 2
                 when view_90_day = 1 then 3
                 else 0
            end period,
            case when completion_ratio <= .25 then 1 else 0 end     first_quartile_complete_rat,
            case when completion_ratio >  .25 
                  and completion_ratio <= .5 then 1 else 0 end      second_quartile_complete_rat,
            case when completion_ratio > .5 
                  and completion_ratio <= .75 then 1 else 0 end     third_quartile_complete_rat,
            case when completion_ratio > .75 then 1 else 0 end      fourth_quartile_complete_rat
    from
        (select vdc.user_id drupal_user_id,
           vdc.created_date,
           vdc.num_views, 
           vdc.watched, 
           vdc.completion_ratio,
           v.duration,
           case when vdc.created_date <= sm3.anniversary_30_date then 1 else 0 end      view_30_day,
           case when vdc.created_date <= sm3.anniversary_60_date then 1 else 0 end      view_60_day,
           case when vdc.created_date <= sm3.anniversary_90_date then 1 else 0 end      view_90_day,
           case when fl.level_1 = 1 then num_views else 0 end                           level_1_views,
           case when fl.level_1 = 1 then watched else 0 end                             level_1_watched,
           case when fl.level_2 = 1 then num_views else 0 end                           level_2_views,
           case when fl.level_2 = 1 then watched else 0 end                             level_2_watched,
           case when fl.level_3 = 1 then num_views else 0 end                           level_3_views,
           case when fl.level_3 = 1 then watched else 0 end                             level_3_watched,
           case when facet_duration = '0-14 minutes' then num_views else 0 end          duration_lt_15_views,
           case when facet_duration = '0-14 minutes' then watched else 0 end            duration_lt_15_watched, 
           case when facet_duration = '15-29 minutes' then num_views else 0 end         duration_15_to_29_views,
           case when facet_duration = '15-29 minutes' then watched else 0 end           duration_15_to_29_watched,  
           case when facet_duration = '30-59 minutes' then num_views else 0 end         duration_30_to_59_views,
           case when facet_duration = '30-59 minutes' then watched else 0 end           duration_30_to_59_watched,  
           case when facet_duration = '60+ minutes' then num_views else 0 end           duration_ge_60_views,
           case when facet_duration = '60+ minutes' then watched else 0 end             duration_ge_60_watched,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration,
           case when guide_day is null then 0 else 1 end                                guide_day_views
        from sub_master_30_60_90 sm3
        left join  common.video_daily_cube vdc
            on sm3.drupal_user_id = vdc.user_id
        left join common.video_d v
           on vdc.media_nid = v.media_nid
        left join common.facet_levels fl 
           on v.facet_level_gid = fl.gid
        left join common.guide_d g
           on vdc.media_nid = g.media_nid) vv ) v2
    group by drupal_user_id, period) vxc;

   

create table video_views_master as
select 
    v1.drupal_user_id,
    v1.num_views                       num_views_1,                             
    v1.hrs_watched                     hrs_watched_1,
    v1.engagement_ratio                engagement_ratio_1,
    v1.yoga_engagement_ratio           yoga_engagement_ratio_1,
    v1.sg_engagement_ratio             sg_engagement_ratio_1,
    v1.st_engagement_ratio             st_engagement_ratio_1,
    v1.level_1_views                   level_1_views_1,
    v1.level_1_watched                 level_1_watched_1,
    v1.level_2_views                   level_2_views_1,
    v1.level_2_watched                 level_2_watched_1,
    v1.level_3_views                   level_3_views_1,
    v1.level_3_watched                 level_3_watched_1,
    v1.duration_lt_15_views            duration_lt_15_views_1,
    v1.duration_lt_15_watched          duration_lt_15_watched_1,
    v1.duration_15_to_29_views         duration_15_to_29_views_1,
    v1.duration_15_to_29_watched       duration_15_to_29_watched_1,
    v1.duration_30_to_59_views         duration_30_to_59_views_1,
    v1.duration_30_to_59_watched       duration_30_to_59_watched_1,
    v1.duration_ge_60_views            duration_ge_60_views_1,
    v1.duration_ge_60_watched          duration_ge_60_watched_1,
    v1.yoga_views                      yoga_views_1,
    v1.yoga_watched                    yoga_watched_1,
    v1.sg_views                        sg_views_1,
    v1.sg_watched                      sg_watched_1,
    v1.st_views                        st_views_1,
    v1.st_watched                      st_watched_1,
    v1.guide_day_views                 guide_day_views_1,
    v1.first_quartile_complete_rat     first_quartile_complete_rat_1,
    v1.second_quartile_complete_rat    second_quartile_complete_rat_1,
    v1.third_quartile_complete_rat    third_quartile_complete_rat_1,
    v1.fourth_quartile_complete_rat    fourth_quartile_complete_rat_1,
    v1.num_days_watched               num_days_watched_1,
    v2.num_views                       num_views_2,                             
    v2.hrs_watched                     hrs_watched_2,
    v2.engagement_ratio                engagement_ratio_2,
    v2.yoga_engagement_ratio           yoga_engagement_ratio_2,
    v2.sg_engagement_ratio             sg_engagement_ratio_2,
    v2.st_engagement_ratio             st_engagement_ratio_2,
    v2.level_1_views                   level_1_views_2,
    v2.level_1_watched                 level_1_watched_2,
    v2.level_2_views                   level_2_views_2,
    v2.level_2_watched                 level_2_watched_2,
    v2.level_3_views                   level_3_views_2,
    v2.level_3_watched                 level_3_watched_2,
    v2.duration_lt_15_views            duration_lt_15_views_2,
    v2.duration_lt_15_watched          duration_lt_15_watched_2,
    v2.duration_15_to_29_views         duration_15_to_29_views_2,
    v2.duration_15_to_29_watched       duration_15_to_29_watched_2,
    v2.duration_30_to_59_views         duration_30_to_59_views_2,
    v2.duration_30_to_59_watched       duration_30_to_59_watched_2,
    v2.duration_ge_60_views            duration_ge_60_views_2,
    v2.duration_ge_60_watched          duration_ge_60_watched_2,
    v2.yoga_views                      yoga_views_2,
    v2.yoga_watched                    yoga_watched_2,
    v2.sg_views                        sg_views_2,
    v2.sg_watched                      sg_watched_2,
    v2.st_views                        st_views_2,
    v2.st_watched                      st_watched_2,
    v2.guide_day_views                 guide_day_views_2,
    v2.first_quartile_complete_rat     first_quartile_complete_rat_2,
    v2.second_quartile_complete_rat    second_quartile_complete_rat_2,
    v2.third_quartile_complete_rat    third_quartile_complete_rat_2,
    v2.fourth_quartile_complete_rat    fourth_quartile_complete_rat_2,
    v2.num_days_watched               num_days_watched_2,
    v3.num_views                       num_views_3,                             
    v3.hrs_watched                     hrs_watched_3,
    v3.engagement_ratio                engagement_ratio_3,
    v3.yoga_engagement_ratio           yoga_engagement_ratio_3,
    v3.sg_engagement_ratio             sg_engagement_ratio_3,
    v3.st_engagement_ratio             st_engagement_ratio_3,
    v3.level_1_views                   level_1_views_3,
    v3.level_1_watched                 level_1_watched_3,
    v3.level_2_views                   level_2_views_3,
    v3.level_2_watched                 level_2_watched_3,
    v3.level_3_views                   level_3_views_3,
    v3.level_3_watched                 level_3_watched_3,
    v3.duration_lt_15_views            duration_lt_15_views_3,
    v3.duration_lt_15_watched          duration_lt_15_watched_3,
    v3.duration_15_to_29_views         duration_15_to_29_views_3,
    v3.duration_15_to_29_watched       duration_15_to_29_watched_3,
    v3.duration_30_to_59_views         duration_30_to_59_views_3,
    v3.duration_30_to_59_watched       duration_30_to_59_watched_3,
    v3.duration_ge_60_views            duration_ge_60_views_3,
    v3.duration_ge_60_watched          duration_ge_60_watched_3,
    v3.yoga_views                      yoga_views_3,
    v3.yoga_watched                    yoga_watched_3,
    v3.sg_views                        sg_views_3,
    v3.sg_watched                      sg_watched_3,
    v3.st_views                        st_views_3,
    v3.st_watched                      st_watched_3,
    v3.guide_day_views                 guide_day_views_3,
    v3.first_quartile_complete_rat     first_quartile_complete_rat_3,
    v3.second_quartile_complete_rat    second_quartile_complete_rat_3,
    v3.third_quartile_complete_rat     third_quartile_complete_rat_3,
    v3.fourth_quartile_complete_rat    fourth_quartile_complete_rat_3,
    v3.num_days_watched               num_days_watched_3
from sub_master_30_60_90 sm 
left join 
     (select * from video_views_30_60_90 where period = 1) v1
     on sm.drupal_user_id = v1.drupal_user_id
left join 
     (select * from video_views_30_60_90 where period = 2) v2
     on sm.drupal_user_id = v2.drupal_user_id
left join 
     (select * from video_views_30_60_90 where period = 3) v3
     on sm.drupal_user_id = v3.drupal_user_id;

drop table if exists guide_day_comp_30_60_90;

create table guide_day_comp_30_60_90 as 
select 
    drupal_user_id,
    period, 
    count(distinct gd3.guide_day_nid) num_days_completed
from (select gd2.*,
    case when complete_30_day = 1 then 1
         when complete_30_day =1 or complete_60_day =1 then 2
         when complete_30_day =1 or complete_60_day = 1 or complete_90_day = 1 then 3
         else 0
    end period
    from
        (select gd1.*,
               case when gd1.complete_day <= sm3.anniversary_30_date then 1 else 0 end      complete_30_day,
               case when gd1.complete_day <= sm3.anniversary_60_date then 1 else 0 end      complete_60_day,
               case when gd1.complete_day <= sm3.anniversary_90_date then 1 else 0 end      complete_90_day
        from 
            (select uid drupal_user_id,
                content_id guide_day_nid,
                to_timestamp(timestamp)::date complete_day
             from drupal.flag_content where fid = 6) gd1
        join sub_master_30_60_90 sm3
          on gd1.drupal_user_id = sm3.drupal_user_id) gd2) gd3
group by drupal_user_id, period;



drop table if exists guide_optins_30_60_90;

create table guide_optins_30_60_90 as
select 
    drupal_user_id,
    period, 
    count(distinct g3.guide_nid) num_opt_ins
from
    (select g2.*,
        case when opt_in_30_day = 1 then 1
             when opt_in_30_day =1 or opt_in_60_day =1 then 2
             when opt_in_30_day =1 or opt_in_60_day = 1 or opt_in_90_day = 1 then 3
             else 0
        end period
        from
            (select g1.*,
                   case when g1.opt_in_day <= sm3.anniversary_30_date then 1 else 0 end      opt_in_30_day,
                   case when g1.opt_in_day <= sm3.anniversary_60_date then 1 else 0 end      opt_in_60_day,
                   case when g1.opt_in_day <= sm3.anniversary_90_date then 1 else 0 end      opt_in_90_day
            from 
                (select uid drupal_user_id,
                    content_id guide_nid,
                    to_timestamp(timestamp)::date opt_in_day
                 from drupal.flag_content where fid = 11) g1
            join sub_master_30_60_90 sm3
              on g1.drupal_user_id = sm3.drupal_user_id) g2) g3
group by drupal_user_id, period;

drop table if exists guide_activity_master;

create table guide_activity_master as 
select gd4.*,
     coalesce(gd1.num_days_completed,0)        num_guide_days_completed_1,
     coalesce(gd2.num_days_completed,0)        num_guide_days_completed_2,
     coalesce(gd3.num_days_completed,0)        num_guide_days_completed_3
from
    (select sm.drupal_user_id,
        coalesce(g1.num_opt_ins,0)              num_guide_opt_ins_1,
        coalesce(g2.num_opt_ins,0)              num_guide_opt_ins_2,
        coalesce(g3.num_opt_ins,0)              num_guide_opt_ins_3
    from sub_master_30_60_90 sm 
   left join 
          (select * from guide_optins_30_60_90 where period = 1) g1
          on sm.drupal_user_id = g1.drupal_user_id
   left join 
          (select * from guide_optins_30_60_90 where period = 2) g2
          on sm.drupal_user_id = g2.drupal_user_id
   left join 
          (select * from guide_optins_30_60_90 where period = 3) g3
          on sm.drupal_user_id = g3.drupal_user_id) gd4   
left join 
      (select * from guide_day_comp_30_60_90 where period = 1) gd1
      on gd4.drupal_user_id = gd1.drupal_user_id
 left join 
      (select * from guide_day_comp_30_60_90 where period = 2) gd2
      on gd4.drupal_user_id = gd2.drupal_user_id
 left join 
      (select * from guide_day_comp_30_60_90 where period = 3) gd3
      on gd4.drupal_user_id = gd3.drupal_user_id;
     



drop table if exists sfss_30_60_90 cascade;

create table sfss_30_60_90 as 
select
    sm.gcsi_user_id ,
    sm.drupal_user_id ,
    sm.subscription_id, 
    sm.subscription_start_date ,
    sm.cancel_date ,
    sm.paid_through_date,
    sm.anniversary_30_date ,
    sm.anniversary_60_date ,
    sm.anniversary_90_date ,
    sm.anniversary_120_date ,
    sm.cancel_age ,
    sm.paid_through_age ,
    sm.iv_age ,
    sm.long_hold ,
    sm.churn_30_day ,
    sm.churn_60_day ,
    sm.churn_90_day ,
    sm.sub_30_day ,
    sm.sub_60_day ,
    sm.sub_90_day,
    sm.onboarding_segment,
    sm.onboarding_parent,
    sm.user_behavior_segment,
    sm.campaign_dept, 
    vv.num_views_1 ,
    vv.hrs_watched_1 ,
    vv.engagement_ratio_1 ,
    vv.yoga_engagement_ratio_1 ,
    vv.sg_engagement_ratio_1 ,
    vv.st_engagement_ratio_1 ,
    vv.level_1_views_1 ,
    vv.level_1_watched_1 ,
    vv.level_2_views_1 ,
    vv.level_2_watched_1 ,
    vv.level_3_views_1 ,
    vv.level_3_watched_1 ,
    vv.duration_lt_15_views_1 ,
    vv.duration_lt_15_watched_1 ,
    vv.duration_15_to_29_views_1 ,
    vv.duration_15_to_29_watched_1 ,
    vv.duration_30_to_59_views_1 ,
    vv.duration_30_to_59_watched_1 ,
    vv.duration_ge_60_views_1 ,
    vv.duration_ge_60_watched_1 ,
    vv.yoga_views_1 ,
    vv.yoga_watched_1 ,
    vv.sg_views_1 ,
    vv.sg_watched_1 ,
    vv.st_views_1 ,
    vv.st_watched_1 ,
    vv.guide_day_views_1 ,
    vv.first_quartile_complete_rat_1 ,
    vv.second_quartile_complete_rat_1 ,
    vv.third_quartile_complete_rat_1 ,
    vv.fourth_quartile_complete_rat_1 ,
    vv.num_days_watched_1 ,
    vv.num_views_2 ,
    vv.hrs_watched_2 ,
    vv.engagement_ratio_2 ,
    vv.yoga_engagement_ratio_2 ,
    vv.sg_engagement_ratio_2 ,
    vv.st_engagement_ratio_2 ,
    vv.level_1_views_2 ,
    vv.level_1_watched_2 ,
    vv.level_2_views_2 ,
    vv.level_2_watched_2 ,
    vv.level_3_views_2 ,
    vv.level_3_watched_2 ,
    vv.duration_lt_15_views_2 ,
    vv.duration_lt_15_watched_2 ,
    vv.duration_15_to_29_views_2 ,
    vv.duration_15_to_29_watched_2 ,
    vv.duration_30_to_59_views_2 ,
    vv.duration_30_to_59_watched_2 ,
    vv.duration_ge_60_views_2 ,
    vv.duration_ge_60_watched_2 ,
    vv.yoga_views_2 ,
    vv.yoga_watched_2 ,
    vv.sg_views_2 ,
    vv.sg_watched_2 ,
    vv.st_views_2 ,
    vv.st_watched_2 ,
    vv.guide_day_views_2 ,
    vv.first_quartile_complete_rat_2 ,
    vv.second_quartile_complete_rat_2 ,
    vv.third_quartile_complete_rat_2 ,
    vv.fourth_quartile_complete_rat_2 ,
    vv.num_days_watched_2 ,
    vv.num_views_3 ,
    vv.hrs_watched_3 ,
    vv.engagement_ratio_3 ,
    vv.yoga_engagement_ratio_3 ,
    vv.sg_engagement_ratio_3 ,
    vv.st_engagement_ratio_3 ,
    vv.level_1_views_3 ,
    vv.level_1_watched_3 ,
    vv.level_2_views_3 ,
    vv.level_2_watched_3 ,
    vv.level_3_views_3 ,
    vv.level_3_watched_3 ,
    vv.duration_lt_15_views_3 ,
    vv.duration_lt_15_watched_3 ,
    vv.duration_15_to_29_views_3 ,
    vv.duration_15_to_29_watched_3 ,
    vv.duration_30_to_59_views_3 ,
    vv.duration_30_to_59_watched_3 ,
    vv.duration_ge_60_views_3 ,
    vv.duration_ge_60_watched_3 ,
    vv.yoga_views_3 ,
    vv.yoga_watched_3 ,
    vv.sg_views_3 ,
    vv.sg_watched_3 ,
    vv.st_views_3 ,
    vv.st_watched_3 ,
    vv.guide_day_views_3 ,
    vv.first_quartile_complete_rat_3 ,
    vv.second_quartile_complete_rat_3 ,
    vv.third_quartile_complete_rat_3 ,
    vv.fourth_quartile_complete_rat_3 ,
    vv.num_days_watched_3,
    coalesce(gm.num_guide_opt_ins_1,0) 					num_guide_opt_ins_1,
    coalesce(gm.num_guide_days_completed_1,0)		num_guide_days_completed_1,
    coalesce(gm.num_guide_opt_ins_2,0)					num_guide_opt_ins_2,
    coalesce(gm.num_guide_days_completed_2,0)		num_guide_days_completed_2,
    coalesce(gm.num_guide_opt_ins_3,0)					num_guide_opt_ins_3,
    coalesce(gm.num_guide_days_completed_3,0)		num_guide_days_completed_3,
    coalesce(pl.playlist_count,0) playlist_count 
from sub_master_30_60_90 sm 
left join video_views_master vv
    on sm.drupal_user_id = vv.drupal_user_id
left join guide_activity_master gm
    on sm.drupal_user_id = gm.drupal_user_id
left join (select drupal_user_id,
           count(distinct page_nid) playlist_count
           from common.playlist_activity 
           group by drupal_user_id) pl
   on sm.drupal_user_id = pl.drupal_user_id;

create or replace view yoga_sfss as select * from sfss_30_60_90;




[2016-02-22 17:31:20.277] [008340] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 13:42:07.242] [030015] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-23 13:42:07.243] [030015] [dwh-dev] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-23 13:42:07.825] [022887] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 13:42:07.906] [022887] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-23 13:42:08.020] [022887] [dwh-dev] [PGSQL]
with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid, facet_teacher_gid,
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category = 'Fitness'
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
v.facet_teacher_gid,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v on vt.nid = v.media_nid
where  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration, v.facet_teacher_gid;








[2016-02-23 13:42:08.104] [022887] [dwh-dev] [PGSQL]
ERROR:  syntax error at or near "from"
LINE 7:      from common.video_d v1
             ^


[2016-02-23 13:42:08.124] [022887] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-23 13:42:16.390] [022887] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-23 13:42:16.507] [022887] [dwh-dev] [PGSQL]
with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid, facet_teacher_gid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category = 'Fitness'
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
v.facet_teacher_gid,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v on vt.nid = v.media_nid
where  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration, v.facet_teacher_gid;








[2016-02-23 13:45:34.602] [023047] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-23 13:45:35.046] [023047] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12311574

[2016-02-23 13:46:38.759] [023047] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-23 13:46:38.908] [023047] [dwh-dev] [PGSQL]

create table avg_yoga_completion as
(with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid, facet_teacher_gid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category = 'Fitness'
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
v.facet_teacher_gid,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v on vt.nid = v.media_nid
where  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration, v.facet_teacher_gid);








[2016-02-23 13:50:00.448] [023047] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-23 13:52:47.822] [023047] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-23 13:52:47.937] [023047] [dwh-dev] [PGSQL]
drop table if exists avg_yoga_completion;


create table avg_yoga_completion as
(with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid, facet_teacher_gid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category in ('Yoga', 'Fitness')
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
v.facet_teacher_gid,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v on vt.nid = v.media_nid
where  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration, v.facet_teacher_gid);








[2016-02-23 13:56:17.183] [023047] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-23 13:59:24.219] [015527] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common' AND c.relname = 'facet_groups'

[2016-02-23 13:59:24.220] [015527] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-23 13:59:24.804] [024011] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 13:59:24.883] [024011] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common' AND c.relname = 'facet_groups'

[2016-02-23 13:59:24.979] [024011] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'facet_groups' ORDER BY col.table_name, col.ordinal_position

[2016-02-23 13:59:25.112] [024011] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-23 13:59:25.500] [024011] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-23 13:59:25.583] [024011] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'facet_groups' AND conname IS NOT NULL

[2016-02-23 13:59:25.669] [024011] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'facet_groups' ORDER BY t.relname, i.oid

[2016-02-23 13:59:25.757] [024011] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'facet_groups' ORDER BY t.relname, c.conname, a.attnum

[2016-02-23 13:59:25.840] [024011] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-23 13:59:25.922] [024011] [dwh-prod] [PGSQL]
SELECT oid, collname FROM pg_collation

[2016-02-23 13:59:26.166] [024011] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS table_name, am.amname, i.indexrelid, i.indisunique, i.indisclustered, i.indisprimary, i.indkey, i.indclass, obj_description(indexrelid) , i.indnatts, pg_get_expr(indpred, indrelid, true) AS indconstraint, pa.rolname AS owner, ts.spcname, ci.reloptions, i.indoption, i.indcollation FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid LEFT JOIN pg_roles pa ON pa.oid = ci.relowner WHERE tns.nspname = 'common' AND ct.relname = 'facet_groups' AND conname IS NULL ORDER BY ct.relname, ins.nspname, ci.relname

[2016-02-23 13:59:26.252] [024011] [dwh-prod] [PGSQL]
SELECT t.oid, (current_database())::information_schema.sql_identifier AS trigger_catalog, (n.nspname)::information_schema.sql_identifier AS trigger_schema, (t.tgname)::information_schema.sql_identifier AS trigger_name, (c.relname)::information_schema.sql_identifier AS trigger_table_name, (em.text)::information_schema.character_data AS event_manipulation, (current_database())::information_schema.sql_identifier AS event_object_catalog, (n.nspname)::information_schema.sql_identifier AS event_object_schema, (c.relname)::information_schema.sql_identifier AS event_object_table, (c.relkind)::information_schema.sql_identifier AS event_object_table_type, (nsp.nspname)::information_schema.sql_identifier AS constraint_referenced_table_schema, (cs.relname)::information_schema.sql_identifier AS constraint_referenced_table_name, (t.tgdeferrable) AS constraint_deferrable_identifier, (t.tginitdeferred) AS constraint_deferred_type, (NULL::information_schema.cardinal_number)::information_schema.cardinal_number AS action_order, (CASE WHEN pg_has_role(c.relowner, 'USAGE'::text) THEN (SELECT rm.m[1] AS m FROM regexp_matches(pg_get_triggerdef(t.oid), (E'.{35,} WHEN \\((.+)\\) EXECUTE PROCEDURE'::text)) rm(m) LIMIT 1) ELSE NULL::text END)::information_schema.character_data AS action_condition, (NULL::information_schema.character_data)::information_schema.character_data AS action_condition, ("substring"(pg_get_triggerdef(t.oid), ("position"("substring"(pg_get_triggerdef(t.oid), 48), 'EXECUTE PROCEDURE'::text) + 47)))::information_schema.character_data AS action_statement, (CASE WHEN (((t.tgtype)::integer & 1) = 1) THEN 'ROW'::text ELSE 'STATEMENT'::text END)::information_schema.character_data AS action_orientation, (CASE WHEN (((t.tgtype)::integer & 2) = 2) THEN 'BEFORE'::text ELSE 'AFTER'::text END)::information_schema.character_data AS condition_timing, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_old_table, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_new_table, (t.tgconstraint) AS constraint_identifier, tc.event_object_column, obj_description(t.oid) FROM pg_namespace n LEFT JOIN pg_class c ON (n.oid = c.relnamespace) INNER JOIN pg_trigger t ON (c.oid = t.tgrelid) LEFT JOIN information_schema.triggered_update_columns tc ON (tc.trigger_schema = n.nspname) AND (tc.trigger_name = t.tgname) AND (tc.event_object_schema = n.nspname) AND (tc.event_object_table = c.relname)LEFT JOIN pg_user u ON (c.relowner = u.usesysid) LEFT JOIN (((SELECT 4, 'INSERT' UNION ALL SELECT 8, 'DELETE') UNION ALL SELECT 16, 'UPDATE') UNION ALL SELECT 32, 'TRUNCATE') em(num, text) ON (((t.tgtype)::integer & em.num) <> 0) LEFT OUTER JOIN (SELECT oid, relnamespace, relname FROM pg_class) cs ON (t.tgconstrrelid = cs.oid) LEFT OUTER JOIN (SELECT oid, nspname FROM pg_namespace) nsp ON (cs.relnamespace = nsp.oid) WHERE true AND n.nspname = 'common' AND c.relname = 'facet_groups' AND (not t.tgisinternal) ORDER BY c.relname, t.tgname

[2016-02-23 13:59:26.350] [024011] [dwh-prod] [PGSQL]
SELECT n.nspname AS rule_schema, c.relname, r.rulename, r.oid, r.ev_type, r.is_instead, pg_get_ruledef(r.oid) AS definition, obj_description(r.oid) AS comment FROM ((pg_rewrite r JOIN pg_class c ON ((c.oid = r.ev_class))) LEFT JOIN pg_namespace n ON ((n.oid = c.relnamespace))) WHERE (r.rulename <> '_RETURN'::name) AND (n.nspname='common') AND (c.relname='facet_groups')

[2016-02-23 13:59:29.504] [024026] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 13:59:29.591] [024011] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'facet_groups' ORDER BY col.table_name, col.ordinal_position

[2016-02-23 13:59:29.690] [024011] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-23 13:59:30.131] [024011] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-23 13:59:30.215] [024011] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'facet_groups' AND conname IS NOT NULL

[2016-02-23 13:59:30.297] [024011] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'facet_groups' ORDER BY t.relname, i.oid

[2016-02-23 13:59:30.381] [024011] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'facet_groups' ORDER BY t.relname, c.conname, a.attnum

[2016-02-23 13:59:30.589] [024026] [dwh-prod] [PGSQL]
SELECT * FROM "common"."facet_groups" LIMIT 1000 OFFSET 0

[2016-02-23 13:59:31.004] [024026] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'facet_groups'

[2016-02-23 13:59:31.105] [024026] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6270927

[2016-02-23 13:59:59.313] [024026] [dwh-prod] [PGSQL]
SELECT * FROM "common"."facet_groups" WHERE "gid" = '592' LIMIT 1000 OFFSET 0

[2016-02-23 13:59:59.394] [024026] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'facet_groups'

[2016-02-23 13:59:59.483] [024026] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6270927

[2016-02-23 14:01:32.334] [023047] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-23 14:01:32.440] [023047] [dwh-dev] [PGSQL]
create table yoga_teachers as 
(select page_nid, fg.name teacher
 from common.video_d v
 join common.facet groups fg
   on f.facet_teacher_gid = fg.gid
     join drupal.node n on v.page_nid = n.nid
     where admin_category in ('Yoga', 'Fitness')
      and n.status = 1
      and feature = 'Feature')


[2016-02-23 14:01:32.520] [023047] [dwh-dev] [PGSQL]
ERROR:  syntax error at or near "fg"
LINE 4:  join common.facet groups fg
                                  ^


[2016-02-23 14:01:32.534] [023047] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-23 14:02:01.142] [023047] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-23 14:02:01.245] [023047] [dwh-dev] [PGSQL]
create table yoga_teachers as 
(select page_nid, fg.name teacher
 from common.video_d v
 join common.facet groups fg
   on v.facet_teacher_gid = fg.gid
     join drupal.node n on v.page_nid = n.nid
     where admin_category in ('Yoga', 'Fitness')
      and n.status = 1
      and feature = 'Feature')


[2016-02-23 14:02:01.324] [023047] [dwh-dev] [PGSQL]
ERROR:  syntax error at or near "fg"
LINE 4:  join common.facet groups fg
                                  ^


[2016-02-23 14:02:01.336] [023047] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-23 14:02:50.481] [023047] [dwh-dev] [PGSQL]
SET search_path TO "moiram","$user", gcsi, drupal, public

[2016-02-23 14:02:50.585] [023047] [dwh-dev] [PGSQL]
create table yoga_teachers as 
(select page_nid, fg.name as teacher
 from common.video_d v
 join common.facet_groups fg
   on v.facet_teacher_gid = fg.gid
     join drupal.node n on v.page_nid = n.nid
     where admin_category in ('Yoga', 'Fitness')
      and n.status = 1
      and feature = 'Feature')


[2016-02-23 14:02:50.782] [023047] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-23 14:04:46.436] [025709] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 14:04:46.515] [025709] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-23 14:04:46.770] [025708] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 14:04:46.858] [025708] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-23 14:04:46.957] [025708] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-23 14:04:47.051] [025708] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-23 14:04:47.136] [025708] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-23 14:04:48.245] [025708] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-23 14:04:48.325] [025708] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-23 14:04:48.423] [025708] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-23 14:04:48.505] [025708] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-23 14:04:48.586] [025708] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-23 14:04:48.666] [025708] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-23 14:04:49.362] [025708] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-23 14:04:49.442] [025708] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-23 14:04:49.525] [025708] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-23 14:04:49.610] [025708] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-23 14:04:50.378] [025709] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 14:04:50.508] [025709] [dwh-prod] [PGSQL]
drop table if exists avg_yoga_completion;


create table avg_yoga_completion as
(with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid, facet_teacher_gid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category in ('Yoga', 'Fitness')
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
v.facet_teacher_gid,
       count(1)total_views, 
       sum(watched) total_watched
from common.video_tmp vt 
join  v on vt.nid = v.media_nid
where  vt.created > 1420070400
group by v.title, v.video_age,v.page_nid, v.duration, v.facet_teacher_gid);

create table yoga_teachers as 
(select page_nid, fg.name as teacher
 from common.video_d v
 join common.facet_groups fg
   on v.facet_teacher_gid = fg.gid
     join drupal.node n on v.page_nid = n.nid
     where admin_category in ('Yoga', 'Fitness')
      and n.status = 1
      and feature = 'Feature')








[2016-02-23 14:06:07.889] [025709] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:03:06.663] [025709] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:03:06.765] [025709] [dwh-prod] [PGSQL]
create table yoga_styles as 
(select page_nid, fg.name as style
 from common.video_d v
 join common.facet_groups fg
   on v.facet_style_gid = fg.gid
     join drupal.node n on v.page_nid = n.nid
     where admin_category in ('Yoga', 'Fitness')
      and n.status = 1
      and feature = 'Feature')


[2016-02-23 15:03:06.888] [025709] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:24:03.570] [025709] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:24:22.474] [025709] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-23 15:24:22.499] [025709] [dwh-prod] [PGSQL]
(select page_nid, fg.name as style
 from common.video_d v
 join common.facet_groups fg
   on v.facet_style_gid = fg.gid
     join drupal.node n on v.page_nid = n.nid
     where admin_category in ('Yoga', 'Fitness')
      and n.status = 1
      and feature = 'Feature')


[2016-02-23 15:24:22.499] [025709] [dwh-prod] [PGSQL]
no connection to the server


[2016-02-23 15:24:23.145] [017844] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 15:24:23.228] [017844] [dwh-prod] [PGSQL]
(select page_nid, fg.name as style
 from common.video_d v
 join common.facet_groups fg
   on v.facet_style_gid = fg.gid
     join drupal.node n on v.page_nid = n.nid
     where admin_category in ('Yoga', 'Fitness')
      and n.status = 1
      and feature = 'Feature')


[2016-02-23 15:24:23.780] [017844] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:26:57.057] [018658] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 15:26:57.137] [018658] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-23 15:26:57.401] [018657] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 15:26:57.484] [018657] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-23 15:26:57.581] [018657] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-23 15:26:57.674] [018657] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-23 15:26:57.758] [018657] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-23 15:26:58.893] [018657] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-23 15:26:58.974] [018657] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-23 15:26:59.061] [018657] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-23 15:26:59.145] [018657] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-23 15:26:59.228] [018657] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-23 15:26:59.311] [018657] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-23 15:27:00.101] [018657] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-23 15:27:00.183] [018657] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-23 15:27:00.268] [018657] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-23 15:27:00.352] [018657] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-23 15:27:24.335] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:27:24.447] [018658] [dwh-prod] [PGSQL]
select count(1) from user_dim where user_behavior_segment is null;


[2016-02-23 15:27:24.553] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:27:35.962] [018822] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 15:27:36.041] [018822] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-23 15:27:36.143] [018822] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-23 15:27:36.229] [018822] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-23 15:27:37.310] [018822] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-23 15:27:37.390] [018822] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-23 15:27:37.481] [018822] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-23 15:27:38.282] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:27:38.385] [018658] [dwh-prod] [PGSQL]
select count(1) from common.user_dim where user_behavior_segment is null;


[2016-02-23 15:27:38.484] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:28:37.936] [019140] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 15:28:38.017] [019140] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='user_behavior_segmentation' ORDER BY ordinal_position

[2016-02-23 15:29:07.040] [024011] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common' AND c.relname = 'user_behavior_segmentation'

[2016-02-23 15:29:07.041] [024011] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-23 15:29:07.636] [019325] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 15:29:07.718] [019325] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common' AND c.relname = 'user_behavior_segmentation'

[2016-02-23 15:29:07.813] [019325] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'user_behavior_segmentation' ORDER BY col.table_name, col.ordinal_position

[2016-02-23 15:29:07.937] [019325] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-23 15:29:08.310] [019325] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-23 15:29:08.397] [019325] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'user_behavior_segmentation' AND conname IS NOT NULL

[2016-02-23 15:29:08.483] [019325] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'user_behavior_segmentation' ORDER BY t.relname, i.oid

[2016-02-23 15:29:08.573] [019325] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'user_behavior_segmentation' ORDER BY t.relname, c.conname, a.attnum

[2016-02-23 15:29:08.661] [019325] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-23 15:29:08.746] [019325] [dwh-prod] [PGSQL]
SELECT oid, collname FROM pg_collation

[2016-02-23 15:29:08.994] [019325] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS table_name, am.amname, i.indexrelid, i.indisunique, i.indisclustered, i.indisprimary, i.indkey, i.indclass, obj_description(indexrelid) , i.indnatts, pg_get_expr(indpred, indrelid, true) AS indconstraint, pa.rolname AS owner, ts.spcname, ci.reloptions, i.indoption, i.indcollation FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid LEFT JOIN pg_roles pa ON pa.oid = ci.relowner WHERE tns.nspname = 'common' AND ct.relname = 'user_behavior_segmentation' AND conname IS NULL ORDER BY ct.relname, ins.nspname, ci.relname

[2016-02-23 15:29:09.088] [019325] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(4507538, 1, true)

[2016-02-23 15:29:09.184] [019325] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(4507539, 1, true)

[2016-02-23 15:29:09.270] [019325] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(4507539, 2, true)

[2016-02-23 15:29:09.353] [019325] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(4507539, 3, true)

[2016-02-23 15:29:09.445] [019325] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(4507540, 1, true)

[2016-02-23 15:29:09.531] [019325] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(4507541, 1, true)

[2016-02-23 15:29:09.619] [019325] [dwh-prod] [PGSQL]
SELECT pg_get_indexdef(4507542, 1, true)

[2016-02-23 15:29:09.704] [019325] [dwh-prod] [PGSQL]
SELECT t.oid, (current_database())::information_schema.sql_identifier AS trigger_catalog, (n.nspname)::information_schema.sql_identifier AS trigger_schema, (t.tgname)::information_schema.sql_identifier AS trigger_name, (c.relname)::information_schema.sql_identifier AS trigger_table_name, (em.text)::information_schema.character_data AS event_manipulation, (current_database())::information_schema.sql_identifier AS event_object_catalog, (n.nspname)::information_schema.sql_identifier AS event_object_schema, (c.relname)::information_schema.sql_identifier AS event_object_table, (c.relkind)::information_schema.sql_identifier AS event_object_table_type, (nsp.nspname)::information_schema.sql_identifier AS constraint_referenced_table_schema, (cs.relname)::information_schema.sql_identifier AS constraint_referenced_table_name, (t.tgdeferrable) AS constraint_deferrable_identifier, (t.tginitdeferred) AS constraint_deferred_type, (NULL::information_schema.cardinal_number)::information_schema.cardinal_number AS action_order, (CASE WHEN pg_has_role(c.relowner, 'USAGE'::text) THEN (SELECT rm.m[1] AS m FROM regexp_matches(pg_get_triggerdef(t.oid), (E'.{35,} WHEN \\((.+)\\) EXECUTE PROCEDURE'::text)) rm(m) LIMIT 1) ELSE NULL::text END)::information_schema.character_data AS action_condition, (NULL::information_schema.character_data)::information_schema.character_data AS action_condition, ("substring"(pg_get_triggerdef(t.oid), ("position"("substring"(pg_get_triggerdef(t.oid), 48), 'EXECUTE PROCEDURE'::text) + 47)))::information_schema.character_data AS action_statement, (CASE WHEN (((t.tgtype)::integer & 1) = 1) THEN 'ROW'::text ELSE 'STATEMENT'::text END)::information_schema.character_data AS action_orientation, (CASE WHEN (((t.tgtype)::integer & 2) = 2) THEN 'BEFORE'::text ELSE 'AFTER'::text END)::information_schema.character_data AS condition_timing, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_old_table, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_new_table, (t.tgconstraint) AS constraint_identifier, tc.event_object_column, obj_description(t.oid) FROM pg_namespace n LEFT JOIN pg_class c ON (n.oid = c.relnamespace) INNER JOIN pg_trigger t ON (c.oid = t.tgrelid) LEFT JOIN information_schema.triggered_update_columns tc ON (tc.trigger_schema = n.nspname) AND (tc.trigger_name = t.tgname) AND (tc.event_object_schema = n.nspname) AND (tc.event_object_table = c.relname)LEFT JOIN pg_user u ON (c.relowner = u.usesysid) LEFT JOIN (((SELECT 4, 'INSERT' UNION ALL SELECT 8, 'DELETE') UNION ALL SELECT 16, 'UPDATE') UNION ALL SELECT 32, 'TRUNCATE') em(num, text) ON (((t.tgtype)::integer & em.num) <> 0) LEFT OUTER JOIN (SELECT oid, relnamespace, relname FROM pg_class) cs ON (t.tgconstrrelid = cs.oid) LEFT OUTER JOIN (SELECT oid, nspname FROM pg_namespace) nsp ON (cs.relnamespace = nsp.oid) WHERE true AND n.nspname = 'common' AND c.relname = 'user_behavior_segmentation' AND (not t.tgisinternal) ORDER BY c.relname, t.tgname

[2016-02-23 15:29:09.794] [019325] [dwh-prod] [PGSQL]
SELECT n.nspname AS rule_schema, c.relname, r.rulename, r.oid, r.ev_type, r.is_instead, pg_get_ruledef(r.oid) AS definition, obj_description(r.oid) AS comment FROM ((pg_rewrite r JOIN pg_class c ON ((c.oid = r.ev_class))) LEFT JOIN pg_namespace n ON ((n.oid = c.relnamespace))) WHERE (r.rulename <> '_RETURN'::name) AND (n.nspname='common') AND (c.relname='user_behavior_segmentation')

[2016-02-23 15:29:19.088] [019378] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 15:29:19.169] [019325] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'user_behavior_segmentation' ORDER BY col.table_name, col.ordinal_position

[2016-02-23 15:29:19.277] [019325] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-23 15:29:19.651] [019325] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-23 15:29:19.734] [019325] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'user_behavior_segmentation' AND conname IS NOT NULL

[2016-02-23 15:29:19.817] [019325] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'user_behavior_segmentation' ORDER BY t.relname, i.oid

[2016-02-23 15:29:19.906] [019325] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'user_behavior_segmentation' ORDER BY t.relname, c.conname, a.attnum

[2016-02-23 15:29:20.102] [019378] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_behavior_segmentation" LIMIT 1000 OFFSET 0

[2016-02-23 15:29:20.872] [019378] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_behavior_segmentation'

[2016-02-23 15:29:20.973] [019378] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4507397

[2016-02-23 15:29:45.622] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:29:45.724] [018658] [dwh-prod] [PGSQL]
select segment_name, count(1) from common.user_behavior_segmentation
where group by segment_name;


[2016-02-23 15:29:45.805] [018658] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "group"
LINE 2: where group by segment_name;
              ^


[2016-02-23 15:29:45.817] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:29:53.117] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:29:53.238] [018658] [dwh-prod] [PGSQL]
select segment_name, count(1) from common.user_behavior_segmentation
 group by segment_name;


[2016-02-23 15:29:53.840] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:29:54.177] [018658] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4507397

[2016-02-23 15:30:31.478] [019758] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 15:30:31.571] [019758] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='user_dim' ORDER BY ordinal_position

[2016-02-23 15:30:41.654] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:30:41.760] [018658] [dwh-prod] [PGSQL]
select user_behavior_segment, count(1)
from common.user_dim
group by user_behavior_segment;


[2016-02-23 15:30:41.907] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:30:42.284] [018658] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6271087

[2016-02-23 15:31:18.208] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:31:18.317] [018658] [dwh-prod] [PGSQL]
select user_behavior_segment, count(1)
from common.user_dim
where user_end_date is null
group by user_behavior_segment;


[2016-02-23 15:31:18.560] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:31:18.891] [018658] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6271087

[2016-02-23 15:34:35.256] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:34:35.373] [018658] [dwh-prod] [PGSQL]
select count(1)
from common.user_dim
where user_end_date is null 
  and user_behavior_segment is NULL
  and drupal_user_id in (select user_id from common.video_tmp);


[2016-02-23 15:35:04.169] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:35:35.186] [021310] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 15:35:35.268] [021310] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_tmp' ORDER BY ordinal_position

[2016-02-23 15:35:48.864] [021420] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 15:35:48.946] [021420] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'drupal') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-23 15:35:49.245] [021420] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='drupal' ORDER BY schemaname, viewname

[2016-02-23 15:35:49.328] [021420] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-23 15:35:50.415] [021420] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-23 15:35:50.497] [021420] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'drupal' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-23 15:35:50.587] [021420] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'drupal' 

[2016-02-23 15:36:30.190] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:36:30.304] [018658] [dwh-prod] [PGSQL]
select count(1)
from common.user_dim
where user_end_date is null 
  and user_behavior_segment is NULL
  and drupal_user_id in (
    select uid from drupal.smfplayer_user_history
    union
    select client_id from drupal.smfplayer_user_history);


[2016-02-23 15:36:30.397] [018658] [dwh-prod] [PGSQL]
ERROR:  column "client_id" does not exist
LINE 8:     select client_id from drupal.smfplayer_user_history);
                   ^


[2016-02-23 15:36:30.409] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:36:36.920] [021606] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 15:36:37.002] [021606] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='drupal' AND table_name='smfplayer_user_history' ORDER BY ordinal_position

[2016-02-23 15:36:39.888] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 15:36:39.995] [018658] [dwh-prod] [PGSQL]
select count(1)
from common.user_dim
where user_end_date is null 
  and user_behavior_segment is NULL
  and drupal_user_id in (
    select uid from drupal.smfplayer_user_history
    union
    select client_uid from drupal.smfplayer_user_history);


[2016-02-23 15:37:59.558] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:11:03.798] [019325] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'common' AND c.relname = 'cohort_d'

[2016-02-23 16:11:03.892] [019325] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'cohort_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-23 16:11:04.026] [019325] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-23 16:11:04.439] [019325] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-23 16:11:04.681] [019325] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'cohort_d' AND conname IS NOT NULL

[2016-02-23 16:11:04.765] [019325] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'cohort_d' ORDER BY t.relname, i.oid

[2016-02-23 16:11:04.850] [019325] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'cohort_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-23 16:11:04.932] [019325] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-23 16:11:05.100] [019325] [dwh-prod] [PGSQL]
SELECT oid, collname FROM pg_collation

[2016-02-23 16:11:05.348] [019325] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS table_name, am.amname, i.indexrelid, i.indisunique, i.indisclustered, i.indisprimary, i.indkey, i.indclass, obj_description(indexrelid) , i.indnatts, pg_get_expr(indpred, indrelid, true) AS indconstraint, pa.rolname AS owner, ts.spcname, ci.reloptions, i.indoption, i.indcollation FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid LEFT JOIN pg_roles pa ON pa.oid = ci.relowner WHERE tns.nspname = 'common' AND ct.relname = 'cohort_d' AND conname IS NULL ORDER BY ct.relname, ins.nspname, ci.relname

[2016-02-23 16:11:05.434] [019325] [dwh-prod] [PGSQL]
SELECT t.oid, (current_database())::information_schema.sql_identifier AS trigger_catalog, (n.nspname)::information_schema.sql_identifier AS trigger_schema, (t.tgname)::information_schema.sql_identifier AS trigger_name, (c.relname)::information_schema.sql_identifier AS trigger_table_name, (em.text)::information_schema.character_data AS event_manipulation, (current_database())::information_schema.sql_identifier AS event_object_catalog, (n.nspname)::information_schema.sql_identifier AS event_object_schema, (c.relname)::information_schema.sql_identifier AS event_object_table, (c.relkind)::information_schema.sql_identifier AS event_object_table_type, (nsp.nspname)::information_schema.sql_identifier AS constraint_referenced_table_schema, (cs.relname)::information_schema.sql_identifier AS constraint_referenced_table_name, (t.tgdeferrable) AS constraint_deferrable_identifier, (t.tginitdeferred) AS constraint_deferred_type, (NULL::information_schema.cardinal_number)::information_schema.cardinal_number AS action_order, (CASE WHEN pg_has_role(c.relowner, 'USAGE'::text) THEN (SELECT rm.m[1] AS m FROM regexp_matches(pg_get_triggerdef(t.oid), (E'.{35,} WHEN \\((.+)\\) EXECUTE PROCEDURE'::text)) rm(m) LIMIT 1) ELSE NULL::text END)::information_schema.character_data AS action_condition, (NULL::information_schema.character_data)::information_schema.character_data AS action_condition, ("substring"(pg_get_triggerdef(t.oid), ("position"("substring"(pg_get_triggerdef(t.oid), 48), 'EXECUTE PROCEDURE'::text) + 47)))::information_schema.character_data AS action_statement, (CASE WHEN (((t.tgtype)::integer & 1) = 1) THEN 'ROW'::text ELSE 'STATEMENT'::text END)::information_schema.character_data AS action_orientation, (CASE WHEN (((t.tgtype)::integer & 2) = 2) THEN 'BEFORE'::text ELSE 'AFTER'::text END)::information_schema.character_data AS condition_timing, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_old_table, (NULL::information_schema.sql_identifier)::information_schema.sql_identifier AS condition_reference_new_table, (t.tgconstraint) AS constraint_identifier, tc.event_object_column, obj_description(t.oid) FROM pg_namespace n LEFT JOIN pg_class c ON (n.oid = c.relnamespace) INNER JOIN pg_trigger t ON (c.oid = t.tgrelid) LEFT JOIN information_schema.triggered_update_columns tc ON (tc.trigger_schema = n.nspname) AND (tc.trigger_name = t.tgname) AND (tc.event_object_schema = n.nspname) AND (tc.event_object_table = c.relname)LEFT JOIN pg_user u ON (c.relowner = u.usesysid) LEFT JOIN (((SELECT 4, 'INSERT' UNION ALL SELECT 8, 'DELETE') UNION ALL SELECT 16, 'UPDATE') UNION ALL SELECT 32, 'TRUNCATE') em(num, text) ON (((t.tgtype)::integer & em.num) <> 0) LEFT OUTER JOIN (SELECT oid, relnamespace, relname FROM pg_class) cs ON (t.tgconstrrelid = cs.oid) LEFT OUTER JOIN (SELECT oid, nspname FROM pg_namespace) nsp ON (cs.relnamespace = nsp.oid) WHERE true AND n.nspname = 'common' AND c.relname = 'cohort_d' AND (not t.tgisinternal) ORDER BY c.relname, t.tgname

[2016-02-23 16:11:05.521] [019325] [dwh-prod] [PGSQL]
SELECT n.nspname AS rule_schema, c.relname, r.rulename, r.oid, r.ev_type, r.is_instead, pg_get_ruledef(r.oid) AS definition, obj_description(r.oid) AS comment FROM ((pg_rewrite r JOIN pg_class c ON ((c.oid = r.ev_class))) LEFT JOIN pg_namespace n ON ((n.oid = c.relnamespace))) WHERE (r.rulename <> '_RETURN'::name) AND (n.nspname='common') AND (c.relname='cohort_d')

[2016-02-23 16:11:14.247] [032343] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 16:11:14.328] [032343] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-23 16:11:14.603] [032342] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 16:11:14.682] [032342] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-23 16:11:14.775] [032342] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-23 16:11:14.862] [032342] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-23 16:11:14.944] [032342] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-23 16:11:16.334] [032342] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-23 16:11:16.413] [032342] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-23 16:11:16.501] [032342] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-23 16:11:16.585] [032342] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-23 16:11:16.678] [032342] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-23 16:11:16.771] [032342] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-23 16:11:17.748] [032342] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-23 16:11:17.830] [032342] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-23 16:11:17.915] [032342] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-23 16:11:17.998] [032342] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-23 16:12:29.302] [032699] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 16:12:29.380] [032699] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='drupal' AND table_name='flag_content' ORDER BY ordinal_position

[2016-02-23 16:13:13.353] [000473] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 16:13:13.433] [019325] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'playlist_activity' ORDER BY col.table_name, col.ordinal_position

[2016-02-23 16:13:13.532] [019325] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-23 16:13:13.852] [019325] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-23 16:13:13.943] [019325] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'playlist_activity' AND conname IS NOT NULL

[2016-02-23 16:13:14.025] [019325] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'playlist_activity' ORDER BY t.relname, i.oid

[2016-02-23 16:13:14.112] [019325] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'playlist_activity' ORDER BY t.relname, c.conname, a.attnum

[2016-02-23 16:13:14.314] [000473] [dwh-prod] [PGSQL]
SELECT * FROM "common"."playlist_activity" LIMIT 1000 OFFSET 0

[2016-02-23 16:13:14.807] [000473] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'playlist_activity'

[2016-02-23 16:13:14.906] [000473] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4507359

[2016-02-23 16:16:42.933] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:16:43.070] [018658] [dwh-prod] [PGSQL]
select * from playlist_activity where drupal_user_id = 2884326;


[2016-02-23 16:16:48.778] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:16:49.118] [018658] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4507359

[2016-02-23 16:17:39.353] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:17:39.468] [018658] [dwh-prod] [PGSQL]
select * from playlist_activity where drupal_user_id = 2883786;


[2016-02-23 16:17:40.777] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:17:41.121] [018658] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4507359

[2016-02-23 16:18:34.204] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:18:34.338] [018658] [dwh-prod] [PGSQL]
select * from drupal.flag_content where uid = 2883786;


[2016-02-23 16:18:34.447] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:18:34.850] [018658] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6252943

[2016-02-23 16:18:34.932] [018658] [dwh-prod] [PGSQL]
SELECT nsp.nspname, cl.relname, array_upper(conkey,1) as pkeycount FROM pg_class cl LEFT JOIN pg_namespace nsp ON nsp.oid = cl.relnamespace LEFT JOIN pg_constraint con ON con.conrelid = cl.oid WHERE con.contype = 'p' AND cl.oid = 6252943

[2016-02-23 16:18:35.013] [018658] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = '' AND cl.table_schema = 'drupal' AND cl.table_name = 'flag_content'

[2016-02-23 16:20:06.724] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:20:06.827] [018658] [dwh-prod] [PGSQL]
select * from subscription_d where drupal_user_id = 2883786;


[2016-02-23 16:20:06.973] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:20:07.385] [018658] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6271104

[2016-02-23 16:34:28.974] [007078] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 16:34:29.053] [007078] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='playlist_activity' ORDER BY ordinal_position

[2016-02-23 16:34:43.722] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:34:43.844] [018658] [dwh-prod] [PGSQL]
create table null_segment_analysis
as 
select drupal_user_id, gcsi_user_id, current_subscription subscription_id
case when vt.user_id is not null then 1 else 0  video_tmp,
case when suh.uid is not null then 1 else 0 suh,
case when fc.uid is not null then 1 else 0 guide,
case when pl.num_videos > 5 then 1 else 0 end playlist
from common.user_dim ud
left join common.video_tmp vt
    on ud.drupal_user_id = vt.user_id
left join 
			(select uid from drupal.smfplayer_user_history
       UNION
       select client_uid from drupal.smfplayer_user_history) suh
   on ud.drupal_user_ suh.uid
left join drupal.flag_content fc
       on ud.drupal_user_id = fc.uid and
          fc.fid = 11
left join 
     (select drupal_user_id, count(1) num_videos
      from common.playlist_activity
      group by drupal_user_id) pl 
     on ud.drupal_user_id = pl.drupal_user_id
where user_end_date is null 
  and user_behavior_segment is NULL


[2016-02-23 16:34:43.925] [018658] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "case"
LINE 4: case when vt.user_id is not null then 1 else 0  video_tmp,
        ^


[2016-02-23 16:34:43.948] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:34:56.095] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:34:56.219] [018658] [dwh-prod] [PGSQL]
create table null_segment_analysis
as 
select drupal_user_id, gcsi_user_id, current_subscription subscription_id,
case when vt.user_id is not null then 1 else 0  video_tmp,
case when suh.uid is not null then 1 else 0 suh,
case when fc.uid is not null then 1 else 0 guide,
case when pl.num_videos > 5 then 1 else 0 end playlist
from common.user_dim ud
left join common.video_tmp vt
    on ud.drupal_user_id = vt.user_id
left join 
			(select uid from drupal.smfplayer_user_history
       UNION
       select client_uid from drupal.smfplayer_user_history) suh
   on ud.drupal_user_ suh.uid
left join drupal.flag_content fc
       on ud.drupal_user_id = fc.uid and
          fc.fid = 11
left join 
     (select drupal_user_id, count(1) num_videos
      from common.playlist_activity
      group by drupal_user_id) pl 
     on ud.drupal_user_id = pl.drupal_user_id
where user_end_date is null 
  and user_behavior_segment is NULL




[2016-02-23 16:34:56.299] [018658] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "video_tmp"
LINE 4: case when vt.user_id is not null then 1 else 0  video_tmp,
                                                        ^


[2016-02-23 16:34:56.321] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:35:47.077] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:35:47.202] [018658] [dwh-prod] [PGSQL]
create table null_segment_analysis
as 
select drupal_user_id, gcsi_user_id, current_subscription subscription_id,
case when vt.user_id is not null then 1 else 0 end  video_tmp,
case when suh.uid is not null then 1 else 0 end suh,
case when fc.uid is not null then 1 else 0 end guide,
case when pl.num_videos > 5 then 1 else 0 end playlist
from common.user_dim ud
left join common.video_tmp vt
    on ud.drupal_user_id = vt.user_id
left join 
			(select uid from drupal.smfplayer_user_history
       UNION
       select client_uid from drupal.smfplayer_user_history) suh
   on ud.drupal_user_ suh.uid
left join drupal.flag_content fc
       on ud.drupal_user_id = fc.uid and
          fc.fid = 11
left join 
     (select drupal_user_id, count(1) num_videos
      from common.playlist_activity
      group by drupal_user_id) pl 
     on ud.drupal_user_id = pl.drupal_user_id
where user_end_date is null 
  and user_behavior_segment is NULL




[2016-02-23 16:35:47.284] [018658] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "suh"
LINE 15:    on ud.drupal_user_ suh.uid
                               ^


[2016-02-23 16:35:47.306] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:36:02.453] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:36:02.574] [018658] [dwh-prod] [PGSQL]
create table null_segment_analysis
as 
select drupal_user_id, gcsi_user_id, current_subscription subscription_id,
case when vt.user_id is not null then 1 else 0 end  video_tmp,
case when suh.uid is not null then 1 else 0 end suh,
case when fc.uid is not null then 1 else 0 end guide,
case when pl.num_videos > 5 then 1 else 0 end playlist
from common.user_dim ud
left join common.video_tmp vt
    on ud.drupal_user_id = vt.user_id
left join 
			(select uid from drupal.smfplayer_user_history
       UNION
       select client_uid from drupal.smfplayer_user_history) suh
   on ud.drupal_user = suh.uid
left join drupal.flag_content fc
       on ud.drupal_user_id = fc.uid and
          fc.fid = 11
left join 
     (select drupal_user_id, count(1) num_videos
      from common.playlist_activity
      group by drupal_user_id) pl 
     on ud.drupal_user_id = pl.drupal_user_id
where user_end_date is null 
  and user_behavior_segment is NULL


[2016-02-23 16:36:02.655] [018658] [dwh-prod] [PGSQL]
ERROR:  column ud.drupal_user does not exist
LINE 15:    on ud.drupal_user = suh.uid
               ^


[2016-02-23 16:36:02.677] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:36:17.541] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:36:17.665] [018658] [dwh-prod] [PGSQL]
create table null_segment_analysis
as 
select drupal_user_id, gcsi_user_id, current_subscription subscription_id,
case when vt.user_id is not null then 1 else 0 end  video_tmp,
case when suh.uid is not null then 1 else 0 end suh,
case when fc.uid is not null then 1 else 0 end guide,
case when pl.num_videos > 5 then 1 else 0 end playlist
from common.user_dim ud
left join common.video_tmp vt
    on ud.drupal_user_id = vt.user_id
left join 
			(select uid from drupal.smfplayer_user_history
       UNION
       select client_uid from drupal.smfplayer_user_history) suh
   on ud.drupal_user_id = suh.uid
left join drupal.flag_content fc
       on ud.drupal_user_id = fc.uid and
          fc.fid = 11
left join 
     (select drupal_user_id, count(1) num_videos
      from common.playlist_activity
      group by drupal_user_id) pl 
     on ud.drupal_user_id = pl.drupal_user_id
where user_end_date is null 
  and user_behavior_segment is NULL




[2016-02-23 16:36:17.748] [018658] [dwh-prod] [PGSQL]
ERROR:  column reference "drupal_user_id" is ambiguous
LINE 3: select drupal_user_id, gcsi_user_id, current_subscription su...
               ^


[2016-02-23 16:36:17.766] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:36:30.575] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:36:30.703] [018658] [dwh-prod] [PGSQL]
create table null_segment_analysis
as 
select ud.drupal_user_id, gcsi_user_id, current_subscription subscription_id,
case when vt.user_id is not null then 1 else 0 end  video_tmp,
case when suh.uid is not null then 1 else 0 end suh,
case when fc.uid is not null then 1 else 0 end guide,
case when pl.num_videos > 5 then 1 else 0 end playlist
from common.user_dim ud
left join common.video_tmp vt
    on ud.drupal_user_id = vt.user_id
left join 
			(select uid from drupal.smfplayer_user_history
       UNION
       select client_uid from drupal.smfplayer_user_history) suh
   on ud.drupal_user_id = suh.uid
left join drupal.flag_content fc
       on ud.drupal_user_id = fc.uid and
          fc.fid = 11
left join 
     (select drupal_user_id, count(1) num_videos
      from common.playlist_activity
      group by drupal_user_id) pl 
     on ud.drupal_user_id = pl.drupal_user_id
where user_end_date is null 
  and user_behavior_segment is NULL




[2016-02-23 16:38:20.520] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:39:05.329] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:39:05.448] [018658] [dwh-prod] [PGSQL]
select segment_name, count(1) from common.user_behavior_segmentation
 group by segment_name;

select user_behavior_segment, count(1)
from common.user_dim
where user_end_date is null
group by user_behavior_segment;


create table null_segment_analysis
as 
select ud.drupal_user_id, gcsi_user_id, current_subscription subscription_id,
case when vt.user_id is not null then 1 else 0 end  video_tmp,
case when suh.uid is not null then 1 else 0 end suh,
case when fc.uid is not null then 1 else 0 end guide,
case when pl.num_videos > 5 then 1 else 0 end playlist
from common.user_dim ud
left join common.video_tmp vt
    on ud.drupal_user_id = vt.user_id
left join 
			(select uid from drupal.smfplayer_user_history
       UNION
       select client_uid from drupal.smfplayer_user_history) suh
   on ud.drupal_user_id = suh.uid
left join (select distinct uid
           from drupal.flag_content) fc
       on ud.drupal_user_id = fc.uid and
          fc.fid = 11
left join 
     (select drupal_user_id, count(1) num_videos
      from common.playlist_activity
      group by drupal_user_id) pl 
     on ud.drupal_user_id = pl.drupal_user_id
where user_end_date is null 
  and user_behavior_segment is NULL




[2016-02-23 16:39:06.045] [018658] [dwh-prod] [PGSQL]
ERROR:  column fc.fid does not exist
LINE 28:           fc.fid = 11
                   ^


[2016-02-23 16:39:06.067] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:39:06.438] [018658] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4507397

[2016-02-23 16:39:14.331] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:39:14.455] [018658] [dwh-prod] [PGSQL]
create table null_segment_analysis
as 
select ud.drupal_user_id, gcsi_user_id, current_subscription subscription_id,
case when vt.user_id is not null then 1 else 0 end  video_tmp,
case when suh.uid is not null then 1 else 0 end suh,
case when fc.uid is not null then 1 else 0 end guide,
case when pl.num_videos > 5 then 1 else 0 end playlist
from common.user_dim ud
left join common.video_tmp vt
    on ud.drupal_user_id = vt.user_id
left join 
			(select uid from drupal.smfplayer_user_history
       UNION
       select client_uid from drupal.smfplayer_user_history) suh
   on ud.drupal_user_id = suh.uid
left join (select distinct uid
           from drupal.flag_content) fc
       on ud.drupal_user_id = fc.uid and
          fc.fid = 11
left join 
     (select drupal_user_id, count(1) num_videos
      from common.playlist_activity
      group by drupal_user_id) pl 
     on ud.drupal_user_id = pl.drupal_user_id
where user_end_date is null 
  and user_behavior_segment is NULL


[2016-02-23 16:39:14.536] [018658] [dwh-prod] [PGSQL]
ERROR:  column fc.fid does not exist
LINE 19:           fc.fid = 11
                   ^


[2016-02-23 16:39:14.563] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:39:48.884] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:39:49.018] [018658] [dwh-prod] [PGSQL]
create table null_segment_analysis
as 
select ud.drupal_user_id, gcsi_user_id, current_subscription subscription_id,
case when vt.user_id is not null then 1 else 0 end  video_tmp,
case when suh.uid is not null then 1 else 0 end suh,
case when fc.uid is not null then 1 else 0 end guide,
case when pl.num_videos > 5 then 1 else 0 end playlist
from common.user_dim ud
left join common.video_tmp vt
    on ud.drupal_user_id = vt.user_id
left join 
			(select uid from drupal.smfplayer_user_history
       UNION
       select client_uid from drupal.smfplayer_user_history) suh
   on ud.drupal_user_id = suh.uid
left join (select distinct uid
           from drupal.flag_content
           where fid = 11) fc
       on ud.drupal_user_id = fc.uid
left join 
     (select drupal_user_id, count(1) num_videos
      from common.playlist_activity
      group by drupal_user_id) pl 
     on ud.drupal_user_id = pl.drupal_user_id
where user_end_date is null 
  and user_behavior_segment is NULL


[2016-02-23 16:39:49.115] [018658] [dwh-prod] [PGSQL]
ERROR:  relation "null_segment_analysis" already exists


[2016-02-23 16:39:49.135] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:40:10.071] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:40:10.207] [018658] [dwh-prod] [PGSQL]
drop table if exists null_segment_analysis;

create table null_segment_analysis
as 
select ud.drupal_user_id, gcsi_user_id, current_subscription subscription_id,
case when vt.user_id is not null then 1 else 0 end  video_tmp,
case when suh.uid is not null then 1 else 0 end suh,
case when fc.uid is not null then 1 else 0 end guide,
case when pl.num_videos > 5 then 1 else 0 end playlist
from common.user_dim ud
left join common.video_tmp vt
    on ud.drupal_user_id = vt.user_id
left join 
			(select uid from drupal.smfplayer_user_history
       UNION
       select client_uid from drupal.smfplayer_user_history) suh
   on ud.drupal_user_id = suh.uid
left join (select distinct uid
           from drupal.flag_content
           where fid = 11) fc
       on ud.drupal_user_id = fc.uid
left join 
     (select drupal_user_id, count(1) num_videos
      from common.playlist_activity
      group by drupal_user_id) pl 
     on ud.drupal_user_id = pl.drupal_user_id
where user_end_date is null 
  and user_behavior_segment is NULL




[2016-02-23 16:41:47.575] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:43:54.747] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:43:54.889] [018658] [dwh-prod] [PGSQL]
select segment_name, count(1) from common.user_behavior_segmentation
 group by segment_name;

select user_behavior_segment, count(1)
from common.user_dim
where user_end_date is null
group by user_behavior_segment;

drop table if exists null_segment_analysis;

create table null_segment_analysis
as 
select ud.drupal_user_id, gcsi_user_id, current_subscription subscription_id,
case when vt.user_id is not null then 1 else 0 end  video_tmp,
case when suh.uid is not null then 1 else 0 end suh,
case when fc.uid is not null then 1 else 0 end guide,
case when pl.num_videos > 5 then 1 else 0 end playlist
from common.user_dim ud
left join (select distinct user_id
           from common.video_tmp) vt
    on ud.drupal_user_id = vt.user_id
left join 
			(select uid from drupal.smfplayer_user_history
       UNION
       select client_uid from drupal.smfplayer_user_history) suh
   on ud.drupal_user_id = suh.uid
left join (select distinct uid
           from drupal.flag_content
           where fid = 11) fc
       on ud.drupal_user_id = fc.uid
left join 
     (select drupal_user_id, count(1) num_videos
      from common.playlist_activity
      group by drupal_user_id) pl 
     on ud.drupal_user_id = pl.drupal_user_id
where user_end_date is null 
  and user_behavior_segment is NULL




[2016-02-23 16:45:57.256] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:45:57.658] [018658] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4507397

[2016-02-23 16:45:58.096] [018658] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6271087

[2016-02-23 16:47:02.306] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:47:02.413] [018658] [dwh-prod] [PGSQL]
select video_tmp, suh, guide, playlist, count(1)
from null_segment_analysis;


[2016-02-23 16:47:02.495] [018658] [dwh-prod] [PGSQL]
ERROR:  column "null_segment_analysis.video_tmp" must appear in the GROUP BY clause or be used in an aggregate function
LINE 1: select video_tmp, suh, guide, playlist, count(1)
               ^


[2016-02-23 16:47:02.506] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:47:21.119] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:47:21.227] [018658] [dwh-prod] [PGSQL]
select video_tmp, suh, guide, playlist, count(1)
from null_segment_analysis
group by video_tmp, suh, guide, playlist;


[2016-02-23 16:47:21.324] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:47:21.658] [018658] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6271641

[2016-02-23 16:54:05.884] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:54:05.988] [018658] [dwh-prod] [PGSQL]
select video_tmp, suh, --guide, playlist, 
count(1)
from null_segment_analysis
group by video_tmp, suh--, guide, playlist;


[2016-02-23 16:54:06.083] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:54:06.520] [018658] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6271641

[2016-02-23 16:55:57.315] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:55:57.421] [018658] [dwh-prod] [PGSQL]
select video_tmp, suh, guide, --playlist, 
count(1)
from null_segment_analysis
group by video_tmp, suh, guide--, playlist;


[2016-02-23 16:55:57.514] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 16:55:57.934] [018658] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6271641

[2016-02-23 17:13:38.638] [018658] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 17:13:38.748] [018658] [dwh-prod] [PGSQL]
select video_tmp, suh, guide, playlist, 
count(1)
from null_segment_analysis
group by video_tmp, suh, guide, playlist;


[2016-02-23 17:13:38.854] [018658] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 17:13:39.180] [018658] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6271641

[2016-02-23 17:21:42.116] [017844] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 17:21:42.117] [017844] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-23 17:21:42.705] [021721] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-23 17:21:42.784] [021721] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 17:21:42.891] [021721] [dwh-prod] [PGSQL]
select style, sum(total_watched/3600) hrs_watched
from avg_yoga_completion ayc
join yoga_styles ys on ayc.page_nid = us.page_nid
group by style
order by style;


[2016-02-23 17:21:42.973] [021721] [dwh-prod] [PGSQL]
ERROR:  missing FROM-clause entry for table "us"
LINE 3: join yoga_styles ys on ayc.page_nid = us.page_nid
                                              ^


[2016-02-23 17:21:42.991] [021721] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 17:21:52.571] [021721] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 17:21:52.675] [021721] [dwh-prod] [PGSQL]
select style, sum(total_watched/3600) hrs_watched
from avg_yoga_completion ayc
join yoga_styles ys on ayc.page_nid = ys.page_nid
group by style
order by style;


[2016-02-23 17:21:52.773] [021721] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-23 17:21:53.128] [021721] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6271606

[2016-02-24 10:28:56.090] [030484] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" LIMIT 1000 OFFSET 0

[2016-02-24 10:28:56.093] [030484] [dwh-dev] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-24 10:28:56.717] [013055] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 10:28:56.798] [013055] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" LIMIT 1000 OFFSET 0

[2016-02-24 10:28:57.702] [013055] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-24 10:28:57.849] [013055] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12337401

[2016-02-24 10:29:36.848] [006167] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 10:29:36.930] [006167] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-24 10:29:37.231] [006166] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 10:29:37.312] [006166] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-24 10:29:37.412] [006166] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 10:29:37.499] [006166] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-24 10:29:37.583] [006166] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 10:29:38.778] [006166] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 10:29:38.859] [006166] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 10:29:38.946] [006166] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-24 10:29:39.031] [006166] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 10:29:39.123] [006166] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-24 10:29:39.206] [006166] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 10:29:40.137] [006166] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 10:29:40.218] [006166] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 10:29:40.302] [006166] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-24 10:29:40.386] [006166] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-24 10:30:05.611] [006167] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:30:05.732] [006167] [dwh-prod] [PGSQL]
select * from video_daily_cube
where nid = 8485;


[2016-02-24 10:30:05.814] [006167] [dwh-prod] [PGSQL]
ERROR:  column "nid" does not exist
LINE 2: where nid = 8485;
              ^


[2016-02-24 10:30:05.825] [006167] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:30:25.438] [006167] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:30:25.538] [006167] [dwh-prod] [PGSQL]
select * from video_daily_cube limit 1
--where nid = 8485;


[2016-02-24 10:30:25.631] [006167] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:30:26.016] [006167] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6290834

[2016-02-24 10:30:43.371] [006167] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:30:43.533] [006167] [dwh-prod] [PGSQL]
select * from video_daily_cube
where media_nid = 8485;


[2016-02-24 10:31:29.359] [006167] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:31:29.736] [006167] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6290834

[2016-02-24 10:33:21.487] [013055] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "page_nid" = '103931' LIMIT 1000 OFFSET 0

[2016-02-24 10:33:21.641] [013055] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-24 10:33:21.743] [013055] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12337401

[2016-02-24 10:33:41.147] [006167] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:33:41.263] [006167] [dwh-prod] [PGSQL]
select * from video_daily_cube
where media_nid = 132491;


[2016-02-24 10:33:42.841] [006167] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:33:43.201] [006167] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6290834

[2016-02-24 10:33:55.884] [006167] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:33:55.988] [006167] [dwh-prod] [PGSQL]
select * from video_daily_cube
where media_nid = 104251;


[2016-02-24 10:33:57.814] [006167] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:33:58.196] [006167] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6290834

[2016-02-24 10:35:41.574] [010395] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 10:35:41.656] [010395] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'drupal') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 10:35:41.971] [010395] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='drupal' ORDER BY schemaname, viewname

[2016-02-24 10:35:42.086] [010395] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 10:35:43.050] [010395] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 10:35:43.137] [010395] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'drupal' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 10:35:43.227] [010395] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'drupal' 

[2016-02-24 10:35:55.689] [006167] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:35:55.793] [006167] [dwh-prod] [PGSQL]
select * from drupal.smfplayer_user_history
where nid = 104251;


[2016-02-24 10:35:59.865] [006167] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:36:00.244] [006167] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4276053

[2016-02-24 10:36:00.328] [006167] [dwh-prod] [PGSQL]
SELECT nsp.nspname, cl.relname, array_upper(conkey,1) as pkeycount FROM pg_class cl LEFT JOIN pg_namespace nsp ON nsp.oid = cl.relnamespace LEFT JOIN pg_constraint con ON con.conrelid = cl.oid WHERE con.contype = 'p' AND cl.oid = 4276053

[2016-02-24 10:36:00.421] [006167] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = '' AND cl.table_schema = 'drupal' AND cl.table_name = 'smfplayer_user_history'

[2016-02-24 10:37:51.591] [011155] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 10:37:51.676] [011155] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 10:37:51.782] [011155] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-24 10:37:51.867] [011155] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 10:37:52.858] [011155] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 10:37:52.955] [011155] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 10:37:53.044] [011155] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-24 10:37:57.496] [006167] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:37:57.602] [006167] [dwh-prod] [PGSQL]
select * from common.video_tmp
where nid = 104251;


[2016-02-24 10:37:58.476] [006167] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:37:58.852] [006167] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4609563

[2016-02-24 10:38:41.785] [011384] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 10:38:41.866] [011384] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_tmp' ORDER BY ordinal_position

[2016-02-24 10:38:48.357] [006167] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:38:48.487] [006167] [dwh-prod] [PGSQL]
select watched from common.video_tmp
where nid = 104251;


[2016-02-24 10:38:48.681] [006167] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:38:49.064] [006167] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4609563

[2016-02-24 10:41:36.321] [012307] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 10:41:36.404] [012307] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-24 10:41:36.723] [012306] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 10:41:36.804] [012306] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-24 10:41:36.905] [012306] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 10:41:36.991] [012306] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-24 10:41:37.074] [012306] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 10:41:38.114] [012306] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 10:41:38.209] [012306] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 10:41:38.296] [012306] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-24 10:41:38.379] [012306] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 10:41:38.468] [012306] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-24 10:41:38.554] [012306] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 10:41:39.372] [012306] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 10:41:39.456] [012306] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 10:41:39.560] [012306] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-24 10:41:39.660] [012306] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-24 10:42:00.379] [012443] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 10:42:00.482] [012443] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 10:42:00.591] [012443] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-24 10:42:00.692] [012443] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 10:42:01.931] [012443] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 10:42:02.015] [012443] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 10:42:02.108] [012443] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-24 10:42:27.211] [006167] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:42:27.314] [006167] [dwh-prod] [PGSQL]
select * from video_daily_cube
where media_nid = 104251;


[2016-02-24 10:42:28.890] [006167] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:42:29.313] [006167] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6290834

[2016-02-24 10:42:40.434] [012615] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 10:42:40.518] [012615] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_daily_cube' ORDER BY ordinal_position

[2016-02-24 10:42:41.298] [012623] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 10:42:41.385] [012623] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_d' ORDER BY ordinal_position

[2016-02-24 10:42:42.143] [012624] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 10:42:42.248] [012624] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'drupal') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 10:42:42.605] [012624] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='drupal' ORDER BY schemaname, viewname

[2016-02-24 10:42:42.693] [012624] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 10:42:43.694] [012624] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 10:42:43.775] [012624] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'drupal' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 10:42:43.863] [012624] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'drupal' 

[2016-02-24 10:42:44.608] [012638] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 10:42:44.690] [012638] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='drupal' AND table_name='node' ORDER BY ordinal_position

[2016-02-24 10:49:10.813] [014663] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 10:49:10.899] [014663] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_daily_cube' ORDER BY ordinal_position

[2016-02-24 10:50:21.101] [006167] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:50:21.223] [006167] [dwh-prod] [PGSQL]
with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category  =  'Yoga'
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
       sum(num_views) total_views, 
       sum(watched) total_watched
from common.video_daily_cube vt 
join  v on vt.nid = v.media_nid
where  vt.created_date > '20150101'::date
group by v.title, v.video_age,v.page_nid, v.duration);


[2016-02-24 10:50:21.311] [006167] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near ")"
LINE 21: group by v.title, v.video_age,v.page_nid, v.duration);
                                                             ^


[2016-02-24 10:50:21.332] [006167] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:50:30.513] [006167] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:50:30.639] [006167] [dwh-prod] [PGSQL]
with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category  =  'Yoga'
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
       sum(num_views) total_views, 
       sum(watched) total_watched
from common.video_daily_cube vt 
join  v on vt.nid = v.media_nid
where  vt.created_date > '20150101'::date
group by v.title, v.video_age,v.page_nid, v.duration;


[2016-02-24 10:50:30.730] [006167] [dwh-prod] [PGSQL]
ERROR:  column vt.nid does not exist
LINE 19: join  v on vt.nid = v.media_nid
                    ^


[2016-02-24 10:50:30.749] [006167] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:50:44.913] [006167] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:50:45.039] [006167] [dwh-prod] [PGSQL]
with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category  =  'Yoga'
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
       sum(num_views) total_views, 
       sum(watched) total_watched
from common.video_daily_cube vt 
join  v on vt.media_nid = v.media_nid
where  vt.created_date > '20150101'::date
group by v.title, v.video_age,v.page_nid, v.duration;


[2016-02-24 10:50:54.210] [006167] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:50:54.584] [006167] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6290809

[2016-02-24 10:52:36.491] [013055] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "page_nid" = '82781' LIMIT 1000 OFFSET 0

[2016-02-24 10:52:36.600] [013055] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-24 10:52:36.710] [013055] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12337401

[2016-02-24 10:58:47.256] [006167] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:58:47.377] [006167] [dwh-prod] [PGSQL]
with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     where admin_category  =  'Fitness'
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
       sum(num_views) total_views, 
       sum(watched) total_watched
from common.video_daily_cube vt 
join  v on vt.media_nid = v.media_nid
where  vt.created_date > '20150101'::date
group by v.title, v.video_age,v.page_nid, v.duration;


[2016-02-24 10:58:52.676] [006167] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 10:58:53.056] [006167] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6290809

[2016-02-24 11:00:52.184] [013055] [dwh-dev] [PGSQL]
SELECT * FROM "common"."video_d" WHERE "page_nid" = '2357' LIMIT 1000 OFFSET 0

[2016-02-24 11:00:52.292] [013055] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'video_d'

[2016-02-24 11:00:52.402] [013055] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12337401

[2016-02-24 11:59:29.358] [003858] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 11:59:29.439] [003858] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-24 11:59:29.834] [003857] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 11:59:29.916] [003857] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-24 11:59:30.013] [003857] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 11:59:30.101] [003857] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-24 11:59:30.197] [003857] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 11:59:31.111] [003857] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 11:59:31.191] [003857] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 11:59:31.278] [003857] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-24 11:59:31.360] [003857] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 11:59:31.448] [003857] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-24 11:59:31.529] [003857] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 11:59:32.206] [003857] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 11:59:32.286] [003857] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 11:59:32.370] [003857] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-24 11:59:32.455] [003857] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-24 11:59:32.646] [003858] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 11:59:32.780] [003858] [dwh-prod] [PGSQL]


drop table if exists tmp.users_nyny;

create table tmp.users_nyny as 
select  ud.drupal_user_id,
    ud.gcsi_user_id,   
    sd.subscription_id,
    sd.start_date,
    sd.paid_through_date,
    sd.cancel_date,
    sd.end_date,
    sd.status,
    pd.gcsi_plan_id,
    pd.plan_period,
    ud.onboarding_parent AS onboarding_segment,
    ud.user_behavior_segment,
    current_date - ud.last_video_view_date::date days_since_last_video_view,
    current_date - ud.last_login::date days_since_last_login
from common.user_dim ud
join common.subscription_d sd 
  on ud.current_subscription = sd.subscription_id
join common.plan_d pd
  on sd.dwh_plan_id = pd.dwh_plan_id
where sd.start_date >= '2015-12-26'::date;

drop table if exists tmp.nyny_cohorts;

create table tmp.nyny_cohorts as
select un.gcsi_user_id, un.subscription_id,
   case 
   when un.user_behavior_segment = 'My Yoga'
        then coalesce(c.cohort_name, 'Other: MY')
   when un.user_behavior_segment = 'Spiritual Growth'
        then coalesce(c.cohort_name, 'Other: SG')
   when un.user_behavior_segment = 'Seeking Truth'
        then coalesce(c.cohort_name, 'Other: ST')
   else c.cohort_name
   end cohort_name
from tmp.users_nyny un
left join
    (select gcsi_user_id, subscription_id, cohort_name
    from
      (select 
           gcsi_user_id, 
           subscription_id, 
           cohort_name,
           row_number() over w as rn
       from common.cohort_d
       where cohort_name <> 'Commit to You'
       window w as (
         partition by gcsi_user_id, subscription_id
         order by rule_id
       rows between unbounded preceding
       and unbounded following)) foo
    where rn = 1 ) c
  on un.subscription_id = c.subscription_id;

drop table if exists tmp.nyny_video;

create table tmp.nyny_video as
(select drupal_user_id,
        vdc.media_nid,
				vdc.extra_nid,
        vdc.created_date, 
        vdc.player_name,
        coalesce(vdc.watched,0) watched,
        coalesce(vdc.num_views,0) num_views,
        vdc.engagement_ratio completion_ratio,
           case when engagement_ratio >= .25 then 1 else 0 end engaged_view,
    v.title,
    v.series_title,
    v.episode,
    v.duration, 
    v.reporting_segment,
    case when gd.media_nid is not null
         then 1 
         else 0
    end guide_day_video,
    gd.guide_title,
    gd.guide_day,
    case when gdv.field_guide_day_videos_nid is NULL
         then 0
         else 1
    end bonus_video 
from tmp.users_nyny un
left join common.video_daily_cube vdc
   on un.drupal_user_id = vdc.user_id and 
      vdc.created_date > '2015-12-26'::date
left join common.video_d v on vdc.media_nid = v.media_nid
left join common.guide_d gd on vdc.media_nid = gd.media_nid
left join 
      (select distinct field_guide_day_videos_nid
       from drupal.content_field_guide_day_videos) gdv 
    on v.page_nid = gdv.field_guide_day_videos_nid);

drop table if exists tmp.nyny_video_cube;

create table tmp.nyny_video_cube as 
select
    drupal_user_id,
    engaged_view,  
    coalesce(vxc.num_views,0)                       num_views,
    coalesce(vxc.num_days_watched,0)                num_days_watched,
    coalesce(vxc.hrs_watched,0)                     hrs_watched,
    coalesce(vxc.engagement_ratio,0)                engagement_ratio,
    coalesce(vxc.yoga_engagement_ratio,0)           yoga_engagement_ratio,
    coalesce(vxc.sg_engagement_ratio,0)             sg_engagement_ratio,
    coalesce(vxc.st_engagement_ratio,0)             st_engagement_ratio,
    coalesce(vxc.yoga_views,0)                      yoga_views,
    coalesce(vxc.yoga_watched,0)                    yoga_watched,
    coalesce(vxc.sg_views,0)                        sg_views,
    coalesce(vxc.sg_watched,0)                      sg_watched,
    coalesce(vxc.st_views,0)                        st_views,
    coalesce(vxc.st_watched,0)                      st_watched,
    coalesce(vxc.guide_day_views,0)                 guide_day_views,
    coalesce(vxc.bonus_video_views,0)               bonus_video_views
from
    (select drupal_user_id,
       engaged_view,
       sum(num_views)               num_views, 
       count(distinct created_date) num_days_watched, 
       round(sum(watched)/3600,5)   hrs_watched,
       case when sum(duration) > 0
            then round(sum(watched)/sum(duration),5)                  
            else 0
       end                                                  engagement_ratio,
       case when sum(yoga_video_duration) > 0
            then round(sum(yoga_watched)/sum(yoga_video_duration),5)
            else 0
       end                                                  yoga_engagement_ratio,
       case when sum(sg_video_duration) > 0
            then round(sum(sg_watched)/sum(sg_video_duration),5)
            else 0
       end                                                  sg_engagement_ratio,
          case when sum(st_video_duration) > 0
            then round(sum(st_watched)/sum(st_video_duration),5)
            else 0
       end                                                  st_engagement_ratio,
       sum(yoga_views)                                      yoga_views,
       sum(yoga_watched)                                    yoga_watched,
       sum(sg_views)                                        sg_views,
       sum(sg_watched)                                      sg_watched,
       sum(st_views)                                        st_views,
       sum(st_watched)                                      st_watched,
       sum(guide_day_views)                                 guide_day_views,
       sum(bonus_video)                                     bonus_video_views
    from
        (select un. drupal_user_id,
           nv.created_date,
           nv.num_views, 
           nv.watched, 
           nv.completion_ratio,
           case when completion_ratio >= .25 then 1 else 0 end engaged_view,
           nv.duration,
           nv.guide_day_video guide_day_views,
           nv.bonus_video,
           case when reporting_segment = 'My Yoga' then num_views else 0 end            yoga_views,
           case when reporting_segment = 'My Yoga' then watched else 0 end              yoga_watched,
           case when reporting_segment = 'My Yoga' then duration else 0 end             yoga_video_duration,
           case when reporting_segment = 'Spiritual Growth' then num_views else 0 end   sg_views,
           case when reporting_segment = 'Spiritual Growth' then watched else 0 end     sg_watched,
           case when reporting_segment = 'Spiritual Growth' then duration else 0 end    sg_video_duration,
           case when reporting_segment = 'Seeking Truth' then num_views else 0 end      st_views,
           case when reporting_segment = 'Seeking Truth' then watched else 0 end        st_watched,
           case when reporting_segment = 'Seeking Truth' then duration else 0 end       st_video_duration    
        from tmp.users_nyny un
        left join tmp.nyny_video nv  
           on un.drupal_user_id = nv.drupal_user_id ) v   
    group by drupal_user_id, engaged_view) vxc;

insert into  tmp.nyny_video_cube (drupal_user_id, engaged_view, num_views)
(select drupal_user_id, 1, 0
 from tmp.users_nyny
 except select drupal_user_id,engaged_view,0
from  tmp.nyny_video_cube);




drop table if exists tmp.ho_video;
--specifically for Hidden Origins
-- has a different start date
create table tmp.ho_video as
(select vdc.*,
    v.title,
    v.series_title,
    v.episode,
    v.reporting_segment,
    v.duration, 
    -- right now designed to be used only by Hidden Origins
    case when v.series_title = 'Disclosure'
              then v.series_title || ' ' || season
         when v.series_title in ('Disclosure', 'Wisdom Teachings','Beyond Belief','Open Minds','Healing Matrix',
                   'Arcanum','Secrets to Health','Spirit Talk' ,'On the Road With Lilou' ,
                   'Eleventh House','Mind Shift','Inspirations', 'Cosmic Disclosure', 'Hidden Origins')
             then v.series_title
         when v.site_segment in('My Yoga', 'Spiritual Growth', 'Film & Series') then v.site_segment
         when series_title is null then 'Standalone'
         else 'Other ST Series'
    end series_of_interest
from common.video_daily_cube vdc
join common.video_d v on vdc.media_nid = v.media_nid
where vdc.created_date > '2016-01-11'::date);

/*   re-work this for HO
drop table if exists user_series_smry;

-- this is really user behavior summary
create table user_series_smry as 
(select user_id, 
    count(distinct series) num_series,
    count(distinct cd_episodes) num_cd_episodes,
    sum(cd_hours) cd_hours,
    sum(watched) all_hours
from
    (select user_id,
        case when series_of_interest <> 'Other'  and 
                  series_of_interest <> 'Films & Series' and 
                  series_of_interest <> 'Standalone' and 
                  series_of_interest <> 'Cosmic Disclosure'
                         then series_of_interest 
        end series,
        case when series_title = 'Cosmic Disclosure' then watched else 0 end cd_hours,
        case when series_title = 'Cosmic Disclosure' then episode  end cd_episodes,
        watched
    from cd_video
    where user_id in (select drupal_user_id from users_cd_tmp)) v
group by user_id);
*/


drop table if exists tmp.all_ny_subscriptions;

create table tmp.all_ny_subscriptions as 
select day_timestamp, cohort_name, 
        'All Subscriptions'::text description,
        running_total sub_count
from
(select day_timestamp, cohort_name, count(1)running_total
 from common.daily_status_snapshot dss
 join tmp.nyny_cohorts c
   on dss.subscription_id = c.subscription_id
group by day_timestamp, cohort_name)foo;


drop table if exists tmp.current_ny_subscriptions;

create table tmp.current_ny_subscriptions as 
(select day_timestamp, cohort_name,
        'Current Active Subscriptions'::text description,
        count(1)
 from common.daily_status_snapshot dss
 join tmp.nyny_cohorts c
   on dss.subscription_id = c.subscription_id
 where dss.status in ('Active',  'Hold')
group by day_timestamp, cohort_name);

/*

custom query

select * from tmp.all_cd_subscriptions
union
select * from tmp.current_cd_subscriptions
order by description, day_timestamp
*/


/*
select * from tmp.nyny_video
where user_id  in 
(select drupal_user_id from tmp.users_nyny
where gcsi_user_id in (select gcsi_user_id from tmp.nyny_cohorts where cohort_name is null));


select series_of_interest, created_date, sum(round(watched/3600,3)) hours_watched
from 
   (select 
      case when series_title in ('Wisdom Teachings' ,'Disclosure','Beyond Belief','Open Minds', 'Cosmic Disclosure','Hidden Origins')
           then series_title
           else 'Other Series'
      end series_of_interest,
      created_date::date created_date,
      watched
    from tmp.nyny_video ny
    join tmp.users_nyny nu 
        on ny.user_id = nu .drupal_user_id 
    join tmp.nyny_cohorts NC 
       on nu .gcsi_user_id = nc .gcsi_user_id and 
          cohort_name in ('Seeking Truth Marathon', 'Cosmic Disclosure',
                          'Hidden Origins', 'Other: ST')) foo
group by series_of_interest, created_date;
*/

select user_behavior_segment, cohort_name, count(1)
from tmp.users_nyny un 
join tmp.nyny_cohorts nc 
  on un.subscription_id = nc.subscription_id
group by user_behavior_segment, cohort_name
order by user_behavior_segment, cohort_name;


select user_behavior_segment, count(1)
from tmp.users_nyny un 
group by user_behavior_segment;


select gcsi_user_id from tmp.users_nyny where drupal_user_id in 
(select drupal_user_id from tmp.users_nyny
except 
select user_id from common.video_tmp
where created > 1451081188);

select count(distinct drupal_user_id) from tmp.nyny_video;

select cohort_name, status, count(1)
from tmp.nyny_cohorts ud
join subscription_d sd
  on ud.subscription_id = sd.subscription_id
group by cohort_name, status;


[2016-02-24 12:00:00.304] [003858] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 12:00:01.305] [003858] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6291011

[2016-02-24 12:00:01.761] [003858] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6291011

[2016-02-24 13:07:42.846] [006167] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 13:07:42.847] [006167] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-24 13:07:43.489] [025988] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 13:07:43.585] [025988] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 13:07:43.695] [025988] [dwh-prod] [PGSQL]
select '20160223'::date - '20151226'::date


[2016-02-24 13:07:43.795] [025988] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 15:35:09.601] [006895] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 15:35:09.688] [006895] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 15:35:09.805] [006895] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-24 15:35:09.925] [006895] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 15:35:10.502] [006895] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 15:35:10.586] [006895] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 15:35:10.697] [006895] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-24 15:35:26.569] [006976] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 15:35:26.649] [006976] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='nyny_video_cube' ORDER BY ordinal_position

[2016-02-24 15:41:10.980] [008751] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 15:41:11.059] [008751] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='users_nyny' ORDER BY ordinal_position

[2016-02-24 15:41:37.239] [008861] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 15:41:37.319] [008861] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='nyny_cohorts' ORDER BY ordinal_position

[2016-02-24 15:42:50.635] [003858] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 15:42:50.636] [003858] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-24 15:42:51.368] [009268] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 15:42:51.470] [009268] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 15:42:51.627] [009268] [dwh-prod] [PGSQL]
select cohort, engaged_view, num_days_watched, count(1)
from tmp.nyny_video_cube vc
right join tmp.users_nyny un 
   on vc.drupal_user_id = vc.drupal_user_id
right join tmp.nyny_cohorts nc 
   on nc.gcsi_user_id = un.gcsi_user_id
group by cohort, engaged_view, num_days_watched;


[2016-02-24 15:42:51.710] [009268] [dwh-prod] [PGSQL]
ERROR:  column "cohort" does not exist
LINE 1: select cohort, engaged_view, num_days_watched, count(1)
               ^


[2016-02-24 15:42:51.736] [009268] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 15:43:31.529] [009268] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 15:43:31.702] [009268] [dwh-prod] [PGSQL]
select cohort_name, engaged_view, num_days_watched, count(1)
from tmp.nyny_video_cube vc
right join tmp.users_nyny un 
   on vc.drupal_user_id = vc.drupal_user_id
right join tmp.nyny_cohorts nc 
   on nc.gcsi_user_id = un.gcsi_user_id
group by cohort_name, engaged_view, num_days_watched;


[2016-02-24 15:47:40.639] [010717] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 15:47:40.722] [010717] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-24 15:47:41.047] [010716] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 15:47:41.127] [010716] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-24 15:47:41.228] [010716] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 15:47:41.316] [010716] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-24 15:47:41.402] [010716] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 15:47:41.963] [010716] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 15:47:42.069] [010716] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 15:47:42.156] [010716] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-24 15:47:42.239] [010716] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 15:47:42.329] [010716] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-24 15:47:42.416] [010716] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 15:47:42.701] [010716] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 15:47:42.781] [010716] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 15:47:42.866] [010716] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-24 15:47:42.959] [010716] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-24 15:47:45.132] [010717] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 15:47:45.261] [010717] [dwh-prod] [PGSQL]
select pid, query from pg_stat_activity
WHERE state = 'active'


[2016-02-24 15:47:45.368] [010717] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 15:47:45.868] [010717] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 11283

[2016-02-24 15:47:54.802] [010717] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 15:47:54.913] [010717] [dwh-prod] [PGSQL]
select pid, query from pg_stat_activity
WHERE state = 'active'



SELECT pg_cancel_backend(9268);


[2016-02-24 15:47:54.993] [010717] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "SELECT"
LINE 6: SELECT pg_cancel_backend(9268);
        ^


[2016-02-24 15:47:55.006] [010717] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 15:48:00.381] [010717] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 15:48:00.499] [010717] [dwh-prod] [PGSQL]
select pid, query from pg_stat_activity
WHERE state = 'active';



SELECT pg_cancel_backend(9268);


[2016-02-24 15:48:00.580] [009268] [dwh-prod] [PGSQL]
ERROR:  canceling statement due to user request


[2016-02-24 15:48:00.595] [010717] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 15:48:00.598] [009268] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 15:48:01.026] [010717] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 11283

[2016-02-24 15:48:19.306] [009268] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 15:48:19.446] [009268] [dwh-prod] [PGSQL]
select cohort_name, engaged_view, num_days_watched, count(1)
from tmp.nyny_video_cube vc
right join tmp.users_nyny un 
   on vc.drupal_user_id = un.drupal_user_id
right join tmp.nyny_cohorts nc 
   on nc.gcsi_user_id = un.gcsi_user_id
group by cohort_name, engaged_view, num_days_watched;


[2016-02-24 15:48:19.753] [009268] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:17:33.797] [006056] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:17:33.876] [006056] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-24 17:17:34.235] [006055] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:17:34.323] [006055] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-24 17:17:34.419] [006055] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 17:17:34.504] [006055] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-24 17:17:34.586] [006055] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 17:17:35.097] [006055] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 17:17:35.176] [006055] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 17:17:35.263] [006055] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-24 17:17:35.344] [006055] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 17:17:35.432] [006055] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-24 17:17:35.518] [006055] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 17:17:35.819] [006055] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 17:17:35.900] [006055] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 17:17:35.984] [006055] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-24 17:17:36.070] [006055] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-24 17:19:13.050] [006551] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:19:13.129] [006551] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 17:19:13.232] [006551] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-24 17:19:13.317] [006551] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 17:19:13.828] [006551] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 17:19:13.908] [006551] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 17:19:13.996] [006551] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-24 17:19:14.667] [006554] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:19:14.747] [006554] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='daily_status_snapshot' ORDER BY ordinal_position

[2016-02-24 17:19:15.413] [006555] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:19:15.493] [006555] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='subscription_d' ORDER BY ordinal_position

[2016-02-24 17:19:16.158] [006569] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:19:16.237] [006569] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='date_d' ORDER BY ordinal_position

[2016-02-24 17:19:47.420] [006761] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:19:47.499] [006761] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='cohort_d' ORDER BY ordinal_position

[2016-02-24 17:21:13.057] [009268] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:21:13.193] [009268] [dwh-prod] [PGSQL]
drop table if exists tmp.nyny_churn_summary;

create table tmp.nyny_churn_summary as 
select  cohort_name, day_timestamp measure_date, customer_days, total_cancels, total_cancels/customer_days::float churn_rate
from 
(select cohort_name, a.day_timestamp, a.total customer_days, coalesce(c.total ,0) total_cancels
from 
(SELECT  dd.day_timestamp,
     cohort_name,
    count(distinct dss.subscription_id) as total
    FROM common.daily_status_snapshot dss
    INNER JOIN common.subscription_d sd ON dss.subscription_id = sd.subscription_id
    inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
    left join common.cohort_d cd 
      on sd.subscription_id = cd.subscription_id
    WHERE dss.paid_through_date >= dd.day_timestamp::date - 1
    AND dss.status NOT IN ('Hold')
    and dd.day_timestamp >= '20151226' 
    and dd.day_timestamp <= current_date::date - 1
  group by  dd.day_timestamp, cohort_name) a
left join
    (SELECT  dd.day_timestamp,
     cohort_name, 
    count(distinct dss.subscription_id) as total
      FROM common.daily_status_snapshot dss
      INNER JOIN common.subscription_d sd ON sd.subscription_id = dss.subscription_id
      inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
    left join common.cohort_d cd 
      on sd.subscription_id = cd.subscription_id
      WHERE
      dss.day_timestamp = dd.day_timestamp
      AND dss.paid_through_date >= dd.day_timestamp::date -1
      AND dss.paid_through_date < dd.day_timestamp::date
      AND dss.paid_through_date >= sd.paid_through_date::date - INTERVAL '15 day'
    group by  dd.day_timestamp, cohort_name
    ) c
on a.day_timestamp = c.day_timestamp)foo;

SELECT 
measure_date,
sum(churn_rate) over(order by measure_date rows 30 PRECEDING) as trailing_30_day_churn_sum
FROM tmp.nyny_churn_summary;


[2016-02-24 17:21:13.289] [009268] [dwh-prod] [PGSQL]
ERROR:  column reference "cohort_name" is ambiguous
LINE 6: (select cohort_name, a.day_timestamp, a.total customer_days,...
                ^


[2016-02-24 17:21:13.313] [009268] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:21:58.536] [009268] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:21:58.662] [009268] [dwh-prod] [PGSQL]
drop table if exists tmp.nyny_churn_summary;

create table tmp.nyny_churn_summary as 
select  cohort_name, day_timestamp measure_date, customer_days, total_cancels, total_cancels/customer_days::float churn_rate
from 
(select a.cohort_name, a.day_timestamp, a.total customer_days, coalesce(c.total ,0) total_cancels
from 
(SELECT  dd.day_timestamp,
     cd.cohort_name,
    count(distinct dss.subscription_id) as total
    FROM common.daily_status_snapshot dss
    INNER JOIN common.subscription_d sd ON dss.subscription_id = sd.subscription_id
    inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
    left join common.cohort_d cd 
      on sd.subscription_id = cd.subscription_id
    WHERE dss.paid_through_date >= dd.day_timestamp::date - 1
    AND dss.status NOT IN ('Hold')
    and dd.day_timestamp >= '20151226' 
    and dd.day_timestamp <= current_date::date - 1
  group by  dd.day_timestamp, cohort_name) a
left join
    (SELECT  dd.day_timestamp,
     cohort_name, 
    count(distinct dss.subscription_id) as total
      FROM common.daily_status_snapshot dss
      INNER JOIN common.subscription_d sd ON sd.subscription_id = dss.subscription_id
      inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
    left join common.cohort_d cd 
      on sd.subscription_id = cd.subscription_id
      WHERE
      dss.day_timestamp = dd.day_timestamp
      AND dss.paid_through_date >= dd.day_timestamp::date -1
      AND dss.paid_through_date < dd.day_timestamp::date
      AND dss.paid_through_date >= sd.paid_through_date::date - INTERVAL '15 day'
    group by  dd.day_timestamp, cohort_name
    ) c
on a.day_timestamp = c.day_timestamp)foo;

SELECT 
measure_date,
sum(churn_rate) over(order by measure_date rows 30 PRECEDING) as trailing_30_day_churn_sum
FROM tmp.nyny_churn_summary;


[2016-02-24 17:23:29.747] [009268] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:23:30.256] [009268] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6291107

[2016-02-24 17:31:04.743] [010250] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:31:04.823] [010250] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='nyny_churn_summary' ORDER BY ordinal_position

[2016-02-24 17:32:00.708] [009268] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:32:00.855] [009268] [dwh-prod] [PGSQL]
SELECT 
cohort_name, measure_date,
sum(churn_rate) over(order by measure_date rows 30 PRECEDING) as trailing_30_day_churn_sum
FROM tmp.nyny_churn_summary;


[2016-02-24 17:32:01.452] [009268] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:32:01.903] [009268] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6291107

[2016-02-24 17:33:30.171] [009268] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:33:30.280] [009268] [dwh-prod] [PGSQL]
SELECT 
cohort_name, measure_date,
sum(churn_rate) over(partition by cohort_name order by measure_date rows 30 PRECEDING) as trailing_30_day_churn_sum
FROM tmp.nyny_churn_summary;


[2016-02-24 17:33:30.878] [009268] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:33:31.308] [009268] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6291107

[2016-02-24 17:34:32.519] [009268] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:34:32.651] [009268] [dwh-prod] [PGSQL]
drop table if exists tmp.nyny_churn_summary;

create table tmp.nyny_churn_summary as 
select  cohort_name, day_timestamp measure_date, customer_days, total_cancels, total_cancels/customer_days::float churn_rate
from 
(select a.cohort_name, a.day_timestamp, a.total customer_days, coalesce(c.total ,0) total_cancels
from 
(SELECT  dd.day_timestamp,
     cd.cohort_name,
    count(distinct dss.subscription_id) as total
    FROM common.daily_status_snapshot dss
    INNER JOIN common.subscription_d sd ON dss.subscription_id = sd.subscription_id
    inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
    left join tmp.nyny_cohorts cd 
      on sd.subscription_id = cd.subscription_id
    WHERE dss.paid_through_date >= dd.day_timestamp::date - 1
    AND dss.status NOT IN ('Hold')
    and dd.day_timestamp >= '20151226' 
    and dd.day_timestamp <= current_date::date - 1
  group by  dd.day_timestamp, cohort_name) a
left join
    (SELECT  dd.day_timestamp,
     cohort_name, 
    count(distinct dss.subscription_id) as total
      FROM common.daily_status_snapshot dss
      INNER JOIN common.subscription_d sd ON sd.subscription_id = dss.subscription_id
      inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
    left join tmp.nyny_cohorts cd  cd 
      on sd.subscription_id = cd.subscription_id
      WHERE
      dss.day_timestamp = dd.day_timestamp
      AND dss.paid_through_date >= dd.day_timestamp::date -1
      AND dss.paid_through_date < dd.day_timestamp::date
      AND dss.paid_through_date >= sd.paid_through_date::date - INTERVAL '15 day'
    group by  dd.day_timestamp, cohort_name
    ) c
on a.day_timestamp = c.day_timestamp)foo;

SELECT 
cohort_name, measure_date,
sum(churn_rate) over(partition by cohort_name order by measure_date rows 30 PRECEDING) as trailing_30_day_churn_sum
FROM tmp.nyny_churn_summary;


[2016-02-24 17:34:32.731] [009268] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "cd"
LINE 28:     left join tmp.nyny_cohorts cd  cd 
                                            ^


[2016-02-24 17:34:32.752] [009268] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:35:54.136] [009268] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:35:54.260] [009268] [dwh-prod] [PGSQL]
drop table if exists tmp.nyny_churn_summary;

create table tmp.nyny_churn_summary as 
select  cohort_name, day_timestamp measure_date, customer_days, total_cancels, total_cancels/customer_days::float churn_rate
from 
(select a.cohort_name, a.day_timestamp, a.total customer_days, coalesce(c.total ,0) total_cancels
from 
(SELECT  dd.day_timestamp,
     cd.cohort_name,
    count(distinct dss.subscription_id) as total
    FROM common.daily_status_snapshot dss
    INNER JOIN common.subscription_d sd ON dss.subscription_id = sd.subscription_id
    inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
    left join tmp.nyny_cohorts cd 
      on sd.subscription_id = cd.subscription_id
    WHERE dss.paid_through_date >= dd.day_timestamp::date - 1
    AND dss.status NOT IN ('Hold')
    and dd.day_timestamp >= '20151226' 
    and dd.day_timestamp <= current_date::date - 1
  group by  dd.day_timestamp, cohort_name) a
left join
    (SELECT  dd.day_timestamp,
     cohort_name, 
    count(distinct dss.subscription_id) as total
      FROM common.daily_status_snapshot dss
      INNER JOIN common.subscription_d sd ON sd.subscription_id = dss.subscription_id
      inner join common.date_d dd on dss.day_timestamp::date = dd.day_timestamp::date
    left join tmp.nyny_cohorts cd 
      on sd.subscription_id = cd.subscription_id
      WHERE
      dss.day_timestamp = dd.day_timestamp
      AND dss.paid_through_date >= dd.day_timestamp::date -1
      AND dss.paid_through_date < dd.day_timestamp::date
      AND dss.paid_through_date >= sd.paid_through_date::date - INTERVAL '15 day'
    group by  dd.day_timestamp, cohort_name
    ) c
on a.day_timestamp = c.day_timestamp)foo;

SELECT 
cohort_name, measure_date,
sum(churn_rate) over(partition by cohort_name order by measure_date rows 30 PRECEDING) as trailing_30_day_churn_sum
FROM tmp.nyny_churn_summary;


[2016-02-24 17:37:14.710] [009268] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:37:15.177] [009268] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6291117

[2016-02-24 17:50:36.451] [020526] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:50:36.530] [020526] [dwh-dev] [PGSQL]
SHOW search_path

[2016-02-24 17:50:36.889] [020525] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:50:36.967] [020525] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-24 17:50:37.079] [020525] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 17:50:37.161] [020525] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-24 17:50:37.244] [020525] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 17:50:37.678] [020525] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 17:50:37.755] [020525] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 17:50:37.858] [020525] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-24 17:50:37.937] [020525] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 17:50:38.033] [020525] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-24 17:50:38.117] [020525] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 17:50:38.315] [020525] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 17:50:38.397] [020525] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 17:50:38.487] [020525] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-24 17:50:38.569] [020525] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-24 17:51:42.284] [020533] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:51:42.365] [028383] [dwh-dev] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'facets_tmp' ORDER BY col.table_name, col.ordinal_position

[2016-02-24 17:51:42.365] [028383] [dwh-dev] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-24 17:51:42.923] [020534] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:51:42.999] [020534] [dwh-dev] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'facets_tmp' ORDER BY col.table_name, col.ordinal_position

[2016-02-24 17:51:43.135] [020534] [dwh-dev] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-24 17:51:43.516] [020534] [dwh-dev] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-24 17:51:43.596] [020534] [dwh-dev] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'facets_tmp' AND conname IS NOT NULL

[2016-02-24 17:51:43.683] [020534] [dwh-dev] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'facets_tmp' ORDER BY t.relname, i.oid

[2016-02-24 17:51:43.776] [020534] [dwh-dev] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'facets_tmp' ORDER BY t.relname, c.conname, a.attnum

[2016-02-24 17:51:44.075] [020533] [dwh-dev] [PGSQL]
SELECT * FROM "tmp"."facets_tmp" LIMIT 1000 OFFSET 0

[2016-02-24 17:51:44.330] [020533] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'tmp' AND cl.table_name = 'facets_tmp'

[2016-02-24 17:51:44.429] [020533] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12337297

[2016-02-24 17:52:32.723] [016875] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:52:32.804] [016875] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-24 17:52:32.913] [016875] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-24 17:52:32.996] [016875] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-24 17:52:34.009] [016875] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-24 17:52:34.089] [016875] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-24 17:52:34.196] [016875] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-24 17:52:46.449] [025988] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:52:46.558] [025988] [dwh-prod] [PGSQL]
select distinct facet_type, facet_name from tmp.facets_tmp;


[2016-02-24 17:52:46.668] [025988] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:52:47.125] [025988] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6290706

[2016-02-24 17:55:04.852] [017658] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:55:04.931] [017658] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='facets_tmp' ORDER BY ordinal_position

[2016-02-24 17:55:16.681] [025988] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:55:16.794] [025988] [dwh-prod] [PGSQL]
select  nid, string_agg(name, ',')  
from tmp.facets_tmp
where facet_name = teacher;


[2016-02-24 17:55:16.874] [025988] [dwh-prod] [PGSQL]
ERROR:  column "teacher" does not exist
LINE 3: where facet_name = teacher;
                           ^


[2016-02-24 17:55:16.888] [025988] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:55:40.053] [025988] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:55:40.167] [025988] [dwh-prod] [PGSQL]
select  nid, string_agg(name, ',')  
from tmp.facets_tmp
where facet_name = 'teacher';


[2016-02-24 17:55:40.246] [025988] [dwh-prod] [PGSQL]
ERROR:  column "facets_tmp.nid" must appear in the GROUP BY clause or be used in an aggregate function
LINE 1: select  nid, string_agg(name, ',')  
                ^


[2016-02-24 17:55:40.265] [025988] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:56:02.520] [025988] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:56:02.637] [025988] [dwh-prod] [PGSQL]
select  nid, string_agg(name, ',')  
from tmp.facets_tmp
where facet_name = 'teacher'
group by nid;


[2016-02-24 17:56:03.061] [025988] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:56:03.506] [025988] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6290706

[2016-02-24 17:56:49.504] [018219] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:56:49.582] [018219] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='video_d' ORDER BY ordinal_position

[2016-02-24 17:56:50.278] [018221] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-24 17:56:50.356] [018221] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='drupal' AND table_name='node' ORDER BY ordinal_position

[2016-02-24 17:58:29.460] [025988] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:58:29.650] [025988] [dwh-prod] [PGSQL]
with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid,
            teacher
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     left join 
				(select  nid, string_agg(name, ',') teacher 
				from tmp.facets_tmp
				where facet_name = 'teacher'
				group by nid) t
      on v1.page_nid = t.nid
     where admin_category  =  'Fitness'
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
       v.teacher,
       sum(num_views) total_views, 
       sum(watched) total_watched
from common.video_daily_cube vt 
join  v on vt.media_nid = v.media_nid
where  vt.created_date > '20150101'::date
group by v.title, v.video_age,v.page_nid, v.duration, v.teacher;



[2016-02-24 17:58:39.622] [025988] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 17:58:40.011] [025988] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6290809

[2016-02-24 18:00:52.213] [025988] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 18:00:52.341] [025988] [dwh-prod] [PGSQL]
with v as 
    (select v1.title, 
            (current_date::date - created_date)/30 video_age,
            page_nid, 
            duration, 
            media_nid,
            teacher
     from common.video_d v1
     join drupal.node n on v1.page_nid = n.nid
     left join 
				(select  nid, string_agg(name, ',') teacher 
				from tmp.facets_tmp
				where facet_name = 'teacher'
				group by nid) t
      on v1.page_nid = t.nid
     where admin_category  =  'Yoga'
      and n.status = 1
      and feature = 'Feature')
select v.title,
       v.video_age,
       v.page_nid,
       v.duration,
       v.teacher,
       sum(num_views) total_views, 
       sum(watched) total_watched
from common.video_daily_cube vt 
join  v on vt.media_nid = v.media_nid
where  vt.created_date > '20150101'::date
group by v.title, v.video_age,v.page_nid, v.duration, v.teacher;



[2016-02-24 18:01:00.104] [025988] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-24 18:01:00.620] [025988] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6290809

[2016-02-25 13:30:23.667] [017097] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:30:23.746] [017097] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-25 13:30:23.897] [017098] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:30:23.977] [017098] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 13:30:24.065] [017098] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 13:30:24.151] [017098] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-25 13:30:24.232] [017098] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 13:30:24.726] [017098] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 13:30:24.805] [017098] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 13:30:24.891] [017098] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-25 13:30:24.978] [017098] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 13:30:25.061] [017098] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-25 13:30:25.145] [017098] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 13:30:25.407] [017098] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 13:30:25.486] [017098] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 13:30:25.568] [017098] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-25 13:30:25.649] [017098] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 13:31:00.881] [017097] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 13:31:01.010] [017097] [dwh-prod] [PGSQL]
SELECT
count(*) as total
, dss.day_timestamp::date as measure_date
FROM common.daily_status_snapshot dss
INNER JOIN common.user_dim ud ON ud.gcsi_user_id = dss.gcsi_user_id
INNER JOIN common.subscription_d sd ON dss.subscription_id = sd.subscription_id
WHERE 
( (dss.paid_through_date >= dss.day_timestamp)
        OR
    (dss.status = 'Suspended' AND dss.paid_through_date >= dss.day_timestamp - INTERVAL '15 days')
)
AND dss.status NOT IN ('Cancelled', 'Hold')
AND dss.day_timestamp >= '2016-02-20'
AND dss.day_timestamp < '2016-02-21'


[2016-02-25 13:31:01.101] [017097] [dwh-prod] [PGSQL]
ERROR:  column "dss.day_timestamp" must appear in the GROUP BY clause or be used in an aggregate function
LINE 3: , dss.day_timestamp::date as measure_date
          ^


[2016-02-25 13:31:01.123] [017097] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 13:31:19.245] [017097] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 13:31:19.355] [017097] [dwh-prod] [PGSQL]
SELECT
count(*) as total
, dss.day_timestamp::date as measure_date
FROM common.daily_status_snapshot dss
INNER JOIN common.user_dim ud ON ud.gcsi_user_id = dss.gcsi_user_id
INNER JOIN common.subscription_d sd ON dss.subscription_id = sd.subscription_id
WHERE 
( (dss.paid_through_date >= dss.day_timestamp)
        OR
    (dss.status = 'Suspended' AND dss.paid_through_date >= dss.day_timestamp - INTERVAL '15 days')
)
AND dss.status NOT IN ('Cancelled', 'Hold')
AND dss.day_timestamp >= '2016-02-20'
AND dss.day_timestamp < '2016-02-21'
GROUP BY dss.day_timestamp


[2016-02-25 13:31:20.469] [017097] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 13:31:41.141] [017508] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:31:41.222] [017508] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 13:31:41.328] [017508] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-25 13:31:41.415] [017508] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 13:31:41.947] [017508] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 13:31:42.028] [017508] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 13:31:42.117] [017508] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-25 13:31:42.784] [017515] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:31:42.869] [017515] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='daily_status_snapshot' ORDER BY ordinal_position

[2016-02-25 13:31:43.550] [017516] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:31:43.631] [017516] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='user_dim' ORDER BY ordinal_position

[2016-02-25 13:31:44.323] [017517] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:31:44.403] [017517] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='subscription_d' ORDER BY ordinal_position

[2016-02-25 13:33:04.074] [017097] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 13:33:04.196] [017097] [dwh-prod] [PGSQL]
SELECT
gcsi_user_id, subscription_id
FROM common.daily_status_snapshot dss
INNER JOIN common.user_dim ud ON ud.gcsi_user_id = dss.gcsi_user_id
INNER JOIN common.subscription_d sd ON dss.gcsi_user_id = sd.gcsi_user_id
WHERE 
( (dss.paid_through_date >= dss.day_timestamp)
        OR
    (dss.status = 'Suspended' AND dss.paid_through_date >= dss.day_timestamp - INTERVAL '15 days')
)
AND dss.status NOT IN ('Cancelled', 'Hold')
AND dss.day_timestamp >= '2016-02-20'
AND dss.day_timestamp < '2016-02-21'
EXCEPT
FROM common.daily_status_snapshot dss
INNER JOIN common.user_dim ud ON ud.gcsi_user_id = dss.gcsi_user_id
INNER JOIN common.subscription_d sd ON dss.subscription_id = sd.subscription_id
WHERE 
( (dss.paid_through_date >= dss.day_timestamp)
        OR
    (dss.status = 'Suspended' AND dss.paid_through_date >= dss.day_timestamp - INTERVAL '15 days')
)
AND dss.status NOT IN ('Cancelled', 'Hold')
AND dss.day_timestamp >= '2016-02-20'
AND dss.day_timestamp < '2016-02-21'



[2016-02-25 13:33:04.280] [017097] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "FROM"
LINE 15: FROM common.daily_status_snapshot dss
         ^


[2016-02-25 13:33:04.298] [017097] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 13:33:18.770] [017097] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 13:33:18.894] [017097] [dwh-prod] [PGSQL]
SELECT
gcsi_user_id, subscription_id
FROM common.daily_status_snapshot dss
INNER JOIN common.user_dim ud ON ud.gcsi_user_id = dss.gcsi_user_id
INNER JOIN common.subscription_d sd ON dss.gcsi_user_id = sd.gcsi_user_id
WHERE 
( (dss.paid_through_date >= dss.day_timestamp)
        OR
    (dss.status = 'Suspended' AND dss.paid_through_date >= dss.day_timestamp - INTERVAL '15 days')
)
AND dss.status NOT IN ('Cancelled', 'Hold')
AND dss.day_timestamp >= '2016-02-20'
AND dss.day_timestamp < '2016-02-21'
EXCEPT
SELECT
gcsi_user_id, subscription_id
FROM common.daily_status_snapshot dss
INNER JOIN common.user_dim ud ON ud.gcsi_user_id = dss.gcsi_user_id
INNER JOIN common.subscription_d sd ON dss.subscription_id = sd.subscription_id
WHERE 
( (dss.paid_through_date >= dss.day_timestamp)
        OR
    (dss.status = 'Suspended' AND dss.paid_through_date >= dss.day_timestamp - INTERVAL '15 days')
)
AND dss.status NOT IN ('Cancelled', 'Hold')
AND dss.day_timestamp >= '2016-02-20'
AND dss.day_timestamp < '2016-02-21'



[2016-02-25 13:33:18.976] [017097] [dwh-prod] [PGSQL]
ERROR:  column reference "gcsi_user_id" is ambiguous
LINE 2: gcsi_user_id, subscription_id
        ^


[2016-02-25 13:33:18.997] [017097] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 13:33:38.562] [017097] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 13:33:38.685] [017097] [dwh-prod] [PGSQL]
SELECT
dss.gcsi_user_id, dss.subscription_id
FROM common.daily_status_snapshot dss
INNER JOIN common.user_dim ud ON ud.gcsi_user_id = dss.gcsi_user_id
INNER JOIN common.subscription_d sd ON dss.gcsi_user_id = sd.gcsi_user_id
WHERE 
( (dss.paid_through_date >= dss.day_timestamp)
        OR
    (dss.status = 'Suspended' AND dss.paid_through_date >= dss.day_timestamp - INTERVAL '15 days')
)
AND dss.status NOT IN ('Cancelled', 'Hold')
AND dss.day_timestamp >= '2016-02-20'
AND dss.day_timestamp < '2016-02-21'
EXCEPT
SELECT
dss.gcsi_user_id, dss.subscription_id
FROM common.daily_status_snapshot dss
INNER JOIN common.user_dim ud ON ud.gcsi_user_id = dss.gcsi_user_id
INNER JOIN common.subscription_d sd ON dss.subscription_id = sd.subscription_id
WHERE 
( (dss.paid_through_date >= dss.day_timestamp)
        OR
    (dss.status = 'Suspended' AND dss.paid_through_date >= dss.day_timestamp - INTERVAL '15 days')
)
AND dss.status NOT IN ('Cancelled', 'Hold')
AND dss.day_timestamp >= '2016-02-20'
AND dss.day_timestamp < '2016-02-21'



[2016-02-25 13:33:39.772] [017097] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 13:34:17.691] [010538] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:34:17.772] [020534] [dwh-dev] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'subscription_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-25 13:34:17.773] [020534] [dwh-dev] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-25 13:34:18.336] [010539] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:34:18.413] [010539] [dwh-dev] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'subscription_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-25 13:34:18.622] [010539] [dwh-dev] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-25 13:34:18.999] [010539] [dwh-dev] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-25 13:34:19.079] [010539] [dwh-dev] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'subscription_d' AND conname IS NOT NULL

[2016-02-25 13:34:19.180] [010539] [dwh-dev] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'subscription_d' ORDER BY t.relname, i.oid

[2016-02-25 13:34:19.283] [010539] [dwh-dev] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'subscription_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-25 13:34:19.530] [010538] [dwh-dev] [PGSQL]
SELECT * FROM "common"."subscription_d" LIMIT 1000 OFFSET 0

[2016-02-25 13:34:20.247] [010538] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'subscription_d'

[2016-02-25 13:34:20.348] [010538] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12362886

[2016-02-25 13:34:49.387] [010538] [dwh-dev] [PGSQL]
SELECT * FROM "common"."subscription_d" WHERE "gcsi_user_id" = '33146971' LIMIT 1000 OFFSET 0

[2016-02-25 13:34:49.471] [010538] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'subscription_d'

[2016-02-25 13:34:49.563] [010538] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 12362886

[2016-02-25 13:35:04.264] [010545] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:35:04.351] [010545] [dwh-dev] [PGSQL]
SHOW search_path

[2016-02-25 13:35:04.700] [010544] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:35:04.780] [010544] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 13:35:04.929] [010544] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 13:35:05.013] [010544] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-25 13:35:05.096] [010544] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 13:35:05.526] [010544] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 13:35:05.605] [010544] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 13:35:05.699] [010544] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-25 13:35:05.781] [010544] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 13:35:05.877] [010544] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-25 13:35:05.961] [010544] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 13:35:06.241] [010544] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 13:35:06.320] [010544] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 13:35:06.405] [010544] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-25 13:35:06.487] [010544] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 13:35:22.740] [010549] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:35:22.817] [010539] [dwh-dev] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'daily_status_snapshot' ORDER BY col.table_name, col.ordinal_position

[2016-02-25 13:35:22.920] [010539] [dwh-dev] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-25 13:35:23.315] [010539] [dwh-dev] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-25 13:35:23.394] [010539] [dwh-dev] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'daily_status_snapshot' AND conname IS NOT NULL

[2016-02-25 13:35:23.478] [010539] [dwh-dev] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'daily_status_snapshot' ORDER BY t.relname, i.oid

[2016-02-25 13:35:23.563] [010539] [dwh-dev] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'daily_status_snapshot' ORDER BY t.relname, c.conname, a.attnum

[2016-02-25 13:35:23.829] [010549] [dwh-dev] [PGSQL]
SELECT * FROM "common"."daily_status_snapshot" LIMIT 1000 OFFSET 0

[2016-02-25 13:35:24.285] [010549] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'daily_status_snapshot'

[2016-02-25 13:35:24.381] [010549] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 11677347

[2016-02-25 13:35:46.378] [010549] [dwh-dev] [PGSQL]
SELECT * FROM "common"."daily_status_snapshot" WHERE "day_timestamp" = '2016-02-20 13:35:34' AND "gcsi_user_id" = '33146971' LIMIT 1000 OFFSET 0

[2016-02-25 13:35:46.462] [010549] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'daily_status_snapshot'

[2016-02-25 13:35:46.549] [010549] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 11677347

[2016-02-25 13:36:17.707] [010549] [dwh-dev] [PGSQL]
SELECT * FROM "common"."daily_status_snapshot" WHERE "day_timestamp" = '2016-02-20 00:00:00' AND "gcsi_user_id" = '33146971' LIMIT 1000 OFFSET 0

[2016-02-25 13:36:17.787] [010549] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'daily_status_snapshot'

[2016-02-25 13:36:17.873] [010549] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 11677347

[2016-02-25 13:36:26.732] [010549] [dwh-dev] [PGSQL]
SELECT * FROM "common"."daily_status_snapshot" WHERE "gcsi_user_id" = '33146971' LIMIT 1000 OFFSET 0

[2016-02-25 13:36:26.815] [010549] [dwh-dev] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_dev' AND cl.table_schema = 'common' AND cl.table_name = 'daily_status_snapshot'

[2016-02-25 13:36:26.900] [010549] [dwh-dev] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 11677347

[2016-02-25 13:37:00.892] [019177] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:37:00.971] [019325] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'daily_status_snapshot' ORDER BY col.table_name, col.ordinal_position

[2016-02-25 13:37:00.975] [019325] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-25 13:37:01.579] [019188] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:37:01.659] [019188] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'daily_status_snapshot' ORDER BY col.table_name, col.ordinal_position

[2016-02-25 13:37:01.780] [019188] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-25 13:37:02.186] [019188] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-25 13:37:02.268] [019188] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'daily_status_snapshot' AND conname IS NOT NULL

[2016-02-25 13:37:02.357] [019188] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'daily_status_snapshot' ORDER BY t.relname, i.oid

[2016-02-25 13:37:02.448] [019188] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'daily_status_snapshot' ORDER BY t.relname, c.conname, a.attnum

[2016-02-25 13:37:02.717] [019177] [dwh-prod] [PGSQL]
SELECT * FROM "common"."daily_status_snapshot" LIMIT 1000 OFFSET 0

[2016-02-25 13:37:03.136] [019177] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'daily_status_snapshot'

[2016-02-25 13:37:03.239] [019177] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5642984

[2016-02-25 13:37:15.130] [019177] [dwh-prod] [PGSQL]
SELECT * FROM "common"."daily_status_snapshot" WHERE "gcsi_user_id" = '33146971' LIMIT 1000 OFFSET 0

[2016-02-25 13:37:15.233] [019177] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'daily_status_snapshot'

[2016-02-25 13:37:15.322] [019177] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5642984

[2016-02-25 13:37:27.753] [019177] [dwh-prod] [PGSQL]
SELECT * FROM "common"."daily_status_snapshot" WHERE "gcsi_user_id" = '33146971' ORDER BY "day_timestamp" LIMIT 1000 OFFSET 0

[2016-02-25 13:37:27.835] [019177] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'daily_status_snapshot'

[2016-02-25 13:37:27.922] [019177] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5642984

[2016-02-25 13:38:20.247] [019557] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:38:20.332] [019188] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'user_dim' ORDER BY col.table_name, col.ordinal_position

[2016-02-25 13:38:20.472] [019188] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-25 13:38:20.838] [019188] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-25 13:38:20.920] [019188] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'user_dim' AND conname IS NOT NULL

[2016-02-25 13:38:21.002] [019188] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'user_dim' ORDER BY t.relname, i.oid

[2016-02-25 13:38:21.089] [019188] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'user_dim' ORDER BY t.relname, c.conname, a.attnum

[2016-02-25 13:38:21.303] [019557] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_dim" LIMIT 1000 OFFSET 0

[2016-02-25 13:38:21.963] [019557] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_dim'

[2016-02-25 13:38:22.067] [019557] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310306

[2016-02-25 13:38:32.488] [019557] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_dim" WHERE "gcsi_user_id" = '33146971' LIMIT 1000 OFFSET 0

[2016-02-25 13:38:32.573] [019557] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_dim'

[2016-02-25 13:38:32.669] [019557] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310306

[2016-02-25 13:39:16.425] [019860] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:39:16.505] [019188] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'subscription_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-25 13:39:16.624] [019188] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-25 13:39:17.023] [019188] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-25 13:39:17.105] [019188] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'subscription_d' AND conname IS NOT NULL

[2016-02-25 13:39:17.188] [019188] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'subscription_d' ORDER BY t.relname, i.oid

[2016-02-25 13:39:17.280] [019188] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'subscription_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-25 13:39:17.510] [019860] [dwh-prod] [PGSQL]
SELECT * FROM "common"."subscription_d" LIMIT 1000 OFFSET 0

[2016-02-25 13:39:18.088] [019860] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'subscription_d'

[2016-02-25 13:39:18.189] [019860] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310324

[2016-02-25 13:39:32.763] [019860] [dwh-prod] [PGSQL]
SELECT * FROM "common"."subscription_d" WHERE "gcsi_user_id" = '33146971' LIMIT 1000 OFFSET 0

[2016-02-25 13:39:32.845] [019860] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'subscription_d'

[2016-02-25 13:39:32.936] [019860] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310324

[2016-02-25 13:40:49.260] [019177] [dwh-prod] [PGSQL]
SELECT * FROM "common"."daily_status_snapshot" WHERE "gcsi_user_id" = '11120470' ORDER BY "day_timestamp" LIMIT 1000 OFFSET 0

[2016-02-25 13:40:49.634] [019177] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'daily_status_snapshot'

[2016-02-25 13:40:49.770] [019177] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5642984

[2016-02-25 13:40:59.480] [019177] [dwh-prod] [PGSQL]
SELECT * FROM "common"."daily_status_snapshot" WHERE "gcsi_user_id" = '11120470' ORDER BY "day_timestamp" DESC LIMIT 1000 OFFSET 0

[2016-02-25 13:40:59.807] [019177] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'daily_status_snapshot'

[2016-02-25 13:40:59.899] [019177] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5642984

[2016-02-25 13:41:14.201] [019557] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_dim" WHERE "gcsi_user_id" = '11120470' LIMIT 1000 OFFSET 0

[2016-02-25 13:41:14.284] [019557] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_dim'

[2016-02-25 13:41:14.382] [019557] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310306

[2016-02-25 13:43:47.772] [019860] [dwh-prod] [PGSQL]
SELECT * FROM "common"."subscription_d" WHERE "gcsi_user_id" = '11120470' LIMIT 1000 OFFSET 0

[2016-02-25 13:43:47.855] [019860] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'subscription_d'

[2016-02-25 13:43:47.947] [019860] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310324

[2016-02-25 13:45:34.970] [021824] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:45:35.050] [019188] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'user_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-25 13:45:35.219] [019188] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-25 13:45:35.621] [019188] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-25 13:45:35.703] [019188] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'user_d' AND conname IS NOT NULL

[2016-02-25 13:45:35.786] [019188] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'user_d' ORDER BY t.relname, i.oid

[2016-02-25 13:45:35.871] [019188] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'user_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-25 13:45:36.100] [021824] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" LIMIT 1000 OFFSET 0

[2016-02-25 13:45:36.871] [021824] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-25 13:45:36.982] [021824] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310091

[2016-02-25 13:45:49.383] [021824] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '11120470' LIMIT 1000 OFFSET 0

[2016-02-25 13:45:49.860] [021824] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-25 13:45:49.959] [021824] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310091

[2016-02-25 13:47:07.165] [022295] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:47:07.245] [022295] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-25 13:47:07.569] [022294] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 13:47:07.649] [022294] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 13:47:07.747] [022294] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 13:47:07.833] [022294] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-25 13:47:07.914] [022294] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 13:47:08.429] [022294] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 13:47:08.508] [022294] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 13:47:08.595] [022294] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-25 13:47:08.676] [022294] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 13:47:08.774] [022294] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-25 13:47:08.858] [022294] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 13:47:09.134] [022294] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 13:47:09.214] [022294] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 13:47:09.299] [022294] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-25 13:47:09.381] [022294] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 14:01:15.778] [026640] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:01:15.859] [026640] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-25 14:01:16.263] [026639] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:01:16.344] [026639] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 14:01:16.643] [026639] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 14:01:16.730] [026639] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-25 14:01:17.011] [026639] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 14:01:19.217] [026639] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 14:01:19.298] [026639] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 14:01:19.385] [026639] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-25 14:01:19.475] [026639] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 14:01:19.576] [026639] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-25 14:01:19.663] [026639] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 14:01:21.450] [026639] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 14:01:21.549] [026639] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 14:01:21.635] [026639] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-25 14:01:21.720] [026639] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 14:01:59.190] [011103] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:01:59.288] [011103] [dwh-dev] [PGSQL]
SELECT d.datname, d.oid, pg_get_userbyid(d.datdba) AS owner, shobj_description(d.oid, 'pg_database') AS comment, t.spcname, d.datacl, d.datlastsysoid, d.encoding, pg_encoding_to_char(d.encoding) AS encodingname FROM pg_database d LEFT JOIN pg_tablespace t ON d.dattablespace=t.oid

[2016-02-25 14:02:07.893] [011105] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:02:07.973] [011105] [dwh-dev] [PGSQL]
SELECT nspname, oid, pg_get_userbyid(nspowner) AS owner, nspacl, obj_description(oid) FROM pg_namespace

[2016-02-25 14:02:25.642] [011109] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:02:25.721] [011109] [dwh-dev] [PGSQL]
SHOW search_path

[2016-02-25 14:02:26.037] [011108] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:02:26.119] [011108] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 14:02:26.228] [011108] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 14:02:26.313] [011108] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-25 14:02:26.419] [011108] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 14:02:27.110] [011108] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 14:02:27.192] [011108] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 14:02:27.280] [011108] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-25 14:02:27.363] [011108] [dwh-dev] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 14:02:42.524] [011109] [dwh-dev] [PGSQL]
select 
    subscription_id,
    drupal_user_id,
    gcsi_user_id,
    subscription_start_date  start_date,
    next_review_date,
    paid_through_date,
    cancel_date,
    subscription_end_date    end_date,
    case when status = 'Hold' or status = 'Start/Hold' then 
         case when paid_through_date >= current_date::date
              then 'Hold'
              else 'Suspended'
         end 
         when cancel_date <= current_date::date then 
         case when paid_through_date > current_date::date 
              then 'Lapsed'
              else 'Cancelled'
         end 
         else status
    end status,
    pd.dwh_plan_id,
    ud.winback
from common.user_d ud
join common.plan_d pd
   on ud.plan_id = pd.gcsi_plan_id and ud.segment_id = pd.segment_id
where id in 
   (select  id
    from common.user_d
    where valid_from <= current_date::date
      and valid_to >= current_date::date);



alter table common.subscription_d owner to dw_admin;


[2016-02-25 14:03:01.747] [011109] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-25 14:06:12.085] [011109] [dwh-dev] [PGSQL]
select 
    subscription_id,
    drupal_user_id,
    gcsi_user_id,
    subscription_start_date  start_date,
    next_review_date,
    paid_through_date,
    cancel_date,
    subscription_end_date    end_date,
    case when status = 'Hold' or status = 'Start/Hold' then 
         case when paid_through_date >= current_date::date
              then 'Hold'
              else 'Suspended'
         end 
         when cancel_date <= current_date::date then 
         case when paid_through_date > current_date::date 
              then 'Lapsed'
              else 'Cancelled'
         end 
         else status
    end status,
    pd.dwh_plan_id,
    ud.winback
from common.user_d ud
join common.plan_d pd
   on ud.plan_id = pd.gcsi_plan_id and ud.segment_id = pd.segment_id
where id in 
 +   (select  max(id)
 +    from common.user_d
      where valid_from <= current_date::date
  --    and valid_to >= current_date::date
 +    group by subscription_id);



alter table common.subscription_d owner to dw_admin;


[2016-02-25 14:06:12.165] [011109] [dwh-dev] [PGSQL]
ERROR:  syntax error at or near "+"
LINE 28:  +   (select  max(id)
          ^


[2016-02-25 14:06:12.186] [011109] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-25 14:06:20.208] [011109] [dwh-dev] [PGSQL]
select 
    subscription_id,
    drupal_user_id,
    gcsi_user_id,
    subscription_start_date  start_date,
    next_review_date,
    paid_through_date,
    cancel_date,
    subscription_end_date    end_date,
    case when status = 'Hold' or status = 'Start/Hold' then 
         case when paid_through_date >= current_date::date
              then 'Hold'
              else 'Suspended'
         end 
         when cancel_date <= current_date::date then 
         case when paid_through_date > current_date::date 
              then 'Lapsed'
              else 'Cancelled'
         end 
         else status
    end status,
    pd.dwh_plan_id,
    ud.winback
from common.user_d ud
join common.plan_d pd
   on ud.plan_id = pd.gcsi_plan_id and ud.segment_id = pd.segment_id
where id in 
    (select  max(id)
     from common.user_d
      where valid_from <= current_date::date
  --    and valid_to >= current_date::date
     group by subscription_id);



alter table common.subscription_d owner to dw_admin;


[2016-02-25 14:06:31.547] [011109] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-25 14:07:49.031] [011180] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:07:49.108] [011180] [dwh-dev] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 14:07:49.212] [011180] [dwh-dev] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-25 14:07:49.294] [011180] [dwh-dev] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 14:07:49.717] [011180] [dwh-dev] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 14:07:49.795] [011180] [dwh-dev] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 14:07:49.881] [011180] [dwh-dev] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-25 14:07:50.543] [011181] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:07:50.623] [011181] [dwh-dev] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='user_d' ORDER BY ordinal_position

[2016-02-25 14:07:51.311] [011182] [dwh-dev] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:07:51.388] [011182] [dwh-dev] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='plan_d' ORDER BY ordinal_position

[2016-02-25 14:08:41.212] [011109] [dwh-dev] [PGSQL]

select count(1)
from
(select 
    subscription_id,
    drupal_user_id,
    gcsi_user_id,
    subscription_start_date  start_date,
    next_review_date,
    paid_through_date,
    cancel_date,
    subscription_end_date    end_date,
    case when status = 'Hold' or status = 'Start/Hold' then 
         case when paid_through_date >= current_date::date
              then 'Hold'
              else 'Suspended'
         end 
         when cancel_date <= current_date::date then 
         case when paid_through_date > current_date::date 
              then 'Lapsed'
              else 'Cancelled'
         end 
         else status
    end status,
    pd.dwh_plan_id,
    ud.winback
from common.user_d ud
join common.plan_d pd
   on ud.plan_id = pd.gcsi_plan_id and ud.segment_id = pd.segment_id
where id in 
    (select  max(id)
     from common.user_d
      where valid_from <= current_date::date
  --    and valid_to >= current_date::date
     group by subscription_id)
where cancel_date < '20140101'::date OR
      end_date < '20140101'::date;



alter table common.subscription_d owner to dw_admin;


[2016-02-25 14:08:41.296] [011109] [dwh-dev] [PGSQL]
ERROR:  syntax error at or near "where"
LINE 36: where cancel_date < '20140101'::date OR
         ^


[2016-02-25 14:08:41.316] [011109] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-25 14:09:10.342] [011109] [dwh-dev] [PGSQL]

select count(1)
from
(select 
    subscription_id,
    drupal_user_id,
    gcsi_user_id,
    subscription_start_date  start_date,
    next_review_date,
    paid_through_date,
    cancel_date,
    subscription_end_date    end_date,
    case when status = 'Hold' or status = 'Start/Hold' then 
         case when paid_through_date >= current_date::date
              then 'Hold'
              else 'Suspended'
         end 
         when cancel_date <= current_date::date then 
         case when paid_through_date > current_date::date 
              then 'Lapsed'
              else 'Cancelled'
         end 
         else status
    end status,
    pd.dwh_plan_id,
    ud.winback
from common.user_d ud
join common.plan_d pd
   on ud.plan_id = pd.gcsi_plan_id and ud.segment_id = pd.segment_id
where id in 
    (select  max(id)
     from common.user_d
      where valid_from <= current_date::date
  --    and valid_to >= current_date::date
     group by subscription_id)) foo
where cancel_date < '20140101'::date OR
      end_date < '20140101'::date;



alter table common.subscription_d owner to dw_admin;


[2016-02-25 14:09:12.214] [011109] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-25 14:10:53.685] [011109] [dwh-dev] [PGSQL]

select count(1)
from
(select 
    subscription_id,
    drupal_user_id,
    gcsi_user_id,
    subscription_start_date  start_date,
    next_review_date,
    paid_through_date,
    cancel_date,
    subscription_end_date    end_date,
    case when status = 'Hold' or status = 'Start/Hold' then 
         case when paid_through_date >= current_date::date
              then 'Hold'
              else 'Suspended'
         end 
         when cancel_date <= current_date::date then 
         case when paid_through_date > current_date::date 
              then 'Lapsed'
              else 'Cancelled'
         end 
         else status
    end status,
    pd.dwh_plan_id,
    ud.winback
from common.user_d ud
join common.plan_d pd
   on ud.plan_id = pd.gcsi_plan_id and ud.segment_id = pd.segment_id
where id in 
    (select  max(id)
     from common.user_d
      where valid_from <= current_date::date
      and valid_to >= current_date::date
     group by subscription_id)) foo
where cancel_date < '20140101'::date OR
      end_date < '20140101'::date;



alter table common.subscription_d owner to dw_admin;


[2016-02-25 14:10:55.012] [011109] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-25 14:11:44.568] [011109] [dwh-dev] [PGSQL]

select count(1)
from
(select 
    subscription_id,
    drupal_user_id,
    gcsi_user_id,
    subscription_start_date  start_date,
    next_review_date,
    paid_through_date,
    cancel_date,
    subscription_end_date    end_date,
    case when status = 'Hold' or status = 'Start/Hold' then 
         case when paid_through_date >= current_date::date
              then 'Hold'
              else 'Suspended'
         end 
         when cancel_date <= current_date::date then 
         case when paid_through_date > current_date::date 
              then 'Lapsed'
              else 'Cancelled'
         end 
         else status
    end status,
    pd.dwh_plan_id,
    ud.winback
from common.user_d ud
join common.plan_d pd
   on ud.plan_id = pd.gcsi_plan_id and ud.segment_id = pd.segment_id
where id in 
    (select  max(id)
     from common.user_d
      where valid_from <= current_date::date
      and valid_to >= current_date::date
     group by subscription_id)) foo
where cancel_date >= '20140101'::date OR
      end_date >= '20140101'::date);



alter table common.subscription_d owner to dw_admin;


[2016-02-25 14:11:44.646] [011109] [dwh-dev] [PGSQL]
ERROR:  syntax error at or near ")"
LINE 37:       end_date >= '20140101'::date);
                                           ^


[2016-02-25 14:11:44.667] [011109] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-25 14:11:56.017] [011109] [dwh-dev] [PGSQL]

select count(1)
from
(select 
    subscription_id,
    drupal_user_id,
    gcsi_user_id,
    subscription_start_date  start_date,
    next_review_date,
    paid_through_date,
    cancel_date,
    subscription_end_date    end_date,
    case when status = 'Hold' or status = 'Start/Hold' then 
         case when paid_through_date >= current_date::date
              then 'Hold'
              else 'Suspended'
         end 
         when cancel_date <= current_date::date then 
         case when paid_through_date > current_date::date 
              then 'Lapsed'
              else 'Cancelled'
         end 
         else status
    end status,
    pd.dwh_plan_id,
    ud.winback
from common.user_d ud
join common.plan_d pd
   on ud.plan_id = pd.gcsi_plan_id and ud.segment_id = pd.segment_id
where id in 
    (select  max(id)
     from common.user_d
      where valid_from <= current_date::date
      and valid_to >= current_date::date
     group by subscription_id)) foo
where cancel_date >= '20140101'::date OR
      end_date >= '20140101'::date;



alter table common.subscription_d owner to dw_admin;


[2016-02-25 14:11:58.978] [011109] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-25 14:12:21.726] [011109] [dwh-dev] [PGSQL]

select count(1)
from
(select 
    subscription_id,
    drupal_user_id,
    gcsi_user_id,
    subscription_start_date  start_date,
    next_review_date,
    paid_through_date,
    cancel_date,
    subscription_end_date    end_date,
    case when status = 'Hold' or status = 'Start/Hold' then 
         case when paid_through_date >= current_date::date
              then 'Hold'
              else 'Suspended'
         end 
         when cancel_date <= current_date::date then 
         case when paid_through_date > current_date::date 
              then 'Lapsed'
              else 'Cancelled'
         end 
         else status
    end status,
    pd.dwh_plan_id,
    ud.winback
from common.user_d ud
join common.plan_d pd
   on ud.plan_id = pd.gcsi_plan_id and ud.segment_id = pd.segment_id
where id in 
    (select  max(id)
     from common.user_d
      where valid_from <= current_date::date
     -- and valid_to >= current_date::date
     group by subscription_id)) foo
where cancel_date >= '20140101'::date OR
      end_date >= '20140101'::date;



alter table common.subscription_d owner to dw_admin;


[2016-02-25 14:12:25.337] [011109] [dwh-dev] [PGSQL]
SET search_path TO "$user", gcsi, drupal, public

[2016-02-25 14:17:03.890] [031521] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:17:03.971] [031521] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='user_d' ORDER BY ordinal_position

[2016-02-25 14:17:04.671] [031522] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:17:04.751] [031522] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='plan_d' ORDER BY ordinal_position

[2016-02-25 14:19:06.882] [022295] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:19:07.016] [022295] [dwh-prod] [PGSQL]
drop table if exists common.subscription_d;

create table common.subscription_d  as
select 
    subscription_id,
    drupal_user_id,
    gcsi_user_id,
    subscription_start_date  start_date,
    next_review_date,
    paid_through_date,
    cancel_date,
    subscription_end_date    end_date,
    case when status = 'Hold' or status = 'Start/Hold' then 
         case when paid_through_date >= current_date::date
              then 'Hold'
              else 'Suspended'
         end 
         when cancel_date <= current_date::date then 
         case when paid_through_date > current_date::date 
              then 'Lapsed'
              else 'Cancelled'
         end 
         else status
    end status,
    pd.dwh_plan_id,
    ud.winback
from common.user_d ud
join common.plan_d pd
   on ud.plan_id = pd.gcsi_plan_id and ud.segment_id = pd.segment_id
where id in 
    (select  max(id)
     from common.user_d
      where valid_from <= current_date::date
     group by subscription_id);



alter table common.subscription_d owner to dw_admin;


[2016-02-25 14:19:14.651] [022295] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:22:08.855] [000647] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:22:08.955] [019188] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'subscription_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-25 14:22:09.076] [019188] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-25 14:22:09.478] [019188] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-25 14:22:09.737] [019188] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'subscription_d' AND conname IS NOT NULL

[2016-02-25 14:22:09.820] [019188] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'subscription_d' ORDER BY t.relname, i.oid

[2016-02-25 14:22:09.907] [019188] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'subscription_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-25 14:22:10.135] [000647] [dwh-prod] [PGSQL]
SELECT * FROM "common"."subscription_d" LIMIT 1000 OFFSET 0

[2016-02-25 14:22:10.659] [000647] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'subscription_d'

[2016-02-25 14:22:10.763] [000647] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310423

[2016-02-25 14:22:28.504] [000647] [dwh-prod] [PGSQL]
SELECT * FROM "common"."subscription_d" WHERE "gcsi_user_id" = '11120470' LIMIT 1000 OFFSET 0

[2016-02-25 14:22:28.690] [000647] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'subscription_d'

[2016-02-25 14:22:28.791] [000647] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310423

[2016-02-25 14:23:06.895] [000940] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:23:06.974] [000940] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-25 14:23:07.329] [000939] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:23:07.410] [000939] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 14:23:07.506] [000939] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 14:23:07.592] [000939] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-25 14:23:07.676] [000939] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 14:23:08.210] [000939] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 14:23:08.291] [000939] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 14:23:08.378] [000939] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-25 14:23:08.463] [000939] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 14:23:08.561] [000939] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-25 14:23:08.651] [000939] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 14:23:08.961] [000939] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 14:23:09.041] [000939] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 14:23:09.136] [000939] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-25 14:23:09.226] [000939] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 14:26:24.252] [001987] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:26:24.344] [001987] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 14:26:24.439] [001987] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-25 14:26:24.521] [001987] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 14:26:25.053] [001987] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 14:26:25.133] [001987] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 14:26:25.223] [001987] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-25 14:27:48.701] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:27:48.844] [000940] [dwh-prod] [PGSQL]
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;

 
  truncate table moiram.daily_status_y2014q1;
 
       
  insert into moiram.daily_status_y2014q1
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp > ptd.schedule_date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= 20140101
    --and day_timestamp < current_date::date
     and day_timestamp < '20140401'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20140101' or
        ud.paid_through_date >= '20140101' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 14:28:12.774] [000940] [dwh-prod] [PGSQL]
ERROR:  relation "moiram.daily_status_y2014q1" does not exist


[2016-02-25 14:28:12.858] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:29:16.917] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:29:17.030] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2015q1;
 
       
  insert into moiram.daily_status_y2015q1
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp > ptd.schedule_date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= 20140101
    --and day_timestamp < current_date::date
     and day_timestamp < '20150401'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20150101' or
        ud.paid_through_date >= '20150101' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 14:29:17.111] [000940] [dwh-prod] [PGSQL]
ERROR:  relation "moiram.daily_status_y2015q1" does not exist


[2016-02-25 14:29:17.128] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:31:50.559] [004106] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:31:50.640] [004106] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-25 14:31:50.969] [004105] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:31:51.048] [004105] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 14:31:51.145] [004105] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 14:31:51.230] [004105] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-25 14:31:51.314] [004105] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 14:31:51.832] [004105] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 14:31:51.913] [004105] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 14:31:51.999] [004105] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-25 14:31:52.079] [004105] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 14:31:52.170] [004105] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-25 14:31:52.252] [004105] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 14:31:52.528] [004105] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 14:31:52.612] [004105] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 14:31:52.699] [004105] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-25 14:31:52.782] [004105] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 14:31:57.607] [004106] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:31:57.755] [004106] [dwh-prod] [PGSQL]
drop table if exists moiram.daily_status_snapshot;

create table moiram.daily_status_snapshot (
day_timestamp timestamp(6),
gcsi_user_id int8,
subscription_id int8,
paid_through_date timestamp(6),
status text 
);

alter table moiram.daily_status_snapshot owner to dw_admin;

drop table if exists moiram.daily_status_y2016q1;

create table moiram.daily_status_y2016q1(
check ( day_timestamp >=  '20160101'::date 
--and day_timestamp <  '20160401'::date
)
) inherits (moiram.daily_status_snapshot);

create index idx_ds_y2016q1_ts on moiram.daily_status_y2016q1 (day_timestamp);
create index idx_ds_y2016q1_sid on moiram.daily_status_y2016q1 (subscription_id);
create index idx_ds_y2016q1_guid on moiram.daily_status_y2016q1 (gcsi_user_id);
create index idx_ds_y2016q1_pdate on moiram.daily_status_y2016q1 (paid_through_date);
create index idx_ds_y2016q1_status on moiram.daily_status_y2016q1 (status);
create index idx_ds_y2016q1_pdate_ts on moiram.daily_status_y2016q1 (day_timestamp, paid_through_date);

alter table moiram.daily_status_y2016q1 owner to dw_admin;

drop table if exists moiram.daily_status_y2015q4;

create table moiram.daily_status_y2015q4(
check ( day_timestamp >=  '20150701'::date and day_timestamp <  '20151001'::date)
) inherits (moiram.daily_status_snapshot);

create index idx_ds_y2015q4_ts on moiram.daily_status_y2015q4 (day_timestamp);
create index idx_ds_y2015q4_sid on moiram.daily_status_y2015q4 (subscription_id);
create index idx_ds_y2015q4_guid on moiram.daily_status_y2015q4 (gcsi_user_id);
create index idx_ds_y2015q4_pdate on moiram.daily_status_y2015q4 (paid_through_date);
create index idx_ds_y2015q4_status on moiram.daily_status_y2015q4 (status);
create index idx_ds_y2015q4_pdate_ts on moiram.daily_status_y2015q4 (day_timestamp, paid_through_date);

alter table moiram.daily_status_y2015q4 owner to dw_admin;

drop table if exists moiram.daily_status_y2015q3;

create table moiram.daily_status_y2015q3(
check ( day_timestamp >=  '20150701'::date and day_timestamp <  '20151001'::date)
) inherits (moiram.daily_status_snapshot);

create index idx_ds_y2015q3_ts on moiram.daily_status_y2015q3 (day_timestamp);
create index idx_ds_y2015q3_sid on moiram.daily_status_y2015q3 (subscription_id);
create index idx_ds_y2015q3_guid on moiram.daily_status_y2015q3 (gcsi_user_id);
create index idx_ds_y2015q3_pdate on moiram.daily_status_y2015q3 (paid_through_date);
create index idx_ds_y2015q3_status on moiram.daily_status_y2015q3 (status);
create index idx_ds_y2015q3_pdate_ts on moiram.daily_status_y2015q3 (day_timestamp, paid_through_date);

alter table moiram.daily_status_y2015q3 owner to dw_admin;

drop table if exists moiram.daily_status_y2015q2;

create table moiram.daily_status_y2015q2(
check ( day_timestamp >=  '20150401'::date and day_timestamp <  '20150701'::date)
) inherits (moiram.daily_status_snapshot);

create index idx_ds_y2015q2_ts on moiram.daily_status_y2015q2 (day_timestamp);
create index idx_ds_y2015q2_sid on moiram.daily_status_y2015q2 (subscription_id);
create index idx_ds_y2015q2_guid on moiram.daily_status_y2015q2 (gcsi_user_id);
create index idx_ds_y2015q2_pdate on moiram.daily_status_y2015q2 (paid_through_date);
create index idx_ds_y2015q2_status on moiram.daily_status_y2015q2 (status);
create index idx_ds_y2015q2_pdate_ts on moiram.daily_status_y2015q2 (day_timestamp, paid_through_date);

alter table moiram.daily_status_y2015q2 owner to dw_admin;

drop table if exists moiram.daily_status_y2015q1;

create table moiram.daily_status_y2015q1(
check ( day_timestamp >=  '20150101'::date and day_timestamp <  '20150401'::date)
) inherits (moiram.daily_status_snapshot);

create index idx_ds_y2015q1_ts on moiram.daily_status_y2015q1 (day_timestamp);
create index idx_ds_y2015q1_sid on moiram.daily_status_y2015q1 (subscription_id);
create index idx_ds_y2015q1_guid on moiram.daily_status_y2015q1 (gcsi_user_id);
create index idx_ds_y2015q1_pdate on moiram.daily_status_y2015q1 (paid_through_date);
create index idx_ds_y2015q1_status on moiram.daily_status_y2015q1 (status);
create index idx_ds_y2015q1_pdate_ts on moiram.daily_status_y2015q1 (day_timestamp, paid_through_date);

alter table moiram.daily_status_y2015q1 owner to dw_admin;

drop table if exists moiram.daily_status_y2014q4;

create table moiram.daily_status_y2014q4(
check ( day_timestamp >=  '20141001'::date and day_timestamp <  '20150101'::date)
) inherits (moiram.daily_status_snapshot);

create index idx_ds_y2014q4_ts on moiram.daily_status_y2014q4 (day_timestamp);
create index idx_ds_y2014q4_sid on moiram.daily_status_y2014q4 (subscription_id);
create index idx_ds_y2014q4_guid on moiram.daily_status_y2014q4 (gcsi_user_id);
create index idx_ds_y2014q4_pdate on moiram.daily_status_y2014q4 (paid_through_date);
create index idx_ds_y2014q4_status on moiram.daily_status_y2014q4 (status);
create index idx_ds_y2014q4_pdate_ts on moiram.daily_status_y2014q4 (day_timestamp, paid_through_date);

alter table moiram.daily_status_y2014q4 owner to dw_admin;

drop table if exists moiram.daily_status_y2014q3;

create table moiram.daily_status_y2014q3(
check ( day_timestamp >=  '20140701'::date and day_timestamp <  '20141001'::date)
) inherits (moiram.daily_status_snapshot);

create index idx_ds_y2014q3_ts on moiram.daily_status_y2014q3 (day_timestamp);
create index idx_ds_y2014q3_sid on moiram.daily_status_y2014q3 (subscription_id);
create index idx_ds_y2014q3_guid on moiram.daily_status_y2014q3 (gcsi_user_id);
create index idx_ds_y2014q3_pdate on moiram.daily_status_y2014q3 (paid_through_date);
create index idx_ds_y2014q3_status on moiram.daily_status_y2014q3 (status);
create index idx_ds_y2014q3_pdate_ts on moiram.daily_status_y2014q3 (day_timestamp, paid_through_date);

alter table moiram.daily_status_y2014q3 owner to dw_admin;

drop table if exists moiram.daily_status_y2014q2;

create table moiram.daily_status_y2014q2(
check ( day_timestamp >=  '20140401'::date and day_timestamp <  '20140701'::date)
) inherits (moiram.daily_status_snapshot);

create index idx_ds_y2014q2_ts on moiram.daily_status_y2014q2 (day_timestamp);
create index idx_ds_y2014q2_sid on moiram.daily_status_y2014q2 (subscription_id);
create index idx_ds_y2014q2_guid on moiram.daily_status_y2014q2 (gcsi_user_id);
create index idx_ds_y2014q2_pdate on moiram.daily_status_y2014q2 (paid_through_date);
create index idx_ds_y2014q2_status on moiram.daily_status_y2014q2 (status);
create index idx_ds_y2014q2_pdate_ts on moiram.daily_status_y2014q2 (day_timestamp, paid_through_date);

alter table moiram.daily_status_y2014q2 owner to dw_admin;

drop table if exists moiram.daily_status_y2014q1;

create table moiram.daily_status_y2014q1(
check ( day_timestamp >=  '20140101'::date and day_timestamp <  '20140401'::date)
) inherits (moiram.daily_status_snapshot);

create index idx_ds_y2014q1_ts on moiram.daily_status_y2014q1 (day_timestamp);
create index idx_ds_y2014q1_sid on moiram.daily_status_y2014q1 (subscription_id);
create index idx_ds_y2014q1_guid on moiram.daily_status_y2014q1 (gcsi_user_id);
create index idx_ds_y2014q1_pdate on moiram.daily_status_y2014q1 (paid_through_date);
create index idx_ds_y2014q1_status on moiram.daily_status_y2014q1 (status);
create index idx_ds_y2014q1_pdate_ts on moiram.daily_status_y2014q1 (day_timestamp, paid_through_date);

alter table moiram.daily_status_y2014q1 owner to dw_admin;

-- this is so we can insert into daily_status_snapshot and
-- the insert into the correct partition will be triggered.
-- we're not actually using this functionality currently.

create or replace function moiram.daily_status_insert_trigger()
returns trigger as $$
begin 
  if  (NEW.day_timestamp >=  '20160101'::date) then
      insert into moiram.daily_status_y2016q1 values (NEW.*);
   elsif (NEW.day_timestamp >=  '20151001'::date and 
          NEW.day_timestamp <  '20160101'::date) then
      insert into moiram.daily_status_y2015q4 values (NEW.*);
   elsif (NEW.day_timestamp >=  '20150701'::date and 
          NEW.day_timestamp <  '20151001'::date) then
      insert into moiram.daily_status_y2015q3 values (NEW.*);
   elsif (NEW.day_timestamp >=  '20150401'::date and 
          NEW.day_timestamp <  '20150701'::date) then
      insert into moiram.daily_status_y2015q2 values (NEW.*);
   elsif (NEW.day_timestamp >=  '20150101'::date and 
          NEW.day_timestamp <  '20150401'::date) then
      insert into moiram.daily_status_y2015q1 values (NEW.*);
   elsif (NEW.day_timestamp >=  '20141001'::date and 
          NEW.day_timestamp <  '20150101'::date) then
      insert into moiram.daily_status_y2014q4 values (NEW.*);
   elsif (NEW.day_timestamp >=  '20140701'::date and 
          NEW.day_timestamp <  '20141001'::date) then
      insert into moiram.daily_status_y2014q3 values (NEW.*);
   elsif (NEW.day_timestamp >=  '20140401'::date and 
          NEW.day_timestamp <  '20140701'::date) then
      insert into moiram.daily_status_y2014q2 values (NEW.*);
   elsif (NEW.day_timestamp >=  '20140101'::date and 
          NEW.day_timestamp <  '20140401'::date) then
      insert into moiram.daily_status_y2014q1 values (NEW.*);
   end if;
   return null;
end;
$$
language plpgsql;

alter function moiram.daily_status_insert_trigger() owner to dw_admin;

create trigger insert_dss_trigger
    before insert on moiram.daily_status_snapshot
    for each row execute procedure moiram.daily_status_insert_trigger();
    


[2016-02-25 14:31:58.477] [004106] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:33:45.543] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:33:45.657] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2014q1;
 
       
  insert into moiram.daily_status_y2014q1
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp > ptd.schedule_date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= [&start]
    --and day_timestamp < current_date::date
     and day_timestamp < [&end]::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= [&start] or
        ud.paid_through_date >= [&start] or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 14:33:45.738] [000940] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "["
LINE 76:   where day_key >= [&start]
                            ^


[2016-02-25 14:33:45.756] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:34:22.717] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:34:22.838] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2014q1;
 
       
  insert into moiram.daily_status_y2014q1
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp > ptd.schedule_date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= '20140101'
    --and day_timestamp < current_date::date
     and day_timestamp < '20140401'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20140101' or
        ud.paid_through_date >= '20140101' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 14:38:29.056] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:41:36.852] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:41:36.970] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2014q2;
 
       
  insert into moiram.daily_status_y2014q2
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp > ptd.schedule_date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= '20140401'
    --and day_timestamp < current_date::date
     and day_timestamp < '20140701'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20140401' or
        ud.paid_through_date >= '20140401' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 14:43:10.903] [017501] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:43:10.982] [017501] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 14:43:11.091] [017501] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-25 14:43:11.177] [017501] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 14:43:11.700] [017501] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 14:43:11.781] [017501] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 14:43:11.869] [017501] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-25 14:43:20.164] [004106] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:43:20.265] [004106] [dwh-prod] [PGSQL]
select count(1) from common.daily_status_y2014q1


[2016-02-25 14:43:24.359] [004106] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:44:42.638] [004106] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:44:42.755] [004106] [dwh-prod] [PGSQL]
select * from common.daily_status_y2014q1
except select * from moiram.daily_status_y2014q1


[2016-02-25 14:45:08.468] [004106] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:46:36.908] [025270] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:46:36.989] [025270] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='daily_status_y2014q1' ORDER BY ordinal_position

[2016-02-25 14:46:55.514] [004106] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:46:55.627] [004106] [dwh-prod] [PGSQL]
select * from common.daily_status_y2014q1 where gcsi_user_id = 14239253;


[2016-02-25 14:46:55.724] [004106] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:46:56.165] [004106] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5716331

[2016-02-25 14:47:02.339] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:47:19.759] [004106] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:47:19.870] [004106] [dwh-prod] [PGSQL]
select * from common.daily_status_y2014q1 where gcsi_user_id = 14239253
order by day_timestamp;


[2016-02-25 14:47:19.968] [004106] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:47:20.481] [004106] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5716331

[2016-02-25 14:48:07.394] [027725] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:48:07.475] [027725] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-25 14:48:07.801] [027719] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:48:07.883] [027719] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 14:48:07.982] [027719] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 14:48:08.071] [027719] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-25 14:48:08.152] [027719] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 14:48:08.747] [027719] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 14:48:08.829] [027719] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 14:48:08.922] [027719] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-25 14:48:09.011] [027719] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 14:48:09.104] [027719] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-25 14:48:09.185] [027719] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 14:48:09.466] [027719] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 14:48:09.546] [027719] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 14:48:09.638] [027719] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-25 14:48:09.726] [027719] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-25 14:48:22.725] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:48:22.854] [027725] [dwh-prod] [PGSQL]
select * from moiram.daily_status_y2014q1 where gcsi_user_id = 14239253
order by day_timestamp;


[2016-02-25 14:48:22.951] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:48:23.387] [027725] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-25 14:50:06.031] [028766] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:50:06.111] [028766] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 14:50:06.223] [028766] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-25 14:50:06.306] [028766] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 14:50:07.089] [028766] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 14:50:07.169] [028766] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 14:50:07.255] [028766] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-25 14:50:29.410] [029488] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 14:50:29.492] [029488] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='paid_through_dates' ORDER BY ordinal_position

[2016-02-25 14:50:50.834] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:50:50.946] [027725] [dwh-prod] [PGSQL]
select * from tmp.paid_through_dates where subscription_id = 14239263;


[2016-02-25 14:50:51.039] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:50:51.478] [027725] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310353

[2016-02-25 14:52:56.836] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:52:56.954] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2014q1;
 
       
  insert into moiram.daily_status_y2014q1
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp >= ptd.schedule_date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= '20140101'
    --and day_timestamp < current_date::date
     and day_timestamp < '20140401'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20140101' or
        ud.paid_through_date >= '20140101' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 14:56:59.009] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:58:18.423] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:58:18.531] [027725] [dwh-prod] [PGSQL]
select * from moiram.daily_status_y2014q1 where gcsi_user_id = 14239253
order by day_timestamp;


[2016-02-25 14:58:18.625] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:58:19.061] [027725] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-25 14:59:24.889] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:59:24.997] [027725] [dwh-prod] [PGSQL]
select * from tmp.paid_through_dates where subscription_id = 14239263;


[2016-02-25 14:59:25.108] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:59:25.539] [027725] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310353

[2016-02-25 14:59:40.243] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 14:59:40.357] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2014q1;
 
       
  insert into moiram.daily_status_y2014q1
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp >= ptd.schedule_date::date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= '20140101'
    --and day_timestamp < current_date::date
     and day_timestamp < '20140401'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20140101' or
        ud.paid_through_date >= '20140101' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 15:03:50.298] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:05:42.760] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:05:42.878] [027725] [dwh-prod] [PGSQL]
select * from moiram.daily_status_y2014q1 where gcsi_user_id = 14239253
order by day_timestamp;


[2016-02-25 15:05:42.974] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:05:43.418] [027725] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-25 15:06:13.314] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:06:13.428] [027725] [dwh-prod] [PGSQL]
select count(1) from moiram.daily_status_y2014q1;


[2016-02-25 15:06:16.581] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:07:53.487] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:07:53.600] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2014q2;
 
       
  insert into moiram.daily_status_y2014q2
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp >= ptd.schedule_date::date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= '20140401'
    --and day_timestamp < current_date::date
     and day_timestamp < '20140701'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20140401' or
        ud.paid_through_date >= '20140401' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 15:13:16.665] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:21:45.085] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:21:45.192] [027725] [dwh-prod] [PGSQL]

select count(1) from moiram.daily_status_y2014q2;


[2016-02-25 15:21:49.725] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:22:25.047] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:22:25.167] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2014q3;
 
       
  insert into moiram.daily_status_y2014q3
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp >= ptd.schedule_date::date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= '20140701'
    --and day_timestamp < current_date::date
     and day_timestamp < '20141001'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20140701' or
        ud.paid_through_date >= '20140701' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 15:23:27.947] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:23:28.054] [027725] [dwh-prod] [PGSQL]
select count(1) from common.daily_status_y2014q2;


[2016-02-25 15:23:32.874] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:28:35.977] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:32:10.290] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:32:10.412] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2014q4;
 
       
  insert into moiram.daily_status_y2014q4
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp >= ptd.schedule_date::date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= '20141001'
    --and day_timestamp < current_date::date
     and day_timestamp < '20150101'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20141001' or
        ud.paid_through_date >= '20141001' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 15:39:03.938] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:47:24.036] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:47:24.180] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2015q1;
 
       
  insert into moiram.daily_status_y2015q1
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp >= ptd.schedule_date::date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= '20150101'
    --and day_timestamp < current_date::date
     and day_timestamp < '20150401'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20150101' or
        ud.paid_through_date >= '20150101' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 15:47:41.932] [008108] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 15:47:42.011] [008108] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-25 15:47:42.115] [008108] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-25 15:47:42.200] [008108] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-25 15:47:42.736] [008108] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-25 15:47:42.817] [008108] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-25 15:47:42.910] [008108] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-25 15:47:45.724] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:47:45.858] [027725] [dwh-prod] [PGSQL]
select count(1) from common.daily_status_y2014q3;


[2016-02-25 15:47:49.173] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:48:22.799] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:48:22.905] [027725] [dwh-prod] [PGSQL]
select count(1) from common.daily_status_y2014q4;


[2016-02-25 15:48:28.207] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:49:04.815] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:49:04.927] [027725] [dwh-prod] [PGSQL]
select count(1) from common.daily_status_y2015q1;


[2016-02-25 15:49:11.191] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:54:43.160] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:56:52.982] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 15:56:53.100] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2015q2;
 
       
  insert into moiram.daily_status_y2015q2
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp >= ptd.schedule_date::date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= '20150401'
    --and day_timestamp < current_date::date
     and day_timestamp < '20150701'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20150401' or
        ud.paid_through_date >= '20150401' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 16:04:39.141] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:07:38.411] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:07:38.531] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2015q3;
 
       
  insert into moiram.daily_status_y2015q3
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp >= ptd.schedule_date::date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= '20150701'
    --and day_timestamp < current_date::date
     and day_timestamp < '20151001'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20150701' or
        ud.paid_through_date >= '20150701' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 16:15:58.132] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:17:05.451] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:17:05.580] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2015q4;
 
       
  insert into moiram.daily_status_y2015q4
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp >= ptd.schedule_date::date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= '20151001'
    --and day_timestamp < current_date::date
     and day_timestamp < '20160101'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20151001' or
        ud.paid_through_date >= '20151001' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 16:17:59.109] [000940] [dwh-prod] [PGSQL]
ERROR:  new row for relation "daily_status_y2015q4" violates check constraint "daily_status_y2015q4_day_timestamp_check"
DETAIL:  Failing row contains (2015-10-01 00:00:00, 4714226, 4714231, 2015-10-11 02:36:44.717, Active).


[2016-02-25 16:17:59.786] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:24:35.717] [004106] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:24:35.839] [004106] [dwh-prod] [PGSQL]
drop table if exists moiram.daily_status_y2015q4;

create table moiram.daily_status_y2015q4(
check ( day_timestamp >=  '20151001'::date and day_timestamp <  '20160101'::date)
) inherits (moiram.daily_status_snapshot);

create index idx_ds_y2015q4_ts on moiram.daily_status_y2015q4 (day_timestamp);
create index idx_ds_y2015q4_sid on moiram.daily_status_y2015q4 (subscription_id);
create index idx_ds_y2015q4_guid on moiram.daily_status_y2015q4 (gcsi_user_id);
create index idx_ds_y2015q4_pdate on moiram.daily_status_y2015q4 (paid_through_date);
create index idx_ds_y2015q4_status on moiram.daily_status_y2015q4 (status);
create index idx_ds_y2015q4_pdate_ts on moiram.daily_status_y2015q4 (day_timestamp, paid_through_date);

alter table moiram.daily_status_y2015q4 owner to dw_admin;


[2016-02-25 16:24:36.115] [004106] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:24:44.732] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:24:44.849] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2015q4;
 
       
  insert into moiram.daily_status_y2015q4
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp >= ptd.schedule_date::date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= '20151001'
    --and day_timestamp < current_date::date
     and day_timestamp < '20160101'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20151001' or
        ud.paid_through_date >= '20151001' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 16:29:24.636] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:29:24.743] [027725] [dwh-prod] [PGSQL]
select count(1) from moiram.daily_status_y2015q2;


[2016-02-25 16:29:35.523] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:29:49.249] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:29:49.360] [027725] [dwh-prod] [PGSQL]
select count(1) from common.daily_status_y2015q2;


[2016-02-25 16:30:01.034] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:31:53.926] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:31:54.040] [027725] [dwh-prod] [PGSQL]
select * from moiram.daily_status_y2014q1 where gcsi_user_id = 14239253
order by day_timestamp;


select * from tmp.paid_through_dates where subscription_id = 14239263;

select count(1) from moiram.daily_status_y2015q2;

select count(1) from common.daily_status_y2015q2;

select day_timestamp, count(1), count(distinct gcsi_user_id) from common.daily_status_snapshot;


[2016-02-25 16:31:55.970] [027725] [dwh-prod] [PGSQL]
ERROR:  column "daily_status_snapshot.day_timestamp" must appear in the GROUP BY clause or be used in an aggregate function
LINE 11: select day_timestamp, count(1), count(distinct gcsi_user_id)...
                ^


[2016-02-25 16:31:55.988] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:31:56.453] [027725] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-25 16:31:56.923] [027725] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310353

[2016-02-25 16:32:22.305] [023914] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 16:32:22.387] [023914] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='daily_status_snapshot' ORDER BY ordinal_position

[2016-02-25 16:32:30.669] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:32:30.796] [027725] [dwh-prod] [PGSQL]
select day_timestamp, count(1), count(distinct gcsi_user_id) from common.daily_status_snapshot
group by day_timestamp;


[2016-02-25 16:33:55.414] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:39:59.992] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:40:00.438] [027725] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5642984

[2016-02-25 16:48:49.268] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:48:49.389] [000940] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2016q1;
 
       
  insert into moiram.daily_status_y2016q1
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp >= ptd.schedule_date::date and
         day_timestamp <= ptd.paid_through_date
  where day_key >= '20160101'
    and day_timestamp < current_date::date
     --and day_timestamp < [$end]::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20160101' or
        ud.paid_through_date >= '20160101' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-25 16:49:19.753] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:49:19.862] [027725] [dwh-prod] [PGSQL]
create table moiram.t2 as
select day_timestamp, count(1), count(distinct gcsi_user_id) from moiram.daily_status_snapshot
group by day_timestamp;


[2016-02-25 16:53:37.249] [027725] [dwh-prod] [PGSQL]
ERROR:  column "count" specified more than once


[2016-02-25 16:53:37.258] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:53:37.267] [000940] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:57:28.811] [015607] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-25 16:57:28.895] [015607] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='moiram' AND table_name='daily_status_snapshot' ORDER BY ordinal_position

[2016-02-25 16:57:55.531] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:57:55.638] [027725] [dwh-prod] [PGSQL]
create table moiram.t2 as
select day_timestamp, count(1) num_rows, count(distinct gcsi_user_id) num_users from moiram.daily_status_snapshot
group by day_timestamp;


[2016-02-25 16:57:55.718] [027725] [dwh-prod] [PGSQL]
ERROR:  relation "t2" already exists


[2016-02-25 16:57:55.731] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:58:13.702] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:58:13.818] [027725] [dwh-prod] [PGSQL]
drop table moiram.t2;


[2016-02-25 16:58:13.946] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:58:16.603] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 16:58:16.710] [027725] [dwh-prod] [PGSQL]

create table moiram.t2 as
select day_timestamp, count(1) num_rows, count(distinct gcsi_user_id) num_users from moiram.daily_status_snapshot
group by day_timestamp;


[2016-02-25 17:34:06.917] [027725] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-25 17:34:06.928] [027725] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-25 17:34:06.928] [027725] [dwh-prod] [PGSQL]
no connection to the server


[2016-02-25 17:34:06.929] [027725] [dwh-prod] [PGSQL]
could not connect to server: Network is unreachable (0x00002743/10051)
	Is the server running on host "172.16.2.166" and accepting
	TCP/IP connections on port 5432?


[2016-02-26 09:57:31.425] [021102] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 09:57:31.513] [021102] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='moiram' AND table_name='t2' ORDER BY ordinal_position

[2016-02-26 09:57:44.835] [027725] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 09:57:44.835] [027725] [dwh-prod] [PGSQL]
no connection to the server


[2016-02-26 09:57:45.432] [021155] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 09:57:45.517] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 09:57:45.633] [021155] [dwh-prod] [PGSQL]
drop table t2;

create table t2 as
select day_timestamp, count(1) num_rows, count(distinct gcsi_user_id) num_users from moiram.daily_status_y2014q1
group by day_timestamp;

select count(1) from t2 where num_rows <> num_users;


[2016-02-26 09:58:21.128] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:09:20.100] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:09:20.201] [021155] [dwh-prod] [PGSQL]
select * from t2 where num_rows <> num_users;


[2016-02-26 10:09:20.297] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:09:20.621] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329853

[2016-02-26 10:10:43.886] [025366] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 10:10:43.972] [025366] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='moiram' AND table_name='daily_status_y2014q1' ORDER BY ordinal_position

[2016-02-26 10:12:13.716] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:12:13.830] [021155] [dwh-prod] [PGSQL]
select * 
from moiram.daily_status_y2014q1
where day_timestamp = '20140101'
  and gcsi_user_id in 
    (select gcsi_user_id 
     from moiram.daily_status_y2014q1
      where day_timestamp = '20140101'
    group by gcis_user_id
    having count(1) > 1);


[2016-02-26 10:12:13.914] [021155] [dwh-prod] [PGSQL]
ERROR:  column "gcis_user_id" does not exist
LINE 8:     group by gcis_user_id
                     ^


[2016-02-26 10:12:13.927] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:12:25.528] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:12:25.643] [021155] [dwh-prod] [PGSQL]
select * 
from moiram.daily_status_y2014q1
where day_timestamp = '20140101'
  and gcsi_user_id in 
    (select gcsi_user_id 
     from moiram.daily_status_y2014q1
      where day_timestamp = '20140101'
    group by gcsi_user_id
    having count(1) > 1);


[2016-02-26 10:12:26.257] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:12:26.706] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 10:14:13.808] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:14:13.917] [021155] [dwh-prod] [PGSQL]
select * from tmp.paid_through_dates where subscription_id = 11760905;


[2016-02-26 10:14:14.011] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:14:14.467] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329796

[2016-02-26 10:16:00.873] [000940] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:16:00.875] [000940] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-26 10:16:01.700] [027034] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 10:16:01.817] [027034] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:16:01.962] [027034] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2014q1;
 
       
  insert into moiram.daily_status_y2014q1
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp >= ptd.schedule_date::date and
         day_timestamp < ptd.paid_through_date::date
  where day_key >= '20140101'
    --and day_timestamp < current_date::date
     and day_timestamp < '20140401'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20140101' or
        ud.paid_through_date >= '20140101' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-26 10:20:11.491] [027034] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:25:33.817] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:25:33.910] [021155] [dwh-prod] [PGSQL]
drop table t2;

create table t2 as
select day_timestamp, count(1) num_rows, count(distinct gcsi_user_id) num_users from moiram.daily_status_y2014q1
group by day_timestamp;

--select * from t2 where num_rows <> num_users;

select * 
from moiram.daily_status_y2014q1
where day_timestamp = '20140101'
  and gcsi_user_id in 
    (select gcsi_user_id 
     from moiram.daily_status_y2014q1
      where day_timestamp = '20140101'
    group by gcsi_user_id
    having count(1) > 1);


[2016-02-26 10:25:43.358] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:25:43.551] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 10:30:17.453] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:30:17.573] [021155] [dwh-prod] [PGSQL]
select status, count(1)
from user_d 
where valid_from <= '20140101'
  and valid_to >= '20140101'
group by status;


[2016-02-26 10:30:17.893] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:30:18.259] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 10:31:35.376] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:31:35.484] [021155] [dwh-prod] [PGSQL]
select status, count(1) 
from daily_status_y2014q1
where day_timestamp = '20140101'
group by status;


[2016-02-26 10:31:35.642] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:31:35.983] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 10:33:50.957] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:33:51.082] [021155] [dwh-prod] [PGSQL]
select status, count(1) 
from common.daily_status_y2014q1
where day_timestamp = '20140101'
group by status;


[2016-02-26 10:33:51.542] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:33:51.961] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5716331

[2016-02-26 10:41:27.730] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:41:27.837] [021155] [dwh-prod] [PGSQL]
select *
from common.daily_status_y2014q1
except 
select *
from moiram.daily_status_y2014q1


[2016-02-26 10:41:46.031] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:45:28.264] [012218] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 10:45:28.350] [012218] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='daily_status_y2014q1' ORDER BY ordinal_position

[2016-02-26 10:46:22.810] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:46:23.297] [021155] [dwh-prod] [PGSQL]
select count(*) from common.daily_status_y2014q1
where paid_through_date > '20150401'


[2016-02-26 10:46:24.818] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:47:18.400] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:47:18.518] [021155] [dwh-prod] [PGSQL]
select gcsi_user_id, subscription_id, status
from common.daily_status_y2014q1
where day_timestamp = '20140101'
except 
select gcsi_user_id, subscription_id, status
from moiram.daily_status_y2014q1
where day_timestamp = '20140101';


[2016-02-26 10:47:18.771] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:48:42.072] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:48:42.178] [021155] [dwh-prod] [PGSQL]
select * from common.user_d where subscription_id in (13121187,12776127)


[2016-02-26 10:48:42.274] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:48:42.693] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 10:49:57.239] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:49:57.352] [021155] [dwh-prod] [PGSQL]
select gcsi_user_id, subscription_id, status
from common.daily_status_y2014q1
where day_timestamp = '20140101'
except 
select gcsi_user_id, subscription_id, status
from moiram.daily_status_y2014q1
where day_timestamp = '20140101';


[2016-02-26 10:49:57.623] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:50:32.436] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:50:32.551] [021155] [dwh-prod] [PGSQL]
select * from common.user_d where gcsi_user_id in (168578,12776120)


[2016-02-26 10:50:32.987] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:50:33.427] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 10:52:24.350] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:52:24.465] [021155] [dwh-prod] [PGSQL]
select gcsi_user_id, subscription_id, status
from common.daily_status_y2014q1
where day_timestamp = '20140101'
except 
select gcsi_user_id, subscription_id, status
from moiram.daily_status_y2014q1
where day_timestamp = '20140101';


select * from common.user_d where gcsi_user_id in (168578,12776120);

select * from common.subscription_d where gcsi_user_id in (168578,12776120);


[2016-02-26 10:52:24.849] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:52:25.600] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 10:52:26.077] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329767

[2016-02-26 10:58:54.247] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:58:54.392] [021155] [dwh-prod] [PGSQL]
select gcsi_user_id, subscription_id, status
from common.daily_status_y2014q1
where day_timestamp = '20140101'
except 
select gcsi_user_id, subscription_id, status
from moiram.daily_status_y2014q1
where day_timestamp = '20140101';


select * from common.user_d where gcsi_user_id in (168578,12776120);

select * from common.subscription_d where gcsi_user_id in (168578,12776120);

select * from common.daily_status_y2014q1 
where day_timestamp = '20140101'
  and gcsi_user_id in (168578,12776120);

select * from moiram.daily_status_y2014q1 
where day_timestamp = '20140101'
  and gcsi_user_id in (168578,12776120);


[2016-02-26 10:58:54.783] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 10:58:55.569] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 10:58:56.003] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329767

[2016-02-26 10:58:56.503] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5716331

[2016-02-26 10:58:56.967] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 11:04:14.606] [017978] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 11:04:14.688] [017978] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-26 11:04:15.047] [017977] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 11:04:15.130] [017977] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-26 11:04:15.236] [017977] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 11:04:15.329] [017977] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-26 11:04:15.412] [017977] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 11:04:15.931] [017977] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 11:04:16.060] [017977] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 11:04:16.146] [017977] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-26 11:04:16.228] [017977] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 11:04:16.320] [017977] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-26 11:04:16.401] [017977] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 11:04:16.676] [017977] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 11:04:16.758] [017977] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 11:04:16.841] [017977] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-26 11:04:16.923] [017977] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-26 11:04:21.771] [018024] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 11:04:21.851] [018024] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'gcsi') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 11:04:21.993] [018024] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='gcsi' ORDER BY schemaname, viewname

[2016-02-26 11:04:22.106] [018024] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 11:04:22.623] [018024] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 11:04:22.703] [018024] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'gcsi' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 11:04:22.858] [018024] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'gcsi' 

[2016-02-26 11:04:39.167] [017978] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:04:39.296] [017978] [dwh-prod] [PGSQL]
select gcsi.subscription_hold limit 1


[2016-02-26 11:04:39.377] [017978] [dwh-prod] [PGSQL]
ERROR:  missing FROM-clause entry for table "gcsi"
LINE 1: select gcsi.subscription_hold limit 1
               ^


[2016-02-26 11:04:39.391] [017978] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:04:45.994] [017978] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:04:46.114] [017978] [dwh-prod] [PGSQL]
select * from gcsi.subscription_hold limit 1


[2016-02-26 11:04:46.209] [017978] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:04:46.635] [017978] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6328694

[2016-02-26 11:05:17.310] [018309] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 11:05:17.389] [018309] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'gcsi') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 11:05:17.529] [018309] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='gcsi' ORDER BY schemaname, viewname

[2016-02-26 11:05:17.638] [018309] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 11:05:18.318] [018309] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 11:05:18.400] [018309] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'gcsi' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 11:05:18.554] [018309] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'gcsi' 

[2016-02-26 11:05:23.835] [018345] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 11:05:23.914] [018345] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='gcsi' AND table_name='subscription_hold' ORDER BY ordinal_position

[2016-02-26 11:06:00.327] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:06:00.461] [021155] [dwh-prod] [PGSQL]
/*
select * from moiram.daily_status_y2014q1 where gcsi_user_id = 14239253
order by day_timestamp;


select * from tmp.paid_through_dates where subscription_id = 11760905;

select count(1) from moiram.daily_status_y2015q2;

select count(1) from common.daily_status_y2015q2;

drop table t2;

create table t2 as
select day_timestamp, count(1) num_rows, count(distinct gcsi_user_id) num_users from moiram.daily_status_y2014q1
group by day_timestamp;

--select * from t2 where num_rows <> num_users;

select * 
from moiram.daily_status_y2014q1
where day_timestamp = '20140101'
  and gcsi_user_id in 
    (select gcsi_user_id 
     from moiram.daily_status_y2014q1
      where day_timestamp = '20140101'
    group by gcsi_user_id
    having count(1) > 1);


select status, count(1)
from user_d 
where valid_from <= '20140101'
  and valid_to >= '20140101'
group by status;

select status, count(1) 
from daily_status_y2014q1
where day_timestamp = '20140101'
group by status;

select status, count(1) 
from common.daily_status_y2014q1
where day_timestamp = '20140101'
group by status;
*/
select gcsi_user_id, subscription_id, status
from common.daily_status_y2014q1
where day_timestamp = '20140101'
except 
select gcsi_user_id, subscription_id, status
from moiram.daily_status_y2014q1
where day_timestamp = '20140101';


select * from common.user_d where gcsi_user_id in (168578,12776120);

select * from common.subscription_d where gcsi_user_id in (168578,12776120);

select * from common.daily_status_y2014q1 
where day_timestamp = '20140101'
  and gcsi_user_id in (168578,12776120);

select * from moiram.daily_status_y2014q1 
where day_timestamp = '20140101'
  and gcsi_user_id in (168578,12776120);

select * from gcsi.subscription_hold where subscription_id in (13121187,
12776127)

       


[2016-02-26 11:06:00.903] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:06:01.583] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 11:06:01.983] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329767

[2016-02-26 11:06:02.364] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5716331

[2016-02-26 11:06:02.724] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 11:06:03.073] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6328694

[2016-02-26 11:08:14.298] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:08:14.471] [021155] [dwh-prod] [PGSQL]
/*
select * from moiram.daily_status_y2014q1 where gcsi_user_id = 14239253
order by day_timestamp;


select * from tmp.paid_through_dates where subscription_id = 11760905;

select count(1) from moiram.daily_status_y2015q2;

select count(1) from common.daily_status_y2015q2;

drop table t2;

create table t2 as
select day_timestamp, count(1) num_rows, count(distinct gcsi_user_id) num_users from moiram.daily_status_y2014q1
group by day_timestamp;

--select * from t2 where num_rows <> num_users;

select * 
from moiram.daily_status_y2014q1
where day_timestamp = '20140101'
  and gcsi_user_id in 
    (select gcsi_user_id 
     from moiram.daily_status_y2014q1
      where day_timestamp = '20140101'
    group by gcsi_user_id
    having count(1) > 1);


select status, count(1)
from user_d 
where valid_from <= '20140101'
  and valid_to >= '20140101'
group by status;
*/
select status, count(1) 
from daily_status_y2014q1
where day_timestamp = '20140101'
group by status;

select status, count(1) 
from common.daily_status_y2014q1
where day_timestamp = '20140101'
group by status;

select gcsi_user_id, subscription_id, status
from common.daily_status_y2014q1
where day_timestamp = '20140101'
except 
select gcsi_user_id, subscription_id, status
from moiram.daily_status_y2014q1
where day_timestamp = '20140101';


select * from common.user_d where gcsi_user_id in (168578,12776120);

select * from common.subscription_d where gcsi_user_id in (168578,12776120);

select * from common.daily_status_y2014q1 
where day_timestamp = '20140101'
  and gcsi_user_id in (168578,12776120);

select * from moiram.daily_status_y2014q1 
where day_timestamp = '20140101'
  and gcsi_user_id in (168578,12776120);

select * from gcsi.subscription_hold where subscription_id in (13121187,
12776127)

       


[2016-02-26 11:08:15.020] [021155] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:08:15.455] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 11:08:15.891] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5716331

[2016-02-26 11:08:16.819] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 11:08:17.356] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329767

[2016-02-26 11:08:17.824] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5716331

[2016-02-26 11:08:18.298] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 11:08:18.747] [021155] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6328694

[2016-02-26 11:10:33.484] [027034] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:10:33.615] [027034] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2014q2;
 
       
  insert into moiram.daily_status_y2014q2
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp >= ptd.schedule_date::date and
         day_timestamp < ptd.paid_through_date::date
  where day_key >= '20140401'
    --and day_timestamp < current_date::date
     and day_timestamp < '20140701'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20140401' or
        ud.paid_through_date >= '20140401' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-26 11:12:17.927] [021155] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:12:18.086] [021155] [dwh-prod] [PGSQL]
select * from subscription_d where subscription_id in 
(select subscription_id from common.daily_status_snapshot where status = 'Cancelled');


[2016-02-26 11:12:45.632] [022958] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:12:46.050] [022958] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329767

[2016-02-26 11:12:52.142] [010717] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:12:52.143] [010717] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-26 11:12:52.740] [023204] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 11:12:52.819] [023204] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:12:52.940] [023204] [dwh-prod] [PGSQL]
select pid, query from pg_stat_activity
WHERE state = 'active';


[2016-02-26 11:12:53.050] [023204] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:12:53.470] [023204] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 11283

[2016-02-26 11:13:06.459] [023204] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:13:06.565] [023204] [dwh-prod] [PGSQL]
SELECT pg_cancel_backend(27034);


[2016-02-26 11:13:06.646] [027034] [dwh-prod] [PGSQL]
ERROR:  canceling statement due to user request


[2016-02-26 11:13:06.657] [023204] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:13:07.111] [027034] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:13:50.972] [022958] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:13:51.081] [022958] [dwh-prod] [PGSQL]
select * from subscription_d where subscription_id in 
(select subscription_id from moiram.daily_status_y2014q1  where status = 'Cancelled');


[2016-02-26 11:13:53.365] [022958] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:13:53.788] [022958] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329767

[2016-02-26 11:15:11.763] [022958] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:15:11.884] [022958] [dwh-prod] [PGSQL]
select * from subscription_d where subscription_id in 
(select subscription_id from moiram.daily_status_y2014q1  where status = 'Cancelled' and day_timestamp = '20140101');
 


[2016-02-26 11:15:12.225] [022958] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:15:12.649] [022958] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329767

[2016-02-26 11:17:43.237] [022958] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:17:43.353] [022958] [dwh-prod] [PGSQL]
select * from moiram.daily_status_y2014q1  where status = 'Cancelled' and day_timestamp = '20140101');
       


[2016-02-26 11:17:43.434] [022958] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near ")"
LINE 1: ... where status = 'Cancelled' and day_timestamp = '20140101');
                                                                     ^


[2016-02-26 11:17:43.446] [022958] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:17:55.589] [022958] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:17:55.718] [022958] [dwh-prod] [PGSQL]
select * from moiram.daily_status_y2014q1  where status = 'Cancelled' and day_timestamp = '20140101';


[2016-02-26 11:17:56.028] [022958] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:17:56.488] [022958] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 11:18:25.169] [022958] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:18:25.279] [022958] [dwh-prod] [PGSQL]
select max(paid_through_date) from moiram.daily_status_y2014q1  where status = 'Cancelled' and day_timestamp = '20140101';
 


[2016-02-26 11:18:25.518] [022958] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:19:37.984] [022958] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:19:38.099] [022958] [dwh-prod] [PGSQL]
select * from moiram.daily_status_y2014q1  
where status = 'Cancelled' and day_timestamp = '20140101' and paid_through_date >'20140101';


[2016-02-26 11:19:38.233] [022958] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:19:38.652] [022958] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 11:21:12.526] [022958] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:21:12.640] [022958] [dwh-prod] [PGSQL]
select * from subscription_d where subscription_id in (8846316,12075219);


[2016-02-26 11:21:12.745] [022958] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 11:21:13.155] [022958] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329767

[2016-02-26 13:28:32.999] [003715] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 13:28:33.078] [003715] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='gcsi' AND table_name='t_subscriptions' ORDER BY ordinal_position

[2016-02-26 13:28:56.587] [022958] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:28:56.588] [022958] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-26 13:28:57.225] [003859] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 13:28:57.332] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:28:57.441] [003859] [dwh-prod] [PGSQL]
select * from gcsi.t_subscriptions where id = 8846316


[2016-02-26 13:28:57.528] [003859] [dwh-prod] [PGSQL]
ERROR:  column "id" does not exist
LINE 1: select * from gcsi.t_subscriptions where id = 8846316
                                                 ^


[2016-02-26 13:28:57.546] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:29:12.431] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:29:12.537] [003859] [dwh-prod] [PGSQL]
select * from gcsi.t_subscriptions where subscription_id = 8846316


[2016-02-26 13:29:14.869] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:29:15.280] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329065

[2016-02-26 13:30:27.461] [004338] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 13:30:27.540] [004338] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-26 13:30:27.887] [004337] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 13:30:27.969] [004337] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-26 13:30:28.073] [004337] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 13:30:28.192] [004337] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-26 13:30:28.289] [004337] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 13:30:28.827] [004337] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 13:30:28.917] [004337] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 13:30:29.007] [004337] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-26 13:30:29.087] [004337] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 13:30:29.184] [004337] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-26 13:30:29.267] [004337] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 13:30:29.556] [004337] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 13:30:29.636] [004337] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 13:30:29.720] [004337] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-26 13:30:29.803] [004337] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-26 13:30:52.179] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:30:52.284] [003859] [dwh-prod] [PGSQL]
select * from common.user_d where subscription_id in (8846316,12075219);


[2016-02-26 13:30:52.384] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:30:52.823] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 13:32:29.810] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:32:29.919] [003859] [dwh-prod] [PGSQL]
select * from gcsi.t_subscriptions where subscription_id = 8846316


[2016-02-26 13:32:31.117] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:32:31.510] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329065

[2016-02-26 13:32:53.562] [005114] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 13:32:53.641] [005114] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-26 13:32:54.024] [005113] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 13:32:54.103] [005113] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-26 13:32:54.200] [005113] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 13:32:54.286] [005113] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-26 13:32:54.367] [005113] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 13:32:54.895] [005113] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 13:32:54.975] [005113] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 13:32:55.062] [005113] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-26 13:32:55.143] [005113] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 13:32:55.240] [005113] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-26 13:32:55.324] [005113] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 13:32:55.599] [005113] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 13:32:55.686] [005113] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 13:32:55.774] [005113] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-26 13:32:55.864] [005113] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-26 13:34:09.345] [005468] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 13:34:09.428] [019188] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 't_uniq_subs' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 13:34:09.429] [019188] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-26 13:34:10.010] [005469] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 13:34:10.090] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 't_uniq_subs' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 13:34:10.232] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 13:34:10.631] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 13:34:10.714] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 't_uniq_subs' AND conname IS NOT NULL

[2016-02-26 13:34:10.802] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 't_uniq_subs' ORDER BY t.relname, i.oid

[2016-02-26 13:34:10.894] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 't_uniq_subs' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 13:34:11.153] [005468] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."t_uniq_subs" LIMIT 1000 OFFSET 0

[2016-02-26 13:34:11.820] [005468] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 't_uniq_subs'

[2016-02-26 13:34:11.923] [005468] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329482

[2016-02-26 13:34:33.290] [005468] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."t_uniq_subs" WHERE "subscription_id" = '8846316' LIMIT 1000 OFFSET 0

[2016-02-26 13:34:33.617] [005468] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 't_uniq_subs'

[2016-02-26 13:34:33.713] [005468] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329482

[2016-02-26 13:35:36.690] [005918] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 13:35:36.775] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'user_activity_tmp' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 13:35:36.879] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 13:35:37.216] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 13:35:37.298] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'user_activity_tmp' AND conname IS NOT NULL

[2016-02-26 13:35:37.390] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'user_activity_tmp' ORDER BY t.relname, i.oid

[2016-02-26 13:35:37.477] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'user_activity_tmp' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 13:35:37.732] [005918] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."user_activity_tmp" LIMIT 1000 OFFSET 0

[2016-02-26 13:35:38.166] [005918] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'user_activity_tmp'

[2016-02-26 13:35:38.276] [005918] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329505

[2016-02-26 13:35:58.924] [005918] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."user_activity_tmp" WHERE "subscription_id" = '8846316' LIMIT 1000 OFFSET 0

[2016-02-26 13:35:59.298] [005918] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'user_activity_tmp'

[2016-02-26 13:35:59.387] [005918] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329505

[2016-02-26 13:37:42.925] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:37:43.031] [003859] [dwh-prod] [PGSQL]
    SELECT DISTINCT
        ON (subscription_id) gcsi_user_id,
        subscription_id,
        end_date AS activity_date,
        'End' activity
    FROM
        tmp.users_tmp
  where end_date is not null and 
        (end_date::date > cancel_date::date OR
         cancel_date is null) and 
subscription_id = 8846316;


[2016-02-26 13:37:43.265] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:37:43.601] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329488

[2016-02-26 13:38:28.313] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:38:28.464] [003859] [dwh-prod] [PGSQL]
select * from gcsi.t_subscriptions where subscription_id = 8846316


[2016-02-26 13:38:29.644] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:38:30.076] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329065

[2016-02-26 13:39:09.072] [007002] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 13:39:09.154] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 't_subscriptions_snap' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 13:39:09.280] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 13:39:09.682] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 13:39:09.766] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 't_subscriptions_snap' AND conname IS NOT NULL

[2016-02-26 13:39:09.850] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 't_subscriptions_snap' ORDER BY t.relname, i.oid

[2016-02-26 13:39:09.934] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 't_subscriptions_snap' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 13:39:10.195] [007002] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."t_subscriptions_snap" LIMIT 1000 OFFSET 0

[2016-02-26 13:39:10.860] [007002] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 't_subscriptions_snap'

[2016-02-26 13:39:10.964] [007002] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329473

[2016-02-26 13:39:31.221] [007002] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."t_subscriptions_snap" WHERE "subscription_id" = '8846316' LIMIT 1000 OFFSET 0

[2016-02-26 13:39:31.553] [007002] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 't_subscriptions_snap'

[2016-02-26 13:39:31.648] [007002] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329473

[2016-02-26 13:40:20.704] [007345] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 13:40:20.791] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'subscriptions_tmp' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 13:40:20.908] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 13:40:21.313] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 13:40:21.394] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'subscriptions_tmp' AND conname IS NOT NULL

[2016-02-26 13:40:21.476] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'subscriptions_tmp' ORDER BY t.relname, i.oid

[2016-02-26 13:40:21.562] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'subscriptions_tmp' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 13:40:21.817] [007345] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."subscriptions_tmp" LIMIT 1000 OFFSET 0

[2016-02-26 13:40:22.396] [007345] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'subscriptions_tmp'

[2016-02-26 13:40:22.513] [007345] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329479

[2016-02-26 13:40:46.186] [007345] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."subscriptions_tmp" WHERE "gcsi_user_id" = '5189234' LIMIT 1000 OFFSET 0

[2016-02-26 13:40:46.434] [007345] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'subscriptions_tmp'

[2016-02-26 13:40:46.525] [007345] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329479

[2016-02-26 13:50:20.700] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:50:20.816] [003859] [dwh-prod] [PGSQL]
select * from moiram.daily_status_y2014q1  
where gcsi_user_id = 5189234
  and day_timestamp = '20140102';


[2016-02-26 13:50:20.916] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:50:21.335] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 13:55:21.855] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'gcsi'

[2016-02-26 13:55:38.716] [012129] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 13:55:38.796] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'gcsi' AND col.table_name = 'subscription_rollover' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 13:55:38.899] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 13:55:39.300] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 13:55:39.383] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'gcsi' AND ct.relname = 'subscription_rollover' AND conname IS NOT NULL

[2016-02-26 13:55:39.466] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'gcsi' AND t.relname = 'subscription_rollover' ORDER BY t.relname, i.oid

[2016-02-26 13:55:39.552] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'gcsi' AND t.relname = 'subscription_rollover' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 13:55:39.829] [012129] [dwh-prod] [PGSQL]
SELECT * FROM "gcsi"."subscription_rollover" LIMIT 1000 OFFSET 0

[2016-02-26 13:55:40.174] [012129] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'gcsi' AND cl.table_name = 'subscription_rollover'

[2016-02-26 13:55:40.273] [012129] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329047

[2016-02-26 13:57:08.297] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:57:08.405] [003859] [dwh-prod] [PGSQL]
select * from common.user_d where subscription_id in (18864058,31989601);


[2016-02-26 13:57:08.501] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:57:08.935] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 13:58:21.175] [027034] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:58:21.176] [027034] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-26 13:58:21.749] [012958] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 13:58:21.830] [012958] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 13:58:21.951] [012958] [dwh-prod] [PGSQL]

/*
drop table if exists tmp.paid_through_dates;

create table tmp.paid_through_dates as 
select  sd.subscription_id, 
        se.schedule_date, 
        lead(se.schedule_date) over w as paid_through_date 
from common.subscription_d sd
join gcsi.subscription_event se 
    on se.subscription_id = sd.subscription_id
join gcsi.subscription_transaction_subscription_events stse 
    on stse.subscription_event_id = se.id
join gcsi.subscription_transaction st 
    on st.id = stse.subscription_transaction_id and 
       st.txn_state = 'SETTLED'
       -- I think I need at least a year for annuals
where se.schedule_date > '20130101'
window w as (
partition by sd.subscription_id
order by
    se.schedule_date
rows between unbounded preceding
and unbounded following
);

CREATE INDEX idx_ptd_sub ON tmp.paid_through_dates (subscription_id);
CREATE INDEX idx_ptd_sub_ptdate ON tmp.paid_through_dates (subscription_id, paid_through_date);

alter table tmp.paid_through_dates owner to dw_admin;
*/
 
  truncate table moiram.daily_status_y2015q4;
 
       
  insert into moiram.daily_status_y2015q4
  select dd.day_timestamp,
      gcsi_user_id,
      ud.subscription_id,
      -- they are suspended, the paid_through_date is the schedule_date
     -- or, if it's a current suspension, the current_paid_through_date
      case when status = 'Hold' or status = 'Start/Hold' and 
                          sh.initiator = 'PAYMENT'
           then coalesce(ptd.schedule_date,ud.paid_through_date)
           else coalesce(ptd.paid_through_date,ud.paid_through_date)
           end paid_through_date,
      case when status = 'Hold' or status = 'Start/Hold' then 
           case when sh.initiator in  ('CUSTOMER', 'ADMINISTRATIVE')
                then 'Hold'
                else 'Suspended'
           end 
           when cancel_date::date <= dd.day_timestamp::date then 
           case when coalesce(ptd.paid_through_date,ud.paid_through_date) > dd.day_timestamp 
                then 'Lapsed'
                else 'Cancelled'
           end 
           else status
      end status
  from common.user_d ud
  join common.date_d dd
      on ud.valid_from <= dd.day_timestamp AND
         ud.valid_to >= dd.day_timestamp
  left join lateral
       --choose ADMINISTRATIVE hold over payment hold if we have two concurrent holds
      (select  subscription_id, min(initiator) initiator
       from gcsi.subscription_hold h 
       where  h.deleted = 'f'  
         and day_timestamp >= h.start_date::date  
         and (day_timestamp < h.end_date::date or h.end_date is null)
        group by subscription_id) sh
      on ud.subscription_id = sh.subscription_id   
  left join tmp.paid_through_dates ptd
      on ud.subscription_id = ptd.subscription_id and 
         day_timestamp >= ptd.schedule_date::date and
         day_timestamp < ptd.paid_through_date::date
  where day_key >= '20151001'
    --and day_timestamp < current_date::date
     and day_timestamp < '20160101'::date
         -- there are cases where cancel_date is not null and status is still active
         -- because of comps
   and (cancel_date is null or 
        cancel_date >= '20151001' or
        ud.paid_through_date >= '20151001' or
        status in( 'Active', 'Lapsed', 'Suspended'));




[2016-02-26 14:01:44.457] [012129] [dwh-prod] [PGSQL]
SELECT * FROM "gcsi"."subscription_rollover" WHERE "plan_change_request_id" IS NOT NULL LIMIT 1000 OFFSET 0

[2016-02-26 14:01:44.700] [012129] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'gcsi' AND cl.table_name = 'subscription_rollover'

[2016-02-26 14:01:44.790] [012129] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329047

[2016-02-26 14:05:20.548] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:05:20.678] [003859] [dwh-prod] [PGSQL]
select * from common.daily_status_y2014q1 
where day_timestamp = '20140101'
  and gcsi_user_id in (168578,12776120);


[2016-02-26 14:05:20.785] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:05:21.253] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5716331

[2016-02-26 14:05:56.449] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:05:56.577] [003859] [dwh-prod] [PGSQL]

select * from common.user_d where gcsi_user_id in (168578,12776120);

select * from common.subscription_d where gcsi_user_id in (168578,12776120);

select * from common.daily_status_y2014q1 
where day_timestamp = '20140101'
  and gcsi_user_id in (168578,12776120);

select * from moiram.daily_status_y2014q1 
where day_timestamp = '20140101'
  and gcsi_user_id in (168578,12776120);

select * from gcsi.subscription_hold where subscription_id in (13121187,
12776127)


select * from subscription_d where subscription_id in 
(select subscription_id from moiram.daily_status_y2014q1  where status = 'Cancelled' and day_timestamp = '20140101');

select * from moiram.daily_status_y2014q1  
where status = 'Cancelled' and day_timestamp = '20140101' and paid_through_date >'20140101';

select * from common.user_d where subscription_id in (18864058,31989601);


[2016-02-26 14:05:56.660] [003859] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "select"
LINE 18: select * from subscription_d where subscription_id in 
         ^


[2016-02-26 14:05:56.685] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:06:30.557] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:06:30.672] [003859] [dwh-prod] [PGSQL]
select * from moiram.daily_status_y2014q1  
where status = 'Cancelled' and day_timestamp = '20140101' and paid_through_date >'20140101';

select * from common.user_d where subscription_id in (18864058,31989601);



[2016-02-26 14:06:30.877] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:06:31.335] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 14:06:31.770] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:06:47.760] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:06:47.907] [003859] [dwh-prod] [PGSQL]
select gcsi_user_id, subscription_id, status
from common.daily_status_y2014q1
where day_timestamp = '20140101'
except 
select gcsi_user_id, subscription_id, status
from moiram.daily_status_y2014q1
where day_timestamp = '20140101';


[2016-02-26 14:06:48.805] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:07:06.751] [012958] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:07:16.840] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:07:16.950] [003859] [dwh-prod] [PGSQL]
select * from common.user_d where gcsi_user_id in (168578,12776120);

select * from common.subscription_d where gcsi_user_id in (168578,12776120);

select * from common.daily_status_y2014q1 
where day_timestamp = '20140101'
  and gcsi_user_id in (168578,12776120);

select * from moiram.daily_status_y2014q1 
where day_timestamp = '20140101'
  and gcsi_user_id in (168578,12776120);

select * from gcsi.subscription_hold where subscription_id in (13121187,
12776127);


[2016-02-26 14:07:17.501] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:07:17.932] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:07:18.407] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329767

[2016-02-26 14:07:18.863] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5716331

[2016-02-26 14:07:19.296] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 14:07:19.736] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6328694

[2016-02-26 14:08:59.401] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:08:59.554] [003859] [dwh-prod] [PGSQL]
select gcsi_user_id, subscription_id, status
from moiram.daily_status_y2014q1
where day_timestamp = '20140101'
except
select gcsi_user_id, subscription_id, status
from common.daily_status_y2014q1
where day_timestamp = '20140101';


[2016-02-26 14:08:59.811] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:10:46.851] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:10:46.974] [003859] [dwh-prod] [PGSQL]
select * from common.user_d where subscription_id in (18864058,31989601);


[2016-02-26 14:10:47.088] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:10:47.570] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:11:31.574] [003403] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 14:11:31.655] [003403] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='moiram' AND table_name='daily_status_y2015q4' ORDER BY ordinal_position

[2016-02-26 14:12:31.624] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:12:31.784] [003859] [dwh-prod] [PGSQL]
select * from daily_status_y2015q4
where gcsi_user_id = 18864052
  and day_timestamp >= '20151210'
  and day_timestamp <= '20151220';


[2016-02-26 14:12:31.947] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:12:32.417] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310665

[2016-02-26 14:17:06.302] [005155] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 14:17:06.417] [005155] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-26 14:17:06.797] [005154] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 14:17:06.905] [005154] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-26 14:17:07.018] [005154] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 14:17:07.135] [005154] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-26 14:17:07.263] [005154] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 14:17:08.037] [005154] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 14:17:08.155] [005154] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 14:17:08.262] [005154] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-26 14:17:08.357] [005154] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'moiram') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 14:17:08.479] [005154] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='moiram' ORDER BY schemaname, viewname

[2016-02-26 14:17:08.604] [005154] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 14:17:09.035] [005154] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 14:17:09.134] [005154] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'moiram' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 14:17:09.237] [005154] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'moiram' 

[2016-02-26 14:17:09.374] [005154] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-26 14:18:25.581] [005541] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 14:18:25.661] [005541] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-26 14:18:26.018] [005540] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 14:18:26.108] [005540] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-26 14:18:26.234] [005540] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 14:18:26.352] [005540] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-26 14:18:26.435] [005540] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 14:18:27.019] [005540] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 14:18:27.113] [005540] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 14:18:27.203] [005540] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-26 14:18:27.289] [005540] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 14:18:27.400] [005540] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-26 14:18:27.484] [005540] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 14:18:27.789] [005540] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 14:18:27.868] [005540] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 14:18:27.963] [005540] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-26 14:18:28.049] [005540] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-26 14:20:19.640] [006152] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 14:20:19.720] [006152] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='t_subscriptions_snap' ORDER BY ordinal_position

[2016-02-26 14:21:17.453] [006459] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 14:21:17.537] [006459] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='subscriptions_tmp' ORDER BY ordinal_position

[2016-02-26 14:21:28.019] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:21:28.163] [003859] [dwh-prod] [PGSQL]
select gcsi_user_id, subscription_id, cancel_date
from tmp.t_subscriptions_snap
where cancel_date is not null
except
select gcsi_user_id, subscription_id, cancel_date
from tmp.subscriptions_tmp
where cancel_date is not null



[2016-02-26 14:21:28.852] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:21:55.722] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:21:55.831] [003859] [dwh-prod] [PGSQL]
select * from gcsi.t_subscriptions where subscription_id = 7301718;


[2016-02-26 14:21:56.978] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:21:57.336] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329065

[2016-02-26 14:22:28.547] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:22:28.662] [003859] [dwh-prod] [PGSQL]
select gcsi_user_id, subscription_id, cancel_date
from tmp.t_subscriptions_snap
where cancel_date is not null AND
      cancel_date > '20140101'
except
select gcsi_user_id, subscription_id, cancel_date
from tmp.subscriptions_tmp
where cancel_date is not null AND
      cancel_date > '20140101'


[2016-02-26 14:22:29.181] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:22:44.997] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:22:45.143] [003859] [dwh-prod] [PGSQL]
select * from gcsi.t_subscriptions where subscription_id = 14291880;


[2016-02-26 14:22:46.327] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:22:46.767] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329065

[2016-02-26 14:23:01.222] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:23:01.340] [003859] [dwh-prod] [PGSQL]
select * from gcsi.t_subscriptions where user_id = 14291846;


[2016-02-26 14:23:04.306] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:23:04.734] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329065

[2016-02-26 14:23:59.966] [007264] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 14:24:00.046] [007264] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='common' AND table_name='user_d' ORDER BY ordinal_position

[2016-02-26 14:24:09.962] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:24:10.085] [003859] [dwh-prod] [PGSQL]
select * from gcsi.t_subscriptions where user_id = 14291846;

select *  from common.user_d where gcsi_user_id = 14291846;


[2016-02-26 14:24:13.059] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:24:13.488] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329065

[2016-02-26 14:24:13.939] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:25:49.708] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:25:49.835] [003859] [dwh-prod] [PGSQL]
select gcsi_user_id, subscription_id, cancel_date
from tmp.t_subscriptions_snap
where cancel_date is not null AND
      cancel_date > '20140101' AND
      subscription_id in (select subscription_id from common.user_d)
except
select gcsi_user_id, subscription_id, cancel_date
from tmp.subscriptions_tmp


[2016-02-26 14:25:50.613] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:29:05.709] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:29:05.827] [003859] [dwh-prod] [PGSQL]
select gcsi_user_id
from common.user_d u1
join common.user_d u2
where u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  and u1.valid_from = u2.valid_2 - 1
limit 10


[2016-02-26 14:29:05.907] [003859] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "where"
LINE 4: where u1.gcsi_user_id = u2.gcsi_user_id
        ^


[2016-02-26 14:29:05.923] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:29:20.769] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:29:20.879] [003859] [dwh-prod] [PGSQL]
select gcsi_user_id
from common.user_d u1
join common.user_d u2
  on  u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  and u1.valid_from = u2.valid_2 - 1
limit 10


[2016-02-26 14:29:20.959] [003859] [dwh-prod] [PGSQL]
ERROR:  column u2.valid_2 does not exist
LINE 6:   and u1.valid_from = u2.valid_2 - 1
                              ^


[2016-02-26 14:29:20.977] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:29:37.145] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:29:37.257] [003859] [dwh-prod] [PGSQL]
select gcsi_user_id
from common.user_d u1
join common.user_d u2
  on  u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  and u1.valid_from = u2.valid_to- 1
limit 10


[2016-02-26 14:29:37.341] [003859] [dwh-prod] [PGSQL]
ERROR:  column reference "gcsi_user_id" is ambiguous
LINE 1: select gcsi_user_id
               ^


[2016-02-26 14:29:37.353] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:29:50.965] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:29:51.078] [003859] [dwh-prod] [PGSQL]
select u1.gcsi_user_id
from common.user_d u1
join common.user_d u2
  on  u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  and u1.valid_from = u2.valid_to- 1
limit 10


[2016-02-26 14:30:37.444] [023204] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:30:37.445] [023204] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-26 14:30:38.028] [009316] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 14:30:38.139] [009316] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:30:38.259] [009316] [dwh-prod] [PGSQL]
select pid, query from pg_stat_activity
WHERE state = 'active';


[2016-02-26 14:30:38.384] [009316] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:30:38.803] [009316] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 11283

[2016-02-26 14:30:48.273] [009316] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:30:48.439] [009316] [dwh-prod] [PGSQL]
SELECT pg_cancel_backend(3859);


[2016-02-26 14:30:48.519] [003859] [dwh-prod] [PGSQL]
ERROR:  canceling statement due to user request


[2016-02-26 14:30:48.533] [009316] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:30:48.536] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:31:23.542] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:31:23.676] [003859] [dwh-prod] [PGSQL]
select u1.gcsi_user_id
from common.user_d u1
join common.user_d u2
  on  u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  and u1.valid_to = u2.valid_from- 1
limit 10


[2016-02-26 14:31:23.870] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:31:24.294] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:31:51.163] [009710] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 14:31:51.258] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'user_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 14:31:51.427] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 14:31:51.824] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 14:31:51.961] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'user_d' AND conname IS NOT NULL

[2016-02-26 14:31:52.052] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'user_d' ORDER BY t.relname, i.oid

[2016-02-26 14:31:52.428] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'user_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 14:31:52.656] [009710] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" LIMIT 1000 OFFSET 0

[2016-02-26 14:31:53.418] [009710] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-26 14:31:53.528] [009710] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:32:45.936] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:32:46.076] [003859] [dwh-prod] [PGSQL]
select u1.gcsi_user_id
from common.user_d u1
join common.user_d u2
  on  u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  and u1.cancel_date > '20140101'
  and u1.valid_to = u2.valid_from- 1
limit 10


[2016-02-26 14:32:46.409] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:32:46.833] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:33:02.854] [009710] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '22750' LIMIT 1000 OFFSET 0

[2016-02-26 14:33:03.363] [009710] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-26 14:33:03.463] [009710] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:33:58.624] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:33:58.749] [003859] [dwh-prod] [PGSQL]
select u1.gcsi_user_id
from common.user_d u1
join common.user_d u2
  on  u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  and u1.cancel_date between  '20140101' and '20140401'  
  and u1.valid_to = u2.valid_from- 1
limit 10


[2016-02-26 14:33:59.287] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:33:59.717] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:34:13.920] [010406] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 14:34:14.000] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'common' AND col.table_name = 'user_d' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 14:34:14.156] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 14:34:14.522] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 14:34:14.616] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'common' AND ct.relname = 'user_d' AND conname IS NOT NULL

[2016-02-26 14:34:14.716] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'common' AND t.relname = 'user_d' ORDER BY t.relname, i.oid

[2016-02-26 14:34:14.808] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'common' AND t.relname = 'user_d' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 14:34:15.026] [010406] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" LIMIT 1000 OFFSET 0

[2016-02-26 14:34:15.815] [010406] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-26 14:34:15.924] [010406] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:34:28.136] [010406] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '5508021' LIMIT 1000 OFFSET 0

[2016-02-26 14:34:28.648] [010406] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-26 14:34:28.751] [010406] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:36:52.742] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:36:52.852] [003859] [dwh-prod] [PGSQL]

select u1.gcsi_user_id
from common.user_d u1
join common.user_d u2
  on  u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  and u1.cancel_date between  '20140101' and '20140401'  
  and u1.cancel_date > u1.paid_through_date
  and u1.valid_to = u2.valid_from- 1
limit 10


[2016-02-26 14:36:53.380] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:36:53.798] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:37:04.735] [010406] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '10232534' LIMIT 1000 OFFSET 0

[2016-02-26 14:37:04.922] [010406] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-26 14:37:05.023] [010406] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:38:19.574] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:38:19.698] [003859] [dwh-prod] [PGSQL]
select u1.gcsi_user_id
from common.user_d u1
join common.user_d u2
  on  u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  and u1.cancel_date between  '20140101' and '20140401'  
  and u1.cancel_date > u1.paid_through_date
  and u1.cancel_date::date = u2.start_date::date - 1
limit 10


[2016-02-26 14:38:19.779] [003859] [dwh-prod] [PGSQL]
ERROR:  column u2.start_date does not exist
LINE 8:   and u1.cancel_date::date = u2.start_date::date - 1
                                     ^


[2016-02-26 14:38:19.794] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:38:33.435] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:38:33.546] [003859] [dwh-prod] [PGSQL]
select u1.gcsi_user_id
from common.user_d u1
join common.user_d u2
  on  u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  and u1.cancel_date between  '20140101' and '20140401'  
  and u1.cancel_date > u1.paid_through_date
  and u1.cancel_date::date = u2.subscription_start_date::date - 1
limit 10


[2016-02-26 14:38:34.031] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:38:34.464] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:38:49.723] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:38:49.836] [003859] [dwh-prod] [PGSQL]
select distinct u1.gcsi_user_id
from common.user_d u1
join common.user_d u2
  on  u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  and u1.cancel_date between  '20140101' and '20140401'  
  and u1.cancel_date > u1.paid_through_date
  and u1.cancel_date::date = u2.subscription_start_date::date - 1
limit 10


[2016-02-26 14:38:50.331] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:38:50.746] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:39:01.306] [010406] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '14368036' LIMIT 1000 OFFSET 0

[2016-02-26 14:39:01.496] [010406] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-26 14:39:01.595] [010406] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:41:06.775] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:41:06.886] [003859] [dwh-prod] [PGSQL]
select * from moiram.daily_status_y2014q1 
where day_timestamp between  '20140310' and '20140401'
  and gcsi_user_id = 14368036
order by day_timestamp;


[2016-02-26 14:41:06.997] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:41:07.421] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 14:46:39.269] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:46:39.407] [003859] [dwh-prod] [PGSQL]
select distinct u1.gcsi_user_id
from common.user_d u1
join common.user_d u2
  on  u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  --and u1.cancel_date between  '20140101' and '20140401'  
  and u1.cancel_date > (u1.paid_through_date +14)
  and u1.cancel_date::date = u2.subscription_start_date::date - 1


[2016-02-26 14:46:39.490] [003859] [dwh-prod] [PGSQL]
ERROR:  operator does not exist: timestamp without time zone + integer
LINE 7:   and u1.cancel_date > (u1.paid_through_date +14)
                                                     ^
HINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.


[2016-02-26 14:46:39.505] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:46:56.724] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:46:56.841] [003859] [dwh-prod] [PGSQL]
select distinct u1.gcsi_user_id
from common.user_d u1
join common.user_d u2
  on  u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  --and u1.cancel_date between  '20140101' and '20140401'  
  and u1.cancel_date > (u1.paid_through_date::date +14)
  and u1.cancel_date::date = u2.subscription_start_date::date - 1


[2016-02-26 14:46:58.221] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:46:58.649] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:49:27.025] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:49:27.138] [003859] [dwh-prod] [PGSQL]
select distinct u1.gcsi_user_id
from common.user_d u1
join common.user_d u2
  on  u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  and u1.cancel_date >  '20140101' 
  and u1.cancel_date > u1.paid_through_date
  and u1.cancel_date <= (u1.paid_through_date::date +14)
  and u1.cancel_date::date = u2.subscription_start_date::date - 1


[2016-02-26 14:49:27.812] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 14:49:28.239] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:50:13.766] [010406] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '14094766' LIMIT 1000 OFFSET 0

[2016-02-26 14:50:13.954] [010406] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-26 14:50:14.052] [010406] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:50:24.280] [010406] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '14094766' LIMIT 1000 OFFSET 1000

[2016-02-26 14:50:24.467] [010406] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-26 14:50:24.564] [010406] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 14:50:27.551] [010406] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '14094766' LIMIT 1000 OFFSET 0

[2016-02-26 14:50:27.739] [010406] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-26 14:50:27.840] [010406] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 15:13:58.484] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:13:58.605] [003859] [dwh-prod] [PGSQL]
select status, count(1) 
from daily_status_y2014q1
--where day_timestamp = '20140101'
group by status;

select status, count(1) 
from common.daily_status_y2014q1
--where day_timestamp = '20140101'
group by status;


[2016-02-26 15:14:02.005] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:14:02.472] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 15:14:02.875] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 5716331

[2016-02-26 15:16:12.658] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:16:12.779] [003859] [dwh-prod] [PGSQL]
select day_timestamp, gcsi_user_id, subscription_id
from moiram.daily_status_y2014q1
where status = 'Active'
except
select day_timestamp, gcsi_user_id, subscription_id
from common.daily_status_y2014q1
where status = 'Active'


[2016-02-26 15:16:20.954] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:16:45.994] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:16:46.108] [003859] [dwh-prod] [PGSQL]
select day_timestamp, gcsi_user_id, subscription_id
from common.daily_status_y2014q1
where status = 'Active'
EXCEPT
select day_timestamp, gcsi_user_id, subscription_id
from moiram.daily_status_y2014q1
where status = 'Active'


[2016-02-26 15:16:54.232] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:17:10.937] [010406] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '168578' LIMIT 1000 OFFSET 0

[2016-02-26 15:17:11.127] [010406] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-26 15:17:11.226] [010406] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 15:18:26.882] [010406] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '14866418' LIMIT 1000 OFFSET 0

[2016-02-26 15:18:27.070] [010406] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-26 15:18:27.169] [010406] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 15:19:54.303] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:19:54.421] [003859] [dwh-prod] [PGSQL]
select day_timestamp, gcsi_user_id, subscription_id
from common.daily_status_y2014q1
where status = 'Active'
EXCEPT
select day_timestamp, gcsi_user_id, subscription_id
from moiram.daily_status_y2014q1
where status = 'Active'
order by gcsi_user_id, day_timestamp


[2016-02-26 15:20:02.550] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:20:46.943] [010406] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '12776120' LIMIT 1000 OFFSET 0

[2016-02-26 15:20:47.131] [010406] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-26 15:20:47.232] [010406] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 15:24:38.082] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:24:38.205] [003859] [dwh-prod] [PGSQL]
select * from moiram.daily_status_y2014q1
where gcsi_user_id in (168578,12776120, 14582111,14866418)
order by gcsi_user_id, day_timestamp


[2016-02-26 15:24:38.400] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:24:38.824] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6310544

[2016-02-26 15:27:04.224] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:27:04.333] [003859] [dwh-prod] [PGSQL]
select * from gcsi.subscription_hold where subscription_id in (13121187,
12776127);


[2016-02-26 15:27:04.452] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:27:04.864] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6328694

[2016-02-26 15:33:06.550] [028592] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 15:33:06.629] [028592] [dwh-prod] [PGSQL]
SHOW search_path

[2016-02-26 15:33:07.009] [028591] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 15:33:07.101] [028591] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-26 15:33:07.199] [028591] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'public') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 15:33:07.284] [028591] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='public' ORDER BY schemaname, viewname

[2016-02-26 15:33:07.366] [028591] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 15:33:07.881] [028591] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 15:33:07.964] [028591] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'public' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 15:33:08.055] [028591] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'public' 

[2016-02-26 15:33:08.147] [028591] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'common') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 15:33:08.247] [028591] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='common' ORDER BY schemaname, viewname

[2016-02-26 15:33:08.331] [028591] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 15:33:08.607] [028591] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 15:33:08.689] [028591] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'common' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 15:33:08.783] [028591] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'common' 

[2016-02-26 15:33:08.874] [028591] [dwh-prod] [PGSQL]
SELECT nspname FROM pg_namespace

[2016-02-26 15:34:12.383] [028926] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 15:34:12.466] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'tmp_holds_prelim' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 15:34:12.570] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 15:34:12.972] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 15:34:13.055] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'tmp_holds_prelim' AND conname IS NOT NULL

[2016-02-26 15:34:13.137] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'tmp_holds_prelim' ORDER BY t.relname, i.oid

[2016-02-26 15:34:13.222] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'tmp_holds_prelim' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 15:34:13.479] [028926] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."tmp_holds_prelim" LIMIT 1000 OFFSET 0

[2016-02-26 15:34:13.894] [028926] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'tmp_holds_prelim'

[2016-02-26 15:34:13.993] [028926] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329491

[2016-02-26 15:35:31.178] [028926] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."tmp_holds_prelim" WHERE "subscription_id" = '12776127' LIMIT 1000 OFFSET 0

[2016-02-26 15:35:31.341] [028926] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'tmp_holds_prelim'

[2016-02-26 15:35:31.441] [028926] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329491

[2016-02-26 15:35:56.625] [029485] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 15:35:56.716] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'tmp_holds' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 15:35:56.821] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 15:35:57.231] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 15:35:57.483] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'tmp_holds' AND conname IS NOT NULL

[2016-02-26 15:35:57.575] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'tmp_holds' ORDER BY t.relname, i.oid

[2016-02-26 15:35:57.663] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'tmp_holds' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 15:35:57.918] [029485] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."tmp_holds" LIMIT 1000 OFFSET 0

[2016-02-26 15:35:58.339] [029485] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'tmp_holds'

[2016-02-26 15:35:58.455] [029485] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329496

[2016-02-26 15:36:09.837] [029485] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."tmp_holds" WHERE "subscription_id" = '12776127' LIMIT 1000 OFFSET 0

[2016-02-26 15:36:09.976] [029485] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'tmp_holds'

[2016-02-26 15:36:10.066] [029485] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329496

[2016-02-26 15:36:53.540] [029782] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 15:36:53.619] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'hold_overlaps2' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 15:36:53.732] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 15:36:54.137] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 15:36:54.218] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'hold_overlaps2' AND conname IS NOT NULL

[2016-02-26 15:36:54.300] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'hold_overlaps2' ORDER BY t.relname, i.oid

[2016-02-26 15:36:54.386] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'hold_overlaps2' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 15:36:54.654] [029782] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."hold_overlaps2" LIMIT 1000 OFFSET 0

[2016-02-26 15:36:55.144] [029782] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'hold_overlaps2'

[2016-02-26 15:36:55.245] [029782] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329501

[2016-02-26 15:37:06.033] [029782] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."hold_overlaps2" WHERE "subscription_id" = '12776127' LIMIT 1000 OFFSET 0

[2016-02-26 15:37:06.122] [029782] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'hold_overlaps2'

[2016-02-26 15:37:06.222] [029782] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329501

[2016-02-26 15:38:10.185] [030136] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 15:38:10.268] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'tmp_activity' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 15:38:10.375] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 15:38:10.789] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 15:38:10.871] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'tmp_activity' AND conname IS NOT NULL

[2016-02-26 15:38:10.954] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'tmp_activity' ORDER BY t.relname, i.oid

[2016-02-26 15:38:11.047] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'tmp_activity' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 15:38:11.316] [030136] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."tmp_activity" LIMIT 1000 OFFSET 0

[2016-02-26 15:38:11.761] [030136] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'tmp_activity'

[2016-02-26 15:38:11.868] [030136] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4871090

[2016-02-26 15:38:25.791] [030136] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."tmp_activity" WHERE "subscription_id" = '12776127' LIMIT 1000 OFFSET 0

[2016-02-26 15:38:26.162] [030136] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'tmp_activity'

[2016-02-26 15:38:26.252] [030136] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4871090

[2016-02-26 15:38:56.567] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:38:56.700] [028592] [dwh-prod] [PGSQL]
INSERT INTO tmp.tmp_activity (
    SELECT DISTINCT
        ON (subscription_id, hold_end_date) gcsi_user_id,
        subscription_id,
        hold_end_date AS activity_date,
        'Hold End' activity,
        id
    FROM
        tmp.tmp_holds
where hold_end_date is not null
);


[2016-02-26 15:38:57.220] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:39:04.433] [030136] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."tmp_activity" WHERE "subscription_id" = '12776127' LIMIT 1000 OFFSET 0

[2016-02-26 15:39:04.629] [030136] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'tmp_activity'

[2016-02-26 15:39:04.722] [030136] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4871090

[2016-02-26 15:39:27.692] [030136] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."tmp_activity" WHERE "subscription_id" = '12776127' ORDER BY "row_number" LIMIT 1000 OFFSET 0

[2016-02-26 15:39:27.844] [030136] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'tmp_activity'

[2016-02-26 15:39:27.935] [030136] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4871090

[2016-02-26 15:40:03.858] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:40:03.967] [028592] [dwh-prod] [PGSQL]
with t1 as
(select subscription_id, 
        next_start_date::date - interval '1 day' cancel_date
from tmp.users_tmp)
update tmp.tmp_activity ta set activity_date = t1.cancel_date
from t1
where (activity = 'Cancel' OR
       activity = 'Hold End')
  and activity_date::date > t1.cancel_date::date
  and ta.subscription_id = t1.subscription_id;


[2016-02-26 15:40:04.862] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:40:17.679] [030136] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."tmp_activity" WHERE "subscription_id" = '12776127' ORDER BY "row_number" LIMIT 1000 OFFSET 0

[2016-02-26 15:40:17.846] [030136] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'tmp_activity'

[2016-02-26 15:40:17.938] [030136] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4871090

[2016-02-26 15:40:34.831] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:40:34.939] [028592] [dwh-prod] [PGSQL]
 -- when I have a 'Hold End' activity that's the 
 -- same date (or later) as the cancel date, delete the 'Hold End' record
delete from tmp.tmp_activity ta
where activity = 'Hold End' 
  and exists 
     (select ta.subscription_id
      from tmp.tmp_activity t1 
      where t1.subscription_id = ta.subscription_id
        and t1.activity_date::date <= ta.activity_date::date
        and t1.activity = 'Cancel');


[2016-02-26 15:40:35.395] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:40:39.068] [030136] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."tmp_activity" WHERE "subscription_id" = '12776127' ORDER BY "row_number" LIMIT 1000 OFFSET 0

[2016-02-26 15:40:39.237] [030136] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'tmp_activity'

[2016-02-26 15:40:39.327] [030136] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4871090

[2016-02-26 15:40:57.309] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:40:57.414] [028592] [dwh-prod] [PGSQL]
 -- when I have a 'Hold Start' activity that's the 
 -- same date as the cancel date, delete the 'Hold Start' record
delete from tmp.tmp_activity ta
where activity = 'Hold Start' 
  and exists 
     (select ta.subscription_id
      from tmp.tmp_activity t1 
      where t1.subscription_id = ta.subscription_id
        and t1.activity_date::date <= ta.activity_date::date
        and t1.activity = 'Cancel');


[2016-02-26 15:40:57.772] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:41:06.605] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:41:06.706] [028592] [dwh-prod] [PGSQL]
-- when I have a 'Hold End' and a new 'Hold Start' on the same day, delete the 'Hold End'
delete from tmp.tmp_activity ta
where activity = 'Hold End' 
  and exists 
     (select ta.subscription_id
      from tmp.tmp_activity t1 
      where t1.subscription_id = ta.subscription_id
        and t1.activity_date::date = ta.activity_date::date
        and t1.activity = 'Hold Start'
        and t1.row_number > ta.row_number);


[2016-02-26 15:41:07.068] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:41:17.167] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:41:17.277] [028592] [dwh-prod] [PGSQL]
 -- when I have two consecutive 'Hold Start' activities  delete the  second one
delete from tmp.tmp_activity ta
where activity = 'Hold Start' 
  and (subscription_id, activity_date) in 
       (select subscription_id, activity_date from 
          (select gcsi_user_id, subscription_id, activity_date, activity,
                 lag(activity) over
                      (partition by subscription_id order by activity_date  
                       ROWS BETWEEN UNBOUNDED PRECEDING
                       AND UNBOUNDED FOLLOWING)  prev_activity
          from tmp.tmp_activity) t
where activity = 'Hold Start' and prev_activity = 'Hold Start');


[2016-02-26 15:41:18.674] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:41:36.009] [030136] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."tmp_activity" WHERE "subscription_id" = '12776127' ORDER BY "row_number" LIMIT 1000 OFFSET 0

[2016-02-26 15:41:36.158] [030136] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'tmp_activity'

[2016-02-26 15:41:36.248] [030136] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4871090

[2016-02-26 15:41:46.822] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:41:46.930] [028592] [dwh-prod] [PGSQL]
 -- when I have two consecutive 'Hold End' activities  delete the  first one
delete from tmp.tmp_activity ta
where activity = 'Hold End' 
  and (subscription_id, activity_date) in 
       (select subscription_id, activity_date from 
          (select gcsi_user_id, subscription_id, activity_date, activity,
                 lead(activity) over
                      (partition by subscription_id order by activity_date  
                       ROWS BETWEEN UNBOUNDED PRECEDING
                       AND UNBOUNDED FOLLOWING)  next_activity
          from tmp.tmp_activity) t
where activity = 'Hold End' and next_activity = 'Hold End');


[2016-02-26 15:41:48.681] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:41:58.707] [030136] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."tmp_activity" WHERE "subscription_id" = '12776127' ORDER BY "row_number" LIMIT 1000 OFFSET 0

[2016-02-26 15:41:58.865] [030136] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'tmp_activity'

[2016-02-26 15:41:58.955] [030136] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4871090

[2016-02-26 15:43:07.495] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:43:07.616] [028592] [dwh-prod] [PGSQL]
 -- when I have  'Hold Start' and 'Hold End' on the same day, bump the 'Hold End' by one DAY
-- so I don't have overlapping valid_from/valid_to dates
update tmp.tmp_activity ta
set activity_date = activity_date + interval '1 day'
where activity = 'Hold End' 
  and exists 
     (select ta.subscription_id
      from tmp.tmp_activity t1 
      where t1.subscription_id = ta.subscription_id
        and t1.activity_date::date = ta.activity_date::date
        and t1.activity = 'Hold Start'
        and t1.row_number = ta.row_number);


[2016-02-26 15:43:07.936] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:43:16.215] [030136] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."tmp_activity" WHERE "subscription_id" = '12776127' ORDER BY "row_number" LIMIT 1000 OFFSET 0

[2016-02-26 15:43:16.349] [030136] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'tmp_activity'

[2016-02-26 15:43:16.447] [030136] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4871090

[2016-02-26 15:43:42.808] [031849] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 15:43:42.889] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'user_activity_tmp' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 15:43:42.994] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 15:43:43.392] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 15:43:43.474] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'user_activity_tmp' AND conname IS NOT NULL

[2016-02-26 15:43:43.555] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'user_activity_tmp' ORDER BY t.relname, i.oid

[2016-02-26 15:43:43.640] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'user_activity_tmp' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 15:43:43.905] [031849] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."user_activity_tmp" LIMIT 1000 OFFSET 0

[2016-02-26 15:43:44.309] [031849] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'user_activity_tmp'

[2016-02-26 15:43:44.408] [031849] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329505

[2016-02-26 15:44:19.393] [031849] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."user_activity_tmp" WHERE "subscription_id" = '12776127' LIMIT 1000 OFFSET 0

[2016-02-26 15:44:19.652] [031849] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'user_activity_tmp'

[2016-02-26 15:44:19.747] [031849] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329505

[2016-02-26 15:45:11.272] [032356] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 15:45:11.351] [032356] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='tmp_activity' ORDER BY ordinal_position

[2016-02-26 15:45:35.154] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:45:35.275] [003859] [dwh-prod] [PGSQL]
     (select t.*, 
         lead (activity_date::date)over w  next_activity_date,
         lead  (gcsi_user_id)  over w next_user
      from tmp.tmp_activity t 
      window w as (
            partition by t.gcsi_user_id
            order by
                activity_date,
                row_number rows between unbounded preceding
            and unbounded following
      )
where t.subscription_id = 12776120
    )


[2016-02-26 15:45:35.355] [003859] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "where"
LINE 12: where t.subscription_id = 12776120
         ^


[2016-02-26 15:45:35.378] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:45:55.571] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:45:56.267] [003859] [dwh-prod] [PGSQL]
     (select t.*, 
         lead (activity_date::date)over w  next_activity_date,
         lead  (gcsi_user_id)  over w next_user
      from tmp.tmp_activity t 
where t.subscription_id = 12776120
      window w as (
            partition by t.gcsi_user_id
            order by
                activity_date,
                row_number rows between unbounded preceding
            and unbounded following
      )

    )


[2016-02-26 15:45:56.481] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:45:56.946] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4871090

[2016-02-26 15:47:14.742] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:47:15.496] [003859] [dwh-prod] [PGSQL]
     select t.*, 
         lead (activity_date::date)over w  next_activity_date,
         lead  (gcsi_user_id)  over w next_user
      from tmp.tmp_activity t 
where t.subscription_id = 12776120
      window w as (
            partition by t.gcsi_user_id
            order by
                activity_date,
                row_number rows between unbounded preceding
            and unbounded following
      )


[2016-02-26 15:47:15.668] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:47:16.100] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4871090

[2016-02-26 15:47:30.523] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:47:30.644] [003859] [dwh-prod] [PGSQL]
     select t.*, 
         lead (activity_date::date)over w  next_activity_date,
         lead  (gcsi_user_id)  over w next_user
      from tmp.tmp_activity t 
where t.subscription_id = 12776127
      window w as (
            partition by t.gcsi_user_id
            order by
                activity_date,
                row_number rows between unbounded preceding
            and unbounded following
      )


[2016-02-26 15:47:30.799] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:47:31.236] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4871090

[2016-02-26 15:49:30.791] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:49:30.916] [003859] [dwh-prod] [PGSQL]
    SELECT
        t1.gcsi_user_id,
        t1.subscription_id,
        t1.activity,
        t1.activity_date::date valid_from,
    case when gcsi_user_id = next_user
         then greatest(activity_date, t1.next_activity_date - integer '1')::date
         else to_date('29991231','yyyymmdd')
    end valid_to,
    case when gcsi_user_id = next_user
         then 'N'
         else 'Y'
    end current_record
 from
     (select t.*, 
         lead (activity_date::date)over w  next_activity_date,
         lead  (gcsi_user_id)  over w next_user
      from tmp.tmp_activity t 
where t.subscription_id = 12776127
      window w as (
            partition by t.gcsi_user_id
            order by
                activity_date,
                row_number rows between unbounded preceding
            and unbounded following
      )
    ) t1
;


[2016-02-26 15:49:31.103] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:49:31.535] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 4871090

[2016-02-26 15:50:51.118] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:50:51.293] [028592] [dwh-prod] [PGSQL]
drop table if exists tmp.user_activity_tmp;

CREATE TABLE tmp.user_activity_tmp AS (
    SELECT
        t1.gcsi_user_id,
        t1.subscription_id,
        t1.activity,
        t1.activity_date::date valid_from,
    case when gcsi_user_id = next_user
         then greatest(activity_date, t1.next_activity_date - integer '1')::date
         else to_date('29991231','yyyymmdd')
    end valid_to,
    case when gcsi_user_id = next_user
         then 'N'
         else 'Y'
    end current_record
 from
     (select t.*, 
         lead (activity_date::date)over w  next_activity_date,
         lead  (gcsi_user_id)  over w next_user
      from tmp.tmp_activity t 
      window w as (
            partition by t.gcsi_user_id
            order by
                activity_date,
                row_number rows between unbounded preceding
            and unbounded following
      )
    ) t1
);


[2016-02-26 15:50:54.467] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:51:01.865] [001803] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 15:51:01.955] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'user_activity_tmp' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 15:51:02.066] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 15:51:02.511] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 15:51:03.041] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'user_activity_tmp' AND conname IS NOT NULL

[2016-02-26 15:51:03.132] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'user_activity_tmp' ORDER BY t.relname, i.oid

[2016-02-26 15:51:03.216] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'user_activity_tmp' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 15:51:03.488] [001803] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."user_activity_tmp" LIMIT 1000 OFFSET 0

[2016-02-26 15:51:03.896] [001803] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'user_activity_tmp'

[2016-02-26 15:51:03.996] [001803] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6330066

[2016-02-26 15:51:40.456] [001803] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."user_activity_tmp" WHERE "gcsi_user_id" = '12776120' LIMIT 1000 OFFSET 0

[2016-02-26 15:51:40.679] [001803] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'user_activity_tmp'

[2016-02-26 15:51:40.774] [001803] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6330066

[2016-02-26 15:52:03.652] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:52:03.767] [028592] [dwh-prod] [PGSQL]
drop table if exists tmp.start_hold_tmp;

create table tmp.start_hold_tmp as 
select u1.* ,  u2.valid_to hold_valid_to, u2.current_record hold_cur_rec
from tmp.user_activity_tmp u1
join tmp.user_activity_tmp u2
  on  u1.subscription_id = u2.subscription_id and 
      u1.valid_from = u2.valid_from
where u1.activity = 'Start'
  and u2.activity = 'Hold Start';

update tmp.user_activity_tmp ua
set valid_to = greatest(st.valid_to, st.hold_valid_to),
    current_record = greatest(st.current_record, st.hold_cur_rec),
    activity = 'Start/Hold'
from tmp.start_hold_tmp st 
where ua.subscription_id = st.subscription_id 
  and ua.valid_from = st.valid_from 
  and ua.activity = 'Start';


[2016-02-26 15:52:04.453] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:52:12.052] [001803] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."user_activity_tmp" WHERE "gcsi_user_id" = '12776120' LIMIT 1000 OFFSET 0

[2016-02-26 15:52:12.196] [001803] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'user_activity_tmp'

[2016-02-26 15:52:12.286] [001803] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6330066

[2016-02-26 15:52:29.295] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:52:29.427] [028592] [dwh-prod] [PGSQL]
delete from tmp.user_activity_tmp ua using tmp.start_hold_tmp st 
where ua.subscription_id = st.subscription_id 
  and ua.valid_from = st.valid_from 
  and ua.activity = 'Hold Start';


[2016-02-26 15:52:29.617] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:52:36.512] [001803] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."user_activity_tmp" WHERE "gcsi_user_id" = '12776120' LIMIT 1000 OFFSET 0

[2016-02-26 15:52:36.655] [001803] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'user_activity_tmp'

[2016-02-26 15:52:36.745] [001803] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6330066

[2016-02-26 15:52:52.225] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:52:52.330] [028592] [dwh-prod] [PGSQL]
-- if there are Start and Cancel records with same 
-- valid_from/valid_to dates, delete the Start record
delete from tmp.user_activity_tmp ua 
where ua.activity = 'Start'
  and ua.valid_from = ua.valid_from 
  and EXISTS
    (select subscription_id
     from tmp.user_activity_tmp ub
     where ua.subscription_id = ub.subscription_id
       and ub.activity = 'Cancel'
       and ua.valid_from = ub.valid_from);


[2016-02-26 15:52:52.875] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 15:52:57.948] [001803] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."user_activity_tmp" WHERE "gcsi_user_id" = '12776120' LIMIT 1000 OFFSET 0

[2016-02-26 15:52:58.087] [001803] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'user_activity_tmp'

[2016-02-26 15:52:58.183] [001803] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6330066

[2016-02-26 16:00:45.771] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:00:45.906] [003859] [dwh-prod] [PGSQL]
  (select t.drupal_user_id,
        t.gcsi_user_id,
        ut.user_start_date,
        case when t.end_date < ua.valid_to
             then t.end_date
             else NULL
        end user_end_date,
        t.subscription_id,
        t.start_date subscription_start_date,
        paid_through_date,
        t.next_review_date,
        case when t.cancel_date < ua.valid_to then t.cancel_date
             when activity = 'Cancel' then  ua.valid_from
             else NULL
        end cancel_date,        
        case when t.end_date < ua.valid_to
             then t.end_date
             else NULL
        end subscription_end_date,
        ua.activity,
        case when ua.activity in ('Start', 'Hold End') then 'Active'
             when ua.activity in ('Start/Hold', 'Hold Start') then 'Hold'
             when ua.activity in ('Cancel', 'End','Paid_Through') then 'Cancelled'
        end status,
        case when ua.activity in ('Start/Hold', 'Hold Start', 'Paid_Through') then 'f'::bool
             when t.cancel_date is null then 't'::bool
             when t.cancel_date > valid_to then 
                   case when ua.activity in ('Cancel', 'End')
                        then 'f'::bool
                        else 't'::bool
                   end
             when t.cancel_date < paid_through_date then 't'::bool
             else 'f'::bool
        end entitled,  --swag.  use drupal instead?
        t.plan_id,
                seg.segment_id,
        s.plan_name,
        seg.plan_period,
        t.channel,
        s.campaign_dept,
        s.user_behavior_segment,
        t.source_name,
        t.service_name,
        case when ut.user_start_date::date < t.start_date::date
             then 'Winback'
             else 'New User'
        end winback,
        ut.onboarding_segment,
        ut.onboarding_parent,
        ua.valid_from,
        ua.valid_to,
        ua.current_record
from tmp.t_uniq_subs t
left join tmp.user_activity_tmp ua
   on t.subscription_id = ua.subscription_id
join tmp.user_attributes_tmp ut
   on t.gcsi_user_id = ut.gcsi_user_id
join tmp.subscription_attributes_tmp s
   on t.subscription_id = s.subscription_id
join tmp.segments_tmp seg
   on ua.subscription_id = seg.subscription_id and 
      ua.valid_from = seg.valid_from
where t.gcsi_user_id = 12776120
order by gcsi_user_id, valid_from);  


[2016-02-26 16:00:46.830] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:01:31.133] [001803] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."user_activity_tmp" WHERE "gcsi_user_id" = '12776120' LIMIT 1000 OFFSET 0

[2016-02-26 16:01:31.271] [001803] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'user_activity_tmp'

[2016-02-26 16:01:31.360] [001803] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6330066

[2016-02-26 16:03:13.692] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:03:13.837] [003859] [dwh-prod] [PGSQL]
  (select t.drupal_user_id,
        t.gcsi_user_id,
        ut.user_start_date,
        case when t.end_date < ua.valid_to
             then t.end_date
             else NULL
        end user_end_date,
        t.subscription_id,
        t.start_date subscription_start_date,
        paid_through_date,
        t.next_review_date,
        case when t.cancel_date < ua.valid_to then t.cancel_date
             when activity = 'Cancel' then  ua.valid_from
             else NULL
        end cancel_date,        
        case when t.end_date < ua.valid_to
             then t.end_date
             else NULL
        end subscription_end_date,
        ua.activity,
        case when ua.activity in ('Start', 'Hold End') then 'Active'
             when ua.activity in ('Start/Hold', 'Hold Start') then 'Hold'
             when ua.activity in ('Cancel', 'End','Paid_Through') then 'Cancelled'
        end status,
        ua.valid_from,
        ua.valid_to,
        ua.current_record
from tmp.t_uniq_subs t
left join tmp.user_activity_tmp ua
   on t.subscription_id = ua.subscription_id
join tmp.user_attributes_tmp ut
   on t.gcsi_user_id = ut.gcsi_user_id
join tmp.subscription_attributes_tmp s
   on t.subscription_id = s.subscription_id
join tmp.segments_tmp seg
   on ua.subscription_id = seg.subscription_id and 
      ua.valid_from = seg.valid_from
where t.gcsi_user_id = 12776120
order by gcsi_user_id, valid_from);  


[2016-02-26 16:03:14.267] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:03:43.072] [001803] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."user_activity_tmp" WHERE "gcsi_user_id" = '12776120' LIMIT 1000 OFFSET 0

[2016-02-26 16:03:43.222] [001803] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'user_activity_tmp'

[2016-02-26 16:03:43.312] [001803] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6330066

[2016-02-26 16:05:08.984] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:05:09.113] [003859] [dwh-prod] [PGSQL]
  (select t.drupal_user_id,
        t.gcsi_user_id,
        t.subscription_id,
        t.start_date subscription_start_date,
        paid_through_date,
        t.next_review_date,
        case when t.cancel_date < ua.valid_to then t.cancel_date
             when activity = 'Cancel' then  ua.valid_from
             else NULL
        end cancel_date,        
        case when t.end_date < ua.valid_to
             then t.end_date
             else NULL
        end subscription_end_date,
        ua.activity,
        case when ua.activity in ('Start', 'Hold End') then 'Active'
             when ua.activity in ('Start/Hold', 'Hold Start') then 'Hold'
             when ua.activity in ('Cancel', 'End','Paid_Through') then 'Cancelled'
        end status,
        ua.valid_from,
        ua.valid_to,
        ua.current_record
from tmp.t_uniq_subs t
left join tmp.user_activity_tmp ua
   on t.subscription_id = ua.subscription_id
where t.gcsi_user_id = 12776120
order by gcsi_user_id, valid_from); 


[2016-02-26 16:05:09.320] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:05:46.789] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:05:46.915] [003859] [dwh-prod] [PGSQL]
  (select t.drupal_user_id,
        t.gcsi_user_id,
        t.subscription_id,
        t.start_date subscription_start_date,
        paid_through_date,
        t.next_review_date,
        case when t.cancel_date < ua.valid_to then t.cancel_date
             when activity = 'Cancel' then  ua.valid_from
             else NULL
        end cancel_date,        
        case when t.end_date < ua.valid_to
             then t.end_date
             else NULL
        end subscription_end_date,
        ua.activity,
        case when ua.activity in ('Start', 'Hold End') then 'Active'
             when ua.activity in ('Start/Hold', 'Hold Start') then 'Hold'
             when ua.activity in ('Cancel', 'End','Paid_Through') then 'Cancelled'
        end status,
        ua.valid_from,
        ua.valid_to,
        ua.current_record
from tmp.t_uniq_subs t
left join tmp.user_activity_tmp ua
   on t.subscription_id = ua.subscription_id
join tmp.user_attributes_tmp ut
   on t.gcsi_user_id = ut.gcsi_user_id
join tmp.subscription_attributes_tmp s
   on t.subscription_id = s.subscription_id
join tmp.segments_tmp seg
   on ua.subscription_id = seg.subscription_id and 
      ua.valid_from = seg.valid_from
where t.gcsi_user_id = 12776120
order by gcsi_user_id, valid_from);  


[2016-02-26 16:05:47.400] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:06:22.906] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:06:23.048] [003859] [dwh-prod] [PGSQL]
  (select t.drupal_user_id,
        t.gcsi_user_id,
        t.subscription_id,
        t.start_date subscription_start_date,
        paid_through_date,
        t.next_review_date,
        case when t.cancel_date < ua.valid_to then t.cancel_date
             when activity = 'Cancel' then  ua.valid_from
             else NULL
        end cancel_date,        
        case when t.end_date < ua.valid_to
             then t.end_date
             else NULL
        end subscription_end_date,
        ua.activity,
        case when ua.activity in ('Start', 'Hold End') then 'Active'
             when ua.activity in ('Start/Hold', 'Hold Start') then 'Hold'
             when ua.activity in ('Cancel', 'End','Paid_Through') then 'Cancelled'
        end status,
        ua.valid_from,
        ua.valid_to,
        ua.current_record
from tmp.t_uniq_subs t
left join tmp.user_activity_tmp ua
   on t.subscription_id = ua.subscription_id
join tmp.user_attributes_tmp ut
   on t.gcsi_user_id = ut.gcsi_user_id
join tmp.subscription_attributes_tmp s
   on t.subscription_id = s.subscription_id
where t.gcsi_user_id = 12776120
order by gcsi_user_id, valid_from);  


[2016-02-26 16:06:23.317] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:07:26.299] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:07:26.433] [003859] [dwh-prod] [PGSQL]
  (select t.drupal_user_id,
        t.gcsi_user_id,
        t.subscription_id,
        t.start_date subscription_start_date,
        paid_through_date,
        t.next_review_date,
        case when t.cancel_date < ua.valid_to then t.cancel_date
             when activity = 'Cancel' then  ua.valid_from
             else NULL
        end cancel_date,        
        case when t.end_date < ua.valid_to
             then t.end_date
             else NULL
        end subscription_end_date,
        ua.activity,
        case when ua.activity in ('Start', 'Hold End') then 'Active'
             when ua.activity in ('Start/Hold', 'Hold Start') then 'Hold'
             when ua.activity in ('Cancel', 'End','Paid_Through') then 'Cancelled'
        end status,
        ua.valid_from,
        ua.valid_to,
        ua.current_record
from tmp.t_uniq_subs t
left join tmp.user_activity_tmp ua
   on t.subscription_id = ua.subscription_id
join tmp.user_attributes_tmp ut
   on t.gcsi_user_id = ut.gcsi_user_id
where t.gcsi_user_id = 12776120
order by gcsi_user_id, valid_from);  


[2016-02-26 16:07:26.659] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:08:01.443] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:08:01.587] [003859] [dwh-prod] [PGSQL]
  (select t.drupal_user_id,
        t.gcsi_user_id,
        t.subscription_id,
        t.start_date subscription_start_date,
        paid_through_date,
        t.next_review_date,
        case when t.cancel_date < ua.valid_to then t.cancel_date
             when activity = 'Cancel' then  ua.valid_from
             else NULL
        end cancel_date,        
        case when t.end_date < ua.valid_to
             then t.end_date
             else NULL
        end subscription_end_date,
        ua.activity,
        case when ua.activity in ('Start', 'Hold End') then 'Active'
             when ua.activity in ('Start/Hold', 'Hold Start') then 'Hold'
             when ua.activity in ('Cancel', 'End','Paid_Through') then 'Cancelled'
        end status,
        ua.valid_from,
        ua.valid_to,
        ua.current_record
from tmp.t_uniq_subs t
left join tmp.user_activity_tmp ua
   on t.subscription_id = ua.subscription_id
join tmp.user_attributes_tmp ut
   on t.gcsi_user_id = ut.gcsi_user_id
join tmp.subscription_attributes_tmp s
   on t.subscription_id = s.subscription_id
join tmp.segments_tmp seg
   on ua.subscription_id = seg.subscription_id and 
      ua.valid_from = seg.valid_from
where t.gcsi_user_id = 12776120
order by gcsi_user_id, valid_from);  


[2016-02-26 16:08:02.025] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:09:47.357] [007609] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 16:09:47.442] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'segments_tmp' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 16:09:47.558] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 16:09:48.048] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 16:09:48.209] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'segments_tmp' AND conname IS NOT NULL

[2016-02-26 16:09:48.294] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'segments_tmp' ORDER BY t.relname, i.oid

[2016-02-26 16:09:48.597] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'segments_tmp' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 16:09:48.850] [007609] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."segments_tmp" LIMIT 1000 OFFSET 0

[2016-02-26 16:09:49.173] [007609] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'segments_tmp'

[2016-02-26 16:09:49.271] [007609] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329517

[2016-02-26 16:10:09.483] [007609] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."segments_tmp" WHERE "subscription_id" = '12776127' LIMIT 1000 OFFSET 0

[2016-02-26 16:10:09.696] [007609] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'segments_tmp'

[2016-02-26 16:10:09.785] [007609] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329517

[2016-02-26 16:12:00.102] [008278] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 16:12:00.189] [008278] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='user_activity_tmp' ORDER BY ordinal_position

[2016-02-26 16:12:00.864] [008286] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 16:12:00.943] [008286] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='gcsi' AND table_name='subscription_event' ORDER BY ordinal_position

[2016-02-26 16:12:01.612] [008287] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 16:12:01.693] [008287] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='gcsi' AND table_name='subscription_plan_event' ORDER BY ordinal_position

[2016-02-26 16:12:35.064] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:12:35.206] [003859] [dwh-prod] [PGSQL]
  (select t.drupal_user_id,
        t.gcsi_user_id,
        t.subscription_id,
        t.start_date subscription_start_date,
        paid_through_date,
        t.next_review_date,
        case when t.cancel_date < ua.valid_to then t.cancel_date
             when activity = 'Cancel' then  ua.valid_from
             else NULL
        end cancel_date,        
        case when t.end_date < ua.valid_to
             then t.end_date
             else NULL
        end subscription_end_date,
        ua.activity,
        case when ua.activity in ('Start', 'Hold End') then 'Active'
             when ua.activity in ('Start/Hold', 'Hold Start') then 'Hold'
             when ua.activity in ('Cancel', 'End','Paid_Through') then 'Cancelled'
        end status,
        ua.valid_from,
        ua.valid_to,
        ua.current_record
from tmp.t_uniq_subs t
left join tmp.user_activity_tmp ua
   on t.subscription_id = ua.subscription_id
join tmp.user_attributes_tmp ut
   on t.gcsi_user_id = ut.gcsi_user_id
join tmp.subscription_attributes_tmp s
   on t.subscription_id = s.subscription_id
join tmp.segments_tmp seg
   on ua.subscription_id = seg.subscription_id and 
      ua.valid_from = seg.valid_from
where t.gcsi_user_id = 12776120
order by gcsi_user_id, valid_from);  

            (select ua.subscription_id, 
                    ua.valid_from, 
                    se.schedule_date,
                    spe .segment_id
             from tmp.user_activity_tmp ua
             join gcsi.subscription_event se on ua.subscription_id = se.subscription_id
             join gcsi.subscription_plan_event spe on se.id = spe.id 
             where se.schedule_date <= ua.valid_to
and ua.subscription_id = 12776127)


[2016-02-26 16:12:37.943] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:14:40.643] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:14:40.784] [003859] [dwh-prod] [PGSQL]
        (select subscription_id,  
               valid_from,
               schedule_date,
               last_value(segment_id) 
               over (partition by subscription_id, valid_from 
               order by schedule_date
               rows between unbounded preceding and unbounded following) segment_id
        from
            (select ua.subscription_id, 
                    ua.valid_from, 
                    se.schedule_date,
                    spe .segment_id
             from tmp.user_activity_tmp ua
             join gcsi.subscription_event se on ua.subscription_id = se.subscription_id
             join gcsi.subscription_plan_event spe on se.id = spe.id 
             where se.schedule_date <= ua.valid_to 
and ua.subscription_id = 12776127) t) t1


[2016-02-26 16:14:40.867] [003859] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "t1"
LINE 17: and ua.subscription_id = 12776127) t) t1
                                               ^


[2016-02-26 16:14:40.891] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:14:51.575] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:14:51.720] [003859] [dwh-prod] [PGSQL]
        (select subscription_id,  
               valid_from,
               schedule_date,
               last_value(segment_id) 
               over (partition by subscription_id, valid_from 
               order by schedule_date
               rows between unbounded preceding and unbounded following) segment_id
        from
            (select ua.subscription_id, 
                    ua.valid_from, 
                    se.schedule_date,
                    spe .segment_id
             from tmp.user_activity_tmp ua
             join gcsi.subscription_event se on ua.subscription_id = se.subscription_id
             join gcsi.subscription_plan_event spe on se.id = spe.id 
             where se.schedule_date <= ua.valid_to 
and ua.subscription_id = 12776127) t) 


[2016-02-26 16:14:52.617] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:16:54.415] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:16:54.544] [003859] [dwh-prod] [PGSQL]
(select t3.*,
    seg.duration_period::interval plan_period
 from
    (select subscription_id, valid_from,
            max(segment_id) segment_id
    from
        (select subscription_id,  
               valid_from,
               schedule_date,
               last_value(segment_id) 
               over (partition by subscription_id, valid_from 
               order by schedule_date
               rows between unbounded preceding and unbounded following) segment_id
        from
            (select ua.subscription_id, 
                    ua.valid_from, 
                    se.schedule_date,
                    spe .segment_id
             from tmp.user_activity_tmp ua
             join gcsi.subscription_event se on ua.subscription_id = se.subscription_id
             join gcsi.subscription_plan_event spe on se.id = spe.id 
             where se.schedule_date <= ua.valid_to
               and ua.subscription_id = 12776127) t) t1
    group by subscription_id, valid_from) t3
 join gcsi.segment seg  on t3.segment_id = seg.id);


[2016-02-26 16:16:55.387] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:16:55.822] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6330066

[2016-02-26 16:17:41.494] [010012] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 16:17:41.573] [010012] [dwh-prod] [PGSQL]
SELECT column_name FROM information_schema.columns WHERE table_schema='tmp' AND table_name='segments_tmp' ORDER BY ordinal_position

[2016-02-26 16:17:56.809] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:17:56.916] [003859] [dwh-prod] [PGSQL]
select * from tmp.segments_tmp
where subscription_id = 12776127;


[2016-02-26 16:17:57.080] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:17:57.513] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329517

[2016-02-26 16:18:15.440] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:18:15.562] [028592] [dwh-prod] [PGSQL]
-- this is slightly different then Parker's query

drop table if exists tmp.paid_subscriptions;

create table tmp.paid_subscriptions as 
SELECT
       distinct gs.id subscription_id
   FROM
       gcsi.subscription gs
   JOIN gcsi.subscription_event se ON se.subscription_id = gs.id
   JOIN gcsi.subscription_transaction_subscription_events stse ON stse.subscription_event_id = se.id
   JOIN gcsi.subscription_transaction st ON st.id = stse.subscription_transaction_id and st.txn_state = 'SETTLED' 
   LEFT JOIN gcsi.credit_card_transaction cct ON cct.id = st.id
   LEFT JOIN gcsi.pay_pal_transaction ppt ON ppt.id = st.id
        AND (cct.amount > 0 OR ppt.amount > 0);


DROP TABLE if exists tmp.t_subscriptions_snap;
CREATE TABLE tmp.t_subscriptions_snap AS SELECT
    d.uid AS drupal_user_id,
    user_id AS gcsi_user_id,
    s.subscription_id,
    s.start_date,
    s.cancel_date,
    s.paid_through_date,
    s.next_review_date,
    s.end_date,
    s.plan_id,
    s.division,
    s.source_name,
    s.service_name,
    s.status,
    s.channel,
    ROW_NUMBER () OVER w AS rn
FROM
    gcsi.t_subscriptions s
JOIN gcsi.users u ON u. ID = s.user_id
JOIN drupal.gcsi_users d ON u.uuid = d.user_uuid
join tmp.paid_subscriptions ps on ps.subscription_id = s.subscription_id
WHERE
    source_name IN (
        'Gaiam TV',
        'MYO'
    ) 
WINDOW w AS (
PARTITION BY user_id
ORDER BY
    start_date,
    paid_through_date,
    end_date ROWS BETWEEN UNBOUNDED PRECEDING
AND UNBOUNDED FOLLOWING
);


drop table if exists tmp.subscriptions_tmp;

create table tmp.subscriptions_tmp as
select b.*,
       -- first attempt at "un-overlapping".  If two subscriptions just butt up against each 
       -- other (e.g. plan changes) this will be sufficient.
       case when (start_date,cancel_date) overlaps (next_start, next_end)
                then next_start - interval '1 day'
            when cancel_date is null and next_start is not null 
                then next_start - interval '1 day'
            when next_start is null then '2999-12-31'::date
            else cancel_date
       end  valid_to
from  --- start with subscriptions, order them by start_date and 
      --- get the start and end of the next subscription
      --- get the start and end of the next subscription for this user_id
    (select gcsi_user_id, subscription_id, 
            start_date, cancel_date, paid_through_date,
            case when cancel_date is NULL then age(current_date, start_date) 
                 when paid_through_date > cancel_date then age(paid_through_date,start_date)
                 else age(cancel_date,start_date)
            end subscription_age,
            lead(start_date) over w  next_start,
            lead(cancel_date)over w  next_end
    from 
        (select   gcsi_user_id, subscription_id, paid_through_date,
            coalesce(cancel_date,end_date) cancel_date,
            start_date            
        from tmp.t_subscriptions_snap) a
    window w as (
    partition by gcsi_user_id
    order by paid_through_date, start_date
    rows between unbounded preceding and unbounded following
    )
 order by gcsi_user_id, start_date, subscription_age, subscription_id) b;


-- this can only happen when there is another subscription with the same start date
-- the last subscription (see ordering above) with the same start date will not meet this condition 
delete from tmp.subscriptions_tmp
where valid_to < start_date;

-- two subscriptions with same start_date, different cancel dates
-- delete the one with the shorter age
delete from tmp.subscriptions_tmp st1
where EXISTS
   (select subscription_id 
    from tmp.subscriptions_tmp st2
    where st1.gcsi_user_id = st2.gcsi_user_id
      and st1.subscription_id <> st2.subscription_id
      and st1.start_date::date = st2.start_date::date
      and st1.subscription_age < st2.subscription_age);

-- two subscriptions with that still overlap (different start_dates)
-- this can include open subscriptions, so use the current date if needed
-- delete the one with the shorter age
delete from tmp.subscriptions_tmp st1
where EXISTS
   (select subscription_id 
    from tmp.subscriptions_tmp st2
    where st1.gcsi_user_id = st2.gcsi_user_id
      and st1.subscription_id <> st2.subscription_id
      and (st1.start_date,st1.valid_to) overlaps (st2.start_date, coalesce(st2.valid_to,current_date))
      and  st1.subscription_age < st2.subscription_age);



-- this should be zero; testing for overlaps
select count(1)
from  tmp.subscriptions_tmp st1
where EXISTS
   (select subscription_id 
    from tmp.subscriptions_tmp st2
    where st1.gcsi_user_id = st2.gcsi_user_id
      and st1.subscription_id <> st2.subscription_id
      and (st1.start_date,st1.valid_to) overlaps (st2.start_date, coalesce(st2.valid_to,current_date)));

select count(1) from tmp.subscriptions_tmp where valid_to is null;


drop table if exists tmp.t_uniq_subs;


-- now use this to create a uniq_subs_table
create table tmp.t_uniq_subs as
select t1.*
from
        (select t.drupal_user_id,
        t.gcsi_user_id,
        t.subscription_id,
        t.start_date,
        t.paid_through_date,
        t.next_review_date,
        case when t.cancel_date is not null
             then least(t.cancel_date, d1.valid_to)
             else NULL
        end  cancel_date,
        case when t.end_date is not null
             then least(t.end_date, d1.valid_to)
            else NULL
        end  end_date,
        t.plan_id,
        t.division,
        t.source_name,
        t.service_name,
        t.channel,
        t.rn
  from tmp.t_subscriptions_snap t
  join tmp.subscriptions_tmp d1
    on t.subscription_id = d1.subscription_id) t1
where t1.start_date::date <> t1.cancel_date::date
      or t1.cancel_date is null;



drop table if exists tmp.users_tmp;

create table tmp.users_tmp as SELECT
    s.gcsi_user_id,
    s.subscription_id,
    s.start_date,
    s.cancel_date,
    s.paid_through_date,
    s.next_review_date,
    s.end_date,
    lead(s.subscription_id) over w next_subscription_id,
    lead(s.start_date) over w next_start_date
FROM
    tmp.t_uniq_subs s
WINDOW w AS (
        PARTITION BY s.gcsi_user_id
        ORDER BY
            rn
    );


drop table  if exists  tmp.tmp_holds_prelim;

create table  tmp.tmp_holds_prelim as
    (SELECT DISTINCT on (gcsi_user_id,sh.subscription_id, hold_start_date)
        sh.id,
        s.gcsi_user_id,
        sh.subscription_id,
        sh.start_date::date AS hold_start_date,
        sh.end_date::date AS hold_end_date
    FROM
        gcsi.subscription_hold sh
    JOIN tmp.users_tmp s ON sh.subscription_id = s.subscription_id
    WHERE
        deleted = 'f' AND
        s.start_date <= sh.start_date
    ORDER BY gcsi_user_id, subscription_id, hold_start_date);

-- if the subscription has a cancel_date and an open hold 
-- set the hold_end date to the cancel_date
update tmp.tmp_holds_prelim h
set hold_end_date = ts.cancel_date::date
from gcsi.t_subscriptions ts
where h.subscription_id = ts.subscription_id
  and h.hold_end_date is NULL
  and ts.cancel_date is not null;

drop table  if exists  tmp.tmp_holds;

create table tmp.tmp_holds as
  (select 
    h1.id, 
    h1.gcsi_user_id,
    h1.subscription_id, 
    h1.hold_start_date,
    case when h1.hold_end_date is null then
         case when h2.new_end_date is null
              then h2.last_start_date + interval '6 months'
              else h2.new_end_date
         end
         else h1.hold_end_date
    end hold_end_date
from  tmp.tmp_holds_prelim h1
left join
    (select id, min(new_end_date) new_end_date,
                max(start_date) last_start_date
     from
        (select h3.*,
               h4.id  id2,
               h4.hold_end_date new_end_date,
               h4.hold_start_date start_date
        from tmp.tmp_holds_prelim h3
        join tmp.tmp_holds_prelim h4
          on h3.subscription_id = h4.subscription_id and 
             h3.hold_start_date < h4.hold_start_date
        where h3.hold_end_date is null) t
     group by id) h2
    on h1.id  = h2.id);

drop sequence if exists hold_groups;
create sequence hold_groups;

drop table if exists tmp.hold_overlaps2;

-- take care of overlapping holds
create table tmp.hold_overlaps2 as
select  
   case when prev_id is null then 0
        when hold_start_date <=  prev_hold_end then 1
        when hold_end_date = prev_hold_end then  2
        when (hold_start_date - interval '1 day') = prev_hold_end then 3
        else 0
   end hold_overlap,
   case when prev_id is null then nextval('hold_groups')
        when hold_start_date <=  prev_hold_end then 0
        when hold_end_date = prev_hold_end then 0
        when (hold_start_date - interval '1 day') = prev_hold_end then 0
        else nextval('hold_groups')
   end hold_group,
   h3.*
from
    (select h1.*,
        first_value(id) over w prev_id,
        lag(hold_end_date) over w prev_hold_end,
        row_number() over w hold_number
    from  tmp.tmp_holds h1
    where EXISTS
        (select subscription_id 
         from tmp.tmp_holds h2
         where h1.subscription_id = h2.subscription_id
           and h1.id <> h2.id
           and ((h1.hold_start_date::date,h1.hold_end_date) overlaps (h2.hold_start_date, h2.hold_end_date)
            or (h2.hold_start_date::date - h1.hold_end_date::date) between 0 and  1 -- same day or next day
            or (h1.hold_start_date::date -  h2.hold_end_date::date) between 0 and  1))  -- need the other half to stitch them together
    window w as
    (partition by subscription_id 
     order by hold_start_date
     rows between unbounded preceding and unbounded following
    )) h3;


update tmp.hold_overlaps2 h1 set hold_group = 
   (select max(hold_group) from tmp.hold_overlaps2 h2
    where h2.hold_number < h1.hold_number AND
         h2.gcsi_user_id = h1.gcsi_user_id and
         h2.subscription_id = h1.subscription_id)
where hold_group = 0;

delete from tmp.tmp_holds where id in (select id from tmp.hold_overlaps2 where hold_overlap > 0);

update tmp.tmp_holds h 
set hold_end_date = o.hold_end_date
FROM
    (select * from 
        (select hold_overlap,
               hold_group, 
               first_value(id) over w id,
               last_value(hold_end_date) over w hold_end_date
        from tmp.hold_overlaps2
        window w as (
           partition by hold_group
           order by hold_number
           rows between unbounded preceding and unbounded following )) t
    where hold_overlap = 0) o
where h.id = o.id;



truncate table tmp.tmp_activity;


INSERT INTO tmp.tmp_activity (
    SELECT DISTINCT
        ON (subscription_id) gcsi_user_id,
        subscription_id,
        start_date AS activity_date,
        'Start' activity
    FROM
        tmp.users_tmp
);

INSERT INTO tmp.tmp_activity (
    SELECT DISTINCT
        ON (subscription_id) gcsi_user_id,
        subscription_id,
        end_date AS activity_date,
        'End' activity
    FROM
        tmp.users_tmp
  where end_date is not null and 
        (end_date::date > cancel_date::date OR
         cancel_date is null)
);


INSERT INTO tmp.tmp_activity (
    SELECT DISTINCT
        ON (subscription_id) gcsi_user_id,
        subscription_id,
        paid_through_date AS activity_date,
        'Paid_Through' activity
    FROM
        tmp.users_tmp u1
  where paid_through_date::date > cancel_date::date
    and paid_through_date::date > end_date::date
    and not EXISTS  -- no overlapping subscription
        (select subscription_id 
         from tmp.users_tmp u2
         where u1.gcsi_user_id = u2.gcsi_user_id
           and u1.subscription_id <> u2.subscription_id
           and u1.start_date < u2.start_date
           and u2.start_date::date <= u1.paid_through_date::date)
);
/*
INSERT INTO tmp.tmp_activity (
    SELECT DISTINCT
        ON (subscription_id) gcsi_user_id,
        subscription_id,
        next_review_date AS activity_date,
        'Next Review' activity
    FROM
        tmp.users_tmp
where next_review_date is not null
);
*/
INSERT INTO tmp.tmp_activity (
    SELECT DISTINCT
        ON (subscription_id) gcsi_user_id,
        subscription_id,
        cancel_date AS activity_date,
        'Cancel' activity
    FROM
        tmp.users_tmp
where cancel_date is not null
);


INSERT INTO tmp.tmp_activity (
    SELECT DISTINCT
        ON (subscription_id, hold_start_date) gcsi_user_id,
        subscription_id,
        hold_start_date AS activity_date,
        'Hold Start' activity,
        id
    FROM
        tmp.tmp_holds
where hold_start_date is not null
);


INSERT INTO tmp.tmp_activity (
    SELECT DISTINCT
        ON (subscription_id, hold_end_date) gcsi_user_id,
        subscription_id,
        hold_end_date AS activity_date,
        'Hold End' activity,
        id
    FROM
        tmp.tmp_holds
where hold_end_date is not null
);

 -- the following adjustments came about from testing the creation 
 -- of the user dimension and finding errors

 
 -- this is primarily to handle the case where Travis swept the database and
 -- multiple subscriptions for a user have the same cancel date.  If a subscription has a
 -- cancel or hold end activity that overlaps the start of the next subscription start, force it
 -- to one day before the subscription start

with t1 as
(select subscription_id, 
        next_start_date::date - interval '1 day' cancel_date
from tmp.users_tmp)
update tmp.tmp_activity ta set activity_date = t1.cancel_date
from t1
where (activity = 'Cancel' OR
       activity = 'Hold End')
  and activity_date::date > t1.cancel_date::date
  and ta.subscription_id = t1.subscription_id;


 -- when I have a 'Hold End' activity that's the 
 -- same date (or later) as the cancel date, delete the 'Hold End' record
delete from tmp.tmp_activity ta
where activity = 'Hold End' 
  and exists 
     (select ta.subscription_id
      from tmp.tmp_activity t1 
      where t1.subscription_id = ta.subscription_id
        and t1.activity_date::date <= ta.activity_date::date
        and t1.activity = 'Cancel');


 -- when I have a 'Hold Start' activity that's the 
 -- same date as the cancel date, delete the 'Hold Start' record
delete from tmp.tmp_activity ta
where activity = 'Hold Start' 
  and exists 
     (select ta.subscription_id
      from tmp.tmp_activity t1 
      where t1.subscription_id = ta.subscription_id
        and t1.activity_date::date <= ta.activity_date::date
        and t1.activity = 'Cancel');

-- when I have a 'Hold End' and a new 'Hold Start' on the same day, delete the 'Hold End'
delete from tmp.tmp_activity ta
where activity = 'Hold End' 
  and exists 
     (select ta.subscription_id
      from tmp.tmp_activity t1 
      where t1.subscription_id = ta.subscription_id
        and t1.activity_date::date = ta.activity_date::date
        and t1.activity = 'Hold Start'
        and t1.row_number > ta.row_number);

 -- when I have two consecutive 'Hold Start' activities  delete the  second one
delete from tmp.tmp_activity ta
where activity = 'Hold Start' 
  and (subscription_id, activity_date) in 
       (select subscription_id, activity_date from 
          (select gcsi_user_id, subscription_id, activity_date, activity,
                 lag(activity) over
                      (partition by subscription_id order by activity_date  
                       ROWS BETWEEN UNBOUNDED PRECEDING
                       AND UNBOUNDED FOLLOWING)  prev_activity
          from tmp.tmp_activity) t
where activity = 'Hold Start' and prev_activity = 'Hold Start');

 -- when I have two consecutive 'Hold End' activities  delete the  first one
delete from tmp.tmp_activity ta
where activity = 'Hold End' 
  and (subscription_id, activity_date) in 
       (select subscription_id, activity_date from 
          (select gcsi_user_id, subscription_id, activity_date, activity,
                 lead(activity) over
                      (partition by subscription_id order by activity_date  
                       ROWS BETWEEN UNBOUNDED PRECEDING
                       AND UNBOUNDED FOLLOWING)  next_activity
          from tmp.tmp_activity) t
where activity = 'Hold End' and next_activity = 'Hold End');

 -- when I have  'Hold Start' and 'Hold End' on the same day, bump the 'Hold End' by one DAY
-- so I don't have overlapping valid_from/valid_to dates
update tmp.tmp_activity ta
set activity_date = activity_date + interval '1 day'
where activity = 'Hold End' 
  and exists 
     (select ta.subscription_id
      from tmp.tmp_activity t1 
      where t1.subscription_id = ta.subscription_id
        and t1.activity_date::date = ta.activity_date::date
        and t1.activity = 'Hold Start'
        and t1.row_number = ta.row_number);



 --OK!!! Finally ready to create the table with valid_from and valid_to dates
drop table if exists tmp.user_activity_tmp;

CREATE TABLE tmp.user_activity_tmp AS (
    SELECT
        t1.gcsi_user_id,
        t1.subscription_id,
        t1.activity,
        t1.activity_date::date valid_from,
    case when gcsi_user_id = next_user
         then greatest(activity_date, t1.next_activity_date - integer '1')::date
         else to_date('29991231','yyyymmdd')
    end valid_to,
    case when gcsi_user_id = next_user
         then 'N'
         else 'Y'
    end current_record
 from
     (select t.*, 
         lead (activity_date::date)over w  next_activity_date,
         lead  (gcsi_user_id)  over w next_user
      from tmp.tmp_activity t 
      window w as (
            partition by t.gcsi_user_id
            order by
                activity_date,
                row_number rows between unbounded preceding
            and unbounded following
      )
    ) t1
);


--one more thing to clean up situation wihere Start and Hold Start have same date

drop table if exists tmp.start_hold_tmp;

create table tmp.start_hold_tmp as 
select u1.* ,  u2.valid_to hold_valid_to, u2.current_record hold_cur_rec
from tmp.user_activity_tmp u1
join tmp.user_activity_tmp u2
  on  u1.subscription_id = u2.subscription_id and 
      u1.valid_from = u2.valid_from
where u1.activity = 'Start'
  and u2.activity = 'Hold Start';

update tmp.user_activity_tmp ua
set valid_to = greatest(st.valid_to, st.hold_valid_to),
    current_record = greatest(st.current_record, st.hold_cur_rec),
    activity = 'Start/Hold'
from tmp.start_hold_tmp st 
where ua.subscription_id = st.subscription_id 
  and ua.valid_from = st.valid_from 
  and ua.activity = 'Start';

delete from tmp.user_activity_tmp ua using tmp.start_hold_tmp st 
where ua.subscription_id = st.subscription_id 
  and ua.valid_from = st.valid_from 
  and ua.activity = 'Hold Start';

-- if there are Start and Cancel records with same 
-- valid_from/valid_to dates, delete the Start record
delete from tmp.user_activity_tmp ua 
where ua.activity = 'Start'
  and ua.valid_from = ua.valid_from 
  and EXISTS
    (select subscription_id
     from tmp.user_activity_tmp ub
     where ua.subscription_id = ub.subscription_id
       and ub.activity = 'Cancel'
       and ua.valid_from = ub.valid_from);



-- get plan segments for each row
drop table if exists tmp.segments_tmp;

create table tmp.segments_tmp as 
(select t3.*,
    seg.duration_period::interval plan_period
 from
    (select subscription_id, valid_from,
            max(segment_id) segment_id
    from
        (select subscription_id,  
               valid_from,
               schedule_date,
               last_value(segment_id) 
               over (partition by subscription_id, valid_from 
               order by schedule_date
               rows between unbounded preceding and unbounded following) segment_id
        from
            (select ua.subscription_id, 
                    ua.valid_from, 
                    se.schedule_date,
                    spe .segment_id
             from tmp.user_activity_tmp ua
             join gcsi.subscription_event se on ua.subscription_id = se.subscription_id
             join gcsi.subscription_plan_event spe on se.id = spe.id 
             where se.schedule_date <= ua.valid_to) t) t1
    group by subscription_id, valid_from) t3
 join gcsi.segment seg  on t3.segment_id = seg.id);


DROP TABLE if exists tmp.user_attributes_tmp;

create table tmp.user_attributes_tmp as (
select t.*,
       uo.segment_name onboarding_segment,
       uo.parent_segment onboarding_parent
from
    (select
        drupal_user_id,
        gcsi_user_id,
        min (start_date :: date) user_start_date
    from
        tmp.t_uniq_subs
   group by drupal_user_id, gcsi_user_id) t
 left JOIN
   (select uid, max(choice) choice
     from 
       (select uid,
               last_value(choice) 
                   over (partition by uid 
                   order by timestamp
                   rows between unbounded preceding and unbounded following) as choice
        from drupal.user_onboard_event_log) t
      group by uid) dr
   on dr.uid = t.drupal_user_id
left join common.user_onboard_segments uo
    on dr.choice = segment_id);
    
-- these are subscription-level attributes not in t_subscriptions
drop table if exists tmp.subscription_attributes_tmp;

create table tmp.subscription_attributes_tmp as
select us.subscription_id,
       p.product_name plan_name,
       c.department campaign_dept,
       ubs.user_behavior_segment
from tmp.t_uniq_subs us
left join gcsi.t_plans p on us.plan_id = p.plan_id 
left join common.campaign_tracking c on us.channel = c.reported_channel
left join 
    (select uid drupal_user_id, max(segment_name) user_behavior_segment
     from 
        (select uid, 
       last_value(segment_name) over 
                    (partition by uid
                     order by engagement_ratio
           ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) segment_name
        from 
     common.user_behavior_segmentation) t
        group by uid) ubs
  on us.drupal_user_id = ubs.drupal_user_id;

DROP TABLE if exists common.user_d cascade;

CREATE TABLE common."user_d" (
"id"                        serial,
"drupal_user_id"            int8,
"gcsi_user_id"              int8,
"user_start_date"           date,
"user_end_date"             timestamp(6),
"subscription_id"           int8,
"subscription_start_date"   timestamp(6),
"paid_through_date"         timestamp(6),
"next_review_date"          timestamp(6),
"cancel_date"               timestamp(6),
"subscription_end_date"     timestamp(6),
"activity"                  text COLLATE "default",
"status"                    text COLLATE "default",
"entitled"                  bool,
"plan_id"                   int8,
"segment_id"                int8,
"plan_name"                 text COLLATE "default",
"plan_period"               interval,
"cid_channel"               text COLLATE "default",
"campaign_dept"             text COLLATE "default",
"user_behavior_segment"     text COLLATE "default",
"source_name"               text COLLATE "default",
"service_name"              text COLLATE "default",
"winback"                   text COLLATE "default",
"onboarding_segment"        text COLLATE "default",
"onboarding_parent"         text COLLATE "default",
"subscription_cohort"       text COLLATE "default",
"sub_cohort_segment"        text COLLATE "default",
"valid_from"                date,
"valid_to"                  date,
"current_record"            text COLLATE "default"
)
WITH (OIDS=FALSE)
;


insert into common.user_d
   (drupal_user_id, gcsi_user_id, user_start_date, user_end_date, 
        subscription_id, subscription_start_date, paid_through_date, 
        next_review_date, cancel_date, subscription_end_date, activity, 
        status, entitled, plan_id, segment_id, plan_name, plan_period, 
        cid_channel, campaign_dept, user_behavior_segment, source_name, 
        service_name, winback, onboarding_segment, onboarding_parent, 
    valid_from, valid_to, current_record)
(select t.drupal_user_id,
        t.gcsi_user_id,
        ut.user_start_date,
        case when t.end_date < ua.valid_to
             then t.end_date
             else NULL
        end user_end_date,
        t.subscription_id,
        t.start_date subscription_start_date,
        paid_through_date,
        t.next_review_date,
        case when t.cancel_date < ua.valid_to then t.cancel_date
             when activity = 'Cancel' then  ua.valid_from
             else NULL
        end cancel_date,        
        case when t.end_date < ua.valid_to
             then t.end_date
             else NULL
        end subscription_end_date,
        ua.activity,
        case when ua.activity in ('Start', 'Hold End') then 'Active'
             when ua.activity in ('Start/Hold', 'Hold Start') then 'Hold'
             when ua.activity in ('Cancel', 'End','Paid_Through') then 'Cancelled'
        end status,
        case when ua.activity in ('Start/Hold', 'Hold Start', 'Paid_Through') then 'f'::bool
             when t.cancel_date is null then 't'::bool
             when t.cancel_date > valid_to then 
                   case when ua.activity in ('Cancel', 'End')
                        then 'f'::bool
                        else 't'::bool
                   end
             when t.cancel_date < paid_through_date then 't'::bool
             else 'f'::bool
        end entitled,  --swag.  use drupal instead?
        t.plan_id,
                seg.segment_id,
        s.plan_name,
        seg.plan_period,
        t.channel,
        s.campaign_dept,
        s.user_behavior_segment,
        t.source_name,
        t.service_name,
        case when ut.user_start_date::date < t.start_date::date
             then 'Winback'
             else 'New User'
        end winback,
        ut.onboarding_segment,
        ut.onboarding_parent,
        ua.valid_from,
        ua.valid_to,
        ua.current_record
from tmp.t_uniq_subs t
left join tmp.user_activity_tmp ua
   on t.subscription_id = ua.subscription_id
join tmp.user_attributes_tmp ut
   on t.gcsi_user_id = ut.gcsi_user_id
join tmp.subscription_attributes_tmp s
   on t.subscription_id = s.subscription_id
join tmp.segments_tmp seg
   on ua.subscription_id = seg.subscription_id and 
      ua.valid_from = seg.valid_from
order by gcsi_user_id, valid_from);
   
update common.user_d d1 set subscription_cohort = t.campaign
from 
(select subscription_id,
 case when campaign like '%Cosmic Disc%' then 'Cosmic Disclosure'
      when campaign like '%Conscious Cleanse%' then 'Conscious Cleanse'
      when campaign like '%al008%'then 'Commit to You'
      when campaign like '%al026%'then 'Gaiam Prospect Offer'
 end campaign
from common.user_d d
join common.campaign_tracking c
    on d.cid_channel = c.reported_channel) t
where d1.subscription_id = t.subscription_id
  and t.campaign is not null;

update common.user_d d1 set sub_cohort_segment = c.sub_cohort_segment
from common.campaign_tracking c
where d1.cid_channel = c.reported_channel
  and d1.subscription_cohort = 'Gaiam Prospect Offer';

update common.user_d d1 set sub_cohort_segment = 'cid'
where subscription_cohort is not null
  and sub_cohort_segment is null;

update common.user_d d1 
set subscription_cohort = 'Commit to You',
    sub_cohort_segment = 'guide opt-in'
where drupal_user_id in
   (select uid from drupal.flag_content 
    where fid = 11 
      and content_id = 92376)
  and d1.subscription_start_date >= '2014-12-26'::date
  and d1.subscription_start_date < '2015-02-01'::date;

update common.user_d d1 
set subscription_cohort = 'Conscious Cleanse',
    sub_cohort_segment = 'guide opt-in'
where drupal_user_id in
   (select uid from drupal.flag_content 
    where fid = 11 
      and content_id = 97961)
  and d1.subscription_start_date >= '2014-12-26'::date
  and d1.subscription_start_date < '2015-02-01'::date;



drop table if exists tmp.cosmic_decision_tree_tmp;


-- alternative ways of joining cosmic cohort
create table tmp.cosmic_decision_tree_tmp (
gcsi_user_id int,
subscription_start_date date,
goode_cid int default 0,
wilcock_cid int default 0,
cd_first_video_engagement int default 0,
cd_any_video_engagement int default 0);

insert into tmp.cosmic_decision_tree_tmp 
     (gcsi_user_id, subscription_start_date, goode_cid, wilcock_cid, cd_first_video_engagement, cd_any_video_engagement)
(select 
       gcsi_user_id,
       subscription_start_date::date,
       case when cid_channel like '%goode%' then 1 else 0 end,
       case when cid_channel= '%wilcock%' 
                 and subscription_start_date >= '2015-07-21'::date 
            then 1 else 0 end,
       case when v1.drupal_user_id is not null then 1 else 0 end,
       case when v2.drupal_user_id is not null then 1 else 0 end
from common.user_d u
left join -- first video engagement
        (select drupal_user_id
    from
        (select drupal_user_id, min(first_nid) first_nid
        from
            (select user_id drupal_user_id,
                    first_value(nid) 
                         over (partition by user_id 
                         order by created
                         rows between unbounded preceding and unbounded following) first_nid
             from moiram.video_tmp
             where created > 1435709437 AND
                   user_id > 0)t
        group by drupal_user_id) t2
    join common.video_d v
       on t2.first_nid = v.media_nid
    where series_title = 'Cosmic Disclosure') v1
  on u.drupal_user_id = v1.drupal_user_id
left join --any video engagement
    (select distinct
          user_id drupal_user_id
     from moiram.video_tmp vt
     join common.video_d v
       on vt.nid = v.media_nid
    where series_title = 'Cosmic Disclosure') v2
  on u.drupal_user_id = v2.drupal_user_id
where u.subscription_start_date >= '2015-07-01'::date
  and u.current_record = 'Y');

update common.user_d d1 set sub_cohort_segment = 'goode'
where gcsi_user_id in
   (select gcsi_user_id
    from tmp.cosmic_decision_tree_tmp t
    where t.goode_cid = 1 
      and t.cd_any_video_engagement = 1)
   and sub_cohort_segment is null;

update common.user_d d1 set sub_cohort_segment = 'wilcock'
where gcsi_user_id in
   (select gcsi_user_id
    from tmp.cosmic_decision_tree_tmp
    where wilcock_cid = 1 
      and cd_any_video_engagement = 1)
  and sub_cohort_segment is null;

update common.user_d d1 set sub_cohort_segment = 'first video engagement'
where gcsi_user_id in
   (select gcsi_user_id
    from tmp.cosmic_decision_tree_tmp
    where cd_first_video_engagement = 1)
   and sub_cohort_segment is null;

update common.user_d d1 set subscription_cohort = 'Cosmic Disclosure'
where sub_cohort_segment in
   ('first video engagement', 'goode', 'wilcock')
  AND subscription_cohort is null;

create view common.current_users
as select * from common.user_d where current_record = 'Y';
/*
select subscription_cohort, sub_cohort_segment, status, count(distinct gcsi_user_id)
from common.user_d
where current_record = 'Y'
group by subscription_cohort, sub_cohort_segment, status;
*/


[2016-02-26 16:50:18.403] [028592] [dwh-prod] [PGSQL]
ERROR:  must be owner of relation user_d


[2016-02-26 16:50:18.801] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:55:06.360] [010406] [dwh-prod] [PGSQL]
SELECT * FROM "common"."user_d" WHERE "gcsi_user_id" = '12776120' LIMIT 1000 OFFSET 0

[2016-02-26 16:55:06.551] [010406] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'common' AND cl.table_name = 'user_d'

[2016-02-26 16:55:06.653] [010406] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329534

[2016-02-26 16:55:41.139] [007609] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."segments_tmp" WHERE "subscription_id" = '12776127' LIMIT 1000 OFFSET 0

[2016-02-26 16:55:41.281] [007609] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'segments_tmp'

[2016-02-26 16:55:41.371] [007609] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329517

[2016-02-26 16:56:17.800] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:56:17.929] [003859] [dwh-prod] [PGSQL]
  (select t.drupal_user_id,
        t.gcsi_user_id,
        t.subscription_id,
        t.start_date subscription_start_date,
        paid_through_date,
        t.next_review_date,
        case when t.cancel_date < ua.valid_to then t.cancel_date
             when activity = 'Cancel' then  ua.valid_from
             else NULL
        end cancel_date,        
        case when t.end_date < ua.valid_to
             then t.end_date
             else NULL
        end subscription_end_date,
        ua.activity,
        case when ua.activity in ('Start', 'Hold End') then 'Active'
             when ua.activity in ('Start/Hold', 'Hold Start') then 'Hold'
             when ua.activity in ('Cancel', 'End','Paid_Through') then 'Cancelled'
        end status,
        ua.valid_from,
        ua.valid_to,
        ua.current_record
from tmp.t_uniq_subs t
left join tmp.user_activity_tmp ua
   on t.subscription_id = ua.subscription_id
join tmp.user_attributes_tmp ut
   on t.gcsi_user_id = ut.gcsi_user_id
join tmp.subscription_attributes_tmp s
   on t.subscription_id = s.subscription_id
join tmp.segments_tmp seg
   on ua.subscription_id = seg.subscription_id and 
      ua.valid_from = seg.valid_from
where t.gcsi_user_id = 12776120
order by gcsi_user_id, valid_from);  


[2016-02-26 16:56:18.366] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 16:59:17.089] [001803] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."user_activity_tmp" WHERE "gcsi_user_id" = '12776120' LIMIT 1000 OFFSET 0

[2016-02-26 16:59:17.227] [001803] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'user_activity_tmp'

[2016-02-26 16:59:17.318] [001803] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6330066

[2016-02-26 17:00:53.474] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:00:53.617] [003859] [dwh-prod] [PGSQL]
(select t3.*,
    seg.duration_period::interval plan_period
 from
    (select subscription_id, valid_from,
            max(segment_id) segment_id
    from
        (select subscription_id,  
               valid_from,
               schedule_date,
               last_value(segment_id) 
               over (partition by subscription_id, valid_from 
               order by schedule_date
               rows between unbounded preceding and unbounded following) segment_id
        from
            (select ua.subscription_id, 
                    ua.valid_from, 
                    se.schedule_date,
                    spe .segment_id
             from tmp.user_activity_tmp ua
             join gcsi.subscription_event se on ua.subscription_id = se.subscription_id
             join gcsi.subscription_plan_event spe on se.id = spe.id 
             where se.schedule_date <= ua.valid_to AND
                where subscription_id = 12776127) t) t1
    group by subscription_id, valid_from) t3
 join gcsi.segment seg  on t3.segment_id = seg.id);


[2016-02-26 17:00:53.697] [003859] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "where"
LINE 23:                 where subscription_id = 12776127) t) t1
                         ^


[2016-02-26 17:00:53.718] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:01:06.798] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:01:06.931] [003859] [dwh-prod] [PGSQL]
(select t3.*,
    seg.duration_period::interval plan_period
 from
    (select subscription_id, valid_from,
            max(segment_id) segment_id
    from
        (select subscription_id,  
               valid_from,
               schedule_date,
               last_value(segment_id) 
               over (partition by subscription_id, valid_from 
               order by schedule_date
               rows between unbounded preceding and unbounded following) segment_id
        from
            (select ua.subscription_id, 
                    ua.valid_from, 
                    se.schedule_date,
                    spe .segment_id
             from tmp.user_activity_tmp ua
             join gcsi.subscription_event se on ua.subscription_id = se.subscription_id
             join gcsi.subscription_plan_event spe on se.id = spe.id 
             where se.schedule_date <= ua.valid_to AND
                 subscription_id = 12776127) t) t1
    group by subscription_id, valid_from) t3
 join gcsi.segment seg  on t3.segment_id = seg.id);


[2016-02-26 17:01:07.012] [003859] [dwh-prod] [PGSQL]
ERROR:  column reference "subscription_id" is ambiguous
LINE 23:                  subscription_id = 12776127) t) t1
                          ^


[2016-02-26 17:01:07.035] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:01:27.300] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:01:27.433] [003859] [dwh-prod] [PGSQL]
(select t3.*,
    seg.duration_period::interval plan_period
 from
    (select subscription_id, valid_from,
            max(segment_id) segment_id
    from
        (select subscription_id,  
               valid_from,
               schedule_date,
               last_value(segment_id) 
               over (partition by subscription_id, valid_from 
               order by schedule_date
               rows between unbounded preceding and unbounded following) segment_id
        from
            (select ua.subscription_id, 
                    ua.valid_from, 
                    se.schedule_date,
                    spe .segment_id
             from tmp.user_activity_tmp ua
             join gcsi.subscription_event se on ua.subscription_id = se.subscription_id
             join gcsi.subscription_plan_event spe on se.id = spe.id 
             where se.schedule_date <= ua.valid_to AND
                 ua.subscription_id = 12776127) t) t1
    group by subscription_id, valid_from) t3
 join gcsi.segment seg  on t3.segment_id = seg.id);


[2016-02-26 17:01:28.277] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:01:28.715] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6330066

[2016-02-26 17:02:47.217] [024828] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 17:02:47.297] [005469] [dwh-prod] [PGSQL]
SELECT col.table_name, col.column_name, col.character_maximum_length, col.is_nullable, col.numeric_precision, col.numeric_scale, col.datetime_precision, col.ordinal_position, b.atttypmod, b.attndims, col.data_type AS col_type, et.typelem, et.typlen, et.typtype, nbt.nspname AS elem_schema , bt.typname AS elem_name, b.atttypid, col.udt_schema, col.udt_name, col.column_default AS col_default, col.domain_catalog, col.domain_schema, col.domain_name, b.attfdwoptions AS foreign_options,col_description(c.oid, col.ordinal_position) AS comment, b.attacl, coll.collname FROM information_schema.columns AS col LEFT JOIN pg_namespace ns ON ns.nspname = col.table_schema LEFT JOIN pg_class c ON col.table_name = c.relname AND c.relnamespace = ns.oid LEFT JOIN pg_attrdef a ON c.oid = a.adrelid AND col.ordinal_position = a.adnum LEFT JOIN pg_attribute b ON b.attrelid = c.oid AND b.attname = col.column_name LEFT JOIN pg_type et ON et.oid = b.atttypid LEFT JOIN pg_collation coll ON coll.oid = b.attcollation LEFT JOIN pg_type bt ON et.typelem = bt.oid LEFT JOIN pg_namespace nbt ON bt.typnamespace = nbt.oid WHERE col.table_schema = 'tmp' AND col.table_name = 'segments_tmp' ORDER BY col.table_name, col.ordinal_position

[2016-02-26 17:02:47.397] [005469] [dwh-prod] [PGSQL]
SELECT oid, oprname FROM pg_catalog.pg_operator

[2016-02-26 17:02:47.959] [005469] [dwh-prod] [PGSQL]
SELECT opc.oid, opc.opcname, nsp.nspname, opc.opcdefault FROM pg_opclass opc, pg_namespace nsp WHERE opc.opcnamespace = nsp.oid

[2016-02-26 17:02:48.120] [005469] [dwh-prod] [PGSQL]
SELECT i.indrelid AS oid, ci.relname AS index_name, ct.relname AS TABLE_NAME, am.amname, i.indkey, i.indclass, i.indnatts, i.indoption ,i.indexrelid FROM pg_index i LEFT JOIN pg_class ct ON ct.oid = i.indrelid LEFT JOIN pg_class ci ON ci.oid = i.indexrelid LEFT JOIN pg_namespace tns ON tns.oid = ct.relnamespace LEFT JOIN pg_namespace ins ON ins.oid = ci.relnamespace LEFT JOIN pg_tablespace ts ON ci.reltablespace = ts.oid LEFT JOIN pg_am am ON ci.relam = am.oid LEFT JOIN pg_depend dep ON dep.classid = ci.tableoid AND dep.objid = ci.oid AND dep.refobjsubid = '0' LEFT JOIN pg_constraint con ON con.tableoid = dep.refclassid AND con.oid = dep.refobjid WHERE tns.nspname = 'tmp' AND ct.relname = 'segments_tmp' AND conname IS NOT NULL

[2016-02-26 17:02:48.202] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, c.conname, c.contype, c.condeferrable, c.condeferred, c.conkey, c.confupdtype, c.confdeltype, c.confmatchtype, c.consrc, c.conindid, c.connoinherit, t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, ts.spcname, i.reloptions AS param, am.amname, c.conexclop, pg_get_expr(ci.indpred, ci.indexrelid, true) where_predicate, obj_description(c.oid) AS comment FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) LEFT JOIN pg_class i ON (c.conname = i.relname) AND (c.connamespace = i.relnamespace) LEFT JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) LEFT JOIN pg_tablespace ts ON (i.reltablespace = ts.oid) LEFT JOIN pg_am am ON (i.relam = am.oid) LEFT JOIN pg_index ci ON (c.conindid = ci.indexrelid) WHERE ns.nspname = 'tmp' AND t.relname = 'segments_tmp' ORDER BY t.relname, i.oid

[2016-02-26 17:02:48.287] [005469] [dwh-prod] [PGSQL]
SELECT t.relname, fns.nspname AS foreign_schema, f.relname AS foreign_table, c.conname, c.confkey, a.attname AS foreign_field, a.attnum FROM pg_constraint c LEFT JOIN pg_namespace ns ON (c.connamespace = ns.oid) LEFT JOIN pg_class t ON (c.conrelid = t.oid) INNER JOIN pg_class f ON (c.confrelid = f.oid) LEFT JOIN pg_namespace fns ON (f.relnamespace = fns.oid) INNER JOIN pg_attribute a ON (a.attrelid = f.oid) WHERE a.attnum > 0 AND ns.nspname = 'tmp' AND t.relname = 'segments_tmp' ORDER BY t.relname, c.conname, a.attnum

[2016-02-26 17:02:48.549] [024828] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."segments_tmp" LIMIT 1000 OFFSET 0

[2016-02-26 17:02:48.873] [024828] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'segments_tmp'

[2016-02-26 17:02:48.971] [024828] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329517

[2016-02-26 17:03:07.947] [024828] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."segments_tmp" WHERE "subscription_id" = '12776127' LIMIT 1000 OFFSET 0

[2016-02-26 17:03:08.159] [024828] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'segments_tmp'

[2016-02-26 17:03:08.248] [024828] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329517

[2016-02-26 17:04:13.726] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:04:13.855] [003859] [dwh-prod] [PGSQL]
/*
select * from moiram.daily_status_y2014q1 where gcsi_user_id = 14239253
order by day_timestamp;


select * from tmp.paid_through_dates where subscription_id = 11760905;

select count(1) from moiram.daily_status_y2015q2;

select count(1) from common.daily_status_y2015q2;

drop table t2;

create table t2 as
select day_timestamp, count(1) num_rows, count(distinct gcsi_user_id) num_users from moiram.daily_status_y2014q1
group by day_timestamp;

--select * from t2 where num_rows <> num_users;

select * 
from moiram.daily_status_y2014q1
where day_timestamp = '20140101'
  and gcsi_user_id in 
    (select gcsi_user_id 
     from moiram.daily_status_y2014q1
      where day_timestamp = '20140101'
    group by gcsi_user_id
    having count(1) > 1);


select status, count(1)
from user_d 
where valid_from <= '20140101'
  and valid_to >= '20140101'
group by status;
*/
select status, count(1) 
from daily_status_y2014q1
--where day_timestamp = '20140101'
group by status;

select status, count(1) 
from common.daily_status_y2014q1
--where day_timestamp = '20140101'
group by status;



--except
select day_timestamp, gcsi_user_id, subscription_id
from common.daily_status_y2014q1
where status = 'Active'
EXCEPT
select day_timestamp, gcsi_user_id, subscription_id
from moiram.daily_status_y2014q1
where status = 'Active'
order by gcsi_user_id, day_timestamp

select * from moiram.daily_status_y2014q1
where gcsi_user_id in (168578,12776120, 14582111,14866418)
order by gcsi_user_id, day_timestamp

select * from gcsi.subscription_hold where subscription_id in (13121187,
12776127);



select * from common.user_d where gcsi_user_id in (168578,12776120);

select * from common.subscription_d where gcsi_user_id in (168578,12776120);

select * from common.daily_status_y2014q1 
where day_timestamp = '20140101'
  and gcsi_user_id in (168578,12776120);

select * from moiram.daily_status_y2014q1 
where day_timestamp between  '20140310' and '20140401'
  and gcsi_user_id = 14368036
order by day_timestamp;

select * from gcsi.subscription_hold where subscription_id in (13121187,
12776127);


select * from subscription_d where subscription_id in 
(select subscription_id from moiram.daily_status_y2014q1  where status = 'Cancelled' and day_timestamp = '20140101');

select * from moiram.daily_status_y2014q1  
where status = 'Cancelled' and day_timestamp = '20140101' and paid_through_date >'20140101';

select * from common.user_d where subscription_id in (18864058,31989601);

select * from gcsi.t_subscriptions where user_id = 14291846;

select *  from common.user_d where gcsi_user_id = 14291846;


select distinct u1.gcsi_user_id
from common.user_d u1
join common.user_d u2
  on  u1.gcsi_user_id = u2.gcsi_user_id
  and u1.subscription_id <> u2.subscription_id
  and u1.cancel_date >  '20140101' 
  and u1.cancel_date > u1.paid_through_date
  and u1.cancel_date <= (u1.paid_through_date::date +14)
  and u1.cancel_date::date = u2.subscription_start_date::date - 1;

    SELECT
        t1.gcsi_user_id,
        t1.subscription_id,
        t1.activity,
        t1.activity_date::date valid_from,
    case when gcsi_user_id = next_user
         then greatest(activity_date, t1.next_activity_date - integer '1')::date
         else to_date('29991231','yyyymmdd')
    end valid_to,
    case when gcsi_user_id = next_user
         then 'N'
         else 'Y'
    end current_record
 from
     (select t.*, 
         lead (activity_date::date)over w  next_activity_date,
         lead  (gcsi_user_id)  over w next_user
      from tmp.tmp_activity t 
where t.subscription_id = 12776127
      window w as (
            partition by t.gcsi_user_id
            order by
                activity_date,
                row_number rows between unbounded preceding
            and unbounded following
      )
    ) t1
;

  (select t.drupal_user_id,
        t.gcsi_user_id,
        t.subscription_id,
        t.start_date subscription_start_date,
        paid_through_date,
        t.next_review_date,
        case when t.cancel_date < ua.valid_to then t.cancel_date
             when activity = 'Cancel' then  ua.valid_from
             else NULL
        end cancel_date,        
        case when t.end_date < ua.valid_to
             then t.end_date
             else NULL
        end subscription_end_date,
        ua.activity,
        case when ua.activity in ('Start', 'Hold End') then 'Active'
             when ua.activity in ('Start/Hold', 'Hold Start') then 'Hold'
             when ua.activity in ('Cancel', 'End','Paid_Through') then 'Cancelled'
        end status,
        ua.valid_from,
        ua.valid_to,
        ua.current_record
from tmp.t_uniq_subs t
left join tmp.user_activity_tmp ua
   on t.subscription_id = ua.subscription_id
join tmp.user_attributes_tmp ut
   on t.gcsi_user_id = ut.gcsi_user_id
join tmp.subscription_attributes_tmp s
   on t.subscription_id = s.subscription_id
join tmp.segments_tmp seg
   on ua.subscription_id = seg.subscription_id and 
      ua.valid_from = seg.valid_from
where t.gcsi_user_id = 12776120
order by gcsi_user_id, valid_from);  

select * from tmp.segments_tmp
where subscription_id = 12776127;

(select t3.*,
    seg.duration_period::interval plan_period
 from
    (select subscription_id, valid_from,
            max(segment_id) segment_id
    from
        (select subscription_id,  
               valid_from,
               schedule_date,
               last_value(segment_id) 
               over (partition by subscription_id, valid_from 
               order by schedule_date
               rows between unbounded preceding and unbounded following) segment_id
        from
            (select ua.subscription_id, 
                    ua.valid_from, 
                    se.schedule_date,
                    spe .segment_id
             from tmp.user_activity_tmp ua
             join gcsi.subscription_event se on ua.subscription_id = se.subscription_id
             join gcsi.subscription_plan_event spe on se.id = spe.id 
             where se.schedule_date <= ua.valid_to AND
                 ua.subscription_id = 12776127) t) t1
    group by subscription_id, valid_from) t3
 join gcsi.segment seg  on t3.segment_id = seg.id);
       


[2016-02-26 17:04:13.936] [003859] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "select"
LINE 59: select * from moiram.daily_status_y2014q1
         ^


[2016-02-26 17:04:13.960] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:04:17.017] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:04:17.144] [003859] [dwh-prod] [PGSQL]
(select t3.*,
    seg.duration_period::interval plan_period
 from
    (select subscription_id, valid_from,
            max(segment_id) segment_id
    from
        (select subscription_id,  
               valid_from,
               schedule_date,
               last_value(segment_id) 
               over (partition by subscription_id, valid_from 
               order by schedule_date
               rows between unbounded preceding and unbounded following) segment_id
        from
            (select ua.subscription_id, 
                    ua.valid_from, 
                    se.schedule_date,
                    spe .segment_id
             from tmp.user_activity_tmp ua
             join gcsi.subscription_event se on ua.subscription_id = se.subscription_id
             join gcsi.subscription_plan_event spe on se.id = spe.id 
             where se.schedule_date <= ua.valid_to AND
                 ua.subscription_id = 12776127) t) t1
    group by subscription_id, valid_from) t3
 join gcsi.segment seg  on t3.segment_id = seg.id);


[2016-02-26 17:04:17.985] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:04:18.398] [003859] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6330066

[2016-02-26 17:05:13.299] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:05:13.426] [003859] [dwh-prod] [PGSQL]
create table t3 as
(select t3.*,
    seg.duration_period::interval plan_period
 from
    (select subscription_id, valid_from,
            max(segment_id) segment_id
    from
        (select subscription_id,  
               valid_from,
               schedule_date,
               last_value(segment_id) 
               over (partition by subscription_id, valid_from 
               order by schedule_date
               rows between unbounded preceding and unbounded following) segment_id
        from
            (select ua.subscription_id, 
                    ua.valid_from, 
                    se.schedule_date,
                    spe .segment_id
             from tmp.user_activity_tmp ua
             join gcsi.subscription_event se on ua.subscription_id = se.subscription_id
             join gcsi.subscription_plan_event spe on se.id = spe.id 
             where se.schedule_date <= ua.valid_to AND
                 ua.subscription_id = 12776127) t) t1
    group by subscription_id, valid_from) t3
 join gcsi.segment seg  on t3.segment_id = seg.id);


[2016-02-26 17:05:14.275] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:05:44.263] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:05:44.385] [003859] [dwh-prod] [PGSQL]
drop table t3; 
create table t3 as
(select t3.*,
    seg.duration_period::interval plan_period
 from
    (select subscription_id, valid_from,
            max(segment_id) segment_id
    from
        (select subscription_id,  
               valid_from,
               schedule_date,
               last_value(segment_id) 
               over (partition by subscription_id, valid_from 
               order by schedule_date
               rows between unbounded preceding and unbounded following) segment_id
        from
            (select ua.subscription_id, 
                    ua.valid_from, 
                    se.schedule_date,
                    spe .segment_id
             from tmp.user_activity_tmp ua
             join gcsi.subscription_event se on ua.subscription_id = se.subscription_id
             join gcsi.subscription_plan_event spe on se.id = spe.id 
             where se.schedule_date <= ua.valid_to) t) t1
    group by subscription_id, valid_from) t3
 join gcsi.segment seg  on t3.segment_id = seg.id);
       


[2016-02-26 17:06:02.581] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:06:26.214] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:06:26.323] [003859] [dwh-prod] [PGSQL]
select count(1) from tmp.segments_tmp


[2016-02-26 17:06:26.475] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:07:40.984] [026334] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 17:07:41.063] [026334] [dwh-prod] [PGSQL]
SELECT c.relname AS tablename, n.nspname AS schemaname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace WHERE (n.nspname = 'tmp') AND (c.relkind IN ('r', 'f'))  ORDER BY schemaname, tablename

[2016-02-26 17:07:41.173] [026334] [dwh-prod] [PGSQL]
SELECT viewname, schemaname FROM pg_views WHERE schemaname='tmp' ORDER BY schemaname, viewname

[2016-02-26 17:07:41.253] [026334] [dwh-prod] [PGSQL]
SELECT t.oid, n.nspname, t.typname FROM pg_type t LEFT JOIN pg_namespace n ON t.typnamespace = n.oid 

[2016-02-26 17:07:41.763] [026334] [dwh-prod] [PGSQL]
SELECT datlastsysoid FROM pg_database

[2016-02-26 17:07:41.842] [026334] [dwh-prod] [PGSQL]
SELECT p.proname, s.nspname, p.proargtypes , p.proargnames , p.proargmodes, p.proallargtypes , pg_get_expr(p.proargdefaults,'pg_proc'::regclass) AS defaultvalues FROM pg_proc p JOIN pg_type typ ON typ.oid=p.prorettype JOIN pg_namespace s on p.pronamespace = s.oid WHERE proisagg = false AND s.nspname = 'tmp' AND typ.typname != 'trigger' ORDER BY p.proname

[2016-02-26 17:07:41.927] [026334] [dwh-prod] [PGSQL]
SELECT c.relname FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace WHERE c.relkind = 'm'::"char" AND n.nspname = 'tmp' 

[2016-02-26 17:08:05.039] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:08:05.159] [028592] [dwh-prod] [PGSQL]
alter table tmp.segments_tmp schema = moiram;


[2016-02-26 17:08:05.238] [028592] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "schema"
LINE 1: alter table tmp.segments_tmp schema = moiram;
                                     ^


[2016-02-26 17:08:05.249] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:08:20.785] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:08:20.923] [028592] [dwh-prod] [PGSQL]
alter table tmp.segments_tmp schema = "moiram";


[2016-02-26 17:08:21.004] [028592] [dwh-prod] [PGSQL]
ERROR:  syntax error at or near "schema"
LINE 1: alter table tmp.segments_tmp schema = "moiram";
                                     ^


[2016-02-26 17:08:21.020] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:09:38.960] [028592] [dwh-prod] [PGSQL]
SET search_path TO "common",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:09:39.104] [028592] [dwh-prod] [PGSQL]
create table tmp.segments_tmp_new as 
(select t3.*,
    seg.duration_period::interval plan_period
 from
    (select subscription_id, valid_from,
            max(segment_id) segment_id
    from
        (select subscription_id,  
               valid_from,
               schedule_date,
               last_value(segment_id) 
               over (partition by subscription_id, valid_from 
               order by schedule_date
               rows between unbounded preceding and unbounded following) segment_id
        from
            (select ua.subscription_id, 
                    ua.valid_from, 
                    se.schedule_date,
                    spe .segment_id
             from tmp.user_activity_tmp ua
             join gcsi.subscription_event se on ua.subscription_id = se.subscription_id
             join gcsi.subscription_plan_event spe on se.id = spe.id 
             where se.schedule_date <= ua.valid_to) t) t1
    group by subscription_id, valid_from) t3
 join gcsi.segment seg  on t3.segment_id = seg.id);


[2016-02-26 17:09:56.925] [028592] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:10:39.051] [024828] [dwh-prod] [PGSQL]
SELECT * FROM "tmp"."segments_tmp" LIMIT 1000 OFFSET 0

[2016-02-26 17:10:39.373] [024828] [dwh-prod] [PGSQL]
SELECT cl.column_name, ty.typtype, cl.udt_schema, ty.typname, cl.column_default FROM information_schema.columns cl LEFT JOIN pg_type ty ON ty.typname = cl.udt_name LEFT JOIN pg_namespace nsp ON nsp.oid = ty.typnamespace WHERE nsp.nspname = cl.udt_schema AND cl.table_catalog = 'dwh_prod' AND cl.table_schema = 'tmp' AND cl.table_name = 'segments_tmp'

[2016-02-26 17:10:39.462] [024828] [dwh-prod] [PGSQL]
SELECT c.conkey FROM pg_constraint c WHERE c.contype='p' AND c.conrelid = 6329517

[2016-02-26 17:11:48.181] [004958] [dwh-prod] [PGSQL]
SELECT d.datname, d.oid, pg_get_userbyid(d.datdba) AS owner, shobj_description(d.oid, 'pg_database') AS comment, t.spcname, d.datacl, d.datlastsysoid, d.encoding, pg_encoding_to_char(d.encoding) AS encodingname FROM pg_database d LEFT JOIN pg_tablespace t ON d.dattablespace=t.oid

[2016-02-26 17:11:48.184] [004958] [dwh-prod] [PGSQL]
server closed the connection unexpectedly
	This probably means the server terminated abnormally
	before or while processing the request.


[2016-02-26 17:11:48.772] [027753] [dwh-prod] [PGSQL]
SET application_name = 'NAVICAT'

[2016-02-26 17:11:48.852] [027753] [dwh-prod] [PGSQL]
SELECT d.datname, d.oid, pg_get_userbyid(d.datdba) AS owner, shobj_description(d.oid, 'pg_database') AS comment, t.spcname, d.datacl, d.datlastsysoid, d.encoding, pg_encoding_to_char(d.encoding) AS encodingname FROM pg_database d LEFT JOIN pg_tablespace t ON d.dattablespace=t.oid

[2016-02-26 17:11:48.952] [005469] [dwh-prod] [PGSQL]
SELECT nspname, oid, pg_get_userbyid(nspowner) AS owner, nspacl, obj_description(oid) FROM pg_namespace

[2016-02-26 17:13:36.488] [005469] [dwh-prod] [PGSQL]
SELECT c.oid, obj_description(c.oid),  c.relhasoids AS hasoids, n.nspname AS schemaname, c.relname AS tablename, c.relkind, pg_get_userbyid(c.relowner) AS tableowner, t.spcname AS "tablespace", c.relhasindex AS hasindexes, c.relhasrules AS hasrules, c.relhastriggers AS hastriggers, ft.ftoptions, fs.srvname, c.relacl, c.reltuples, ((SELECT count(*) FROM pg_inherits WHERE inhparent = c.oid) > 0) AS inhtable, i2.nspname AS inhschemaname, i2.relname AS inhtablename, c.reloptions AS param, c.relpersistence AS unlogged FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace LEFT JOIN pg_tablespace t ON t.oid = c.reltablespace LEFT JOIN (pg_inherits i INNER JOIN pg_class c2 ON i.inhparent = c2.oid LEFT JOIN pg_namespace n2 ON n2.oid = c2.relnamespace) i2 ON i2.inhrelid = c.oid LEFT JOIN pg_foreign_table ft ON ft.ftrelid = c.oid LEFT JOIN pg_foreign_server fs ON ft.ftserver = fs.oid WHERE ((c.relkind = 'r'::"char") OR (c.relkind = 'f'::"char")) AND n.nspname = 'tmp'

[2016-02-26 17:15:12.234] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:15:12.361] [003859] [dwh-prod] [PGSQL]
select max(valid_from) from tmp.segments_tmp;


[2016-02-26 17:15:12.523] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:16:44.909] [003859] [dwh-prod] [PGSQL]
SET search_path TO "moiram",common, drupal, gcsi, tmp, responsys, omniture

[2016-02-26 17:16:45.016] [003859] [dwh-prod] [PGSQL]
create table moiram.segments_tmp as (select * from tmp.segments_tmp);


[2016-02-26 17:16:46.890] [003859] [dwh-prod] [PGSQL]
SET search_path TO common, drupal, gcsi, tmp, responsys, omniture

